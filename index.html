<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Quality Performance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        :root {
            --navy:       #3B8BF5;
            --navy-mid:   #2D7CE5;
            --navy-light: #5BA0F7;
            --gold:       #3B8BF5;
            --gold-light: #6DB3FF;
            --gold-pale:  #EBF3FF;
            --cyan:       #5BA0F7;
            --success:    #34D399;
            --danger:     #F87171;
            --warning:    #FBBF24;
            --bg:         #F4F7FC;
            --surface:    #ffffff;
            --surface2:   #F8FAFF;
            --border:     #E2E8F0;
            --text:       #1E293B;
            --text-sub:   #64748B;
            --text-muted: #94A3B8;
            --shadow-sm:  0 2px 8px rgba(59,139,245,0.08);
            --shadow-md:  0 8px 24px rgba(59,139,245,0.12);
            --shadow-lg:  0 20px 48px rgba(59,139,245,0.16);
            --r:          14px;
            --r-lg:       20px;
        }

        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 28px;
            background-image:
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59,139,245,0.10) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(59,139,245,0.05) 0%, transparent 50%);
            word-break: keep-all;
            -webkit-font-smoothing: antialiased;
        }

        /* ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ */
        #loadingOverlay {
            position: fixed; inset: 0;
            background: url('https://images.unsplash.com/photo-1518770660439-4636190af475?w=1600&q=80') center/cover no-repeat;
            z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        #loadingOverlay::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(45,124,229,0.90) 0%, rgba(59,139,245,0.85) 40%, rgba(91,160,247,0.82) 100%);
        }
        .loading-logo { font-size: 36px; font-weight: 900; color: white; letter-spacing: 3px; font-family: 'Inter', 'Noto Sans KR', sans-serif; text-transform: uppercase; position: relative; z-index: 1; }
        .loading-logo span { color: rgba(255,255,255,0.7); }
        .loading-bar {
            width: 200px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;
            position: relative; z-index: 1;
        }
        .loading-bar-inner {
            height: 100%; width: 0%; background: linear-gradient(90deg, rgba(255,255,255,0.9), white);
            border-radius: 2px; animation: loadBar 1.8s ease-in-out forwards;
        }
        @keyframes loadBar { to { width: 100%; } }
        .loading-text { font-size: 13px; color: rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 0.3px; font-family: 'Noto Sans KR', sans-serif; position: relative; z-index: 1; }

        /* ‚îÄ‚îÄ‚îÄ Sync Status ‚îÄ‚îÄ‚îÄ */
        #syncStatus {
            position: fixed; bottom: 24px; right: 24px;
            padding: 10px 18px; border-radius: 40px;
            font-size: 12px; font-weight: 700; z-index: 9999;
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(12px); letter-spacing: 0.3px;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .sync-online  { background: rgba(16,185,129,0.15); color: #059669; border-color: rgba(16,185,129,0.3); }
        .sync-saving  { background: rgba(245,158,11,0.15); color: #d97706; border-color: rgba(245,158,11,0.3); }
        .sync-offline { background: rgba(244,63,94,0.15);  color: #e11d48; border-color: rgba(244,63,94,0.3); }
        .sync-dot { width: 7px; height: 7px; border-radius: 50%; }
        .sync-online  .sync-dot { background: #059669; animation: blink 2s infinite; }
        .sync-saving  .sync-dot { background: #d97706; animation: blink 0.6s infinite; }
        .sync-offline .sync-dot { background: #e11d48; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* ‚îÄ‚îÄ‚îÄ Save Toast ‚îÄ‚îÄ‚îÄ */
        .save-toast {
            position: fixed; top: 28px; right: 28px;
            background: var(--navy); color: white;
            padding: 14px 22px; border-radius: var(--r);
            font-size: 14px; font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 9999; display: none;
            border-left: 4px solid var(--gold);
            animation: toastIn 0.4s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes toastIn { from{transform:translateY(-80px);opacity:0} to{transform:translateY(0);opacity:1} }

        /* ‚îÄ‚îÄ‚îÄ Page Enter Animation ‚îÄ‚îÄ‚îÄ */
        .fade-up {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeUp 0.5s ease forwards;
        }
        @keyframes fadeUp { to { opacity:1; transform:translateY(0); } }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            background: url('https://images.unsplash.com/photo-1518770660439-4636190af475?w=1600&q=80') center/cover no-repeat;
            border-radius: var(--r-lg);
            padding: 32px 36px;
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(59,139,245,0.25);
            animation: fadeUp 0.5s ease forwards;
        }
        .header::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(45,124,229,0.88) 0%, rgba(59,139,245,0.82) 40%, rgba(91,160,247,0.78) 100%);
            pointer-events: none;
        }
        .header::after {
            content: '';
            position: absolute; inset: 0;
            background:
                radial-gradient(ellipse at 90% 20%, rgba(255,255,255,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 10% 80%, rgba(255,255,255,0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        .header-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: start;
            gap: 24px;
            position: relative; z-index: 1;
        }
        .header-brand { display: flex; align-items: center; gap: 16px; margin-bottom: 6px; }
        .brand-badge {
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            backdrop-filter: blur(4px);
        }
        .header h1 {
            font-size: 24px; font-weight: 800; color: white;
            letter-spacing: 1.5px; line-height: 1.2;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            text-transform: uppercase;
        }
        .header-sub {
            font-size: 12px; color: rgba(255,255,255,0.45);
            font-weight: 400; margin-top: 4px; letter-spacing: 0.2px;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .logo-area { text-align: right; }
        .logo-text {
            font-family: 'Inter', sans-serif;
            font-weight: 900; font-size: 28px;
            color: white; letter-spacing: 2px;
            line-height: 1; text-transform: uppercase;
        }
        .logo-text span { color: rgba(255,255,255,0.65); font-weight: 900; }
        .logo-sub {
            font-size: 9px; color: rgba(255,255,255,0.45);
            letter-spacing: 3px; text-transform: uppercase;
            margin-top: 5px; font-family: 'Inter', sans-serif;
            font-weight: 500;
        }
        .logo-designer {
            font-size: 9px; color: rgba(255,255,255,0.35);
            letter-spacing: 1px; margin-top: 8px;
            font-family: 'Inter', sans-serif; font-weight: 400;
            font-style: italic;
        }

        /* ‚îÄ‚îÄ‚îÄ Controls Row ‚îÄ‚îÄ‚îÄ */
        .controls-row {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
            margin-top: 24px; padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            position: relative; z-index: 1;
        }
        .lang-switch {
            background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px; padding: 3px; display: flex; gap: 2px;
        }
        .lang-btn {
            border: none; background: transparent; color: rgba(255,255,255,0.55);
            padding: 7px 16px; border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 700; transition: all 0.2s;
            font-family: 'Noto Sans KR', sans-serif; letter-spacing: 0;
        }
        .lang-btn:hover { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.85); }
        .lang-btn.active { background: rgba(255,255,255,0.25); color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.15); }

        .btn {
            padding: 9px 16px; border: none; border-radius: 10px; cursor: pointer;
            font-size: 13px; font-weight: 700; display: inline-flex; align-items: center;
            gap: 6px; transition: all 0.2s; font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; white-space: nowrap;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn-prod  { background: rgba(52,211,153,0.85); color: white; border: 1px solid rgba(52,211,153,0.6); backdrop-filter: blur(4px); box-shadow: 0 2px 8px rgba(52,211,153,0.3); }
        .btn-prod:hover { background: rgba(52,211,153,1); box-shadow: 0 4px 12px rgba(52,211,153,0.4); }
        .btn-ship  { background: rgba(96,165,250,0.85); color: white; border: 1px solid rgba(96,165,250,0.6); backdrop-filter: blur(4px); box-shadow: 0 2px 8px rgba(96,165,250,0.3); }
        .btn-ship:hover { background: rgba(96,165,250,1); box-shadow: 0 4px 12px rgba(96,165,250,0.4); }
        .btn-def   { background: rgba(251,146,60,0.85); color: white; border: 1px solid rgba(251,146,60,0.6); backdrop-filter: blur(4px); box-shadow: 0 2px 8px rgba(251,146,60,0.3); }
        .btn-def:hover { background: rgba(251,146,60,1); box-shadow: 0 4px 12px rgba(251,146,60,0.4); }
        .btn-excel { background: rgba(34,197,94,0.8); color: white; border: 1px solid rgba(34,197,94,0.5); box-shadow: 0 2px 8px rgba(34,197,94,0.25); }
        .btn-excel:hover { background: rgba(34,197,94,1); box-shadow: 0 4px 12px rgba(34,197,94,0.35); }

        /* ‚îÄ‚îÄ‚îÄ Filter Row ‚îÄ‚îÄ‚îÄ */
        .filter-section {
            background: white; border-radius: var(--r-lg);
            padding: 18px 24px; margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            animation: fadeUp 0.5s 0.1s ease both;
        }
        .filter-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .filter-row + .filter-row { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }
        .filter-label {
            font-size: 11px; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; min-width: 44px;
            font-family: 'Inter', sans-serif;
        }
        .filter-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        .filter-btn {
            background: var(--surface2); border: 1.5px solid var(--border);
            color: var(--text-sub); padding: 8px 14px; height:36px; box-sizing:border-box; border-radius: 30px;
            font-size: 12px; cursor: pointer; transition: all 0.18s ease;
            font-weight: 600; font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; line-height: 1.2; display:inline-flex; align-items:center;
        }
        .filter-btn:hover { border-color: #3B8BF5; color: #2563EB; background: #EBF3FF; }
        .filter-btn.active {
            background: var(--navy); color: white; border-color: var(--navy);
            box-shadow: 0 2px 8px rgba(12,30,62,0.20);
        }

        /* ‚îÄ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ‚îÄ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .kpi-card {
            background: white; border-radius: var(--r);
            padding: 22px 24px;
            border: 1px solid var(--border);
            position: relative; overflow: hidden;
            transition: all 0.25s;
            box-shadow: var(--shadow-sm);
            animation: fadeUp 0.5s ease both;
        }
        .kpi-card:nth-child(1){animation-delay:0.1s}
        .kpi-card:nth-child(2){animation-delay:0.15s}
        .kpi-card:nth-child(3){animation-delay:0.2s}
        .kpi-card:nth-child(4){animation-delay:0.25s}
        .kpi-card:nth-child(5){animation-delay:0.3s}
        .kpi-card:nth-child(6){animation-delay:0.35s}
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .kpi-card::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
        }
        .kpi-card.c-blue::after  { background: linear-gradient(90deg,#3B8BF5,#6DB3FF); }
        .kpi-card.c-green::after { background: linear-gradient(90deg,#10b981,#6ee7b7); }
        .kpi-card.c-red::after   { background: linear-gradient(90deg,#F87171,#FCA5A5); }
        .kpi-card.c-slate::after { background: linear-gradient(90deg,#94A3B8,#CBD5E1); }
        .kpi-card.c-orange::after{ background: linear-gradient(90deg,#FBBF24,#FDE68A); }

        .kpi-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; margin-bottom: 14px;
        }
        .c-blue  .kpi-icon { background: #EBF3FF; }
        .c-green .kpi-icon { background: #ECFDF5; }
        .c-red   .kpi-icon { background: #FEF2F2; }
        .c-slate .kpi-icon { background: #F1F5F9; }
        .c-orange .kpi-icon { background: #FFFBEB; }
        .kpi-value {
            font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
            font-family: 'JetBrains Mono', 'Inter', monospace; margin-bottom: 4px; line-height: 1.1;
        }
        .c-blue   .kpi-value { color: #2563EB; }
        .c-green  .kpi-value { color: #059669; }
        .c-red    .kpi-value { color: #e11d48; }
        .c-slate  .kpi-value { color: #334155; }
        .c-orange .kpi-value { color: #b45309; }
        .kpi-sub-value {
            font-size: 14px; font-weight: 700; letter-spacing: -0.3px;
            font-family: 'JetBrains Mono', 'Inter', monospace;
            margin-bottom: 6px; line-height: 1.1; opacity: 0.7;
        }
        .c-red    .kpi-sub-value { color: #e11d48; }
        .c-orange .kpi-sub-value { color: #b45309; }
        .kpi-label {
            font-size: 11px; color: var(--text-muted); font-weight: 500;
            letter-spacing: 0.3px; font-family: 'Noto Sans KR', sans-serif;
        }

        /* ‚îÄ‚îÄ‚îÄ Section Header ‚îÄ‚îÄ‚îÄ */
        .section-hd {
            display: flex; align-items: center; gap: 12px;
            margin: 36px 0 18px;
        }
        .section-hd-line {
            flex: 1; height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }
        .section-hd-title {
            font-size: 13px; font-weight: 800; color: var(--text-sub);
            text-transform: uppercase; letter-spacing: 1.5px;
            white-space: nowrap;
        }
        .section-toggle {
            font-size: 11px; color: var(--text-muted); transition: transform 0.3s;
        }
        .section-toggle.collapsed { transform: rotate(-90deg); }

        /* ‚îÄ‚îÄ‚îÄ Grid Layouts ‚îÄ‚îÄ‚îÄ */
        .g2 { display: grid; grid-template-columns: repeat(auto-fit,minmax(440px,1fr)); gap: 20px; margin-bottom: 20px; }
        .g3 { display: grid; grid-template-columns: repeat(auto-fit,minmax(340px,1fr)); gap: 20px; margin-bottom: 20px; }
        .g-full { width: 100%; margin-bottom: 20px; }

        /* ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ */
        .card {
            background: white; border-radius: var(--r);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
            transition: box-shadow 0.2s;
            overflow: hidden;
        }
        .card:hover { box-shadow: var(--shadow-md); }
        .card-head {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 22px 0;
        }
        .card-title {
            font-size: 13px; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 8px;
            letter-spacing: 0; font-family: 'Noto Sans KR', sans-serif;
        }
        .card-title-dot {
            width: 8px; height: 8px; border-radius: 2px;
            background: linear-gradient(135deg, #3B8BF5, #6DB3FF);
            flex-shrink: 0;
        }
        .card-body { padding: 16px 22px 22px; flex: 1; }

        /* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
        .tbl-wrap { overflow-x: auto; }
        .tbl-wrap::-webkit-scrollbar { height: 5px; }
        .tbl-wrap::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .tbl-wrap::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th {
            background: var(--surface2); color: var(--text-sub);
            padding: 10px 14px; text-align: center; font-weight: 700;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky; top: 0; z-index: 5;
            font-family: 'Inter', sans-serif;
        }
        thead th:first-child { text-align: left; }
        tbody td {
            padding: 10px 14px; border-bottom: 1px solid #f1f5f9;
            text-align: center; color: var(--text);
            font-variant-numeric: tabular-nums;
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        tbody td:first-child { text-align: left; font-weight: 600; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background: #f8faff; }

        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 800; letter-spacing: 0.3px;
        }
        .badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; }
        .badge-ok   { background: #f0fdf4; color: #16a34a; }
        .badge-ok::before { background: #16a34a; }
        .badge-ng   { background: #fff1f2; color: #e11d48; }
        .badge-ng::before { background: #e11d48; }

        .yield-good { color: #16a34a; font-weight: 700; font-family:'JetBrains Mono','Inter',monospace; }
        .yield-bad  { color: #e11d48; font-weight: 700; font-family:'JetBrains Mono','Inter',monospace; }

        /* ‚îÄ‚îÄ‚îÄ Chart Boxes ‚îÄ‚îÄ‚îÄ */
        .ch-sm  { position: relative; height: 190px; }
        .ch-md  { position: relative; height: 270px; }
        .ch-lg  { position: relative; height: 310px; }

        /* ‚îÄ‚îÄ‚îÄ Defect Table ‚îÄ‚îÄ‚îÄ */
        #tblDefectType thead th {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: rgba(255,255,255,0.9); border-bottom: none;
            font-family: 'Inter', sans-serif; font-size: 11px;
            letter-spacing: 0.5px; padding: 12px 14px;
        }
        #tblDefectType thead th:first-child { text-align: left; }
        #tblDefectType tbody td {
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        #tblDefectType tbody td:first-child {
            font-family: 'Noto Sans KR', sans-serif; font-weight: 600; color: var(--text);
        }
        #tblDefectType tbody td:last-child {
            color: #4f46e5; font-weight: 700;
            font-family: 'JetBrains Mono', monospace; font-size: 13px;
        }
        #tblDefectType tbody tr.grand-row td {
            background: #f0f4fb !important; font-weight: 700;
            border-top: 2px solid var(--navy); color: var(--navy);
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        #tblDefectType tbody tr.grand-row td:first-child {
            font-family: 'Noto Sans KR', sans-serif;
        }
        #tblDefectType tbody tr.grand-row td:last-child {
            background: var(--navy) !important; color: white;
            font-family: 'JetBrains Mono', monospace;
        }
        .d-zero   { color: #c8d6e5; font-style: normal; font-size: 15px; line-height: 1; }
        .d-low    { color: #d97706; font-weight: 700; font-family: 'JetBrains Mono', monospace !important; }
        .d-med    { color: #ea580c; font-weight: 700; font-family: 'JetBrains Mono', monospace !important; }
        .d-high   { color: #dc2626; font-weight: 800; font-family: 'JetBrains Mono', monospace !important; }

        /* ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ */
        .modal {
            display: none; position: fixed; inset: 0; z-index: 2000;
            background: rgba(12,30,62,0.65); backdrop-filter: blur(6px);
        }
        .modal-box {
            background: white; width: 92%; max-width: 980px;
            margin: 36px auto; padding: 36px; border-radius: var(--r-lg);
            max-height: 88vh; overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes modalUp { from{transform:translateY(40px);opacity:0} to{transform:translateY(0);opacity:1} }
        .modal-title { font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 6px; font-family: 'Noto Sans KR', sans-serif; }
        .modal-desc { font-size: 13px; color: var(--text-sub); margin-bottom: 20px; line-height: 1.7; font-family: 'Noto Sans KR', sans-serif; }
        .paste-area {
            width: 100%; height: 90px; padding: 14px;
            border: 2px dashed var(--border); border-radius: var(--r);
            background: var(--surface2); font-family: 'DM Mono', monospace;
            font-size: 12px; margin-bottom: 16px; resize: vertical;
            transition: border-color 0.2s;
        }
        .paste-area:focus { outline: none; border-color: #6366f1; background: #eef2ff; }
        .modal-footer {
            display: flex; gap: 12px; margin-top: 24px;
            padding-top: 20px; border-top: 1px solid var(--border);
        }
        .btn-full { flex: 1; padding: 13px; font-size: 14px; border-radius: 10px; }
        .btn-save   { background: linear-gradient(135deg,var(--navy),var(--navy-light)); color:white; border:none; cursor:pointer; font-family:inherit; font-weight:700; transition:all .2s; }
        .btn-save:hover { box-shadow: 0 6px 18px rgba(12,30,62,0.3); transform:translateY(-2px); }
        .btn-cancel { background: var(--surface2); color: var(--text-sub); border:1px solid var(--border); cursor:pointer; font-family:inherit; font-weight:600; transition:all .2s; }
        .btn-cancel:hover { border-color: var(--text-sub); }
        .btn-parse  { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; cursor:pointer; padding:10px 16px; border-radius:8px; font-family:inherit; font-weight:700; font-size:13px; flex:1; transition:all .2s; }
        .btn-parse:hover { background: #e0e7ff; }
        .btn-clr    { background: #fff1f2; color: #e11d48; border:1px solid #fecdd3; cursor:pointer; padding:10px 16px; border-radius:8px; font-family:inherit; font-weight:700; font-size:13px; width:110px; transition:all .2s; }
        .btn-clr:hover { background:#ffe4e6; }
        .btn-addrow { width:100%; margin-top:12px; padding:10px; background:var(--surface2); border:1px dashed var(--border); border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600; font-size:13px; color:var(--text-sub); transition:all .2s; }
        .btn-addrow:hover { border-color:#6366f1; color:#4f46e5; background:#eef2ff; }

        .entry-tbl { width:100%; border-collapse:collapse; font-size:13px; }
        .entry-tbl th { background:#f8faff; color:var(--text-sub); padding:9px 10px; text-align:center; font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid var(--border); font-family:'Inter',sans-serif; }
        .entry-tbl td { padding:6px 6px; border-bottom:1px solid #f1f5f9; }
        .entry-tbl input, .entry-tbl select {
            width:100%; padding:8px 10px; border:1px solid var(--border);
            border-radius:7px; font-size:13px; font-family:'Noto Sans KR','Inter',sans-serif;
            background:white; transition:all .2s; color:var(--text);
        }
        .entry-tbl input:focus, .entry-tbl select:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
        .entry-tbl select { cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%236366f1' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; padding-right:30px; }
        .btn-del { background:#fff1f2; color:#e11d48; border:1px solid #fecdd3; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:700; transition:all .2s; font-family:'Noto Sans KR',sans-serif; }
        .btn-del:hover { background:#ffe4e6; }

        /* ‚îÄ‚îÄ‚îÄ Config Banner ‚îÄ‚îÄ‚îÄ */
        #configBanner {
            background: linear-gradient(135deg,#fffbeb,#fef3c7);
            border: 2px solid #fcd34d; border-radius: var(--r);
            padding: 20px 24px; margin-bottom: 20px; display: none;
        }
        #configBanner h3 { color: #92400e; margin-bottom: 6px; font-size: 16px; }
        #configBanner p  { color: #78350f; font-size: 13px; line-height: 1.7; }
        #configBanner code { background:rgba(0,0,0,0.07); padding:2px 7px; border-radius:5px; font-family:'DM Mono',monospace; font-size:12px; }

        /* ‚îÄ‚îÄ‚îÄ Chart filter mini-btns ‚îÄ‚îÄ‚îÄ */
        .mini-filters { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:12px; }
        .mini-btn {
            padding: 5px 13px; border-radius: 30px; border: 1.5px solid var(--border);
            background: var(--surface2); color: var(--text-sub);
            font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s;
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; line-height: 1.4;
        }
        .mini-btn:hover { border-color: #6366f1; color: #4f46e5; background: #eef2ff; }
        .mini-btn.active { background: #3B8BF5; color: white; border-color: #3B8BF5; box-shadow: 0 2px 6px rgba(59,139,245,0.25); }


        /* ‚îÄ‚îÄ‚îÄ View Switch ‚îÄ‚îÄ‚îÄ */
        .view-switch{background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:10px;padding:3px;display:flex;gap:2px;}
        .btn-daily-prod{background:rgba(52,211,153,0.85);color:white;border:1px solid rgba(52,211,153,0.6);backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(52,211,153,0.3);}
        .btn-daily-prod:hover{background:rgba(52,211,153,1);box-shadow:0 4px 12px rgba(52,211,153,0.4);}
        .btn-daily-def{background:rgba(251,146,60,0.85);color:white;border:1px solid rgba(251,146,60,0.6);backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(251,146,60,0.3);}
        .btn-daily-def:hover{background:rgba(251,146,60,1);box-shadow:0 4px 12px rgba(251,146,60,0.4);}
        .btn-daily-att{background:rgba(59,130,246,0.85);color:white;border:1px solid rgba(59,130,246,0.6);backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(59,130,246,0.3);}
        .btn-daily-att:hover{background:rgba(59,130,246,1);box-shadow:0 4px 12px rgba(59,130,246,0.4);}
        .btn-daily-member{background:rgba(139,92,246,0.85);color:white;border:1px solid rgba(139,92,246,0.6);backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(139,92,246,0.3);}
        .btn-daily-member:hover{background:rgba(139,92,246,1);box-shadow:0 4px 12px rgba(139,92,246,0.4);}
        /* ‚îÄ‚îÄ‚îÄ Attendance ‚îÄ‚îÄ‚îÄ */
        .att-team-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:20px;}
        .att-team-card{background:white;border-radius:14px;padding:16px;border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,0.04);}
        .att-team-name{font-size:14px;font-weight:800;color:var(--navy);font-family:'Noto Sans KR',sans-serif;margin-bottom:8px;}
        .att-team-count{font-size:11px;color:var(--text-muted);margin-bottom:10px;}
        .att-team-rate{font-size:24px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:6px;}
        .att-stat-row{display:flex;gap:10px;flex-wrap:wrap;}
        .att-stat{text-align:center;flex:1;min-width:40px;}
        .att-stat-val{font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace;}
        .att-stat-lbl{font-size:9px;color:var(--text-muted);font-weight:600;margin-top:2px;}
        .att-badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;font-family:'Inter',sans-serif;}
        .att-badge-work{background:#d1fae5;color:#059669;}
        .att-badge-vacation{background:#dbeafe;color:#2563eb;}
        .att-badge-absence{background:#fee2e2;color:#dc2626;}
        .att-badge-early{background:#fef3c7;color:#d97706;}
        .att-tab{border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;background:#f1f5f9;color:#64748b;transition:all .2s;}
        .att-tab.active{background:#3b82f6;color:white;}
        .att-tab:hover:not(.active){background:#e2e8f0;}
        /* ‚îÄ‚îÄ‚îÄ Team Badges ‚îÄ‚îÄ‚îÄ */
        .team-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;font-family:'Inter',sans-serif;}
        .team-smt{background:#eef2ff;color:#6366f1;}
        .team-test{background:#e0f7fa;color:#0891b2;}
        /* ‚îÄ‚îÄ‚îÄ Date range filter ‚îÄ‚îÄ‚îÄ */
        .date-range{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
        .date-input{padding:8px 12px;height:36px;box-sizing:border-box;border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-family:'JetBrains Mono',monospace;color:var(--text);background:white;cursor:pointer;transition:all .2s;}
        .date-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1);}
        .date-sep{color:var(--text-muted);font-size:12px;font-weight:600;}
        .date-apply{padding:8px 14px;height:36px;box-sizing:border-box;background:var(--navy);color:white;border:none;border-radius:10px;cursor:pointer;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;transition:all .2s;}
        .date-apply:hover{background:var(--navy-light);}
        /* ‚îÄ‚îÄ‚îÄ Daily Summary Cards ‚îÄ‚îÄ‚îÄ */
        .kpi-grid-6{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;margin-bottom:24px;}
        .c-smt::after{background:linear-gradient(90deg,#6366f1,#818cf8);}
        .c-test::after{background:linear-gradient(90deg,#0891b2,#38bdf8);}
        .c-smt .kpi-value{color:#6366f1;}
        .c-test .kpi-value{color:#0891b2;}
        .daily-summary-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}
        .team-card{background:white;border-radius:var(--r-lg);padding:20px 24px;border:1px solid var(--border);box-shadow:var(--shadow-sm);}
        .team-card-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
        .team-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
        .team-stat{text-align:center;}
        .team-stat-value{font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1.1;}
        .team-stat-label{font-size:10px;color:var(--text-muted);font-weight:600;margin-top:2px;}
        /* ‚îÄ‚îÄ‚îÄ Searchable Dropdown ‚îÄ‚îÄ‚îÄ */
        .search-select-wrap{position:relative;}
        .search-select-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:7px;font-size:12px;font-family:'JetBrains Mono','Inter',sans-serif;background:white;transition:all .2s;color:var(--text);}
        .search-select-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1);}
        .search-dropdown{position:absolute;left:0;right:0;top:100%;margin-top:2px;background:white;border:1.5px solid #c7d2fe;border-radius:10px;box-shadow:var(--shadow-md);z-index:500;max-height:180px;overflow-y:auto;display:none;}
        .search-dropdown.open{display:block;}
        .search-option{padding:8px 12px;font-size:12px;cursor:pointer;font-family:'JetBrains Mono',monospace;color:var(--text);transition:all .15s;border-bottom:1px solid #f1f5f9;}
        .search-option:last-child{border-bottom:none;}
        .search-option:hover{background:#eef2ff;color:#4f46e5;}
        .opt-code{font-weight:700;color:#4f46e5;}
        .opt-name{color:var(--text-sub);margin-left:6px;font-size:11px;}
        /* ‚îÄ‚îÄ‚îÄ Daily table ‚îÄ‚îÄ‚îÄ */
        .daily-no-data{text-align:center;padding:48px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;font-size:14px;}
        .filter-btn.active-smt{background:#6366f1;color:white;border-color:#6366f1;}
        .filter-btn-sm{padding:4px 10px;font-size:11px;}
        .mini-btn-sep{display:inline-flex;align-items:center;font-size:9px;font-weight:700;letter-spacing:.5px;padding:0 4px;color:var(--text-muted);}
        .filter-btn.active-test{background:#0891b2;color:white;border-color:#0891b2;}


        /* ‚îÄ‚îÄ‚îÄ Login Modal ‚îÄ‚îÄ‚îÄ */
        #loginModal{display:flex;position:fixed;inset:0;z-index:99998;background:url('https://images.unsplash.com/photo-1518770660439-4636190af475?w=1600&q=80') center/cover no-repeat;align-items:center;justify-content:center;}
        #loginModal::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(45,124,229,0.92) 0%,rgba(59,139,245,0.88) 40%,rgba(91,160,247,0.85) 100%);}
        .login-box{background:white;border-radius:24px;padding:48px 52px;width:420px;text-align:center;box-shadow:0 40px 80px rgba(0,0,0,0.15);animation:modalUp .5s cubic-bezier(.34,1.56,.64,1);position:relative;z-index:1;}
        .login-logo{font-family:'Inter',sans-serif;font-weight:900;font-size:34px;color:#1E293B;letter-spacing:2px;margin-bottom:6px;text-transform:uppercase;}.login-logo span{color:#3B8BF5;}
        .login-sub{font-size:10px;color:var(--text-muted);letter-spacing:3px;text-transform:uppercase;margin-bottom:36px;font-family:'Inter',sans-serif;line-height:1.6;}
        .login-divider{width:40px;height:3px;background:linear-gradient(90deg,#3B8BF5,#6DB3FF);border-radius:2px;margin:0 auto 28px;}
        .login-title{font-size:16px;font-weight:700;color:#1E293B;margin-bottom:6px;font-family:'Noto Sans KR',sans-serif;}
        .login-title-en{font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:20px;font-family:'Inter',sans-serif;letter-spacing:0.5px;}
        .login-desc{font-size:13px;color:var(--text-sub);margin-bottom:24px;font-family:'Noto Sans KR',sans-serif;}
        .login-input{width:100%;padding:15px 18px;border:2px solid var(--border);border-radius:12px;font-size:18px;text-align:center;font-family:'JetBrains Mono',monospace;letter-spacing:6px;transition:all .2s;margin-bottom:14px;}
        .login-input:focus{outline:none;border-color:#3B8BF5;box-shadow:0 0 0 4px rgba(59,139,245,0.15);}
        .login-err{font-size:12px;color:#F87171;margin-bottom:14px;height:16px;font-family:'Noto Sans KR',sans-serif;transition:all .2s;}
        .login-btn{width:100%;padding:15px;background:linear-gradient(135deg,#3B8BF5,#5BA0F7);color:white;border:none;border-radius:12px;cursor:pointer;font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;transition:all .2s;letter-spacing:1px;}
        .login-btn:hover{box-shadow:0 8px 20px rgba(59,139,245,0.35);transform:translateY(-2px);}
        .login-att-btn{width:100%;padding:12px;background:rgba(255,255,255,0.15);color:white;border:1.5px solid rgba(255,255,255,0.35);border-radius:12px;cursor:pointer;font-size:13px;font-weight:600;font-family:'Noto Sans KR',sans-serif;transition:all .2s;letter-spacing:0.5px;backdrop-filter:blur(4px);}
        .login-att-btn:hover{background:rgba(255,255,255,0.25);box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:translateY(-1px);}
        .login-hint{font-size:11px;color:var(--text-muted);margin-top:16px;font-family:'Noto Sans KR',sans-serif;position:relative;z-index:1;}

        @media(max-width:768px){
            body{padding:14px;}
            .header-grid{grid-template-columns:1fr;}
            .g2,.g3{grid-template-columns:1fr;}
            .kpi-grid{grid-template-columns:repeat(2,1fr);}
        }

        /* ‚îÄ‚îÄ‚îÄ Password Modal ‚îÄ‚îÄ‚îÄ */
        #pwModal {
            display:none; position:fixed; inset:0; z-index:3000;
            background:rgba(12,30,62,0.75); backdrop-filter:blur(8px);
            align-items:center; justify-content:center;
        }
        #pwModal.open { display:flex; }
        .pw-box {
            background:white; border-radius:var(--r-lg);
            padding:36px 40px; width:360px;
            box-shadow:var(--shadow-lg); text-align:center;
            animation:modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        .pw-icon { font-size:40px; margin-bottom:16px; }
        .pw-title { font-size:18px; font-weight:800; color:var(--navy); margin-bottom:6px; font-family:'Noto Sans KR',sans-serif; }
        .pw-sub { font-size:13px; color:var(--text-sub); margin-bottom:22px; font-family:'Noto Sans KR',sans-serif; }
        .pw-input {
            width:100%; padding:13px 16px; border:2px solid var(--border);
            border-radius:10px; font-size:16px; text-align:center;
            font-family:'JetBrains Mono',monospace; letter-spacing:4px;
            transition:all .2s; margin-bottom:16px;
        }
        .pw-input:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
        .pw-err { font-size:12px; color:#e11d48; margin-bottom:12px; height:16px; font-family:'Noto Sans KR',sans-serif; }
        .pw-btns { display:flex; gap:10px; }
        .pw-ok { flex:1; padding:12px; background:linear-gradient(135deg,var(--navy),var(--navy-light)); color:white; border:none; border-radius:10px; cursor:pointer; font-size:14px; font-weight:700; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .pw-ok:hover { box-shadow:0 4px 14px rgba(12,30,62,0.3); transform:translateY(-1px); }
        .pw-cancel { padding:12px 20px; background:var(--surface2); color:var(--text-sub); border:1px solid var(--border); border-radius:10px; cursor:pointer; font-size:14px; font-weight:600; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .pw-cancel:hover { border-color:var(--text-sub); }

        /* ‚îÄ‚îÄ‚îÄ Backup Button ‚îÄ‚îÄ‚îÄ */
        .btn-backup { background:rgba(168,85,247,0.8); color:white; border:1px solid rgba(168,85,247,0.5); font-size:12px; padding:8px 14px; box-shadow:0 2px 8px rgba(168,85,247,0.25); }
        .btn-backup:hover { background:rgba(168,85,247,1); box-shadow:0 4px 12px rgba(168,85,247,0.35); }

        /* ‚îÄ‚îÄ‚îÄ Backup Modal ‚îÄ‚îÄ‚îÄ */
        #backupModal {
            display:none; position:fixed; inset:0; z-index:3000;
            background:rgba(12,30,62,0.75); backdrop-filter:blur(8px);
            align-items:center; justify-content:center;
        }
        #backupModal.open { display:flex; }
        .backup-box {
            background:white; border-radius:var(--r-lg); padding:36px;
            width:500px; max-height:80vh; overflow-y:auto;
            box-shadow:var(--shadow-lg);
            animation:modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        .backup-item {
            display:flex; align-items:center; justify-content:space-between;
            padding:12px 16px; border:1px solid var(--border); border-radius:10px;
            margin-bottom:8px; transition:all .2s;
        }
        .backup-item:hover { border-color:#3B8BF5; background:#F8FAFF; }
        .backup-item-info { font-size:13px; }
        .backup-item-time { font-weight:700; color:var(--navy); font-family:'JetBrains Mono',monospace; }
        .backup-item-size { font-size:11px; color:var(--text-muted); margin-top:2px; }
        .backup-restore-btn { padding:7px 14px; background:#EBF3FF; color:#2563EB; border:1px solid #BFDBFE; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .backup-restore-btn:hover { background:#DBEAFE; }
        .backup-del-btn { padding:7px 10px; background:#fff1f2; color:#e11d48; border:1px solid #fecdd3; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700; margin-left:6px; transition:all .2s; }
        .backup-del-btn:hover { background:#ffe4e6; }
    </style>
</head>
<body>


<!-- ‚ïê‚ïê‚ïê LOGIN MODAL ‚ïê‚ïê‚ïê -->
<div id="loginModal">
    <div class="login-box">
        <div class="login-logo">DREAM<span>TECH</span></div>
        <div class="login-sub">DS Division ¬∑ Quality Dashboard</div>
        <div class="login-divider"></div>
        <div class="login-title">üîê Î°úÍ∑∏Ïù∏ Login</div>
        <div class="login-title-en">Enter your access password</div>
        <div class="login-desc">Ï†ëÏÜç ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</div>
        <input type="password" class="login-input" id="loginInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20" onkeydown="if(event.key==='Enter')doLogin()">
        <div class="login-err" id="loginErr"></div>
        <button class="login-btn" onclick="doLogin()">Ï†ëÏÜç Connect</button>
        <div class="login-divider" style="margin:16px 0 12px;"></div>
        <button class="login-att-btn" onclick="goAttendance()">üë• Ï∂úÌá¥Í∑º Í¥ÄÎ¶¨ (ÎπÑÎ∞ÄÎ≤àÌò∏ Î∂àÌïÑÏöî)</button>
        <div class="login-hint">üîë Ï†ëÏÜç Access: <code>LOGIN_PASSWORD</code> &nbsp;|&nbsp; Îç∞Ïù¥ÌÑ∞ÏûÖÎ†• Data: <code>DATA_PASSWORD</code></div>
    </div>
</div>

<!-- Loading -->
<div id="loadingOverlay" style="display:none;">
    <div class="loading-logo">DREAM<span>TECH</span></div>
    <div class="loading-bar"><div class="loading-bar-inner"></div></div>
    <div class="loading-text">üî• FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
</div>

<div id="syncStatus" class="sync-online">
    <div class="sync-dot"></div>
    <span id="syncText">Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®</span>
</div>

<div id="saveSuccess" class="save-toast">‚úÖ Ï†ÄÏû• ÏôÑÎ£å! Î™®Îì† ÌåÄÏõêÏóêÍ≤å Ï¶âÏãú Î∞òÏòÅÎê©ÎãàÎã§.</div>
<div id="configBanner">
    <h3>‚ö†Ô∏è Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§</h3>
    <p>ÌååÏùºÏùò <code>FIREBASE_CONFIG</code> Í∞íÏùÑ Ïã§Ï†ú Firebase ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥Î°ú ÍµêÏ≤¥Ìï¥ Ï£ºÏÑ∏Ïöî.</p>
</div>

<!-- Header -->
<div class="header">
    <div class="header-grid">
        <div>
            <div class="header-brand">
                <div class="brand-badge">üìä</div>
                <div>
                    <h1 id="mainTitle">DS Quality Performance</h1>
                    <div class="header-sub" id="lastUpdate">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
                </div>
            </div>
        </div>
        <div class="logo-area">
            <div class="logo-text">DREAM<span>TECH</span></div>
            <div class="logo-sub">Solutions come from Dreamtech</div>
            <div class="logo-designer">Designed by YU.KIM</div>
        </div>
    </div>
    <div class="controls-row">
        <div class="lang-switch">
            <button class="lang-btn active" onclick="setLang('ko')" id="btnKo">ÌïúÍ∏Ä</button>
            <button class="lang-btn" onclick="setLang('en')" id="btnEn">English</button>
        </div>
        <div class="view-switch">
            <button class="lang-btn active" onclick="setView('monthly')" id="btnViewMonthly">üìÖ ÏõîÎ≥Ñ</button>
            <button class="lang-btn" onclick="setView('daily')" id="btnViewDaily">üìÜ ÏùºÎ≥Ñ</button>
            <button class="lang-btn" onclick="setView('attendance')" id="btnViewAtt">üë• Ï∂úÌá¥Í∑º</button>
        </div>
        <span id="monthlyBtns" style="display:inline-flex;gap:8px;align-items:center;">
            <button class="btn btn-prod" onclick="openModal('prod')" id="btnProd">‚úèÔ∏è ÏÉùÏÇ∞ ÏûÖÎ†•</button>
            <button class="btn btn-ship" onclick="openModal('ship')" id="btnShip">üì¶ Ï∂úÌïò ÏûÖÎ†•</button>
            <button class="btn btn-def"  onclick="openModal('defect')" id="btnDefect">üõ†Ô∏è Î∂àÎüâ Ïú†Ìòï ÏûÖÎ†•</button>
        </span>
        <span id="dailyBtns" style="display:none;gap:8px;align-items:center;">
            <button class="btn btn-daily-prod" onclick="openDailyProdModal()" id="btnDailyProd">üìÖ ÏùºÎ≥Ñ ÏÉùÏÇ∞ ÏûÖÎ†•</button>
            <button class="btn btn-daily-def"  onclick="openDailyDefModal()" id="btnDailyDef">üî¥ Î∂àÎüâ ÏΩîÎìú ÏûÖÎ†•</button>
        </span>
        <span id="attBtns" style="display:none;gap:8px;align-items:center;">
            <button class="btn btn-daily-att"  onclick="openAttendanceModal()" id="btnAttendance">üë• Ï∂úÍ∑º Ïù∏Ïõê Îì±Î°ù</button>
            <button class="btn btn-daily-member" onclick="openMemberModal()" id="btnMemberMgmt">üë§ ÌåÄÏõê Í¥ÄÎ¶¨</button>
        </span>
        <button class="btn btn-excel" onclick="exportExcel()">üìä Excel</button>
        <button class="btn btn-backup" onclick="openBackupModal()" id="btnBackup">üíæ Î∞±ÏóÖ</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê MONTHLY VIEW ‚ïê‚ïê‚ïê -->
<div id="viewMonthly">
<!-- Filters -->
<div class="filter-section">
    <div class="filter-row">
        <div class="filter-label" id="lblProd">Ï†úÌíà</div>
        <div class="filter-btns" id="filterProduct"></div>
    </div>
    <div class="filter-row">
        <div class="filter-label" id="lblPeriod">Í∏∞Í∞Ñ</div>
        <div class="filter-btns" id="filterMonth"></div>
    </div>
    <div class="filter-row">
        <div class="filter-label" id="lblProcess">Í≥µÏ†ï</div>
        <div class="filter-btns" id="filterProcess"></div>
    </div>
</div>

<!-- KPI -->
<div class="kpi-grid">
    <div class="kpi-card c-blue">
        <div class="kpi-icon">üìà</div>
        <div class="kpi-value" id="kpiYield">‚Äî</div>
        <div class="kpi-label" id="lblKpiYield">Ï¢ÖÌï© ÏàòÏú®</div>
    </div>
    <div class="kpi-card c-slate">
        <div class="kpi-icon">üì•</div>
        <div class="kpi-value" id="kpiInput">‚Äî</div>
        <div class="kpi-label" id="lblKpiInput">Ï¥ù Ìà¨ÏûÖ ÏàòÎüâ</div>
    </div>
    <div class="kpi-card c-slate">
        <div class="kpi-icon">üì§</div>
        <div class="kpi-value" id="kpiOutput">‚Äî</div>
        <div class="kpi-label" id="lblKpiOutput">Ï¥ù ÏÇ∞Ï∂ú ÏàòÎüâ</div>
    </div>
    <div class="kpi-card c-red">
        <div class="kpi-icon">‚ùå</div>
        <div class="kpi-value" id="kpiDefect">‚Äî</div>
        <div class="kpi-sub-value" id="kpiDefectPPM">‚Äî PPM</div>
        <div class="kpi-label" id="lblKpiDefect">Ï¥ù Î∂àÎüâ ÏàòÎüâ</div>
    </div>
    <div class="kpi-card c-orange">
        <div class="kpi-icon">üè≠</div>
        <div class="kpi-value" id="kpiCompDefect">‚Äî</div>
        <div class="kpi-sub-value" id="kpiPPM">‚Äî PPM</div>
        <div class="kpi-label" id="lblKpiCompDefect">ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâ Ïàò</div>
    </div>
</div>

<!-- Tables row -->
<div class="g3">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProcYield">Í≥µÏ†ïÎ≥Ñ ÏàòÏú® ÌòÑÌô©</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblProcYield">
                    <thead><tr><th id="thProc">Í≥µÏ†ï</th><th id="thIn">Ìà¨ÏûÖ</th><th id="thOut">ÏÇ∞Ï∂ú</th><th id="thFail">Î∂àÎüâ</th><th id="thYld">ÏàòÏú®</th><th id="thStat">ÌåêÏ†ï</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titMonthYield">Í≥µÏ†ïÎ≥Ñ ÏõîÎ≥Ñ ÏàòÏú® Ï∂îÏù¥</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblMonthYield">
                    <thead><tr><th id="thMonth">Í∏∞Í∞Ñ</th><th>SMD</th><th>ROUTER</th><th>ATE</th><th>PCT</th><th>AVI</th><th>TC</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdYield">Ï†úÌíàÎ≥Ñ ÏàòÏú® ÌòÑÌô©</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblProdYield">
                    <thead><tr><th id="thProd">Ï†úÌíà</th><th id="thIn2">Ìà¨ÏûÖ</th><th id="thOut2">ÏÇ∞Ï∂ú</th><th id="thFail2">Î∂àÎüâ</th><th id="thYld2">ÏàòÏú®</th><th id="thStat2">ÌåêÏ†ï</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Total Yield Trend -->
<div class="g-full">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titTotalTrend">Ï¢ÖÌï© ÏàòÏú® ÏõîÎ≥Ñ Ìä∏Î†åÎìú (%)</span></div></div>
        <div class="card-body"><div class="ch-sm"><canvas id="chartTotalYield"></canvas></div></div>
    </div>
</div>

<!-- PPM Monthly Trend -->
<div class="g-full">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titPpmTrend">Ï¢ÖÌï© PPM ÏõîÎ≥Ñ Ìä∏Î†åÎìú</span></div></div>
        <div class="card-body"><div class="ch-sm"><canvas id="chartPpmTrend"></canvas></div></div>
    </div>
</div>

<!-- 3 charts -->
<div class="g3">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdTrend">Ï†úÌíàÎ≥Ñ ÏàòÏú® Ï∂îÏù¥ (%)</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="prodChartFilter"></div>
            <div class="ch-md"><canvas id="chartProdYield"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProcTrend">Í≥µÏ†ïÎ≥Ñ ÏàòÏú® Ï∂îÏù¥ (%)</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="procChartFilter"></div>
            <div class="ch-md"><canvas id="chartProcYield"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdVol">DS ÏÉùÏÇ∞ Ïã§Ï†Å</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="prodVolFilter"></div>
            <div class="ch-md"><canvas id="chartProdVol"></canvas></div>
        </div>
    </div>
</div>

<!-- Defect Section -->
<div class="section-hd">
    <div class="section-hd-title" id="titDefectSection">üìâ Î∂àÎüâ Î∂ÑÏÑù Î∞è ÏÉÅÏÑ∏ ÌòÑÌô©</div>
    <div class="section-hd-line"></div>
</div>

<div class="g2">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titTotalDefect">ÏõîÎ≥Ñ Î∂àÎüâ Ïàò Ìä∏Î†åÎìú</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartTotalDefect"></canvas></div></div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titCompDefect">ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâ Ïàò Ìä∏Î†åÎìú</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartCompDefect"></canvas></div></div>
    </div>
</div>

<div class="g3">
    <div class="card">
        <div class="card-head">
            <div class="card-title"><div class="card-title-dot"></div><span id="titDefectType">Î∂àÎüâ Ïú†Ìòï Ï∞®Ìä∏</span></div>
            <button class="btn-del" onclick="openModal('defect')">ÏàòÏ†ï</button>
        </div>
        <div class="card-body">
            <div class="mini-filters" id="defectTypeFilters"></div>
            <div class="ch-lg"><canvas id="chartDefectType"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span>Î∂àÎüâ Ïú†Ìòï ÎπÑÏú® (Pie)</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartDefectTypePie"></canvas></div></div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titDefectTable">Î∂àÎüâ Ïú†Ìòï ÏÉÅÏÑ∏ ÌòÑÌô©</span></div></div>
        <div class="card-body" style="padding-top:0;">
            <div class="tbl-wrap" style="max-height:320px;overflow-y:auto;">
                <table id="tblDefectType">
                    <thead><tr><th>Í∏∞Í∞Ñ</th><th>Human Error</th><th>Handling Damage</th><th>Component Lifting</th><th>Ìï©Í≥Ñ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Shipment Section -->
<div class="section-hd">
    <div class="section-hd-title" id="titShipSection">üì¶ Ï∂úÌïò Ïã§Ï†Å</div>
    <div class="section-hd-line"></div>
</div>
<div class="g2">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titShipTable">ÏõîÎ≥Ñ Ï∂úÌïò ÏàòÎüâ</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblShipment">
                    <thead><tr><th id="thShipMonth">Í∏∞Í∞Ñ</th><th>RDIMM</th><th>SODIMM</th><th>UDIMM</th><th id="thTotal">Ìï©Í≥Ñ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titShipChart">ÏõîÎ≥Ñ Ï∂úÌïò Ïã§Ï†Å Ï∂îÏù¥</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="shipChartFilter"></div>
            <div class="ch-md"><canvas id="chartShipment"></canvas></div>
        </div>
    </div>
</div>


</div><!-- /viewMonthly -->

<!-- ‚ïê‚ïê‚ïê DAILY VIEW ‚ïê‚ïê‚ïê -->
<div id="viewDaily" style="display:none;">
    <!-- Daily Filters -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-label" id="dlblDate">ÎÇ†Ïßú</div>
            <div class="date-range" style="flex-wrap:wrap;gap:6px;">
                <input type="date" class="date-input" id="dFilterFrom" onchange="applyDailyFilters()">
                <span class="date-sep">~</span>
                <input type="date" class="date-input" id="dFilterTo" onchange="applyDailyFilters()">
                <button class="date-apply" onclick="setDailyDatePreset('today')" id="btnToday">Ïò§Îäò</button>
                <button class="date-apply" onclick="setDailyDatePreset('yesterday')" id="btnYesterday" style="background:#0891b2;">Ïñ¥Ï†ú</button>
                <button class="date-apply" onclick="setDailyDatePreset('week')" id="btnThisWeek" style="background:#4f46e5;">Ïù¥Î≤àÏ£º</button>
                <button class="date-apply" onclick="setDailyDatePreset('month')" id="btnThisMonth" style="background:#059669;">Ïù¥Î≤àÎã¨</button>
                <button class="date-apply" onclick="setDailyDatePreset('all')" id="btnAllDate" style="background:#475569;">Ï†ÑÏ≤¥</button>
                <span class="date-sep" id="lblWeekNum" style="font-size:11px;white-space:nowrap;">Ï£ºÏ∞®:</span>
                <input type="number" id="weekNumInput" min="1" max="53" placeholder="Ïòà) 8" style="width:70px;padding:6px 10px;border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-family:'JetBrains Mono',monospace;" onkeydown="if(event.key==='Enter')setDailyDatePreset('weeknum')">
                <button class="date-apply" onclick="setDailyDatePreset('weeknum')" style="background:#6366f1;" id="btnWeekGo">Ïù¥Îèô</button>
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-label" id="dlblProd">Ï†úÌíà</div>
            <div class="filter-btns" id="dFilterProduct"></div>
        </div>
        <div class="filter-row">
            <div class="filter-label" id="dlblTeam">ÌåÄ</div>
            <div class="filter-btns" id="dFilterTeam"></div>
        </div>
        <div class="filter-row">
            <div class="filter-label" id="dlblProcess">Í≥µÏ†ï</div>
            <div class="filter-btns" id="dFilterProcess"></div>
        </div>
    </div>

    <!-- Daily KPIs -->
    <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit, minmax(190px, 1fr))">
        <div class="kpi-card c-blue"><div class="kpi-icon">üìà</div><div class="kpi-value" id="dKpiYield">‚Äî</div><div class="kpi-label" id="dLblYield">Ï¢ÖÌï© ÏàòÏú®</div></div>
        <div class="kpi-card c-slate"><div class="kpi-icon">üì•</div><div class="kpi-value" id="dKpiInput">‚Äî</div><div class="kpi-label" id="dLblInput">Ï¥ù Ìà¨ÏûÖ ÏàòÎüâ</div></div>
        <div class="kpi-card c-red"><div class="kpi-icon">‚ùå</div><div class="kpi-value" id="dKpiDefect">‚Äî</div><div class="kpi-sub-value" id="dKpiDefectPPM">‚Äî PPM</div><div class="kpi-label" id="dLblDefect">Ï¥ù Î∂àÎüâ ÏàòÎüâ</div></div>
        <div class="kpi-card c-orange"><div class="kpi-icon">üè≠</div><div class="kpi-value" id="dKpiCompDefect">‚Äî</div><div class="kpi-sub-value" id="dKpiPpm">‚Äî PPM</div><div class="kpi-label" id="dLblCompDefect">ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâ Ïàò</div></div>
    </div>

    <!-- SMT vs TEST Summary -->
    <div class="daily-summary-row">
        <div class="team-card">
            <div class="team-card-header">
                <span style="font-size:28px;">üîµ</span>
                <div><div style="font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;">SMT Team</div><div style="font-size:11px;color:var(--text-muted);">SMD + ROUTER</div></div>
                <span class="team-badge team-smt" style="margin-left:auto;">SMT</span>
            </div>
            <div class="team-stat-grid">
                <div class="team-stat"><div class="team-stat-value" id="smtYield" style="color:#6366f1;">‚Äî</div><div class="team-stat-label" id="smtLblYield">ÏàòÏú®</div></div>
                <div class="team-stat"><div class="team-stat-value" id="smtInput" style="color:#334155;">‚Äî</div><div class="team-stat-label" id="smtLblInput">Ìà¨ÏûÖ ÏàòÎüâ</div></div>
                <div class="team-stat"><div class="team-stat-value" id="smtDefect" style="color:#e11d48;">‚Äî</div><div class="team-stat-label" id="smtLblDefect">Î∂àÎüâ</div></div>
            </div>
            <div id="smtProcDetail" style="margin-top:10px;padding-top:10px;border-top:1px dashed #e0e8f5;"></div>
        </div>
        <div class="team-card">
            <div class="team-card-header">
                <span style="font-size:28px;">üî¨</span>
                <div><div style="font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;">TEST Team</div><div style="font-size:11px;color:var(--text-muted);">ATE + PCT + AVI + TC</div></div>
                <span class="team-badge team-test" style="margin-left:auto;">TEST</span>
            </div>
            <div class="team-stat-grid">
                <div class="team-stat"><div class="team-stat-value" id="testYield" style="color:#0891b2;">‚Äî</div><div class="team-stat-label" id="testLblYield">ÏàòÏú®</div></div>
                <div class="team-stat"><div class="team-stat-value" id="testInput" style="color:#334155;">‚Äî</div><div class="team-stat-label" id="testLblInput">Ìà¨ÏûÖ ÏàòÎüâ</div></div>
                <div class="team-stat"><div class="team-stat-value" id="testDefect" style="color:#e11d48;">‚Äî</div><div class="team-stat-label" id="testLblDefect">Î∂àÎüâ</div></div>
            </div>
            <div id="testProcDetail" style="margin-top:10px;padding-top:10px;border-top:1px dashed #e0e8f5;"></div>
        </div>
    </div>

    <!-- Daily Charts -->
    <div class="g2">
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitYieldTrend">ÏùºÎ≥Ñ ÏàòÏú® Ìä∏Î†åÎìú (%)</span></div></div><div class="card-body"><div class="mini-filters" id="dYieldFilter"></div><div class="ch-md"><canvas id="dChartYield"></canvas></div></div></div>
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitVolTrend">ÏùºÎ≥Ñ Ìà¨ÏûÖÎüâ Ìä∏Î†åÎìú</span></div></div><div class="card-body"><div class="mini-filters" id="dVolFilter"></div><div class="ch-md"><canvas id="dChartVol"></canvas></div></div></div>
    </div>
    <div class="g-full">
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitPpmTrend">ÏùºÎ≥Ñ ÎãπÏÇ¨ Í∑ÄÏ±Ö PPM Ìä∏Î†åÎìú</span></div></div><div class="card-body"><div class="mini-filters" id="dPpmFilter"></div><div class="ch-sm"><canvas id="dChartPpm"></canvas></div></div></div>
    </div>

    <!-- Defect Code Analysis -->
    <div class="section-hd"><div class="section-hd-title" id="dTitDefectSection">üìâ Î∂àÎüâ ÏΩîÎìú Î∂ÑÏÑù</div><div class="section-hd-line"></div></div>
    <div class="g3">
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitDefectBar">Î∂àÎüâ ÏΩîÎìú TOP 10</span></div></div><div class="card-body"><div class="mini-filters" id="dDefectTeamFilter"></div><div style="position:relative;height:340px;"><canvas id="dChartDefectBar"></canvas></div></div></div>
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitDefectPie">Î∂àÎüâ ÏΩîÎìú ÎπÑÏú®</span></div></div><div class="card-body"><div style="position:relative;height:420px;"><canvas id="dChartDefectPie"></canvas></div></div></div>
    </div>
    <div class="g-full" style="margin-top:0;">
        <div class="card">
            <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitDefectTable">Î∂àÎüâ ÏΩîÎìú ÏÉÅÏÑ∏</span></div></div>
            <div class="card-body" style="padding-top:0;"><div class="tbl-wrap" style="max-height:280px;overflow-y:auto;"><table id="dTblDefect"><thead><tr><th id="dTblDefThCode">ÏΩîÎìú</th><th id="dTblDefThName">Î∂àÎüâÎ™Ö</th><th id="dTblDefThTeam">ÌåÄ</th><th id="dTblDefThQty">ÏàòÎüâ</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </div>

    <!-- Daily Production Table -->
    <div class="section-hd"><div class="section-hd-title" id="dTitProdSection">üìã ÏùºÎ≥Ñ ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞</div><div class="section-hd-line"></div></div>
    <div class="g-full">
        <div class="card"><div class="card-body" style="padding-top:16px;">
            <!-- Table-level filters -->
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);">
                <span style="font-size:11px;font-weight:700;color:var(--text-muted);letter-spacing:.5px;">FILTER</span>
                <div class="filter-btns" id="dTblModelFilter"></div>
                <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
                <div class="filter-btns" id="dTblProcFilter"></div>
                <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
                <div class="filter-btns" id="dTblTeamFilter"></div>
                <div style="margin-left:auto;display:flex;align-items:center;gap:6px;">
                    <span style="font-size:11px;color:var(--text-muted);" id="dSortLabel">Ï†ïÎ†¨:</span>
                    <select id="dTblSort" style="padding:5px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-family:'Noto Sans KR',sans-serif;" onchange="updateDailyTables(getDailyFiltered(),getDailyDefFiltered())">
                        <option value="date-desc" id="dSortDateDesc">ÎÇ†Ïßú ‚Üì</option>
                        <option value="date-asc" id="dSortDateAsc">ÎÇ†Ïßú ‚Üë</option>
                        <option value="yield-asc" id="dSortYieldAsc">ÏàòÏú® ‚Üë</option>
                        <option value="yield-desc" id="dSortYieldDesc">ÏàòÏú® ‚Üì</option>
                        <option value="defect-desc" id="dSortDefectDesc">Î∂àÎüâ ‚Üì</option>
                    </select>
                </div>
            </div>
            <div class="tbl-wrap" style="max-height:400px;overflow-y:auto;">
                <table id="dTblProd">
                    <thead><tr><th id="dProdTblThDate">ÎÇ†Ïßú</th><th id="dProdTblThModel">Î™®Îç∏</th><th id="dProdTblThProc">Í≥µÏ†ï</th><th id="dProdTblThTeam">ÌåÄ</th><th id="dThInQty">Ìà¨ÏûÖÏàòÎüâ</th><th id="dThGoodQty">ÏñëÌíàÏàòÎüâ</th><th id="dThDefQty">Î∂àÎüâÏàòÎüâ</th><th id="dThRate">ÏàòÏú®</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="dTblProdCount" style="text-align:right;font-size:11px;color:var(--text-muted);margin-top:8px;font-family:'JetBrains Mono',monospace;"></div>
        </div></div>
    </div>
    <!-- ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ Ï∞®Ìä∏ (ÌÖåÏù¥Î∏î ÏïÑÎûò) -->
    <div class="g2" style="margin-top:0;">
        <div class="card">
            <div class="card-head">
                <div class="card-title"><div class="card-title-dot"></div><span id="dTitProdBarProc">Í≥µÏ†ïÎ≥Ñ Ìà¨ÏûÖÏàòÎüâ</span></div>
            </div>
            <div class="card-body"><div class="mini-filters" id="dProcVolFilter"></div><div style="position:relative;height:260px;"><canvas id="dChartProdByProc"></canvas></div></div>
        </div>
        <div class="card">
            <div class="card-head">
                <div class="card-title"><div class="card-title-dot"></div><span id="dTitProdBarModel">Î™®Îç∏Î≥Ñ Ìà¨ÏûÖÏàòÎüâ</span></div>
            </div>
            <div class="card-body"><div class="mini-filters" id="dModelVolFilter"></div><div style="position:relative;height:260px;"><canvas id="dChartProdByModel"></canvas></div></div>
        </div>
    </div>
    <!-- ÏàòÏú® vs Î∂àÎüâ Î≥µÌï© Ï∞®Ìä∏ -->
    <div class="g-full" style="margin-top:0;margin-bottom:24px;">
        <div class="card">
            <div class="card-head">
                <div class="card-title"><div class="card-title-dot"></div><span id="dTitProdYieldDefect">ÎÇ†ÏßúÎ≥Ñ ÏàòÏú® & Î∂àÎüâ Ï∂îÏù¥</span></div>
                <div class="mini-filters" id="dProdChartModelFilter"></div>
            </div>
            <div class="card-body"><div style="position:relative;height:260px;"><canvas id="dChartProdYieldDef"></canvas></div></div>
        </div>
    </div>

</div><!-- /viewDaily -->

<!-- ‚ïê‚ïê‚ïê ATTENDANCE VIEW ‚ïê‚ïê‚ïê -->
<div id="viewAttendance" style="display:none;">
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-label" id="attLblDate">ÎÇ†Ïßú</div>
            <input type="date" id="attFilterFrom" class="date-input" onchange="updateAttendanceUI();drawAttendanceCharts();">
            <span class="date-sep">~</span>
            <input type="date" id="attFilterTo" class="date-input" onchange="updateAttendanceUI();drawAttendanceCharts();">
            <button class="date-apply" onclick="setAttDatePreset('today')" id="attBtnToday">Ïò§Îäò</button>
            <button class="date-apply" onclick="setAttDatePreset('thisWeek')" id="attBtnThisWeek">Ïù¥Î≤à Ï£º</button>
            <button class="date-apply" onclick="setAttDatePreset('thisMonth')" id="attBtnThisMonth">Ïù¥Î≤à Îã¨</button>
        </div>
    </div>
    <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit, minmax(180px, 1fr))">
        <div class="kpi-card c-green"><div class="kpi-icon">‚úÖ</div><div class="kpi-value" id="attKpiRateVal">‚Äî</div><div class="kpi-label" id="attKpiRate">Ï∂úÍ∑ºÏú®</div></div>
        <div class="kpi-card c-blue"><div class="kpi-icon">üë•</div><div class="kpi-value" id="attKpiWorkVal">‚Äî</div><div class="kpi-label" id="attKpiWork">Ï∂úÍ∑º</div></div>
        <div class="kpi-card c-slate"><div class="kpi-icon">üèñÔ∏è</div><div class="kpi-value" id="attKpiVacationVal">‚Äî</div><div class="kpi-label" id="attKpiVacation">Ìú¥Í∞Ä</div></div>
        <div class="kpi-card c-red"><div class="kpi-icon">‚ö†Ô∏è</div><div class="kpi-value" id="attKpiAbsentVal">‚Äî</div><div class="kpi-label" id="attKpiAbsent">Í≤∞Í∑º¬∑Ï°∞Ìá¥</div></div>
    </div>
    <div class="att-team-grid" id="attTeamGrid"></div>
    <div class="g2">
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="attTitDonut">Ï∂úÍ∑º ÏÉÅÌÉú ÎπÑÏú®</span></div></div><div class="card-body"><div style="position:relative;height:300px;"><canvas id="attChartDonut"></canvas></div></div></div>
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="attTitBar">ÎÇ†ÏßúÎ≥Ñ Ï∂úÍ∑º ÌòÑÌô©</span></div></div><div class="card-body"><div style="position:relative;height:300px;"><canvas id="attChartBar"></canvas></div></div></div>
    </div>
</div><!-- /viewAttendance -->

<!-- Modals -->
<div id="modalProd" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitProd">‚úèÔ∏è ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•</div>
        <div class="modal-desc">ExcelÏóêÏÑú <strong>[Ï†úÌíà | Í∏∞Í∞Ñ | Í≥µÏ†ï | Ìà¨ÏûÖ | ÏÇ∞Ï∂ú | Î∂àÎüâ]</strong> ÏàúÏÑúÎ°ú Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£ÏùÑ Ïàò ÏûàÏäµÎãàÎã§.</div>
        <textarea class="paste-area" id="pasteProd" placeholder="Excel Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('prod')">üìã Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©</button>
            <button class="btn-clr" onclick="clearTable('prod')">üóëÔ∏è Ï¥àÍ∏∞Ìôî</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryProd">
                <thead><tr><th>Ï†úÌíà</th><th>Í∏∞Í∞Ñ</th><th>Í≥µÏ†ï</th><th>Ìà¨ÏûÖ</th><th>ÏÇ∞Ï∂ú</th><th>Î∂àÎüâ</th><th>ÏÇ≠Ï†ú</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('prod')">+ Ìñâ Ï∂îÍ∞Ä</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('prod')">üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('prod')">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<div id="modalShip" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitShip">üì¶ Ï∂úÌïò Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•</div>
        <div class="modal-desc">ExcelÏóêÏÑú <strong>[Î™®Îç∏ | Î™®Îç∏Î™Ö | ÎÇ†Ïßú | ÏàòÎüâ | ÏÇ¨Ïú†]</strong> ÏàúÏÑúÎ°ú Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£ÏùÑ Ïàò ÏûàÏäµÎãàÎã§.</div>
        <textarea class="paste-area" id="pasteShip" placeholder="Excel Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('ship')">üìã Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©</button>
            <button class="btn-clr" onclick="clearTable('ship')">üóëÔ∏è Ï¥àÍ∏∞Ìôî</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryShip">
                <thead><tr><th>Î™®Îç∏</th><th>Î™®Îç∏Î™Ö</th><th>ÎÇ†Ïßú</th><th>ÏàòÎüâ</th><th>ÏÇ¨Ïú†</th><th>Í∏∞Í∞Ñ(ÏûêÎèô)</th><th>ÏÇ≠Ï†ú</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('ship')">+ Ìñâ Ï∂îÍ∞Ä</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('ship')">üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('ship')">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<div id="modalDefect" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitDefect">üõ†Ô∏è Î∂àÎüâ Ïú†Ìòï Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•</div>
        <div class="modal-desc">ExcelÏóêÏÑú <strong>[Î∂àÎüâÎ™Ö | Í∏∞Í∞Ñ(YY.MM) | ÏàòÎüâ]</strong> ÏàúÏÑúÎ°ú Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£ÏùÑ Ïàò ÏûàÏäµÎãàÎã§.</div>
        <textarea class="paste-area" id="pasteDefect" placeholder="ÏòàÏãú: Human Error&#9;26.02&#9;5"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('defect')">üìã Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©</button>
            <button class="btn-clr" onclick="clearTable('defect')">üóëÔ∏è Ï¥àÍ∏∞Ìôî</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryDefect">
                <thead><tr><th>Î∂àÎüâÎ™Ö</th><th>Í∏∞Í∞Ñ (YY.MM)</th><th>ÏàòÎüâ</th><th>ÏÇ≠Ï†ú</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('defect')">+ Ìñâ Ï∂îÍ∞Ä</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('defect')">üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('defect')">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>


<!-- ‚ïê‚ïê‚ïê Daily Production Entry Modal ‚ïê‚ïê‚ïê -->
<div id="modalDailyProd" class="modal">
    <div class="modal-box">
        <div class="modal-title">üìÖ ÏùºÎ≥Ñ ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•</div>
        <div class="modal-desc" id="dprodModalDesc">ÎÇ†Ïßú¬∑Î™®Îç∏¬∑Í≥µÏ†ïÎ≥ÑÎ°ú <strong>Ìà¨ÏûÖÏàòÎüâ, ÏñëÌíàÏàòÎüâ, Î∂àÎüâÏàòÎüâ</strong>ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.<br><strong style="color:#4f46e5;">Î∂ôÏó¨ÎÑ£Í∏∞ ÏàúÏÑú: ÎÇ†Ïßú(YYYY-MM-DD) | Î™®Îç∏ | Í≥µÏ†ï | ÌåÄ | Ìà¨ÏûÖÏàòÎüâ | ÏñëÌíàÏàòÎüâ | Î∂àÎüâÏàòÎüâ</strong></div>
        <textarea class="paste-area" id="pasteDailyProd" placeholder="Excel Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;"><button class="btn-parse" onclick="parseDailyPaste()">üìã Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©</button><span id="pasteSkipHint" style="font-size:11px;color:#f59e0b;margin-left:8px;font-family:'Noto Sans KR',sans-serif;"></span><button class="btn-clr" onclick="document.querySelector('#tblDailyProdEntry tbody').innerHTML='';document.getElementById('pasteDailyProd').value=''">üóëÔ∏è Ï¥àÍ∏∞Ìôî</button></div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblDailyProdEntry">
                <thead><tr><th>ÎÇ†Ïßú</th><th>Î™®Îç∏</th><th>Í≥µÏ†ï</th><th>ÌåÄ</th><th id="dThInQtyM">Ìà¨ÏûÖÏàòÎüâ</th><th id="dThGoodQtyM">ÏñëÌíàÏàòÎüâ</th><th id="dThDefQtyM">Î∂àÎüâÏàòÎüâ</th><th>ÏÇ≠Ï†ú</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addDailyProdRow()">+ Ìñâ Ï∂îÍ∞Ä</button>
        <div style="padding:10px 20px 0;"><button onclick="clearAllDailyProdData()" style="width:100%;padding:10px;background:#fff0f0;border:1.5px solid #fca5a5;border-radius:10px;color:#e11d48;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;">üóëÔ∏è Firebase ÏùºÎ≥Ñ ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî (Ï£ºÏùò: Î≥µÍµ¨ Î∂àÍ∞Ä)</button></div>
        <div class="modal-footer"><button class="btn-save btn-full" onclick="saveDailyProd()">üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)</button><button class="btn-cancel btn-full" onclick="document.getElementById('modalDailyProd').style.display='none'">Ï∑®ÏÜå</button></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê Daily Defect Entry Modal ‚ïê‚ïê‚ïê -->
<div id="modalDailyDef" class="modal">
    <div class="modal-box" style="max-width:920px;">
        <div class="modal-title" id="ddefModalTitle">üî¥ ÏùºÎ≥Ñ Î∂àÎüâ ÏΩîÎìú ÏûÖÎ†•</div>
        <div class="modal-desc" id="ddefModalDesc">Í≥µÏ†ïÎ≥Ñ <strong>Î∂àÎüâ ÏàòÎüâ ÎÇ¥ÏóêÏÑúÎßå</strong> ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§. Í≥µÏ†ï ÏÑ†ÌÉù Ïãú Ìï¥Îãπ Î∂àÎüâ ÏàòÎüâÏù¥ ÏûêÎèôÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§.<br>
        <span style="color:#6366f1;font-weight:700;">üîµ SMT (SMD/ROUTER): 1000Î≤àÎåÄ</span> &nbsp;|&nbsp; <span style="color:#0891b2;font-weight:700;">üî¨ TEST (ATE/PCT/AVI/TC): 4000Î≤àÎåÄ</span></div>
        <div id="ddefAvailPanel" style="background:#f0f4fb;border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:12px;font-family:'Noto Sans KR',sans-serif;">
            <strong>üìã ÌòÑÏû¨ ÎÇ†Ïßú Î≤îÏúÑ ÎØ∏ÏûÖÎ†• Î∂àÎüâ:</strong> <span id="ddefAvailList" style="color:var(--text-sub);">ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Î∂àÎüâ ÏàòÎüâÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§</span>
        </div>
        <div style="max-height:420px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblDailyDefEntry">
                <thead><tr><th style="min-width:80px;">Î™®Îç∏</th><th style="min-width:130px;">ÎÇ†Ïßú</th><th style="min-width:80px;">Í≥µÏ†ï</th><th style="min-width:50px;">ÌåÄ</th><th style="min-width:220px;">Î∂àÎüâ ÏΩîÎìú Í≤ÄÏÉâ</th><th style="min-width:90px;">ÏàòÎüâ<br><span style="font-size:10px;color:#94a3b8;">(Í∞ÄÏö©/ÏûîÏó¨)</span></th><th>ÏÇ≠Ï†ú</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addDailyDefRow()">+ Ìñâ Ï∂îÍ∞Ä</button>
        <div class="modal-footer"><button class="btn-save btn-full" onclick="saveDailyDef()">üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)</button><button class="btn-cancel btn-full" onclick="document.getElementById('modalDailyDef').style.display='none'">Ï∑®ÏÜå</button></div>
    </div>
</div>
<!-- ‚ïê‚ïê‚ïê Attendance Entry Modal ‚ïê‚ïê‚ïê -->
<div id="modalAttendance" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="attModalTitle">üë• Ï∂úÍ∑º Ïù∏Ïõê Îì±Î°ù</div>
        <div class="modal-desc" id="attModalDesc">ÎÇ†ÏßúÏôÄ ÌåÄÏùÑ ÏÑ†ÌÉùÌïòÍ≥† Í∞Å ÌåÄÏõêÏùò Ï∂úÍ∑º ÏÉÅÌÉúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
            <input type="date" id="attDateInput" onchange="renderAttTeamTab(attTeamTab)" style="padding:8px 12px;border:1.5px solid var(--border);border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:13px;">
            <div id="attTeamTabs" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
            <button class="btn-parse" onclick="setAllAttStatus('Work')" id="attSetAllWork">‚úÖ Ï†ÑÏ≤¥ Ï∂úÍ∑º</button>
            <button class="btn-clr" onclick="setAllAttStatus('Vacation')" id="attSetAllVacation">üèñÔ∏è Ï†ÑÏ≤¥ Ìú¥Í∞Ä</button>
        </div>
        <div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblAttEntry">
                <thead><tr><th style="min-width:120px;">Ïù¥Î¶Ñ</th><th style="min-width:80px;">ÏßÅÍ∏â</th><th style="min-width:180px;">ÏÉÅÌÉú</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveAttendance()">üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)</button>
            <button class="btn-cancel btn-full" onclick="document.getElementById('modalAttendance').style.display='none'">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê Member Management Modal ‚ïê‚ïê‚ïê -->
<div id="modalMemberMgmt" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="memberModalTitle">üë§ ÌåÄÏõê Í¥ÄÎ¶¨</div>
        <div class="modal-desc">ÌåÄÏõêÏùÑ Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.</div>
        <div id="memberTeamTabs" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px;"></div>
        <div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblMemberEntry">
                <thead><tr><th style="min-width:140px;">Ïù¥Î¶Ñ</th><th style="min-width:100px;">ÏßÅÍ∏â</th><th>ÏÇ≠Ï†ú</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="display:flex;gap:8px;margin:12px 0;">
            <input type="text" id="newMemberName" placeholder="Ïù¥Î¶Ñ" style="flex:2;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Noto Sans KR',sans-serif;font-size:12px;">
            <input type="text" id="newMemberPos" placeholder="ÏßÅÍ∏â" style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Noto Sans KR',sans-serif;font-size:12px;">
            <button class="btn-parse" onclick="addNewMember()">+ Ï∂îÍ∞Ä</button>
        </div>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveMemberData()">üíæ Ï†ÄÏû•</button>
            <button class="btn-cancel btn-full" onclick="document.getElementById('modalMemberMgmt').style.display='none'">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div id="pwModal">
    <div class="pw-box">
        <div class="pw-icon">üîí</div>
        <div class="pw-title" id="pwTitle">Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†• ÎπÑÎ∞ÄÎ≤àÌò∏</div>
        <div class="pw-sub" id="pwSub">Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏ†ïÌïòÎ†§Î©¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</div>
        <input type="password" class="pw-input" id="pwInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20" onkeydown="if(event.key==='Enter')pwConfirm()">
        <div class="pw-err" id="pwErr"></div>
        <div class="pw-btns">
            <button class="pw-cancel" onclick="pwCancel()" id="pwCancelBtn">Ï∑®ÏÜå</button>
            <button class="pw-ok" onclick="pwConfirm()" id="pwOkBtn">ÌôïÏù∏</button>
        </div>
    </div>
</div>

<!-- Backup Modal -->
<div id="backupModal">
    <div class="backup-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div>
                <div style="font-size:20px;font-weight:800;color:var(--navy);font-family:'Noto Sans KR',sans-serif;" id="backupTitle">üíæ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ Í¥ÄÎ¶¨</div>
                <div style="font-size:12px;color:var(--text-sub);margin-top:4px;font-family:'Noto Sans KR',sans-serif;" id="backupSubTitle">ÏµúÎåÄ 10Í∞ú Î∞±ÏóÖ Ï†ÄÏû• ¬∑ ÏûòÎ™ª ÏûÖÎ†• Ïãú Î≥µÏõê Í∞ÄÎä•</div>
            </div>
            <button onclick="closeBackupModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);">‚úï</button>
        </div>
        <button onclick="createBackup()" style="width:100%;padding:13px;background:linear-gradient(135deg,var(--navy),var(--navy-light));color:white;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;margin-bottom:20px;transition:all .2s;" id="backupNowBtn" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">üì∏ ÏßÄÍ∏à Î∞±ÏóÖ ÏÉùÏÑ±</button>
        <div id="backupList"><div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">Î∞±ÏóÖÏù¥ ÏóÜÏäµÎãàÎã§</div></div>
    </div>
</div>



<script>
// ============================================================
// üî• FIREBASE ÏÑ§Ï†ï
// ============================================================
const FIREBASE_CONFIG = {
    apiKey:            "AIzaSyAQAqYYenEzp0ps71LRxF9ikcYywq8WwQo",
    authDomain:        "ds-quality-41ad2.firebaseapp.com",
    databaseURL:       "https://ds-quality-41ad2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:         "ds-quality-41ad2",
    storageBucket:     "ds-quality-41ad2.firebasestorage.app",
    messagingSenderId: "910427066275",
    appId:             "1:910427066275:web:3aa0c8009e17619ad3d416"
};
// ============================================================

const isConfigured = !Object.values(FIREBASE_CONFIG).some(v=>v.includes('YOUR_'));
let db=null, prodData=[], shipData=[], defectTypeData=[];
let filters={product:'Ï†ÑÏ≤¥',month:'Ï†ÑÏ≤¥',process:'Ï†ÑÏ≤¥',defectType:'Ï†ÑÏ≤¥'};
let procChartFilter='Ï†ÑÏ≤¥', prodChartFilter='Ï†ÑÏ≤¥', prodVolFilter='Ï†ÑÏ≤¥', shipChartFilter='Ï†ÑÏ≤¥';
let charts={}, lang='ko';
let dataLoaded={prod:false,ship:false,defect:false,dprod:false,ddef:false,att:false,members:false};
let attendanceData=[], teamMembers={};
const ATT_STATUS=['Work','Vacation','Unauthorized absence','Early retirement'];
const ATT_TEAMS=['DS TEST','DS SMD','DS Quality','DS Warehouse','DS Technical'];
let attCharts={}, attTeamTab='DS TEST', memberTeamTab='DS TEST';
function getDefaultTeamMembers(){return{
'DS TEST':[{name:'TEST-1',position:'Manager'},{name:'TEST-2',position:'Engineer'},{name:'TEST-3',position:'Engineer'},{name:'TEST-4',position:'Engineer'},{name:'TEST-5',position:'Worker'},{name:'TEST-6',position:'Worker'},{name:'TEST-7',position:'Worker'},{name:'TEST-8',position:'Worker'},{name:'TEST-9',position:'Worker'},{name:'TEST-10',position:'Worker'},{name:'TEST-11',position:'Worker'},{name:'TEST-12',position:'Worker'},{name:'TEST-13',position:'Worker'},{name:'TEST-14',position:'Worker'},{name:'TEST-15',position:'Worker'},{name:'TEST-16',position:'Worker'},{name:'TEST-17',position:'Worker'}],
'DS SMD':[{name:'SMD-1',position:'Manager'},{name:'SMD-2',position:'Engineer'},{name:'SMD-3',position:'Engineer'},{name:'SMD-4',position:'Worker'},{name:'SMD-5',position:'Worker'},{name:'SMD-6',position:'Worker'},{name:'SMD-7',position:'Worker'},{name:'SMD-8',position:'Worker'},{name:'SMD-9',position:'Worker'},{name:'SMD-10',position:'Worker'},{name:'SMD-11',position:'Worker'},{name:'SMD-12',position:'Worker'},{name:'SMD-13',position:'Worker'},{name:'SMD-14',position:'Worker'}],
'DS Quality':[{name:'QC-1',position:'Manager'},{name:'QC-2',position:'Engineer'},{name:'QC-3',position:'Engineer'},{name:'QC-4',position:'Engineer'},{name:'QC-5',position:'Worker'},{name:'QC-6',position:'Worker'},{name:'QC-7',position:'Worker'},{name:'QC-8',position:'Worker'},{name:'QC-9',position:'Worker'},{name:'QC-10',position:'Worker'},{name:'QC-11',position:'Worker'},{name:'QC-12',position:'Worker'},{name:'QC-13',position:'Worker'},{name:'QC-14',position:'Worker'}],
'DS Warehouse':[{name:'WH-1',position:'Manager'},{name:'WH-2',position:'Worker'},{name:'WH-3',position:'Worker'}],
'DS Technical':[{name:'TECH-1',position:'Manager'},{name:'TECH-2',position:'Engineer'},{name:'TECH-3',position:'Engineer'},{name:'TECH-4',position:'Worker'},{name:'TECH-5',position:'Worker'}]
};}

// ‚òÖ ÏµúÏö∞ÏÑ† Ïã§Ìñâ: Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ï¶âÏãú ÌëúÏãú (Îã§Î•∏ ÏΩîÎìú Ïò§Î•òÏôÄ Î¨¥Í¥Ä)
(function showLoginFirst(){
    try{
        var ov=document.getElementById('loadingOverlay');
        var lm=document.getElementById('loginModal');
        var li=document.getElementById('loginInput');
        if(ov) ov.style.display='none';
        if(lm) lm.style.display='flex';
        if(li) setTimeout(function(){try{li.focus();}catch(e){}},200);
    }catch(e){console.error('Login init error:',e);}
})();

// ‚îÄ‚îÄ‚îÄ PASSWORD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DATA_PASSWORD = "ds!data"; // ‚Üê Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†• ÎπÑÎ∞ÄÎ≤àÌò∏ (Ï†ëÏÜç ÎπÑÎ∞ÄÎ≤àÌò∏ÏôÄ Îã§Î•¥Í≤å ÏÑ§Ï†ï)
let pwCallback = null;

function requirePassword(cb){
    pwCallback = cb;
    document.getElementById('pwInput').value='';
    document.getElementById('pwErr').innerText='';
    document.getElementById('pwModal').classList.add('open');
    setTimeout(()=>document.getElementById('pwInput').focus(),100);
}
function pwConfirm(){
    const v=document.getElementById('pwInput').value;
    if(v===DATA_PASSWORD){ document.getElementById('pwModal').classList.remove('open'); if(pwCallback){pwCallback();pwCallback=null;} }
    else{ document.getElementById('pwErr').innerText=lang==='ko'?'‚ùå ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§':'‚ùå Incorrect password'; document.getElementById('pwInput').value=''; document.getElementById('pwInput').focus(); }
}
function pwCancel(){ document.getElementById('pwModal').classList.remove('open'); pwCallback=null; }

// ‚îÄ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createBackup(){
    const now=new Date(), p=x=>String(x).padStart(2,'0');
    const ts=`${now.getFullYear()}-${p(now.getMonth()+1)}-${p(now.getDate())} ${p(now.getHours())}:${p(now.getMinutes())}:${p(now.getSeconds())}`;
    const key=`backup_${now.getTime()}`;
    const snapshot={ts,prodData:[...prodData],shipData:[...shipData],defectTypeData:[...defectTypeData]};
    if(db){
        db.ref('backups/'+key).set(snapshot).then(()=>{
            cleanOldBackups(); loadBackupList();
            alert(lang==='ko'?'‚úÖ Î∞±ÏóÖÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!':'‚úÖ Backup created successfully!');
        }).catch(()=>alert(lang==='ko'?'‚ö†Ô∏è Î∞±ÏóÖ Ï†ÄÏû• Ïã§Ìå®':'‚ö†Ô∏è Backup failed'));
    } else {
        try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');bs[key]=snapshot;const keys=Object.keys(bs).sort();if(keys.length>10){delete bs[keys[0]];}localStorage.setItem('ds_backups',JSON.stringify(bs));loadBackupList();alert(lang==='ko'?'‚úÖ Î∞±ÏóÖÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§! (Î°úÏª¨ Ï†ÄÏû•)':'‚úÖ Backup created (local)!');}catch(e){alert('Î∞±ÏóÖ Ïò§Î•ò');}
    }
}
function cleanOldBackups(){
    if(!db)return;
    db.ref('backups').once('value',s=>{
        const bks=s.val(); if(!bks)return;
        const keys=Object.keys(bks).sort();
        if(keys.length>10){ const toDelete=keys.slice(0,keys.length-10); toDelete.forEach(k=>db.ref('backups/'+k).remove()); }
    });
}
function loadBackupList(){
    const list=document.getElementById('backupList'); if(!list)return;
    if(db){
        db.ref('backups').orderByKey().limitToLast(10).once('value',s=>{
            const bks=s.val();
            if(!bks){list.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">${lang==='ko'?'Î∞±ÏóÖÏù¥ ÏóÜÏäµÎãàÎã§':'No backups'}</div>`;return;}
            const keys=Object.keys(bks).sort().reverse();
            list.innerHTML=keys.map((k,i)=>`<div class="backup-item"><div class="backup-item-info"><div class="backup-item-time">${bks[k].ts}</div><div class="backup-item-size">${lang==='ko'?`ÏÉùÏÇ∞ ${bks[k].prodData?.length||0}Í±¥ ¬∑ Ï∂úÌïò ${bks[k].shipData?.length||0}Í±¥ ¬∑ Î∂àÎüâ ${bks[k].defectTypeData?.length||0}Í±¥`:`Prod ${bks[k].prodData?.length||0} ¬∑ Ship ${bks[k].shipData?.length||0} ¬∑ Defect ${bks[k].defectTypeData?.length||0}`}</div></div><div style="display:flex;align-items:center;gap:6px;"><button class="backup-restore-btn" onclick="restoreBackup('${k}')">${lang==='ko'?'Î≥µÏõê':'Restore'}</button><button class="backup-del-btn" onclick="deleteBackup('${k}')">‚úï</button></div></div>`).join('');
        });
    } else {
        try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');const keys=Object.keys(bs).sort().reverse();if(!keys.length){list.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">${lang==='ko'?'Î∞±ÏóÖÏù¥ ÏóÜÏäµÎãàÎã§':'No backups'}</div>`;return;}list.innerHTML=keys.map(k=>`<div class="backup-item"><div class="backup-item-info"><div class="backup-item-time">${bs[k].ts}</div><div class="backup-item-size">${lang==='ko'?`ÏÉùÏÇ∞ ${bs[k].prodData?.length||0}Í±¥ ¬∑ Ï∂úÌïò ${bs[k].shipData?.length||0}Í±¥ ¬∑ Î∂àÎüâ ${bs[k].defectTypeData?.length||0}Í±¥`:`Prod ${bs[k].prodData?.length||0} ¬∑ Ship ${bs[k].shipData?.length||0} ¬∑ Defect ${bs[k].defectTypeData?.length||0}`}</div></div><div style="display:flex;align-items:center;gap:6px;"><button class="backup-restore-btn" onclick="restoreBackup('${k}')">${lang==='ko'?'Î≥µÏõê':'Restore'}</button><button class="backup-del-btn" onclick="deleteBackup('${k}')">‚úï</button></div></div>`).join('');}catch(e){}
    }
}
function restoreBackup(key){
    if(!confirm(lang==='ko'?'‚ö†Ô∏è Ïù¥ Î∞±ÏóÖÏúºÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Îäî ÎçÆÏñ¥ÏîåÏõåÏßëÎãàÎã§.':'‚ö†Ô∏è Restore from this backup?\nCurrent data will be overwritten.'))return;
    const doRestore=(snap)=>{
        if(!snap)return;
        prodData=snap.prodData||[]; shipData=snap.shipData||[]; defectTypeData=snap.defectTypeData||[];
        if(db){saveToFirebase('prod',prodData);saveToFirebase('ship',shipData);saveToFirebase('defect',defectTypeData);}
        updateSmartLists(); updateUI(); updateLastUpdate(); closeBackupModal();
        alert(lang==='ko'?'‚úÖ Î≥µÏõê ÏôÑÎ£å!':'‚úÖ Restore complete!');
    };
    if(db){db.ref('backups/'+key).once('value',s=>doRestore(s.val()));}
    else{try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');doRestore(bs[key]);}catch(e){}}
}
function deleteBackup(key){
    if(!confirm(lang==='ko'?'Ïù¥ Î∞±ÏóÖÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?':'Delete this backup?'))return;
    if(db){db.ref('backups/'+key).remove().then(()=>loadBackupList());}
    else{try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');delete bs[key];localStorage.setItem('ds_backups',JSON.stringify(bs));loadBackupList();}catch(e){}}
}
function openBackupModal(){ document.getElementById('backupModal').classList.add('open'); loadBackupList(); }
function closeBackupModal(){ document.getElementById('backupModal').classList.remove('open'); }

try{Chart.register(ChartDataLabels);}catch(e){console.warn("Chart init deferred:",e);}

function initFirebase(){
    if(!isConfigured){
        document.getElementById('configBanner').style.display='block';
        document.getElementById('loadingOverlay').style.display='none';
        setSyncStatus('offline','‚ö†Ô∏è Firebase ÎØ∏ÏÑ§Ï†ï');
        prodData=getDefaultProdData(); shipData=getDefaultShipData(); defectTypeData=getDefaultDefectData();
        dailyProdData=[]; dailyDefectData=[]; attendanceData=[]; teamMembers=getDefaultTeamMembers();
        Object.keys(dataLoaded).forEach(k=>dataLoaded[k]=true);
        initUI(); return;
    }
    try{
        firebase.initializeApp(FIREBASE_CONFIG); db=firebase.database();
        setupListeners();
        // 10Ï¥à ÌõÑÏóêÎèÑ Î°úÎî© ÎØ∏ÏôÑÎ£å Ïãú Í∞ïÏ†ú ÏßÑÌñâ
        setTimeout(()=>{
            if(!Object.values(dataLoaded).every(v=>v)){
                console.warn('Timeout: forcing load. Missing:',Object.entries(dataLoaded).filter(([k,v])=>!v).map(([k])=>k));
                // ÎØ∏Î°úÎìú Îç∞Ïù¥ÌÑ∞Ïóê Í∏∞Î≥∏Í∞í Ï†ÅÏö©
                if(!dataLoaded.att){ attendanceData=[]; dataLoaded.att=true; }
                if(!dataLoaded.members){ teamMembers=getDefaultTeamMembers(); dataLoaded.members=true; }
                if(!dataLoaded.prod){ prodData=getDefaultProdData(); dataLoaded.prod=true; }
                if(!dataLoaded.ship){ shipData=getDefaultShipData(); dataLoaded.ship=true; }
                if(!dataLoaded.defect){ defectTypeData=getDefaultDefectData(); dataLoaded.defect=true; }
                if(!dataLoaded.dprod){ dailyProdData=[]; dataLoaded.dprod=true; }
                if(!dataLoaded.ddef){ dailyDefectData=[]; dataLoaded.ddef=true; }
                document.getElementById('loadingOverlay').style.display='none';
                initUI();
            }
        },10000);
    }catch(e){ setSyncStatus('offline','Ïó∞Í≤∞ Ïò§Î•ò'); document.getElementById('loadingOverlay').style.display='none'; }
}

function setupListeners(){
    setSyncStatus('saving','Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...');
    db.ref('prodData').on('value',s=>{ prodData=s.val()?Object.values(s.val()):getDefaultProdData(); dataLoaded.prod=true; checkLoaded(); },e=>{ console.error('prodData error:',e); prodData=getDefaultProdData(); dataLoaded.prod=true; checkLoaded(); });
    db.ref('shipData').on('value',s=>{ shipData=s.val()?Object.values(s.val()):getDefaultShipData(); dataLoaded.ship=true; checkLoaded(); },e=>{ console.error('shipData error:',e); shipData=getDefaultShipData(); dataLoaded.ship=true; checkLoaded(); });
    db.ref('defectTypeData').on('value',s=>{ defectTypeData=s.val()?Object.values(s.val()):getDefaultDefectData(); dataLoaded.defect=true; checkLoaded(); },e=>{ console.error('defectTypeData error:',e); defectTypeData=getDefaultDefectData(); dataLoaded.defect=true; checkLoaded(); });
    db.ref('dailyProdData').on('value',s=>{
        const raw=s.val()?Object.values(s.val()):[];
        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú: inspQty > 0Ïù∏ ÌñâÎßå, defectQtyÎäî Ï†ÄÏû•Í∞í Í∑∏ÎåÄÎ°ú Ïã†Î¢∞
        // (Ï†ÄÏû• Ïãú defectQty = inspQty - goodQty Î°ú Ïù¥ÎØ∏ Ï†ïÌôïÌûà Í≥ÑÏÇ∞Îê®)
        dailyProdData=raw.filter(d=>d.inspQty>0).map(d=>{
            const inspQty = Number(d.inspQty)||0;
            const goodQty = Number(d.goodQty)||0;
            // defectQty: Ï†ÄÏû•Îêú Í∞íÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ inspQty-goodQty
            const defectQty = (d.defectQty !== undefined && d.defectQty !== null)
                ? Math.min(Number(d.defectQty), inspQty)  // inspQty Ï¥àÍ≥º Î∞©ÏßÄÎßå
                : Math.max(0, inspQty - goodQty);
            return {...d, inspQty, goodQty, defectQty};
        });
        dataLoaded.dprod=true; checkLoaded(); if(currentView==='daily') updateDailyUI();
    },e=>{ console.error('dailyProdData error:',e); dailyProdData=[]; dataLoaded.dprod=true; checkLoaded(); });
    db.ref('dailyDefectData').on('value',s=>{ dailyDefectData=s.val()?Object.values(s.val()):[]; dataLoaded.ddef=true; checkLoaded(); if(currentView==='daily') updateDailyUI(); },e=>{ console.error('dailyDefectData error:',e); dailyDefectData=[]; dataLoaded.ddef=true; checkLoaded(); });
    db.ref('teamMembers').on('value',s=>{ teamMembers=s.val()||getDefaultTeamMembers(); dataLoaded.members=true; checkLoaded(); if(currentView==='daily') updateDailyUI(); },e=>{ console.error('teamMembers listener error:',e); teamMembers=getDefaultTeamMembers(); dataLoaded.members=true; checkLoaded(); });
    db.ref('attendanceData').on('value',s=>{ attendanceData=s.val()?Object.values(s.val()):[]; dataLoaded.att=true; checkLoaded(); if(currentView==='daily') updateDailyUI(); },e=>{ console.error('attendanceData listener error:',e); attendanceData=[]; dataLoaded.att=true; checkLoaded(); });
    firebase.database().ref('.info/connected').on('value',s=>setSyncStatus(s.val()?'online':'offline',s.val()?'Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®':'Ïò§ÌîÑÎùºÏù∏'));
}

function checkLoaded(){
    console.log('dataLoaded:',JSON.stringify(dataLoaded));
    if(Object.values(dataLoaded).every(v=>v)){ document.getElementById('loadingOverlay').style.display='none'; initUI(); }
}
function initUI(){
    updateSmartLists(); renderFilterButtons(); updateUI(); updateLastUpdate();
    if(attOnlyMode){ setView('attendance'); }
}
function setSyncStatus(t,x){ const e=document.getElementById('syncStatus'); e.className='sync-'+t; document.getElementById('syncText').textContent=x; }

function saveToFirebase(type,data){
    if(!db) return Promise.resolve();
    setSyncStatus('saving','Ï†ÄÏû• Ï§ë...');
    const k={prod:'prodData',ship:'shipData',defect:'defectTypeData',dprod:'dailyProdData',ddef:'dailyDefectData',att:'attendanceData',members:'teamMembers'}[type]||'prodData';
    return db.ref(k).set(data).then(()=>{setSyncStatus('online','Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®');const t=document.getElementById('saveSuccess');t.style.display='block';setTimeout(()=>t.style.display='none',2500);}).catch(()=>setSyncStatus('offline','Ï†ÄÏû• Ïã§Ìå®'));
}

function getDefaultProdData(){return[{"prod":"RDIMM","month":"10Ïõî","proc":"SMD","in":3450,"out":3450,"fail":0},{"prod":"RDIMM","month":"10Ïõî","proc":"ROUTER","in":3450,"out":3450,"fail":0},{"prod":"RDIMM","month":"10Ïõî","proc":"ATE","in":3450,"out":3448,"fail":2},{"prod":"RDIMM","month":"10Ïõî","proc":"PCT","in":3448,"out":3418,"fail":30},{"prod":"RDIMM","month":"10Ïõî","proc":"AVI","in":3418,"out":3413,"fail":5},{"prod":"RDIMM","month":"11Ïõî","proc":"SMD","in":1410,"out":1410,"fail":0},{"prod":"RDIMM","month":"11Ïõî","proc":"ROUTER","in":1410,"out":1409,"fail":1},{"prod":"RDIMM","month":"11Ïõî","proc":"ATE","in":1409,"out":1407,"fail":2},{"prod":"RDIMM","month":"11Ïõî","proc":"PCT","in":1407,"out":1386,"fail":21},{"prod":"RDIMM","month":"11Ïõî","proc":"AVI","in":1386,"out":1384,"fail":2},{"prod":"RDIMM","month":"12Ïõî","proc":"SMD","in":7632,"out":7630,"fail":2},{"prod":"RDIMM","month":"12Ïõî","proc":"ROUTER","in":7630,"out":7628,"fail":2},{"prod":"RDIMM","month":"12Ïõî","proc":"ATE","in":7628,"out":7622,"fail":6},{"prod":"RDIMM","month":"12Ïõî","proc":"PCT","in":7622,"out":7581,"fail":41},{"prod":"RDIMM","month":"12Ïõî","proc":"AVI","in":7581,"out":7576,"fail":5},{"prod":"RDIMM","month":"1Ïõî","proc":"SMD","in":3204,"out":3204,"fail":0},{"prod":"RDIMM","month":"1Ïõî","proc":"ROUTER","in":3204,"out":3204,"fail":0},{"prod":"RDIMM","month":"1Ïõî","proc":"ATE","in":3204,"out":3201,"fail":3},{"prod":"RDIMM","month":"1Ïõî","proc":"PCT","in":3201,"out":3179,"fail":22},{"prod":"RDIMM","month":"1Ïõî","proc":"AVI","in":3179,"out":3179,"fail":0},{"prod":"SODIMM","month":"11Ïõî","proc":"SMD","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11Ïõî","proc":"ROUTER","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11Ïõî","proc":"ATE","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11Ïõî","proc":"PCT","in":2574,"out":2562,"fail":12},{"prod":"SODIMM","month":"11Ïõî","proc":"AVI","in":2562,"out":2559,"fail":3},{"prod":"SODIMM","month":"12Ïõî","proc":"SMD","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12Ïõî","proc":"ROUTER","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12Ïõî","proc":"ATE","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12Ïõî","proc":"PCT","in":1404,"out":1399,"fail":5},{"prod":"SODIMM","month":"12Ïõî","proc":"AVI","in":1399,"out":1398,"fail":1},{"prod":"UDIMM","month":"12Ïõî","proc":"SMD","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12Ïõî","proc":"ROUTER","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12Ïõî","proc":"ATE","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12Ïõî","proc":"PCT","in":4212,"out":4198,"fail":14},{"prod":"UDIMM","month":"12Ïõî","proc":"AVI","in":4198,"out":4198,"fail":0},{"prod":"UDIMM","month":"1Ïõî","proc":"SMD","in":2046,"out":2046,"fail":0},{"prod":"UDIMM","month":"1Ïõî","proc":"ROUTER","in":2046,"out":2046,"fail":0},{"prod":"UDIMM","month":"1Ïõî","proc":"ATE","in":2046,"out":2045,"fail":1},{"prod":"UDIMM","month":"1Ïõî","proc":"PCT","in":2045,"out":2042,"fail":3},{"prod":"UDIMM","month":"1Ïõî","proc":"AVI","in":2042,"out":2042,"fail":0}];}
function getDefaultShipData(){return[{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-10-28","qty":1026,"reason":"Mass Production","month":"25.10"},{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-11-06","qty":4304,"reason":"Mass Production","month":"25.11"},{"model":"UDIMM","name":"M323R2GA3EB0-CWMOL-IYB","date":"2025-11-25","qty":2000,"reason":"Mass Production","month":"25.11"},{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-12-16","qty":2344,"reason":"Mass Production","month":"25.12"},{"model":"SODIMM","name":"M425R2GA3EB0-CWMOL-IYB","date":"2025-12-16","qty":1935,"reason":"Mass Production","month":"25.12"}];}
function getDefaultDefectData(){return[{"reason":"Human Error","month":"25.10","qty":0},{"reason":"Human Error","month":"25.11","qty":3},{"reason":"Human Error","month":"25.12","qty":1},{"reason":"Human Error","month":"26.01","qty":0},{"reason":"Handling Damage","month":"25.10","qty":5},{"reason":"Handling Damage","month":"25.11","qty":3},{"reason":"Handling Damage","month":"25.12","qty":8},{"reason":"Handling Damage","month":"26.01","qty":0},{"reason":"Component Lifting","month":"25.10","qty":0},{"reason":"Component Lifting","month":"25.11","qty":0},{"reason":"Component Lifting","month":"25.12","qty":1},{"reason":"Component Lifting","month":"26.01","qty":0}];}

const T={ko:{mainTitle:'üìä DS Quality Performance',lblProd:'Ï†úÌíà',lblPeriod:'Í∏∞Í∞Ñ',lblProcess:'Í≥µÏ†ï',btnProd:'‚úèÔ∏è ÏÉùÏÇ∞ ÏûÖÎ†•',btnShip:'üì¶ Ï∂úÌïò ÏûÖÎ†•',btnDefect:'üõ†Ô∏è Î∂àÎüâ Ïú†Ìòï ÏûÖÎ†•',lblKpiYield:'Ï¢ÖÌï© ÏàòÏú®',lblKpiPPM:'ÎãπÏÇ¨ Í∑ÄÏ±Ö PPM',lblKpiInput:'Ï¥ù Ìà¨ÏûÖ ÏàòÎüâ',lblKpiOutput:'Ï¥ù ÏÇ∞Ï∂ú ÏàòÎüâ',lblKpiDefect:'Ï¥ù Î∂àÎüâ ÏàòÎüâ',lblKpiDefectPPM:'Ï¥ù Î∂àÎüâ PPM',lblKpiCompDefect:'ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâ Ïàò',titProcYield:'Í≥µÏ†ïÎ≥Ñ ÏàòÏú® ÌòÑÌô©',titMonthYield:'Í≥µÏ†ïÎ≥Ñ ÏõîÎ≥Ñ ÏàòÏú® Ï∂îÏù¥',titProdYield:'Ï†úÌíàÎ≥Ñ ÏàòÏú® ÌòÑÌô©',titTotalTrend:'Ï¢ÖÌï© ÏàòÏú® ÏõîÎ≥Ñ Ìä∏Î†åÎìú (%)',titPpmTrend:'Ï¢ÖÌï© PPM ÏõîÎ≥Ñ Ìä∏Î†åÎìú',titProdTrend:'Ï†úÌíàÎ≥Ñ ÏàòÏú® Ï∂îÏù¥ (%)',titProcTrend:'Í≥µÏ†ïÎ≥Ñ ÏàòÏú® Ï∂îÏù¥ (%)',titProdVol:'DS ÏÉùÏÇ∞ Ïã§Ï†Å',titTotalDefect:'ÏõîÎ≥Ñ Î∂àÎüâ Ïàò Ìä∏Î†åÎìú',titCompDefect:'ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâ Ïàò Ìä∏Î†åÎìú',titDefectType:'Î∂àÎüâ Ïú†Ìòï Ï∞®Ìä∏',titDefectTable:'Î∂àÎüâ Ïú†Ìòï ÏÉÅÏÑ∏ ÌòÑÌô©',titDefectSection:'üìâ Î∂àÎüâ Î∂ÑÏÑù Î∞è ÏÉÅÏÑ∏ ÌòÑÌô©',titShipSection:'üì¶ Ï∂úÌïò Ïã§Ï†Å',titShipTable:'ÏõîÎ≥Ñ Ï∂úÌïò ÏàòÎüâ',titShipChart:'ÏõîÎ≥Ñ Ï∂úÌïò Ïã§Ï†Å Ï∂îÏù¥',thProc:'Í≥µÏ†ï',thIn:'Ìà¨ÏûÖ',thOut:'ÏÇ∞Ï∂ú',thFail:'Î∂àÎüâ',thYld:'ÏàòÏú®',thStat:'ÌåêÏ†ï',thMonth:'Í∏∞Í∞Ñ',thProd:'Ï†úÌíà',thIn2:'Ìà¨ÏûÖ',thOut2:'ÏÇ∞Ï∂ú',thFail2:'Î∂àÎüâ',thYld2:'ÏàòÏú®',thStat2:'ÌåêÏ†ï',thShipMonth:'Í∏∞Í∞Ñ',thTotal:'Ìï©Í≥Ñ',moTitProd:'‚úèÔ∏è ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•',moTitShip:'üì¶ Ï∂úÌïò Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•',moTitDefect:'üõ†Ô∏è Î∂àÎüâ Ïú†Ìòï Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•',all:'Ï†ÑÏ≤¥',good:'ÏñëÌò∏',warn:'Í≤ΩÍ≥†',
    btnViewMonthly:'üìÖ ÏõîÎ≥Ñ',btnViewDaily:'üìÜ ÏùºÎ≥Ñ',btnViewAtt:'üë• Ï∂úÌá¥Í∑º',btnDailyProd:'üìÖ ÏùºÎ≥Ñ ÏÉùÏÇ∞ ÏûÖÎ†•',btnDailyDef:'üî¥ Î∂àÎüâ ÏΩîÎìú ÏûÖÎ†•',
    dlblDate:'ÎÇ†Ïßú',dlblProd:'Ï†úÌíà',dlblTeam:'ÌåÄ',dlblProcess:'Í≥µÏ†ï',
    dLblYield:'Ï¢ÖÌï© ÏàòÏú®',dLblInput:'Ï¥ù Ìà¨ÏûÖ ÏàòÎüâ',dLblDefect:'Ï¥ù Î∂àÎüâ ÏàòÎüâ',dLblDefectPPM:'Ï¥ù Î∂àÎüâ PPM',dLblCompDefect:'ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâ Ïàò',dLblPpm:'ÎãπÏÇ¨ Í∑ÄÏ±Ö PPM',
    dTitYieldTrend:'ÏùºÎ≥Ñ ÏàòÏú® Ìä∏Î†åÎìú (%)',dTitPpmTrend:'ÏùºÎ≥Ñ ÎãπÏÇ¨ Í∑ÄÏ±Ö PPM Ìä∏Î†åÎìú',dTitVolTrend:'ÏùºÎ≥Ñ Ìà¨ÏûÖÎüâ Ìä∏Î†åÎìú',
    dTitDefectSection:'üìâ Î∂àÎüâ ÏΩîÎìú Î∂ÑÏÑù',dTitDefectBar:'Î∂àÎüâ ÏΩîÎìú TOP 10',dTitDefectPie:'Î∂àÎüâ ÏΩîÎìú ÎπÑÏú®',dTitDefectTable:'Î∂àÎüâ ÏΩîÎìú ÏÉÅÏÑ∏',
    dTitProdSection:'üìã ÏùºÎ≥Ñ ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞',dTitProcVolTrend:'Í≥µÏ†ïÎ≥Ñ ÏùºÎ≥Ñ ÏÉùÏÇ∞ÏàòÎüâ',dTitProdBarProc:'Í≥µÏ†ïÎ≥Ñ Ìà¨ÏûÖÏàòÎüâ',dTitProdBarModel:'Î™®Îç∏Î≥Ñ Ìà¨ÏûÖÏàòÎüâ',dTitProdYieldDefect:'ÎÇ†ÏßúÎ≥Ñ ÏàòÏú® & Î∂àÎüâ Ï∂îÏù¥',
    dTblDefThCode:'ÏΩîÎìú',dTblDefThName:'Î∂àÎüâÎ™Ö',dTblDefThTeam:'ÌåÄ',dTblDefThQty:'ÏàòÎüâ',
    dThRate:'ÏàòÏú®',
    dProdTblThDate:'ÎÇ†Ïßú',dProdTblThModel:'Î™®Îç∏',dProdTblThProc:'Í≥µÏ†ï',dProdTblThTeam:'ÌåÄ',dProdTblThYield:'ÏàòÏú®',
    dThDate:'ÎÇ†Ïßú',dThModel:'Î™®Îç∏',dThProc:'Í≥µÏ†ï',dThTeamCol:'ÌåÄ',dThInQty:'Ìà¨ÏûÖÏàòÎüâ',dThGoodQty:'ÏñëÌíàÏàòÎüâ',dThDefQty:'Î∂àÎüâÏàòÎüâ',dThYield:'ÏàòÏú®',dThInQtyM:'Ìà¨ÏûÖÏàòÎüâ',dThGoodQtyM:'ÏñëÌíàÏàòÎüâ',dThDefQtyM:'Î∂àÎüâÏàòÎüâ',
    btnToday:'Ïò§Îäò',btnYesterday:'Ïñ¥Ï†ú',btnThisWeek:'Ïù¥Î≤àÏ£º',btnThisMonth:'Ïù¥Î≤àÎã¨',btnAllDate:'Ï†ÑÏ≤¥',lblWeekNum:'Ï£ºÏ∞® Í≤ÄÏÉâ:',btnWeekGo:'Ïù¥Îèô',btnBackup:'üíæ Î∞±ÏóÖ',
    smtLblYield:'ÏàòÏú®',smtLblInput:'Ìà¨ÏûÖ ÏàòÎüâ',smtLblDefect:'Î∂àÎüâ',testLblYield:'ÏàòÏú®',testLblInput:'Ìà¨ÏûÖ ÏàòÎüâ',testLblDefect:'Î∂àÎüâ',
    dSortLabel:'Ï†ïÎ†¨:',dSortDateDesc:'ÎÇ†Ïßú ‚Üì',dSortDateAsc:'ÎÇ†Ïßú ‚Üë',dSortYieldAsc:'ÏàòÏú® ‚Üë',dSortYieldDesc:'ÏàòÏú® ‚Üì',dSortDefectDesc:'Î∂àÎüâ ‚Üì',
    modalDailyProdTitle:'üìÖ ÏùºÎ≥Ñ ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•',modalDailyProdDesc:'Î∂ôÏó¨ÎÑ£Í∏∞ ÏàúÏÑú: ÎÇ†Ïßú(YYYY-MM-DD) | Î™®Îç∏ | Í≥µÏ†ï | ÌåÄ | Ìà¨ÏûÖÏàòÎüâ | ÏñëÌíàÏàòÎüâ | Î∂àÎüâÏàòÎüâ',
    modalDailyDefTitle:'üî¥ ÏùºÎ≥Ñ Î∂àÎüâ ÏΩîÎìú ÏûÖÎ†•',modalDailyDefDesc:'Í≥µÏ†ïÎ≥Ñ Î∂àÎüâ ÏàòÎüâ ÎÇ¥ÏóêÏÑúÎßå ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§',
    btnAttendance:'üë• Ï∂úÍ∑º Ïù∏Ïõê Îì±Î°ù',btnMemberMgmt:'üë§ ÌåÄÏõê Í¥ÄÎ¶¨',
    attLblDate:'ÎÇ†Ïßú',attBtnToday:'Ïò§Îäò',attBtnThisWeek:'Ïù¥Î≤à Ï£º',attBtnThisMonth:'Ïù¥Î≤à Îã¨',
    attSection:'üìç Ï∂úÍ∑º ÌòÑÌô©',attKpiRate:'Ï∂úÍ∑ºÏú®',attKpiWork:'Ï∂úÍ∑º',attKpiVacation:'Ìú¥Í∞Ä',attKpiAbsent:'Í≤∞Í∑º¬∑Ï°∞Ìá¥',
    attTitDonut:'Ï∂úÍ∑º ÏÉÅÌÉú ÎπÑÏú®',attTitBar:'ÎÇ†ÏßúÎ≥Ñ Ï∂úÍ∑º ÌòÑÌô©',
    attModalTitle:'üë• Ï∂úÍ∑º Ïù∏Ïõê Îì±Î°ù',attModalDesc:'ÎÇ†ÏßúÏôÄ ÌåÄÏùÑ ÏÑ†ÌÉùÌïòÍ≥† Í∞Å ÌåÄÏõêÏùò Ï∂úÍ∑º ÏÉÅÌÉúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.',
    attSetAllWork:'‚úÖ Ï†ÑÏ≤¥ Ï∂úÍ∑º',attSetAllVacation:'üèñÔ∏è Ï†ÑÏ≤¥ Ìú¥Í∞Ä',memberModalTitle:'üë§ ÌåÄÏõê Í¥ÄÎ¶¨'},en:{mainTitle:'üìä DS Quality Performance',lblProd:'Product',lblPeriod:'Period',lblProcess:'Process',btnProd:'‚úèÔ∏è Production',btnShip:'üì¶ Shipment',btnDefect:'üõ†Ô∏è Defect Types',lblKpiYield:'Overall Yield',lblKpiPPM:'Company Defect PPM',lblKpiInput:'Total Input',lblKpiOutput:'Total Output',lblKpiDefect:'Total Defects',lblKpiDefectPPM:'Total Defect PPM',lblKpiCompDefect:'Company Defect Qty',titProcYield:'Process Yield',titMonthYield:'Monthly Process Yield',titProdYield:'Product Yield',titTotalTrend:'Overall Yield Trend (%)',titPpmTrend:'Overall PPM Trend',titProdTrend:'Product Yield Trend (%)',titProcTrend:'Process Yield Trend (%)',titProdVol:'Production Volume',titTotalDefect:'Total Defect Trend',titCompDefect:'Company Defect Trend',titDefectType:'Defect Type Chart',titDefectTable:'Defect Type Details',titDefectSection:'üìâ Defect Analysis',titShipSection:'üì¶ Shipment Performance',titShipTable:'Monthly Shipment',titShipChart:'Shipment Trend',thProc:'Process',thIn:'Input',thOut:'Output',thFail:'Defect',thYld:'Yield',thStat:'Status',thMonth:'Period',thProd:'Product',thIn2:'Input',thOut2:'Output',thFail2:'Defect',thYld2:'Yield',thStat2:'Status',thShipMonth:'Period',thTotal:'Total',moTitProd:'‚úèÔ∏è Production Data Entry',moTitShip:'üì¶ Shipment Data Entry',moTitDefect:'üõ†Ô∏è Defect Type Data Entry',all:'All',good:'Good',warn:'Warning',
    btnViewMonthly:'üìÖ Monthly',btnViewDaily:'üìÜ Daily',btnViewAtt:'üë• Attendance',btnDailyProd:'üìÖ Daily Prod Entry',btnDailyDef:'üî¥ Defect Code Entry',
    dlblDate:'Date',dlblProd:'Product',dlblTeam:'Team',dlblProcess:'Process',
    dLblYield:'Overall Yield',dLblInput:'Total Input Qty',dLblDefect:'Total Defects',dLblDefectPPM:'Total Defect PPM',dLblCompDefect:'Company Defect Qty',dLblPpm:'Company Defect PPM',
    dTitYieldTrend:'Daily Yield Trend (%)',dTitPpmTrend:'Daily Overall PPM Trend',dTitVolTrend:'Daily Input Volume Trend',
    dTitDefectSection:'üìâ Defect Code Analysis',dTitDefectBar:'Top 10 Defect Codes',dTitDefectPie:'Defect Code Distribution',dTitDefectTable:'Defect Code Details',
    dTitProdSection:'üìã Daily Production Data',dTitProcVolTrend:'Daily Volume by Process',dTitProdBarProc:'Input Qty by Process',dTitProdBarModel:'Input Qty by Model',dTitProdYieldDefect:'Daily Yield & Defect Trend',
    dTblDefThCode:'Code',dTblDefThName:'Defect Name',dTblDefThTeam:'Team',dTblDefThQty:'Qty',
    dThRate:'Yield',
    dProdTblThDate:'Date',dProdTblThModel:'Model',dProdTblThProc:'Process',dProdTblThTeam:'Team',dProdTblThYield:'Yield',
    dThDate:'Date',dThModel:'Model',dThProc:'Process',dThTeamCol:'Team',dThInQty:'Input Qty',dThGoodQty:'Good Qty',dThDefQty:'Def. Qty',dThYield:'Yield',dThInQtyM:'Input Qty',dThGoodQtyM:'Good Qty',dThDefQtyM:'Def. Qty',
    btnToday:'Today',btnYesterday:'Yesterday',btnThisWeek:'This Week',btnThisMonth:'This Month',btnAllDate:'All',lblWeekNum:'Week#:',btnWeekGo:'Go',btnBackup:'üíæ Backup',
    smtLblYield:'Yield',smtLblInput:'Input Qty',smtLblDefect:'Defects',testLblYield:'Yield',testLblInput:'Input Qty',testLblDefect:'Defects',
    dSortLabel:'Sort:',dSortDateDesc:'Date ‚Üì',dSortDateAsc:'Date ‚Üë',dSortYieldAsc:'Yield ‚Üë',dSortYieldDesc:'Yield ‚Üì',dSortDefectDesc:'Defect ‚Üì',
    modalDailyProdTitle:'üìÖ Daily Production Entry',modalDailyProdDesc:'Paste order: Date(YYYY-MM-DD) | Model | Process | Team | InputQty | GoodQty | DefectQty',
    modalDailyDefTitle:'üî¥ Daily Defect Code Entry',modalDailyDefDesc:'Defect codes must be within the defect quantity already recorded for that date/model/process',
    btnAttendance:'üë• Attendance Entry',btnMemberMgmt:'üë§ Member Mgmt',
    attLblDate:'Date',attBtnToday:'Today',attBtnThisWeek:'This Week',attBtnThisMonth:'This Month',
    attSection:'üìç Attendance',attKpiRate:'Attendance Rate',attKpiWork:'Present',attKpiVacation:'Vacation',attKpiAbsent:'Absent/Early',
    attTitDonut:'Status Distribution',attTitBar:'Daily Attendance',
    attModalTitle:'üë• Attendance Entry',attModalDesc:'Select date and team, then set attendance status for each member.',
    attSetAllWork:'‚úÖ All Present',attSetAllVacation:'üèñÔ∏è All Vacation',memberModalTitle:'üë§ Member Management'}};

function getUV(a,k){return[...new Set(a.map(d=>d[k]))].filter(v=>v&&v.toString().trim()).sort();}
function updateSmartLists(){
    document.querySelectorAll('datalist').forEach(d=>d.remove());
    const months=[...new Set([...prodData.map(d=>d.month),...shipData.map(d=>d.month),...defectTypeData.map(d=>d.month)])];
    const dReasons=[...new Set([...getUV(defectTypeData,'reason'),'Human Error','Handling Damage','Component Lifting'])];
    const sReasons=[...new Set([...getUV(shipData,'reason'),'Mass Production','Sample','RMA'])];
    document.body.insertAdjacentHTML('beforeend',`<datalist id="list-products"><option value="RDIMM"><option value="SODIMM"><option value="UDIMM"></datalist><datalist id="list-months">${months.map(m=>`<option value="${m}">`).join('')}</datalist><datalist id="list-model-names">${getUV(shipData,'name').map(n=>`<option value="${n}">`).join('')}</datalist><datalist id="list-ship-reasons">${sReasons.map(r=>`<option value="${r}">`).join('')}</datalist><datalist id="list-defect-reasons">${dReasons.map(r=>`<option value="${r}">`).join('')}</datalist>`);
}
function updateLastUpdate(){
    const el=document.getElementById('lastUpdate'); if(!el)return;
    const n=new Date(), p=x=>String(x).padStart(2,'0');
    el.innerText=(lang==='ko'?'ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏: ':'Last Update: ')+`${n.getFullYear()}-${p(n.getMonth()+1)}-${p(n.getDate())} ${p(n.getHours())}:${p(n.getMinutes())}:${p(n.getSeconds())}`;
}
// initFirebaseÎäî Î°úÍ∑∏Ïù∏ ÌõÑ doLogin()ÏóêÏÑú Ìò∏Ï∂úÎê®
// window.onload=initFirebase; ‚Üê ÏûêÎèôÏã§Ìñâ Ï†úÍ±∞

function extractYM(s){
    if(!s)return''; const c=s.toString().trim();
    if(/^\d{2}\.\d{2}$/.test(c))return c;
    const km=c.match(/(\d{2,4})\s*ÎÖÑ\s*(\d{1,2})\s*Ïõî?/);
    if(km){let y=km[1];const m=km[2].padStart(2,'0');if(y.length===4)y=y.slice(2);return`${y}.${m}`;}
    const dm=c.match(/(\d{4})[-/](\d{1,2})/);
    if(dm)return`${dm[1].slice(2)}.${dm[2].padStart(2,'0')}`;
    return c;
}
function fmtPeriod(p){
    if(!/^\d{2}\.\d{2}$/.test(p))return p;
    const[y,m]=p.split('.'),mn=parseInt(m);
    if(lang==='en'){const ns=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${ns[mn]} ${y}`;}
    return`${y}ÎÖÑ ${mn}Ïõî`;
}
function smartMonthLabels(months){
    let prevY='';
    const enM=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return months.map(m=>{
        if(!/^\d{2}\.\d{2}$/.test(m))return fmtPeriod(m);
        const[y,mo]=m.split('.');const mn=parseInt(mo);
        if(y!==prevY){prevY=y;return lang==='en'?(enM[mn]+' \''+y):('\''+y+'ÎÖÑ '+mn+'Ïõî');}
        return lang==='en'?enM[mn]:(mn+'Ïõî');
    });
}
function smartDateLabels(dates){
    let prevY='';
    return dates.map(d=>{
        const[y,m,day]=d.split('-');const sy=y.slice(2),mn=parseInt(m),dn=parseInt(day);
        if(lang==='en'){
            const enM=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            if(sy!==prevY){prevY=sy;return enM[mn]+' '+dn+' \''+sy;}
            return enM[mn]+' '+dn;
        }
        if(sy!==prevY){prevY=sy;return"'"+sy+'ÎÖÑ '+mn+'Ïõî '+dn+'Ïùº';}
        return mn+'Ïõî '+dn+'Ïùº';
    });
}
function getPM(){return[...new Set(prodData.map(d=>d.month))].sort();}
function getSM(){return[...new Set(shipData.map(d=>d.month))].sort();}
function getDM(){return[...new Set(defectTypeData.map(d=>d.month))].sort();}
function getAM(){return[...new Set([...prodData.map(d=>d.month),...shipData.map(d=>d.month),...defectTypeData.map(d=>d.month)])].sort();}
function getFD(){return prodData.filter(d=>(filters.product==='Ï†ÑÏ≤¥'||d.prod===filters.product)&&(filters.month==='Ï†ÑÏ≤¥'||d.month===filters.month)&&(filters.process==='Ï†ÑÏ≤¥'||d.proc===filters.process));}
function cleanNum(v){return Number((v||'').toString().replace(/[,\s]/g,''))||0;}

function saveData(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const rows=document.querySelector(`#${tid} tbody`).querySelectorAll('tr');
    const nd=[];
    rows.forEach(tr=>{
        const i=tr.querySelectorAll('input,select');
        if(type==='prod'&&i[0].value)nd.push({prod:i[0].value,month:i[1].value.trim(),proc:i[2].value,in:cleanNum(i[3].value),out:cleanNum(i[4].value),fail:cleanNum(i[5].value)});
        else if(type==='ship'&&i[0].value.trim())nd.push({model:i[0].value.trim(),name:i[1].value.trim(),date:i[2].value.trim(),qty:cleanNum(i[3].value),reason:i[4].value.trim(),month:i[5].value.trim()});
        else if(type==='defect'&&i[0].value.trim())nd.push({reason:i[0].value.trim(),month:i[1].value.trim(),qty:cleanNum(i[2].value)});
    });
    if(!nd.length){alert('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');return;}
    if(type==='prod')prodData=nd; else if(type==='ship')shipData=nd; else defectTypeData=nd;
    saveToFirebase(type,nd).then(()=>{
        closeModal(type); updateSmartLists(); updateUI(); updateLastUpdate();
        const s=document.getElementById('saveSuccess'); s.style.display='block'; setTimeout(()=>s.style.display='none',3000);
    });
}

function setLang(l){
    lang=l;
    document.getElementById('btnKo').className=l==='ko'?'lang-btn active':'lang-btn';
    document.getElementById('btnEn').className=l==='en'?'lang-btn active':'lang-btn';
    for(let k in T[lang]){const e=document.getElementById(k);if(e)e.innerText=T[lang][k];}
    const wni=document.getElementById('weekNumInput');if(wni)wni.placeholder=lang==='ko'?'Ïòà) 8':'e.g. 8';
    updateUI(); updateLastUpdate(); updateModalLang();
    if(typeof currentView!=='undefined'&&currentView==='daily') updateDailyUI();
}
function filter(t,v){filters[t]=v; updateUI();}

function renderProdChartBtns(){
    const c=document.getElementById('prodChartFilter'); if(!c)return; c.innerHTML='';
    ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(prodChartFilter===p?' active':'');
        b.innerText=p==='Ï†ÑÏ≤¥'?T[lang].all:p; b.onclick=()=>setPCF(p); c.appendChild(b);
    });
}
function setPCF(v){
    prodChartFilter=v;
    if(charts.prodYield){
        const isSingle = v!=='Ï†ÑÏ≤¥';
        charts.prodYield.data.datasets.forEach((ds,i)=>charts.prodYield.setDatasetVisibility(i,!isSingle||ds.label===v));
        // Show labels only when single filter
        charts.prodYield.options.plugins.datalabels.display = isSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false;
        charts.prodYield.update();
    }
    renderProdChartBtns();
}
function renderProcChartBtns(){
    const c=document.getElementById('procChartFilter'); if(!c)return; c.innerHTML='';
    ['Ï†ÑÏ≤¥','SMD','ROUTER','ATE','PCT','AVI','TC'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(procChartFilter===p?' active':'');
        b.innerText=p==='Ï†ÑÏ≤¥'?T[lang].all:p; b.onclick=()=>setRCF(p); c.appendChild(b);
    });
}
function setRCF(v){
    procChartFilter=v;
    if(charts.procYield){
        const isSingle = v!=='Ï†ÑÏ≤¥';
        charts.procYield.data.datasets.forEach((ds,i)=>charts.procYield.setDatasetVisibility(i,!isSingle||ds.label===v));
        charts.procYield.options.plugins.datalabels.display = isSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false;
        charts.procYield.update();
    }
    renderProcChartBtns();
}
function renderProdVolBtns(){
    const c=document.getElementById('prodVolFilter'); if(!c)return; c.innerHTML='';
    ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(prodVolFilter===p?' active':'');
        b.innerText=p==='Ï†ÑÏ≤¥'?T[lang].all:p; b.onclick=()=>setPVF(p); c.appendChild(b);
    });
}
function setPVF(v){
    prodVolFilter=v;
    if(charts.prodVol){
        charts.prodVol.data.datasets.forEach((ds,i)=>charts.prodVol.setDatasetVisibility(i,v==='Ï†ÑÏ≤¥'||ds.label===v));
        charts.prodVol.update();
    }
    renderProdVolBtns();
}
function renderShipChartBtns(){
    const c=document.getElementById('shipChartFilter'); if(!c)return; c.innerHTML='';
    ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(shipChartFilter===p?' active':'');
        b.innerText=p==='Ï†ÑÏ≤¥'?T[lang].all:p; b.onclick=()=>setSCF(p); c.appendChild(b);
    });
}
function setSCF(v){
    shipChartFilter=v;
    if(charts.shipment){
        charts.shipment.data.datasets.forEach((ds,i)=>{
            if(ds.label==='Total')charts.shipment.setDatasetVisibility(i,v==='Ï†ÑÏ≤¥');
            else charts.shipment.setDatasetVisibility(i,v==='Ï†ÑÏ≤¥'||ds.label===v);
        });
        charts.shipment.update();
    }
    renderShipChartBtns();
}
function renderDefectBtns(){
    const c=document.getElementById('defectTypeFilters'); if(!c)return; c.innerHTML='';
    const rs=[...new Set(defectTypeData.map(d=>d.reason))].sort();
    ['Ï†ÑÏ≤¥',...rs].forEach(r=>{
        const b=document.createElement('button'); b.className='mini-btn'+(filters.defectType===r?' active':'');
        b.innerText=r==='Ï†ÑÏ≤¥'?T[lang].all:r; b.onclick=()=>filter('defectType',r); c.appendChild(b);
    });
}

function updateDefectTable(){
    const tbl=document.getElementById('tblDefectType'); if(!tbl)return;
    const thead=tbl.querySelector('thead'), tbody=tbl.querySelector('tbody');
    const months=getDM(), ml=smartMonthLabels(months), reasons=[...new Set(defectTypeData.map(d=>d.reason))].sort();
    thead.innerHTML=`<tr><th>${lang==='ko'?'Íµ¨Î∂Ñ':'Type'}</th>${ml.map(l=>`<th>${l}</th>`).join('')}<th>${lang==='ko'?'Ìï©Í≥Ñ':'Total'}</th></tr>`;
    if(!months.length||!reasons.length){tbody.innerHTML=`<tr><td colspan="${months.length+2}" style="text-align:center;color:#94a3b8;padding:30px;">${lang==='ko'?'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå':'No data'}</td></tr>`;return;}
    const mt={};months.forEach(m=>mt[m]=defectTypeData.filter(d=>d.month===m).reduce((a,b)=>a+b.qty,0));
    tbody.innerHTML=''; let grand=0;
    reasons.forEach(r=>{
        let rt2=0,row=`<tr><td><strong>${r}</strong></td>`;
        months.forEach(m=>{
            const item=defectTypeData.find(d=>d.month===m&&d.reason===r), q=item?item.qty:0; rt2+=q;
            let cls='',dsp='';
            if(q===0){cls='d-zero';dsp='-';}else if(q<=2){cls='d-low';dsp=q.toLocaleString();}else if(q<=5){cls='d-med';dsp=q.toLocaleString();}else{cls='d-high';dsp=q.toLocaleString();}
            row+=`<td class="${cls}">${dsp}</td>`;
        });
        row+=`<td>${rt2.toLocaleString()}</td></tr>`;
        tbody.innerHTML+=row; grand+=rt2;
    });
    tbody.innerHTML+=`<tr class="grand-row"><td>${lang==='ko'?'Ï†ÑÏ≤¥ Ìï©Í≥Ñ':'Grand Total'}</td>${months.map(m=>`<td>${mt[m].toLocaleString()}</td>`).join('')}<td>${grand.toLocaleString()}</td></tr>`;
}

function renderFilterButtons(){
    const pc=document.getElementById('filterProduct'); pc.innerHTML='';
    ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(p=>{const b=document.createElement('button');b.className='filter-btn'+(filters.product===p?' active':'');b.innerText=p==='Ï†ÑÏ≤¥'?T[lang].all:p;b.onclick=()=>filter('product',p);pc.appendChild(b);});
    const mc=document.getElementById('filterMonth'); mc.innerHTML='';
    ['',...getAM()].forEach((m,i)=>{const b=document.createElement('button');const v=i===0?'Ï†ÑÏ≤¥':m;b.className='filter-btn'+(filters.month===v?' active':'');b.innerText=i===0?T[lang].all:fmtPeriod(m);b.onclick=()=>filter('month',v);mc.appendChild(b);});
    const proc=document.getElementById('filterProcess'); proc.innerHTML='';
    ['Ï†ÑÏ≤¥','SMD','ROUTER','ATE','PCT','AVI','TC'].forEach(p=>{const b=document.createElement('button');b.className='filter-btn'+(filters.process===p?' active':'');b.innerText=p==='Ï†ÑÏ≤¥'?T[lang].all:p;b.onclick=()=>filter('process',p);proc.appendChild(b);});
}

function updateUI(){
    renderFilterButtons(); renderProdChartBtns(); renderProcChartBtns(); renderDefectBtns(); renderProdVolBtns(); renderShipChartBtns();
    const data=getFD();
    let tI=0,tO=0,tF=0,cF=0;
    if(filters.process!=='Ï†ÑÏ≤¥'){tI=data.reduce((a,b)=>a+b.in,0);tO=data.reduce((a,b)=>a+b.out,0);}
    else{tI=data.filter(d=>d.proc==='SMD').reduce((a,b)=>a+b.in,0);tO=data.filter(d=>d.proc==='AVI').reduce((a,b)=>a+b.out,0);}
    tF=data.reduce((a,b)=>a+b.fail,0);
    cF=data.filter(d=>['SMD','ROUTER','AVI'].includes(d.proc)).reduce((a,b)=>a+b.fail,0);
    const yv=tI>0?tO/tI*100:0, ppm=tI>0?cF/tI*1000000:0;
    document.getElementById('kpiYield').innerText=yv.toFixed(2)+'%';
    document.getElementById('kpiPPM').innerText=Math.round(ppm).toLocaleString()+' PPM';
    document.getElementById('kpiInput').innerText=tI.toLocaleString();
    document.getElementById('kpiOutput').innerText=tO.toLocaleString();
    document.getElementById('kpiDefect').innerText=tF.toLocaleString();
    const totalDefPpm=tI>0?tF/tI*1000000:0;
    document.getElementById('kpiDefectPPM').innerText=Math.round(totalDefPpm).toLocaleString()+' PPM';
    document.getElementById('kpiCompDefect').innerText=cF.toLocaleString();
    updateTables(data); updateDefectTable(); drawCharts(data);
}

function updateTables(data){
    const t=T[lang];
    const pb=document.querySelector('#tblProcYield tbody'); pb.innerHTML='';
    ['SMD','ROUTER','ATE','PCT','AVI','TC'].forEach(p=>{
        const d=data.filter(r=>r.proc===p);
        const ti=d.reduce((a,b)=>a+b.in,0),to=d.reduce((a,b)=>a+b.out,0),tf=d.reduce((a,b)=>a+b.fail,0);
        const y=ti>0?to/ti*100:0, ok=y>=99.5;
        pb.innerHTML+=`<tr><td><strong>${p}</strong></td><td>${ti.toLocaleString()}</td><td>${to.toLocaleString()}</td><td>${tf.toLocaleString()}</td><td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td><td><span class="badge ${ok?'badge-ok':'badge-ng'}">${ok?t.good:t.warn}</span></td></tr>`;
    });
    const mb=document.querySelector('#tblMonthYield tbody'); mb.innerHTML='';
    getPM().forEach(m=>{
        const d=data.filter(r=>r.month===m); if(!d.length)return;
        let row=`<tr><td><strong>${fmtPeriod(m)}</strong></td>`;
        ['SMD','ROUTER','ATE','PCT','AVI','TC'].forEach(p=>{
            const pd=d.filter(r=>r.proc===p);
            const ti=pd.reduce((a,b)=>a+b.in,0),to=pd.reduce((a,b)=>a+b.out,0);
            row+=`<td class="${ti>0&&to/ti*100>=99.5?'yield-good':'yield-bad'}">${ti>0?(to/ti*100).toFixed(2)+'%':'-'}</td>`;
        });
        mb.innerHTML+=row+'</tr>';
    });
    const prb=document.querySelector('#tblProdYield tbody'); prb.innerHTML='';
    ['RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const d=data.filter(r=>r.prod===p);
        const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0),to=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0),tf=d.reduce((a,b)=>a+b.fail,0);
        const y=ti>0?to/ti*100:0, ok=y>=99.5;
        prb.innerHTML+=`<tr><td><strong>${p}</strong></td><td>${ti.toLocaleString()}</td><td>${to.toLocaleString()}</td><td>${tf.toLocaleString()}</td><td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td><td><span class="badge ${ok?'badge-ok':'badge-ng'}">${ok?t.good:t.warn}</span></td></tr>`;
    });
    const sb=document.querySelector('#tblShipment tbody'); sb.innerHTML='';
    getSM().forEach(m=>{
        const d=shipData.filter(r=>r.month===m); if(!d.length)return;
        const r=d.filter(x=>x.model.toUpperCase()==='RDIMM').reduce((a,b)=>a+b.qty,0);
        const s=d.filter(x=>x.model.toUpperCase()==='SODIMM').reduce((a,b)=>a+b.qty,0);
        const u=d.filter(x=>x.model.toUpperCase()==='UDIMM').reduce((a,b)=>a+b.qty,0);
        sb.innerHTML+=`<tr><td><strong>${fmtPeriod(m)}</strong></td><td>${r.toLocaleString()}</td><td>${s.toLocaleString()}</td><td>${u.toLocaleString()}</td><td style="font-weight:800;color:#4f46e5;font-family:'DM Mono',monospace">${(r+s+u).toLocaleString()}</td></tr>`;
    });
}

function drawCharts(data){
    const pm=getPM(), pl=smartMonthLabels(pm);
    const sm=getSM(), sl=smartMonthLabels(sm);
    const dm=getDM(), dl=smartMonthLabels(dm);
    const reasons=[...new Set(defectTypeData.map(d=>d.reason))];
    Object.values(charts).forEach(c=>c&&c.destroy()); charts={};

    const baseOpts={
        responsive:true, maintainAspectRatio:false,
        layout:{padding:{top:40}},
        plugins:{
            legend:{position:'bottom',labels:{boxWidth:10,boxHeight:10,padding:14,font:{size:12,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:10}},
            datalabels:{color:'#0c1e3e',backgroundColor:'rgba(255,255,255,0.92)',borderRadius:5,padding:{top:3,right:7,bottom:3,left:7},font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},anchor:'end',align:'end',offset:8,clip:false,display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,formatter:v=>v?v.toLocaleString():''}
        },
        scales:{
            x:{grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},color:'#94a3b8'},border:{display:false}},
            y:{grid:{color:'#f1f5f9',drawBorder:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false},grace:'20%'}
        }
    };

    try{
        const totalY=pm.map(m=>{const d=data.filter(r=>r.month===m);const i=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);const o=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0);return i>0?o/i*100:null;});
        // Fix 1: Much more padding so labels never overlap Y axis
        charts.totalYield=new Chart(document.getElementById('chartTotalYield'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiYield,data:totalY,borderColor:'#3B8BF5',backgroundColor:'rgba(59,139,245,0.06)',fill:true,tension:0.4,pointBackgroundColor:'white',pointBorderColor:'#3B8BF5',pointBorderWidth:2.5,pointRadius:5,borderWidth:2.5}]},options:{...baseOpts,layout:{padding:{left:10,right:50,top:38,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{color:'#2563EB',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:9,bottom:4,left:9},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},anchor:'end',align:'end',offset:12,clip:false,display:true,formatter:v=>v?v.toFixed(2)+'%':''}},scales:{...baseOpts.scales,x:{...baseOpts.scales.x,offset:true},y:{...baseOpts.scales.y,min:97,max:101}}}});

        // PPM Monthly Trend Chart
        const ppmTrendData=pm.map(m=>{
            const d=data.filter(r=>r.month===m);
            const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);
            const tf=d.reduce((a,b)=>a+b.fail,0);
            return ti>0?Math.round(tf/ti*1000000):null;
        });
        charts.ppmTrend=new Chart(document.getElementById('chartPpmTrend'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].titPpmTrend||'Ï¢ÖÌï© PPM',data:ppmTrendData,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.07)',fill:true,tension:0.4,pointBackgroundColor:'white',pointBorderColor:'#f59e0b',pointBorderWidth:2.5,pointRadius:5,borderWidth:2.5}]},options:{...baseOpts,layout:{padding:{left:10,right:50,top:38,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{color:'#d97706',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:9,bottom:4,left:9},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},anchor:'end',align:'end',offset:12,clip:false,display:true,formatter:v=>v!==null?v.toLocaleString()+' PPM':''}},scales:{...baseOpts.scales,x:{...baseOpts.scales.x,offset:true},y:{...baseOpts.scales.y,afterDataLimits:(axis)=>{const vals=[];axis.chart.data.datasets.forEach(ds=>{ds.data.forEach(v=>{if(v!==null&&v!==undefined)vals.push(v);});});if(vals.length){const mn=Math.min(...vals),mx=Math.max(...vals),pad=Math.max(500,Math.round((mx-mn)*0.15));axis.min=Math.max(0,Math.floor((mn-pad)/500)*500);axis.max=Math.ceil((mx+pad)/500)*500;}else{axis.min=0;axis.max=1000;}}}}}});

        // Fix 2: legend ON, Fix 3: datalabels only when single filter
        const prodSingle = prodChartFilter!=='Ï†ÑÏ≤¥';
        const prodYieldLabelOpts = {
            display: prodSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false,
            color: ctx=>['#f43f5e','#0891b2','#f59e0b'][ctx.datasetIndex]||'#0c1e3e',
            backgroundColor:'rgba(255,255,255,0.95)',borderRadius:5,
            padding:{top:3,right:7,bottom:3,left:7},
            font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},
            anchor:'end',align:'end',offset:8,clip:false,
            formatter:v=>v?v.toFixed(2)+'%':''
        };
        charts.prodYield=new Chart(document.getElementById('chartProdYield'),{type:'line',data:{labels:pl,datasets:['RDIMM','SODIMM','UDIMM'].map((p,i)=>({label:p,borderColor:['#f43f5e','#0891b2','#f59e0b'][i],backgroundColor:['rgba(244,63,94,0.05)','rgba(8,145,178,0.05)','rgba(245,158,11,0.05)'][i],fill:true,tension:0.4,borderWidth:2.5,pointRadius:4,pointBorderWidth:2,pointBackgroundColor:'white',hidden:prodSingle&&p!==prodChartFilter,data:pm.map(m=>{const d=data.filter(r=>r.month===m&&r.prod===p);const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);const to=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0);return ti>0?to/ti*100:null;})}))},options:{...baseOpts,layout:{padding:{top:prodSingle?38:16,right:prodSingle?50:14,bottom:8,left:8}},plugins:{...baseOpts.plugins,legend:{position:'bottom',display:true,labels:{boxWidth:10,boxHeight:10,padding:12,font:{size:11,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:8}},datalabels:prodYieldLabelOpts},scales:{...baseOpts.scales,y:{...baseOpts.scales.y,min:97,max:101}}}});

        const procSingle = procChartFilter!=='Ï†ÑÏ≤¥';
        const procColors=['#8b5cf6','#ec4899','#6366f1','#f59e0b','#10b981','#f97316'];
        const procYieldLabelOpts = {
            display: procSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false,
            color: ctx=>procColors[ctx.datasetIndex]||'#0c1e3e',
            backgroundColor:'rgba(255,255,255,0.95)',borderRadius:5,
            padding:{top:3,right:7,bottom:3,left:7},
            font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},
            anchor:'end',align:'end',offset:8,clip:false,
            formatter:v=>v?v.toFixed(2)+'%':''
        };
        charts.procYield=new Chart(document.getElementById('chartProcYield'),{type:'line',data:{labels:pl,datasets:['SMD','ROUTER','ATE','PCT','AVI','TC'].map((p,i)=>({label:p,borderColor:procColors[i],tension:0.4,borderWidth:2.5,pointRadius:4,pointBorderWidth:2,pointBackgroundColor:'white',hidden:procSingle&&p!==procChartFilter,data:pm.map(m=>{const d=data.filter(r=>r.month===m&&r.proc===p);const ti=d.reduce((a,b)=>a+b.in,0);const to=d.reduce((a,b)=>a+b.out,0);return ti>0?to/ti*100:null;})}))},options:{...baseOpts,layout:{padding:{top:procSingle?38:16,right:procSingle?50:14,bottom:8,left:8}},plugins:{...baseOpts.plugins,legend:{position:'bottom',display:true,labels:{boxWidth:10,boxHeight:10,padding:12,font:{size:11,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:8}},datalabels:procYieldLabelOpts},scales:{...baseOpts.scales,y:{...baseOpts.scales.y,min:97,max:101}}}});

        // Fix 4: prodVol by model RDIMM/SODIMM/UDIMM stacked with filter
        const pvColors=['#6366f1','#0891b2','#f59e0b'];
        const pvDS=['RDIMM','SODIMM','UDIMM'].map((p,i)=>({
            label:p,
            data:pm.map(m=>data.filter(r=>r.month===m&&r.prod===p&&r.proc==='SMD').reduce((a,b)=>a+b.in,0)),
            backgroundColor:pvColors[i], borderRadius:4, borderSkipped:false, stack:'pv',
            hidden: prodVolFilter!=='Ï†ÑÏ≤¥'&&p!==prodVolFilter,
            datalabels:{display:true,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',
                font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},
                formatter:v=>v>0?v.toLocaleString():''}
        }));
        const pvTotals=pm.map(m=>data.filter(r=>r.month===m&&r.proc==='SMD').reduce((a,b)=>a+b.in,0));
        charts.prodVol=new Chart(document.getElementById('chartProdVol'),{
            type:'bar',
            data:{labels:pl,datasets:[...pvDS,{type:'line',label:lang==='ko'?'Ìï©Í≥Ñ':'Total',data:pvTotals,borderColor:'transparent',backgroundColor:'transparent',pointRadius:0,hidden:prodVolFilter!=='Ï†ÑÏ≤¥',
                datalabels:{display:true,anchor:'end',align:'end',color:'#4f46e5',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,
                    padding:{top:4,right:8,bottom:4,left:8},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},
                    formatter:v=>v.toLocaleString(),offset:12},order:-1}]},
            options:{...baseOpts,layout:{padding:{top:50,right:20,left:10,bottom:8}},
                plugins:{...baseOpts.plugins,
                    legend:{position:'bottom',display:true,labels:{boxWidth:10,boxHeight:10,padding:12,font:{size:11,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:8,filter:item=>item.text!==lang?'Ìï©Í≥Ñ':'Total'}},
                    datalabels:{display:false}},
                scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},color:'#94a3b8'},border:{display:false}},
                    y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false}}}
            }
        });

        const defData=pm.map(m=>data.filter(r=>r.month===m).reduce((a,b)=>a+b.fail,0));
        charts.totalDefect=new Chart(document.getElementById('chartTotalDefect'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiDefect,data:defData,borderColor:'#f43f5e',backgroundColor:'rgba(244,63,94,0.07)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:'#f43f5e',pointBorderWidth:2.5}]},options:{...baseOpts,layout:{padding:{top:40,right:50,left:10,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{...baseOpts.plugins.datalabels,color:'#f43f5e',offset:10,formatter:v=>v.toLocaleString()}}}});

        const compDef=pm.map(m=>data.filter(r=>r.month===m&&['SMD','ROUTER','AVI'].includes(r.proc)).reduce((a,b)=>a+b.fail,0));
        charts.compDefect=new Chart(document.getElementById('chartCompDefect'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiCompDefect,data:compDef,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.07)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:'#f59e0b',pointBorderWidth:2.5}]},options:{...baseOpts,layout:{padding:{top:40,right:50,left:10,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{...baseOpts.plugins.datalabels,color:'#d97706',offset:10,formatter:v=>v.toLocaleString()}}}});

        // Fix 5: Shipment chart with filter buttons support
        const sColors=['#3b82f6','#10b981','#f59e0b'];
        const sDS=['RDIMM','SODIMM','UDIMM'].map((m,i)=>({
            label:m,
            data:sm.map(mo=>shipData.filter(r=>r.month===mo&&r.model===m).reduce((a,b)=>a+b.qty,0)),
            backgroundColor:sColors[i], borderRadius:5, stack:'s0',
            hidden:shipChartFilter!=='Ï†ÑÏ≤¥'&&m!==shipChartFilter,
            datalabels:{display:true,color:'white',font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},anchor:'center',align:'center',formatter:v=>v>0?v.toLocaleString():''}
        }));
        const sTotals=sm.map(mo=>shipData.filter(r=>r.month===mo).reduce((a,b)=>a+b.qty,0));
        charts.shipment=new Chart(document.getElementById('chartShipment'),{type:'bar',data:{labels:sl,datasets:[...sDS,{type:'line',label:'Total',data:sTotals,borderColor:'transparent',backgroundColor:'transparent',pointRadius:0,hidden:shipChartFilter!=='Ï†ÑÏ≤¥',
            datalabels:{display:true,anchor:'end',align:'end',color:'#0c1e3e',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:8,bottom:4,left:8},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},formatter:v=>v.toLocaleString(),offset:14},order:-1}]},
            options:{...baseOpts,layout:{padding:{top:50,right:20,left:10,bottom:8}},
                plugins:{...baseOpts.plugins,legend:{...baseOpts.plugins.legend,labels:{...baseOpts.plugins.legend.labels,filter:item=>item.text!=='Total'}},datalabels:{display:false}},
                scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},color:'#94a3b8'},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false}}}}});

        const palCols=['#6366f1','#06b6d4','#f59e0b','#f43f5e','#10b981'];
        let dDS=reasons.map((r,i)=>({label:r,data:dm.map(m=>{const d=defectTypeData.find(x=>x.month===m&&x.reason===r);return d?d.qty:0;}),backgroundColor:palCols[i%5],borderRadius:4,borderSkipped:false,stack:'s0'}));
        if(filters.defectType!=='Ï†ÑÏ≤¥')dDS=dDS.filter(ds=>ds.label===filters.defectType);
        charts.defectType=new Chart(document.getElementById('chartDefectType'),{type:'bar',data:{labels:dl,datasets:dDS},options:{...baseOpts,plugins:{...baseOpts.plugins,datalabels:{...baseOpts.plugins.datalabels,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',font:{weight:'bold',size:11,family:'JetBrains Mono, monospace'}}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false},grace:'20%'}}}});

        // Pie chart
        const pieVals=reasons.map(r=>defectTypeData.filter(d=>d.reason===r).reduce((a,b)=>a+b.qty,0));
        charts.defectTypePie=new Chart(document.getElementById('chartDefectTypePie'),{
            type:'doughnut',
            data:{labels:reasons,datasets:[{data:pieVals,backgroundColor:palCols,borderWidth:3,borderColor:'white',hoverBorderWidth:5,hoverOffset:6}]},
            options:{
                responsive:true, maintainAspectRatio:false, cutout:'52%',
                layout:{padding:{top:20,bottom:20,left:20,right:20}},
                plugins:{
                    legend:{
                        position:'right',
                        labels:{font:{size:12,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},padding:14,usePointStyle:true,pointStyleWidth:10,color:'#334155'}
                    },
                    datalabels:{
                        display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,
                        color:'white',
                        backgroundColor:'rgba(0,0,0,0.0)',
                        font:{weight:'800',size:13,family:'JetBrains Mono, monospace'},
                        textStrokeColor:'rgba(0,0,0,0.4)',
                        textStrokeWidth:3,
                        formatter:(v,ctx)=>{
                            const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                            const pct=(v*100/total).toFixed(1);
                            return v>0?pct+'%':'';
                        },
                        anchor:'center', align:'center', offset:0
                    }
                }
            }
        });
    }catch(e){console.error('Ï∞®Ìä∏ Ïò§Î•ò:',e);}
}

function openModal(t){
    requirePassword(()=>{
        document.getElementById(t==='prod'?'modalProd':t==='ship'?'modalShip':'modalDefect').style.display='block';
        renderEntryTable(t);
        updateModalLang();
    });
}
function closeModal(t){document.getElementById(t==='prod'?'modalProd':t==='ship'?'modalShip':'modalDefect').style.display='none';}
function clearTable(t){if(!confirm(lang==='ko'?'‚ö†Ô∏è Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?':'‚ö†Ô∏è Reset all data?'))return;document.querySelector(`#${t==='prod'?'tblEntryProd':t==='ship'?'tblEntryShip':'tblEntryDefect'} tbody`).innerHTML='';document.getElementById(t==='prod'?'pasteProd':t==='ship'?'pasteShip':'pasteDefect').value='';}

function updateModalLang(){
    const t=T[lang];
    // Password modal
    document.getElementById('pwTitle').innerText=lang==='ko'?'Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†• ÎπÑÎ∞ÄÎ≤àÌò∏':'Password Required';
    document.getElementById('pwSub').innerText=lang==='ko'?'Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏ†ïÌïòÎ†§Î©¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî':'Enter password to edit data';
    document.getElementById('pwOkBtn').innerText=lang==='ko'?'ÌôïÏù∏':'Confirm';
    document.getElementById('pwCancelBtn').innerText=lang==='ko'?'Ï∑®ÏÜå':'Cancel';
    // Prod modal
    document.getElementById('moTitProd').innerText=t.moTitProd;
    document.querySelector('#modalProd .modal-desc').innerHTML=lang==='ko'?'ExcelÏóêÏÑú <strong>[Ï†úÌíà | Í∏∞Í∞Ñ | Í≥µÏ†ï | Ìà¨ÏûÖ | ÏÇ∞Ï∂ú | Î∂àÎüâ]</strong> ÏàúÏÑúÎ°ú Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£ÏùÑ Ïàò ÏûàÏäµÎãàÎã§.':'Paste from Excel in order: <strong>[Product | Period | Process | Input | Output | Defect]</strong>';
    document.getElementById('pasteProd').placeholder=lang==='ko'?'Excel Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V)':'Paste Excel data here (Ctrl+V)';
    document.querySelector('#modalProd .btn-parse').innerText=lang==='ko'?'üìã Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©':'üìã Apply Data';
    document.querySelector('#modalProd .btn-clr').innerText=lang==='ko'?'üóëÔ∏è Ï¥àÍ∏∞Ìôî':'üóëÔ∏è Reset';
    document.querySelector('#tblEntryProd thead tr').innerHTML=`<th>${lang==='ko'?'Ï†úÌíà':'Product'}</th><th>${lang==='ko'?'Í∏∞Í∞Ñ':'Period'}</th><th>${lang==='ko'?'Í≥µÏ†ï':'Process'}</th><th>${lang==='ko'?'Ìà¨ÏûÖ':'Input'}</th><th>${lang==='ko'?'ÏÇ∞Ï∂ú':'Output'}</th><th>${lang==='ko'?'Î∂àÎüâ':'Defect'}</th><th>${lang==='ko'?'ÏÇ≠Ï†ú':'Del'}</th>`;
    document.querySelector('#modalProd .btn-addrow').innerText=lang==='ko'?'+ Ìñâ Ï∂îÍ∞Ä':'+ Add Row';
    document.querySelector('#modalProd .btn-save').innerText=lang==='ko'?'üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)':'üíæ Save (Sync Now)';
    document.querySelector('#modalProd .btn-cancel').innerText=lang==='ko'?'Ï∑®ÏÜå':'Cancel';
    // Ship modal
    document.getElementById('moTitShip').innerText=t.moTitShip;
    document.querySelector('#modalShip .modal-desc').innerHTML=lang==='ko'?'ExcelÏóêÏÑú <strong>[Î™®Îç∏ | Î™®Îç∏Î™Ö | ÎÇ†Ïßú | ÏàòÎüâ | ÏÇ¨Ïú†]</strong> ÏàúÏÑúÎ°ú Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£ÏùÑ Ïàò ÏûàÏäµÎãàÎã§.':'Paste from Excel: <strong>[Model | Name | Date | Qty | Reason]</strong>';
    document.getElementById('pasteShip').placeholder=lang==='ko'?'Excel Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V)':'Paste Excel data here (Ctrl+V)';
    document.querySelector('#modalShip .btn-parse').innerText=lang==='ko'?'üìã Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©':'üìã Apply Data';
    document.querySelector('#modalShip .btn-clr').innerText=lang==='ko'?'üóëÔ∏è Ï¥àÍ∏∞Ìôî':'üóëÔ∏è Reset';
    document.querySelector('#tblEntryShip thead tr').innerHTML=`<th>${lang==='ko'?'Î™®Îç∏':'Model'}</th><th>${lang==='ko'?'Î™®Îç∏Î™Ö':'Name'}</th><th>${lang==='ko'?'ÎÇ†Ïßú':'Date'}</th><th>${lang==='ko'?'ÏàòÎüâ':'Qty'}</th><th>${lang==='ko'?'ÏÇ¨Ïú†':'Reason'}</th><th>${lang==='ko'?'Í∏∞Í∞Ñ(ÏûêÎèô)':'Period(auto)'}</th><th>${lang==='ko'?'ÏÇ≠Ï†ú':'Del'}</th>`;
    document.querySelector('#modalShip .btn-addrow').innerText=lang==='ko'?'+ Ìñâ Ï∂îÍ∞Ä':'+ Add Row';
    document.querySelector('#modalShip .btn-save').innerText=lang==='ko'?'üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)':'üíæ Save (Sync Now)';
    document.querySelector('#modalShip .btn-cancel').innerText=lang==='ko'?'Ï∑®ÏÜå':'Cancel';
    // Defect modal
    document.getElementById('moTitDefect').innerText=t.moTitDefect;
    document.querySelector('#modalDefect .modal-desc').innerHTML=lang==='ko'?'ExcelÏóêÏÑú <strong>[Î∂àÎüâÎ™Ö | Í∏∞Í∞Ñ(YY.MM) | ÏàòÎüâ]</strong> ÏàúÏÑúÎ°ú Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£ÏùÑ Ïàò ÏûàÏäµÎãàÎã§.':'Paste from Excel: <strong>[Defect Name | Period(YY.MM) | Qty]</strong>';
    document.getElementById('pasteDefect').placeholder=lang==='ko'?'ÏòàÏãú: Human Error\t26.02\t5':'Example: Human Error\t26.02\t5';
    document.querySelector('#modalDefect .btn-parse').innerText=lang==='ko'?'üìã Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©':'üìã Apply Data';
    document.querySelector('#modalDefect .btn-clr').innerText=lang==='ko'?'üóëÔ∏è Ï¥àÍ∏∞Ìôî':'üóëÔ∏è Reset';
    document.querySelector('#tblEntryDefect thead tr').innerHTML=`<th>${lang==='ko'?'Î∂àÎüâÎ™Ö':'Defect Name'}</th><th>${lang==='ko'?'Í∏∞Í∞Ñ (YY.MM)':'Period (YY.MM)'}</th><th>${lang==='ko'?'ÏàòÎüâ':'Qty'}</th><th>${lang==='ko'?'ÏÇ≠Ï†ú':'Del'}</th>`;
    document.querySelector('#modalDefect .btn-addrow').innerText=lang==='ko'?'+ Ìñâ Ï∂îÍ∞Ä':'+ Add Row';
    document.querySelector('#modalDefect .btn-save').innerText=lang==='ko'?'üíæ Ï†ÄÏû• (Ï¶âÏãú Î∞òÏòÅ)':'üíæ Save (Sync Now)';
    document.querySelector('#modalDefect .btn-cancel').innerText=lang==='ko'?'Ï∑®ÏÜå':'Cancel';
    // Backup modal
    document.getElementById('backupTitle').innerText=lang==='ko'?'üíæ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ Í¥ÄÎ¶¨':'üíæ Backup Manager';
    document.getElementById('backupSubTitle').innerText=lang==='ko'?'ÏµúÎåÄ 10Í∞ú Î∞±ÏóÖ Ï†ÄÏû• ¬∑ ÏûòÎ™ª ÏûÖÎ†• Ïãú Î≥µÏõê Í∞ÄÎä•':'Up to 10 backups ¬∑ Restore anytime';
    document.getElementById('backupNowBtn').innerText=lang==='ko'?'üì∏ ÏßÄÍ∏à Î∞±ÏóÖ ÏÉùÏÑ±':'üì∏ Create Backup Now';
}

function renderEntryTable(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`); tbody.innerHTML='';
    const src=type==='prod'?prodData:type==='ship'?shipData:defectTypeData;
    src.forEach(d=>{
        const tr=document.createElement('tr');
        if(type==='prod'){tr.innerHTML=`<td><select><option value="">ÏÑ†ÌÉù</option><option value="RDIMM"${d.prod==='RDIMM'?' selected':''}>RDIMM</option><option value="SODIMM"${d.prod==='SODIMM'?' selected':''}>SODIMM</option><option value="UDIMM"${d.prod==='UDIMM'?' selected':''}>UDIMM</option></select></td><td><input list="list-months" value="${d.month}"></td><td><select><option value="">ÏÑ†ÌÉù</option><option value="SMD"${d.proc==='SMD'?' selected':''}>SMD</option><option value="ROUTER"${d.proc==='ROUTER'?' selected':''}>ROUTER</option><option value="ATE"${d.proc==='ATE'?' selected':''}>ATE</option><option value="PCT"${d.proc==='PCT'?' selected':''}>PCT</option><option value="AVI"${d.proc==='AVI'?' selected':''}>AVI</option><option value="TC"${d.proc==='TC'?' selected':''}>TC</option></select></td><td><input type="number" value="${d.in}"></td><td><input type="number" value="${d.out}"></td><td><input type="number" value="${d.fail}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;}
        else if(type==='ship'){tr.innerHTML=`<td><input list="list-products" value="${d.model}"></td><td><input list="list-model-names" value="${d.name}"></td><td><input type="date" value="${d.date}"></td><td><input type="number" value="${d.qty}"></td><td><input list="list-ship-reasons" value="${d.reason}"></td><td><input list="list-months" value="${d.month}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;}
        else{tr.innerHTML=`<td><input list="list-defect-reasons" value="${d.reason||''}"></td><td><input list="list-months" value="${d.month||''}"></td><td><input type="number" value="${d.qty||0}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;}
        tbody.appendChild(tr);
    });
}

function addRow(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`);
    const tr=document.createElement('tr');
    if(type==='prod'){tr.innerHTML=`<td><select><option value="">ÏÑ†ÌÉù</option><option value="RDIMM">RDIMM</option><option value="SODIMM">SODIMM</option><option value="UDIMM">UDIMM</option></select></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><select><option value="">ÏÑ†ÌÉù</option><option value="SMD">SMD</option><option value="ROUTER">ROUTER</option><option value="ATE">ATE</option><option value="PCT">PCT</option><option value="AVI">AVI</option><option value="TC">TC</option></select></td><td><input type="number" placeholder="1000"></td><td><input type="number" placeholder="995"></td><td><input type="number" value="0"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;}
    else if(type==='ship'){tr.innerHTML=`<td><input list="list-products" placeholder="RDIMM"></td><td><input list="list-model-names" placeholder="Î™®Îç∏Î™Ö"></td><td><input type="date"></td><td><input type="number" placeholder="1000"></td><td><input list="list-ship-reasons" placeholder="Mass Production"></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;}
    else{tr.innerHTML=`<td><input list="list-defect-reasons" placeholder="Human Error"></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><input type="number" value="0"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;}
    tbody.appendChild(tr); tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function parsePaste(type){
    const pid=type==='prod'?'pasteProd':type==='ship'?'pasteShip':'pasteDefect';
    const txt=document.getElementById(pid).value.trim();
    if(!txt){alert('Î∂ôÏó¨ÎÑ£ÏùÑ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');return;}
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`); let cnt=0;
    txt.split('\n').forEach(row=>{
        const c=row.split(/\t/); const tr=document.createElement('tr');
        if(type==='prod'&&c.length>=6){const mv=extractYM(c[1].trim());tr.innerHTML=`<td><select><option value="">ÏÑ†ÌÉù</option><option value="RDIMM"${c[0].trim()==='RDIMM'?' selected':''}>RDIMM</option><option value="SODIMM"${c[0].trim()==='SODIMM'?' selected':''}>SODIMM</option><option value="UDIMM"${c[0].trim()==='UDIMM'?' selected':''}>UDIMM</option></select></td><td><input list="list-months" value="${mv}"></td><td><select><option value="">ÏÑ†ÌÉù</option><option value="SMD"${c[2].trim()==='SMD'?' selected':''}>SMD</option><option value="ROUTER"${c[2].trim()==='ROUTER'?' selected':''}>ROUTER</option><option value="ATE"${c[2].trim()==='ATE'?' selected':''}>ATE</option><option value="PCT"${c[2].trim()==='PCT'?' selected':''}>PCT</option><option value="AVI"${c[2].trim()==='AVI'?' selected':''}>AVI</option><option value="TC"${c[2].trim()==='TC'?' selected':''}>TC</option></select></td><td><input type="number" value="${cleanNum(c[3])}"></td><td><input type="number" value="${cleanNum(c[4])}"></td><td><input type="number" value="${cleanNum(c[5])}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;tbody.appendChild(tr);cnt++;}
        else if(type==='ship'&&c.length>=5){const mv=c.length>=6&&c[5].trim()?extractYM(c[5].trim()):extractYM(c[2].trim());tr.innerHTML=`<td><input list="list-products" value="${c[0].trim()}"></td><td><input list="list-model-names" value="${c[1].trim()}"></td><td><input type="date" value="${c[2].trim()}"></td><td><input type="number" value="${cleanNum(c[3])}"></td><td><input list="list-ship-reasons" value="${c[4].trim()}"></td><td><input list="list-months" value="${mv}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;tbody.appendChild(tr);cnt++;}
        else if(type==='defect'&&c.length>=3){const mv=extractYM(c[1].trim());tr.innerHTML=`<td><input list="list-defect-reasons" value="${c[0].trim()}"></td><td><input list="list-months" value="${mv}"></td><td><input type="number" value="${cleanNum(c[2])}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ÏÇ≠Ï†ú</button></td>`;tbody.appendChild(tr);cnt++;}
    });
    if(cnt>0){alert(`‚úÖ ${cnt}Í∞ú Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞ÄÎê®. Ï†ÄÏû• Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.`);document.getElementById(pid).value='';}
    else alert('‚ö†Ô∏è Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
}

function exportExcel(){
    try{
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(prodData.map(d=>({'Ï†úÌíà':d.prod,'Í∏∞Í∞Ñ':fmtPeriod(d.month),'Í≥µÏ†ï':d.proc,'Ìà¨ÏûÖ':d.in,'ÏÇ∞Ï∂ú':d.out,'Î∂àÎüâ':d.fail}))),"ÏÉùÏÇ∞Îç∞Ïù¥ÌÑ∞");
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(shipData.map(d=>({'Î™®Îç∏':d.model,'Î™®Îç∏Î™Ö':d.name,'Ï∂úÌïòÏùº':d.date,'ÏàòÎüâ':d.qty,'ÏÇ¨Ïú†':d.reason,'Í∏∞Í∞Ñ':fmtPeriod(d.month)}))),"Ï∂úÌïòÎç∞Ïù¥ÌÑ∞");
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(defectTypeData.map(d=>({'Î∂àÎüâÎ™Ö':d.reason,'Í∏∞Í∞Ñ':fmtPeriod(d.month),'ÏàòÎüâ':d.qty}))),lang==='ko'?"Î∂àÎüâÏú†ÌòïÎç∞Ïù¥ÌÑ∞":"Defect_Types");
        if(dailyProdData&&dailyProdData.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dailyProdData.map(d=>({[lang==='ko'?'ÎÇ†Ïßú':'Date']:d.date,[lang==='ko'?'Î™®Îç∏':'Model']:d.model,[lang==='ko'?'Í≥µÏ†ï':'Process']:d.proc,[lang==='ko'?'ÌåÄ':'Team']:d.team,[lang==='ko'?'Ìà¨ÏûÖÏàòÎüâ':'Input Qty']:d.inspQty,[lang==='ko'?'ÏñëÌíàÏàòÎüâ':'Good Qty']:d.goodQty,[lang==='ko'?'Î∂àÎüâÏàòÎüâ':'Defect Qty']:d.defectQty}))),lang==='ko'?"ÏùºÎ≥ÑÏÉùÏÇ∞":"Daily_Prod");
        if(dailyDefectData&&dailyDefectData.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dailyDefectData.map(d=>({[lang==='ko'?'ÎÇ†Ïßú':'Date']:d.date,[lang==='ko'?'Î™®Îç∏':'Model']:d.model,[lang==='ko'?'Í≥µÏ†ï':'Process']:d.proc,[lang==='ko'?'ÌåÄ':'Team']:d.team,[lang==='ko'?'Î∂àÎüâÏΩîÎìú':'Code']:d.defectCode,[lang==='ko'?'Î∂àÎüâÎ™Ö':'Name']:d.defectName,[lang==='ko'?'ÏàòÎüâ':'Qty']:d.qty}))),lang==='ko'?"ÏùºÎ≥ÑÎ∂àÎüâÏΩîÎìú":"Daily_Defects");
        XLSX.writeFile(wb,`DS_Quality_Performance_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.xlsx`);
        alert('‚úÖ Excel ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
    }catch(e){alert('Excel Ïò§Î•ò: '+e.message);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LOGIN_PASSWORD = "ds2025"; // ‚Üê ÎåÄÏãúÎ≥¥Îìú Ï†ëÏÜç ÎπÑÎ∞ÄÎ≤àÌò∏ (Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•Í≥º Î∂ÑÎ¶¨)
let loggedIn = false;

function doLogin(){
    const v=document.getElementById('loginInput').value;
    if(v===LOGIN_PASSWORD){
        loggedIn=true;
        document.getElementById('loginModal').style.display='none';
        document.getElementById('loadingOverlay').style.display='flex';
        initFirebase();
    } else {
        const e=document.getElementById('loginErr');
        e.innerText='‚ùå ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§';
        document.getElementById('loginInput').value='';
        document.getElementById('loginInput').focus();
        setTimeout(()=>e.innerText='',2000);
    }
}
// Î°úÍ∑∏Ïù∏ Ï¥àÍ∏∞ÌôîÎäî Ïä§ÌÅ¨Î¶ΩÌä∏ ÏµúÏÉÅÎã® IIFEÏóêÏÑú Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê® (ÏúÑ Ï∞∏Í≥†)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFECT CODE LISTS (SMT = 1000s, TEST = 4000s)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SMD_DEFECTS=[
    {code:'1000',name:'PCB;TAB BREAKAGE'},{code:'1001',name:'PCB;TAB EXPOSE'},{code:'1002',name:'PCB;TAB BUBBLE'},
    {code:'1003',name:'PCB;TAB BURR'},{code:'1004',name:'PCB;TAB LIFTING'},{code:'1005',name:'PCB;TAB DISCOLOR'},
    {code:'1006',name:'PCB;TAB SOLDER RESIDUE'},{code:'1008',name:'PCB;TAB FOREIGN MATERIALS'},{code:'1009',name:'PCB TAB DAMAGED'},
    {code:'1012',name:'PCB;TAB BURNT'},{code:'1013',name:'PCB;TAB DENT'},{code:'1014',name:'PCB;TAB SCRATCH'},
    {code:'1015',name:'PCB;TAB SHORT'},{code:'1016',name:'PCB;TAB VOID'},{code:'1018',name:'PCB;TAB SHAPE DEFECT'},
    {code:'1021',name:'PCB;TAB FINE DEFECT'},{code:'1100',name:'PCB;PCB FOLD'},{code:'1101',name:'PCB;PCB BURR'},
    {code:'1102',name:'PCB PCB LIFTING'},{code:'1103',name:'PCB PCB DELAMINATION'},{code:'1104',name:'PCB PCB DISCOLOR'},
    {code:'1105',name:'PCB PCB CONTAMINATION'},{code:'1106',name:'PCB PCB BREAKAGE'},{code:'1107',name:'PCB PCB FOREIGN MATERIALS'},
    {code:'1108',name:'PCB PCB BURNING'},{code:'1109',name:'PCB PCB CIRCUIT DEFECT'},{code:'1112',name:'PCB;PCB BOW'},
    {code:'1113',name:'PCB;PCB BUBBLE'},{code:'1115',name:'PCB PCB CU EXPOSE'},{code:'1116',name:'PCB PCB DIMENSION DEFECT'},
    {code:'1117',name:'PCB PCB MARKING DEFECT'},{code:'1118',name:'PCB PCB MIX'},{code:'1119',name:'PCB PCB PAD DEFECT'}
];
const TEST_DEFECTS=[
    {code:'4001',name:'COM;SPD_WP'},{code:'4041',name:'COM;SPD_WRITE_FUNC'},{code:'4044',name:'COM;SPD_READ_SERIAL_FUNC'},
    {code:'4045',name:'COM;SPD_WP (2)'},{code:'4046',name:'COM;EEPROM_TEMP_GRADE'},{code:'4048',name:'COM;SPD_BIN_READ_FUNC'},
    {code:'4050',name:'COM;BIN 50'},{code:'4051',name:'COM;BIN 51'},{code:'4052',name:'COM;BIN 52'},
    {code:'4053',name:'COM;BIN 53'},{code:'4054',name:'COM;BIN 54'},{code:'4057',name:'COM;BIN 57'},
    {code:'4061',name:'COM;VREFDQ-Vss_SHORT_SCREEN'},{code:'4070',name:'COM;INPUT_LEAKAGE'},{code:'4071',name:'COM;OUTPUT_LEAKAGE'},
    {code:'4080',name:'COM;INPUT_OPEN'},{code:'4081',name:'COM;OUTPUT_OPEN'},{code:'4095',name:'COM;FUSE FAIL'}
];
let CUSTOM_DEFECTS=[];

function getDefectsForProc(proc){
    const c=CUSTOM_DEFECTS;
    if(['SMD','ROUTER'].includes(proc)) return [...SMD_DEFECTS,...c.filter(d=>d.team==='SMT')];
    if(['ATE','PCT','AVI','TC'].includes(proc)) return [...TEST_DEFECTS,...c.filter(d=>d.team==='TEST')];
    return [...SMD_DEFECTS,...TEST_DEFECTS,...c];
}
function getTeam(proc){
    if(['SMD','ROUTER'].includes(proc)) return 'SMT';
    if(['ATE','PCT','AVI','TC'].includes(proc)) return 'TEST';
    return '‚Äî';
}
function getTeamBadge(proc){
    const t=getTeam(proc);
    if(t==='SMT') return '<span class="team-badge team-smt">SMT</span>';
    if(t==='TEST') return '<span class="team-badge team-test">TEST</span>';
    return '<span style="color:var(--text-muted)">‚Äî</span>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dailyProdData=[], dailyDefectData=[];
let dFilters={product:'Ï†ÑÏ≤¥',team:'Ï†ÑÏ≤¥',process:'Ï†ÑÏ≤¥',dateFrom:'',dateTo:''};
let dYieldFilter='Ï†ÑÏ≤¥', dVolFilter='Ï†ÑÏ≤¥', dDefectTeamFilter='Ï†ÑÏ≤¥';
let dProcVolFilter='Ï†ÑÏ≤¥', dModelVolFilter='Ï†ÑÏ≤¥';
let dCharts={}, currentView='monthly';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW SWITCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setView(v){
    if((v==='monthly'||v==='daily')&&!loggedIn){
        document.getElementById('loginModal').style.display='flex';
        return;
    }
    currentView=v;
    document.getElementById('viewMonthly').style.display=v==='monthly'?'block':'none';
    document.getElementById('viewDaily').style.display=v==='daily'?'block':'none';
    document.getElementById('viewAttendance').style.display=v==='attendance'?'block':'none';
    document.getElementById('monthlyBtns').style.display=v==='monthly'?'inline-flex':'none';
    document.getElementById('dailyBtns').style.display=v==='daily'?'inline-flex':'none';
    document.getElementById('attBtns').style.display=v==='attendance'?'inline-flex':'none';
    document.getElementById('btnViewMonthly').className='lang-btn'+(v==='monthly'?' active':'');
    document.getElementById('btnViewDaily').className='lang-btn'+(v==='daily'?' active':'');
    document.getElementById('btnViewAtt').className='lang-btn'+(v==='attendance'?' active':'');
    if(v==='daily'){initDailyFilters();updateDailyUI();}
    if(v==='attendance'){initAttFilters();updateAttendanceUI();drawAttendanceCharts();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY DATE FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initDailyFilters(){
    const now=new Date(),y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0');
    const last=new Date(y,now.getMonth()+1,0);
    if(!dFilters.dateFrom){
        dFilters.dateFrom=`${y}-${m}-01`;
        document.getElementById('dFilterFrom').value=dFilters.dateFrom;
    }
    if(!dFilters.dateTo){
        dFilters.dateTo=`${y}-${m}-${String(last.getDate()).padStart(2,'0')}`;
        document.getElementById('dFilterTo').value=dFilters.dateTo;
    }
}

function setDailyDatePreset(type){
    const now=new Date(),y=now.getFullYear(),m=now.getMonth();
    const p=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    let from,to;
    if(type==='today'){from=to=now;}
    else if(type==='yesterday'){const y2=new Date(now);y2.setDate(now.getDate()-1);from=to=y2;}
    else if(type==='week'){
        const day=now.getDay(),diff=now.getDate()-day+(day===0?-6:1);
        from=new Date(y,m,diff);to=new Date(y,m,diff+6);
    }
    else if(type==='month'){from=new Date(y,m,1);to=new Date(y,m+1,0);}
    else if(type==='all'){from=new Date('2000-01-01');to=new Date('2099-12-31');}
    else if(type==='weeknum'){
        const wn=parseInt(document.getElementById('weekNumInput').value);
        if(!wn||wn<1||wn>53){alert(lang==='ko'?'Ïò¨Î∞îÎ•∏ Ï£ºÏ∞®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (1~53)':'Enter valid week number (1~53)');return;}
        const yr=now.getFullYear();
        const jan4=new Date(yr,0,4);
        const firstMon=new Date(jan4);
        firstMon.setDate(jan4.getDate()-(jan4.getDay()||7)+1);
        from=new Date(firstMon);from.setDate(firstMon.getDate()+(wn-1)*7);
        to=new Date(from);to.setDate(from.getDate()+6);
    }
    dFilters.dateFrom=p(from);dFilters.dateTo=p(to);
    document.getElementById('dFilterFrom').value=dFilters.dateFrom;
    document.getElementById('dFilterTo').value=dFilters.dateTo;
    updateDailyUI();
}

function applyDailyFilters(){
    dFilters.dateFrom=document.getElementById('dFilterFrom').value;
    dFilters.dateTo=document.getElementById('dFilterTo').value;
    updateDailyUI();
}
function dFilter(t,v){dFilters[t]=v;updateDailyUI();}

function renderDailyFilterBtns(){
    const all=lang==='ko'?'Ï†ÑÏ≤¥':'All';
    const pp=document.getElementById('dFilterProduct');if(!pp)return;
    pp.innerHTML='';
    ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button');
        b.className='filter-btn'+(dFilters.product===p?' active':'');
        b.innerText=p==='Ï†ÑÏ≤¥'?all:p;
        b.onclick=()=>dFilter('product',p);
        pp.appendChild(b);
    });
    const tp=document.getElementById('dFilterTeam');tp.innerHTML='';
    [['Ï†ÑÏ≤¥',all],['SMT','SMT'],['TEST','TEST']].forEach(([v,label])=>{
        const b=document.createElement('button');
        b.className='filter-btn'+(dFilters.team===v?(v==='SMT'?' active-smt':v==='TEST'?' active-test':' active'):'');
        b.innerText=label;b.onclick=()=>dFilter('team',v);tp.appendChild(b);
    });
    const pr=document.getElementById('dFilterProcess');pr.innerHTML='';
    ['Ï†ÑÏ≤¥','SMD','ROUTER','ATE','PCT','AVI','TC'].forEach(p=>{
        const b=document.createElement('button');
        b.className='filter-btn'+(dFilters.process===p?' active':'');
        b.innerText=p==='Ï†ÑÏ≤¥'?all:p;b.onclick=()=>dFilter('process',p);pr.appendChild(b);
    });
    // Chart mini-filters
    const dyf=document.getElementById('dYieldFilter');if(dyf){dyf.innerHTML='';
        const yGroups=[
            {items:['Ï†ÑÏ≤¥'],color:''},
            {items:['SMT','TEST'],color:'#6366f1',label:'Team'},
            {items:['RDIMM','SODIMM','UDIMM'],color:'#f43f5e',label:'Model'},
            {items:['SMD','ROUTER'],color:'#8b5cf6',label:'SMT-Proc'},
            {items:['ATE','PCT','AVI','TC'],color:'#0891b2',label:'TEST-Proc'}
        ];
        const yGroupColors={'SMT':'#6366f1','TEST':'#6366f1','RDIMM':'#f43f5e','SODIMM':'#0891b2','UDIMM':'#f59e0b','SMD':'#8b5cf6','ROUTER':'#ec4899','ATE':'#6366f1','PCT':'#f59e0b','AVI':'#10b981','TC':'#f97316'};
        yGroups.forEach(g=>{
            if(g.label){const sep=document.createElement('span');sep.style.cssText='display:inline-flex;align-items:center;margin:0 4px 0 6px;font-size:9px;font-weight:700;color:'+g.color+';letter-spacing:.5px;';sep.innerText=g.label.toUpperCase();dyf.appendChild(sep);}
            g.items.forEach(p=>{
                const b=document.createElement('button');
                const isActive=dYieldFilter===p;
                const gc=yGroupColors[p]||'';
                b.style.cssText=gc&&!isActive?`border-color:${gc}40;color:${gc};`:'';
                b.className='mini-btn'+(isActive?' active':'');
                if(isActive&&gc) b.style.cssText=`background:${gc};border-color:${gc};color:white;`;
                b.innerText=p==='Ï†ÑÏ≤¥'?all:p;
                b.onclick=()=>{dYieldFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};
                dyf.appendChild(b);
            });
        });
    }
    // PPM ÌïÑÌÑ∞ (ÏàòÏú® ÌïÑÌÑ∞ÏôÄ ÎèôÏùºÌïú Í∞í Í≥µÏú†)
    const dpf=document.getElementById('dPpmFilter');if(dpf){dpf.innerHTML='';
        const ppmGroups=[
            {items:['Ï†ÑÏ≤¥'],color:''},
            {items:['SMT','TEST'],color:'#6366f1',label:'Team'},
            {items:['RDIMM','SODIMM','UDIMM'],color:'#f43f5e',label:'Model'},
            {items:['SMD','ROUTER'],color:'#8b5cf6',label:'SMT-Proc'},
            {items:['ATE','PCT','AVI','TC'],color:'#0891b2',label:'TEST-Proc'}
        ];
        const ppmGC={'SMT':'#6366f1','TEST':'#6366f1','RDIMM':'#f43f5e','SODIMM':'#0891b2','UDIMM':'#f59e0b','SMD':'#8b5cf6','ROUTER':'#ec4899','ATE':'#6366f1','PCT':'#f59e0b','AVI':'#10b981','TC':'#f97316'};
        ppmGroups.forEach(g=>{
            if(g.label){const sep=document.createElement('span');sep.style.cssText='display:inline-flex;align-items:center;margin:0 4px 0 6px;font-size:9px;font-weight:700;color:'+g.color+';letter-spacing:.5px;';sep.innerText=g.label.toUpperCase();dpf.appendChild(sep);}
            g.items.forEach(p=>{
                const b=document.createElement('button');
                const isActive=dYieldFilter===p;
                const gc=ppmGC[p]||'';
                b.style.cssText=gc&&!isActive?`border-color:${gc}40;color:${gc};`:'';
                b.className='mini-btn'+(isActive?' active':'');
                if(isActive&&gc) b.style.cssText=`background:${gc};border-color:${gc};color:white;`;
                b.innerText=p==='Ï†ÑÏ≤¥'?all:p;
                b.onclick=()=>{dYieldFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};
                dpf.appendChild(b);
            });
        });
    }
    const dvf=document.getElementById('dVolFilter');if(dvf){dvf.innerHTML='';
        ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(p=>{
            const b=document.createElement('button');b.className='mini-btn'+(dVolFilter===p?' active':'');
            b.innerText=p==='Ï†ÑÏ≤¥'?all:p;b.onclick=()=>{dVolFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};dvf.appendChild(b);});}
    const ddf=document.getElementById('dDefectTeamFilter');if(ddf){ddf.innerHTML='';
        ['Ï†ÑÏ≤¥','SMT','TEST'].forEach(t=>{
            const b=document.createElement('button');b.className='mini-btn'+(dDefectTeamFilter===t?' active':'');
            b.innerText=t==='Ï†ÑÏ≤¥'?all:t;b.onclick=()=>{dDefectTeamFilter=t;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};ddf.appendChild(b);});}
    // Í≥µÏ†ïÎ≥Ñ Ìà¨ÏûÖÏàòÎüâ ÌïÑÌÑ∞
    const dpvf=document.getElementById('dProcVolFilter');if(dpvf){dpvf.innerHTML='';
        ['Ï†ÑÏ≤¥','SMD','ROUTER','ATE','PCT','AVI','TC'].forEach(p=>{
            const b=document.createElement('button');b.className='mini-btn'+(dProcVolFilter===p?' active':'');
            b.innerText=p==='Ï†ÑÏ≤¥'?all:p;b.onclick=()=>{dProcVolFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};dpvf.appendChild(b);});}
    // Î™®Îç∏Î≥Ñ Ìà¨ÏûÖÏàòÎüâ ÌïÑÌÑ∞
    const dmvf=document.getElementById('dModelVolFilter');if(dmvf){dmvf.innerHTML='';
        ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(m=>{
            const b=document.createElement('button');b.className='mini-btn'+(dModelVolFilter===m?' active':'');
            b.innerText=m==='Ï†ÑÏ≤¥'?all:m;b.onclick=()=>{dModelVolFilter=m;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};dmvf.appendChild(b);});}
}

function getDailyFiltered(){
    return dailyProdData.filter(d=>{
        if(!d.inspQty||d.inspQty<=0) return false; // 0Í±¥ Ï†úÏô∏
        if(dFilters.dateFrom&&d.date<dFilters.dateFrom)return false;
        if(dFilters.dateTo&&d.date>dFilters.dateTo)return false;
        if(dFilters.product!=='Ï†ÑÏ≤¥'&&d.model!==dFilters.product)return false;
        if(dFilters.team!=='Ï†ÑÏ≤¥'&&getTeam(d.proc)!==dFilters.team)return false;
        if(dFilters.process!=='Ï†ÑÏ≤¥'&&d.proc!==dFilters.process)return false;
        return true;
    });
}
function getDailyDefFiltered(){
    // Î∂àÎüâ Îç∞Ïù¥ÌÑ∞ ÏûêÏ≤¥ÏóêÏÑú qty > 0Ïù∏ Í≤ÉÎßå ÌïÑÌÑ∞ÎßÅ (ÎÇ†Ïßú/Ï†úÌíà/ÌåÄ/Í≥µÏ†ï ÌïÑÌÑ∞ Ï†ÅÏö©)
    return dailyDefectData.filter(d=>{
        if(!d.qty||d.qty<=0)return false;
        if(dFilters.dateFrom&&d.date<dFilters.dateFrom)return false;
        if(dFilters.dateTo&&d.date>dFilters.dateTo)return false;
        if(dFilters.product!=='Ï†ÑÏ≤¥'&&d.model!==dFilters.product)return false;
        if(dFilters.team!=='Ï†ÑÏ≤¥'&&d.team!==dFilters.team)return false;
        if(dFilters.process!=='Ï†ÑÏ≤¥'&&d.proc!==dFilters.process)return false;
        return true;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY UI UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDailyUI(){
    renderDailyFilterBtns();
    const data=getDailyFiltered(), defData=getDailyDefFiltered();
    const smtData=data.filter(d=>['SMD','ROUTER'].includes(d.proc));
    const testData=data.filter(d=>['ATE','PCT','AVI','TC'].includes(d.proc));
    // Ìà¨ÏûÖÏàòÎüâ: SMD Í∏∞Ï§Ä (Ï≤´ Í≥µÏ†ï)ÏúºÎ°úÎßå ÏßëÍ≥Ñ
    const smdData=data.filter(d=>d.proc==='SMD');
    const totalIn=smdData.length>0 ? smdData.reduce((a,b)=>a+b.inspQty,0)
                  : data.filter(d=>d.proc==='ROUTER').reduce((a,b)=>a+b.inspQty,0)||data.reduce((a,b)=>a+b.inspQty,0);
    // ‚îÄ‚îÄ Î∂àÎüâ: Í∞Å Í≥µÏ†ï defectQty Ìï©ÏÇ∞ ‚îÄ‚îÄ
    const totalDef = data.reduce((a,b)=>a+(b.defectQty||0), 0);

    // ‚îÄ‚îÄ SMT ÌåÄÏπ¥Îìú: SMD Í∏∞Ï§Ä Ìà¨ÏûÖ / SMT Ï†ÑÏ≤¥ Î∂àÎüâ Ìï©ÏÇ∞ ‚îÄ‚îÄ
    const smtSmdRows = data.filter(d=>d.proc==='SMD');
    const smtIn = smtSmdRows.reduce((a,b)=>a+b.inspQty,0);
    const smtDef = smtData.reduce((a,b)=>a+(b.defectQty||0), 0);
    // SMT ÏàòÏú®: SMD Ìà¨ÏûÖ Í∏∞Ï§Ä (SMT Ï†ÑÏ≤¥ Î∂àÎüâ Ìè¨Ìï®)
    const smtYield = smtIn>0 ? Math.max(0,(smtIn-smtDef))/smtIn*100 : 0;

    // ‚îÄ‚îÄ TEST ÌåÄÏπ¥Îìú: ATE Í∏∞Ï§Ä Ìà¨ÏûÖ / TEST Ï†ÑÏ≤¥ Î∂àÎüâ Ìï©ÏÇ∞ ‚îÄ‚îÄ
    const testAteRows = data.filter(d=>d.proc==='ATE');
    const testIn = testAteRows.reduce((a,b)=>a+b.inspQty,0);
    const testDef = testData.reduce((a,b)=>a+(b.defectQty||0), 0);
    // TEST ÏàòÏú®: ATE Ìà¨ÏûÖ Í∏∞Ï§Ä (TEST Ï†ÑÏ≤¥ Î∂àÎüâ Ìè¨Ìï®)
    const testYield = testIn>0 ? Math.max(0,(testIn-testDef))/testIn*100 : 0;

    // ‚îÄ‚îÄ Ï¢ÖÌï© ÏàòÏú®/PPM: SMD Í∏∞Ï§Ä Ìà¨ÏûÖ ‚îÄ‚îÄ
    const overallYield = totalIn>0 ? Math.max(0,(totalIn-totalDef))/totalIn*100 : 0;
    // ‚îÄ‚îÄ PPM: ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâÎßå (SMD/ROUTER/AVI) ‚îÄ‚îÄ
    const companyDefProcs = ['SMD','ROUTER','AVI'];
    let ppmDef, ppmIn;
    if(dFilters.process!=='Ï†ÑÏ≤¥'){
        // ÌäπÏ†ï Í≥µÏ†ï ÌïÑÌÑ∞ Ïãú: Ìï¥Îãπ Í≥µÏ†ïÏùò Î∂àÎüâ/Ìà¨ÏûÖÏúºÎ°ú PPM Í≥ÑÏÇ∞
        const procData = data.filter(d=>d.proc===dFilters.process);
        ppmDef = procData.reduce((a,b)=>a+(b.defectQty||0), 0);
        ppmIn = procData.reduce((a,b)=>a+b.inspQty, 0);
    } else {
        // Ï†ÑÏ≤¥: ÎãπÏÇ¨ Í∑ÄÏ±Ö Î∂àÎüâÎßå
        ppmDef = data.filter(d=>companyDefProcs.includes(d.proc)).reduce((a,b)=>a+(b.defectQty||0), 0);
        ppmIn = totalIn;
    }
    const ppm = ppmIn>0 ? ppmDef/ppmIn*1000000 : 0;

    // KPI Ïπ¥Îìú
    document.getElementById('dKpiYield').innerText=overallYield.toFixed(2)+'%';
    document.getElementById('dKpiInput').innerText=totalIn.toLocaleString();
    document.getElementById('dKpiDefect').innerText=totalDef.toLocaleString();
    const dailyTotalDefPpm=totalIn>0?totalDef/totalIn*1000000:0;
    document.getElementById('dKpiDefectPPM').innerText=Math.round(dailyTotalDefPpm).toLocaleString()+' PPM';
    const companyDefQty=data.filter(d=>companyDefProcs.includes(d.proc)).reduce((a,b)=>a+(b.defectQty||0),0);
    document.getElementById('dKpiCompDefect').innerText=companyDefQty.toLocaleString();
    document.getElementById('dKpiPpm').innerText=Math.round(ppm).toLocaleString()+' PPM';
    // ÌåÄ Ïπ¥Îìú
    document.getElementById('smtYield').innerText=smtIn>0?smtYield.toFixed(2)+'%':'‚Äî';
    document.getElementById('smtInput').innerText=smtIn.toLocaleString();
    document.getElementById('smtDefect').innerText=smtDef.toLocaleString();
    document.getElementById('testYield').innerText=testIn>0?testYield.toFixed(2)+'%':'‚Äî';
    document.getElementById('testInput').innerText=testIn.toLocaleString();
    document.getElementById('testDefect').innerText=testDef.toLocaleString();
    // ‚îÄ‚îÄ ÌåÄ Ïπ¥Îìú Í≥µÏ†ïÎ≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ‚îÄ‚îÄ
    const procDetailStyle='display:grid;grid-template-columns:repeat(3,1fr);gap:4px;font-size:11px;text-align:center;';
    const procHeaderStyle='font-size:10px;color:#94a3b8;font-weight:600;padding:2px 0;';
    const procValStyle='font-family:"JetBrains Mono",monospace;font-weight:700;font-size:12px;';
    // SMT Í≥µÏ†ïÎ≥Ñ (SMD, ROUTER)
    const smtDetail=document.getElementById('smtProcDetail');
    if(smtDetail){
        let smtHtml='<div style="'+procDetailStyle+'"><div style="'+procHeaderStyle+'">'+(lang==='ko'?'Í≥µÏ†ï':'Process')+'</div><div style="'+procHeaderStyle+'">'+(lang==='ko'?'ÏàòÏú®':'Yield')+'</div><div style="'+procHeaderStyle+'">'+(lang==='ko'?'Ìà¨ÏûÖ/Î∂àÎüâ':'Input/Defect')+'</div>';
        ['SMD','ROUTER'].forEach(proc=>{
            const pd=data.filter(d=>d.proc===proc);
            const pi=pd.reduce((a,b)=>a+b.inspQty,0);
            const pdef=pd.reduce((a,b)=>a+(b.defectQty||0),0);
            const py=pi>0?((pi-pdef)/pi*100):0;
            const pyOk=py>=99.5;
            smtHtml+='<div style="font-weight:700;color:#8b5cf6;font-size:11px;">'+proc+'</div>';
            smtHtml+='<div style="'+procValStyle+'color:'+(pyOk?'#10b981':'#e11d48')+';">'+(pi>0?py.toFixed(2)+'%':'‚Äî')+'</div>';
            smtHtml+='<div style="'+procValStyle+'color:#334155;">'+pi.toLocaleString()+' / <span style="color:#e11d48;">'+pdef.toLocaleString()+'</span></div>';
        });
        smtHtml+='</div>';
        smtDetail.innerHTML=smtHtml;
    }
    // TEST Í≥µÏ†ïÎ≥Ñ (ATE, PCT, AVI)
    const testDetail=document.getElementById('testProcDetail');
    if(testDetail){
        let testHtml='<div style="'+procDetailStyle+'"><div style="'+procHeaderStyle+'">'+(lang==='ko'?'Í≥µÏ†ï':'Process')+'</div><div style="'+procHeaderStyle+'">'+(lang==='ko'?'ÏàòÏú®':'Yield')+'</div><div style="'+procHeaderStyle+'">'+(lang==='ko'?'Ìà¨ÏûÖ/Î∂àÎüâ':'Input/Defect')+'</div>';
        ['ATE','PCT','AVI','TC'].forEach(proc=>{
            const pd=data.filter(d=>d.proc===proc);
            const pi=pd.reduce((a,b)=>a+b.inspQty,0);
            const pdef=pd.reduce((a,b)=>a+(b.defectQty||0),0);
            const py=pi>0?((pi-pdef)/pi*100):0;
            const pyOk=py>=99.5;
            testHtml+='<div style="font-weight:700;color:#0891b2;font-size:11px;">'+proc+'</div>';
            testHtml+='<div style="'+procValStyle+'color:'+(pyOk?'#10b981':'#e11d48')+';">'+(pi>0?py.toFixed(2)+'%':'‚Äî')+'</div>';
            testHtml+='<div style="'+procValStyle+'color:#334155;">'+pi.toLocaleString()+' / <span style="color:#e11d48;">'+pdef.toLocaleString()+'</span></div>';
        });
        testHtml+='</div>';
        testDetail.innerHTML=testHtml;
    }
    updateDailyTables(data,defData);
    drawDailyCharts(data);
}

// Table-level filter state
let tblFilters={model:'Ï†ÑÏ≤¥',proc:'Ï†ÑÏ≤¥',team:'Ï†ÑÏ≤¥'};
function renderTblFilterBtns(){
    const all=lang==='ko'?'Ï†ÑÏ≤¥':'All';
    const mf=document.getElementById('dTblModelFilter');
    if(mf){mf.innerHTML='';['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(v=>{const b=document.createElement('button');b.className='filter-btn filter-btn-sm'+(tblFilters.model===v?' active':'');b.innerText=v==='Ï†ÑÏ≤¥'?all:v;b.onclick=()=>{tblFilters.model=v;renderTblFilterBtns();updateDailyTables(getDailyFiltered(),getDailyDefFiltered());};mf.appendChild(b);});}
    const pf=document.getElementById('dTblProcFilter');
    if(pf){pf.innerHTML='';['Ï†ÑÏ≤¥','SMD','ROUTER','ATE','PCT','AVI','TC'].forEach(v=>{const b=document.createElement('button');b.className='filter-btn filter-btn-sm'+(tblFilters.proc===v?' active':'');b.innerText=v==='Ï†ÑÏ≤¥'?all:v;b.onclick=()=>{tblFilters.proc=v;renderTblFilterBtns();updateDailyTables(getDailyFiltered(),getDailyDefFiltered());};pf.appendChild(b);});}
    const tf=document.getElementById('dTblTeamFilter');
    if(tf){tf.innerHTML='';[['Ï†ÑÏ≤¥',all],['SMT','SMT'],['TEST','TEST']].forEach(([v,l])=>{const b=document.createElement('button');b.className='filter-btn filter-btn-sm'+(tblFilters.team===v?(v==='SMT'?' active-smt':v==='TEST'?' active-test':' active'):'');b.innerText=l;b.onclick=()=>{tblFilters.team=v;renderTblFilterBtns();updateDailyTables(getDailyFiltered(),getDailyDefFiltered());};tf.appendChild(b);});}
}
function applyTblFilter(data){
    return data.filter(d=>{
        if(tblFilters.model!=='Ï†ÑÏ≤¥'&&d.model!==tblFilters.model) return false;
        if(tblFilters.proc!=='Ï†ÑÏ≤¥'&&d.proc!==tblFilters.proc) return false;
        if(tblFilters.team!=='Ï†ÑÏ≤¥'&&getTeam(d.proc)!==tblFilters.team) return false;
        return true;
    });
}
function updateDailyTables(data,defData){
    renderTblFilterBtns();
    // Production table with table-level filters + sort
    const tbody=document.querySelector('#dTblProd tbody');
    const tblData=applyTblFilter(data);
    if(!tblData.length){
        tbody.innerHTML=`<tr><td colspan="8" class="daily-no-data">üì≠ ${lang==='ko'?'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå ‚Äî ÏùºÎ≥Ñ ÏÉùÏÇ∞ ÏûÖÎ†• Î≤ÑÌäºÏúºÎ°ú Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî':'No data ‚Äî use Daily Prod Entry'}</td></tr>`;
    } else {
        const sortVal=(document.getElementById('dTblSort')||{}).value||'date-desc';
        const sorted=[...tblData].sort((a,b)=>{
            const ya=a.inspQty>0?a.goodQty/a.inspQty*100:0;
            const yb=b.inspQty>0?b.goodQty/b.inspQty*100:0;
            if(sortVal==='date-desc') return a.date>b.date?-1:1;
            if(sortVal==='date-asc') return a.date<b.date?-1:1;
            if(sortVal==='yield-asc') return ya-yb;
            if(sortVal==='yield-desc') return yb-ya;
            if(sortVal==='defect-desc') return b.defectQty-a.defectQty;
            return 0;
        });
        tbody.innerHTML=sorted.map(d=>{
            const y=d.inspQty>0?d.goodQty/d.inspQty*100:0,ok=y>=99.5;
            return`<tr>
                <td><strong>${d.date}</strong></td>
                <td>${d.model}</td><td>${d.proc}</td>
                <td>${getTeamBadge(d.proc)}</td>
                <td style="text-align:right;font-family:'JetBrains Mono',monospace">${d.inspQty.toLocaleString()}</td>
                <td style="text-align:right;font-family:'JetBrains Mono',monospace">${d.goodQty.toLocaleString()}</td>
                <td style="text-align:right;font-family:'JetBrains Mono',monospace;color:#e11d48">${d.defectQty.toLocaleString()}</td>
                <td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td>
            </tr>`;
        }).join('');
        const cnt=document.getElementById('dTblProdCount');
        if(cnt) cnt.innerText=(lang==='ko'?`${sorted.length}Í±¥ / Ï†ÑÏ≤¥ ${tblData.length}Í±¥`:`${sorted.length} / ${tblData.length} records`);
    }
    // Defect code table
    const dtbody=document.querySelector('#dTblDefect tbody');
    const fDef=dDefectTeamFilter==='Ï†ÑÏ≤¥'?defData:defData.filter(d=>d.team===dDefectTeamFilter);
    if(!fDef.length){
        dtbody.innerHTML=`<tr><td colspan="4" class="daily-no-data">${lang==='ko'?'Î∂àÎüâ ÏΩîÎìú Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå':'No defect code data'}</td></tr>`;
        return;
    }
    const codeMap={};
    fDef.forEach(d=>{if(!codeMap[d.defectCode])codeMap[d.defectCode]={code:d.defectCode,name:d.defectName,team:d.team,qty:0};codeMap[d.defectCode].qty+=d.qty;});
    dtbody.innerHTML=Object.values(codeMap).sort((a,b)=>b.qty-a.qty).map(r=>
        `<tr><td style="font-family:'JetBrains Mono',monospace;font-weight:700;color:#4f46e5">${r.code}</td>
         <td style="font-size:12px;">${r.name}</td>
         <td>${getTeamBadge(r.team==='SMT'?'SMD':'ATE')}</td>
         <td style="font-family:'JetBrains Mono',monospace;font-weight:700;color:#e11d48">${r.qty.toLocaleString()}</td></tr>`
    ).join('');
}

function drawDailyCharts(data){
    Object.values(dCharts).forEach(c=>c&&c.destroy());dCharts={};
    const defData=getDailyDefFiltered();
    const bOpts={responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{boxWidth:10,boxHeight:10,padding:10,font:{size:11,weight:'600',family:'Noto Sans KR,Inter,sans-serif'},usePointStyle:true,pointStyleWidth:8}},
        datalabels:{display:false}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10,family:'Noto Sans KR,Inter,sans-serif',weight:'600'},color:'#94a3b8',maxRotation:45},border:{display:false}},
        y:{grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}};
    try{
        const dates=[...new Set(data.map(d=>d.date))].sort();
        if(!dates.length) return;
        // ‚îÄ‚îÄ Yield Trend with DATA LABELS ‚îÄ‚îÄ
        const isTeam=['SMT','TEST'].includes(dYieldFilter);
        const isProc=['SMD','ROUTER','ATE','PCT','AVI','TC'].includes(dYieldFilter);
        let yDS;
        if(isTeam){
            const procs=dYieldFilter==='SMT'?['SMD','ROUTER']:['ATE','PCT','AVI','TC'];
            const c=dYieldFilter==='SMT'?'#6366f1':'#0891b2';
            yDS=[{label:dYieldFilter,data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&procs.includes(r.proc));const i=d.reduce((a,b)=>a+b.inspQty,0);const g=d.reduce((a,b)=>a+b.goodQty,0);return i>0?+(g/i*100).toFixed(2):null;}),borderColor:c,fill:false,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
        } else if(isProc){
            const c={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981',TC:'#f97316'}[dYieldFilter]||'#6366f1';
            yDS=[{label:dYieldFilter,data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.proc===dYieldFilter);const i=d.reduce((a,b)=>a+b.inspQty,0);const g=d.reduce((a,b)=>a+b.goodQty,0);return i>0?+(g/i*100).toFixed(2):null;}),borderColor:c,fill:false,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
        } else {
            const models=dYieldFilter==='Ï†ÑÏ≤¥'?['RDIMM','SODIMM','UDIMM']:[dYieldFilter];
            const pColors={RDIMM:'#f43f5e',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
            yDS=models.map(p=>({label:p,borderColor:pColors[p]||'#6366f1',fill:false,tension:.4,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'white',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.model===p);const i=d.reduce((a,b)=>a+b.inspQty,0);const g=d.reduce((a,b)=>a+b.goodQty,0);return i>0?+(g/i*100).toFixed(2):null;})}));
        }
        const yLabelOpts={display:ctx=>ctx.dataset.data[ctx.dataIndex]!==null,color:ctx=>{const c=['#f43f5e','#0891b2','#f59e0b','#6366f1','#10b981'];return c[ctx.datasetIndex]||'#334155';},backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:3,right:8,bottom:3,left:8},font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},anchor:'end',align:'top',offset:6,clip:false,formatter:v=>v?v.toFixed(2)+'%':''};
        dCharts.yield=new Chart(document.getElementById('dChartYield'),{type:'line',data:{labels:smartDateLabels(dates),datasets:yDS},options:{...bOpts,layout:{padding:{top:40,right:50,bottom:10,left:20}},plugins:{...bOpts.plugins,datalabels:yLabelOpts},scales:{...bOpts.scales,x:{...bOpts.scales.x,offset:true},y:{...bOpts.scales.y,max:101,min:99,afterDataLimits:(axis)=>{
                        axis.max=101;
                        // ÏµúÏÜüÍ∞íÏù¥ 99 ÎØ∏ÎßåÏù¥Î©¥ Îç∞Ïù¥ÌÑ∞Ïóê ÎßûÏ∂∞ ÏÇ¥Ïßù Ï°∞Ï†ï
                        const allVals=[];
                        axis.chart.data.datasets.forEach(ds=>{ds.data.forEach(v=>{if(v!==null&&v!==undefined)allVals.push(v);});});
                        if(allVals.length){const minVal=Math.min(...allVals);axis.min=minVal<99?Math.floor(minVal-0.5):99;}
                        else{axis.min=99;}
                    }}}}});

        // ‚îÄ‚îÄ Volume Trend (SMD Í∏∞Ï§Ä Ìà¨ÏûÖÏàòÎüâ per day+model) ‚îÄ‚îÄ
        const models2=dVolFilter==='Ï†ÑÏ≤¥'?['RDIMM','SODIMM','UDIMM']:[dVolFilter];
        const vColors={RDIMM:'#6366f1',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
        // SMD Í∏∞Ï§Ä: ÎÇ†Ïßú+Î™®Îç∏Î≥Ñ SMD Ìà¨ÏûÖÏàòÎüâÎßå ÏÇ¨Ïö© (ÏóÜÏúºÎ©¥ Ï≤´Î≤àÏß∏ Í≥µÏ†ï)
        const getVolForDateModel=(dt,model)=>{
            const smdRow=data.find(r=>r.date===dt&&r.model===model&&r.proc==='SMD');
            if(smdRow) return smdRow.inspQty;
            const rows=data.filter(r=>r.date===dt&&r.model===model);
            if(!rows.length) return 0;
            rows.sort((a,b)=>['SMD','ROUTER','ATE','PCT','AVI','TC'].indexOf(a.proc)-['SMD','ROUTER','ATE','PCT','AVI','TC'].indexOf(b.proc));
            return rows[0].inspQty;
        };
        const vDS=models2.map(m=>({label:m,data:dates.map(dt=>getVolForDateModel(dt,m)),backgroundColor:vColors[m]||'#6366f1',borderRadius:4,borderSkipped:false,stack:'v0',
            datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',font:{weight:'700',size:10,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}}));
        const vTotals=dates.map(dt=>models2.reduce((s,m)=>s+getVolForDateModel(dt,m),0));
        dCharts.vol=new Chart(document.getElementById('dChartVol'),{type:'bar',data:{labels:smartDateLabels(dates),datasets:[...vDS,{type:'line',label:'Total',data:vTotals,borderColor:'transparent',backgroundColor:'transparent',pointRadius:0,order:-1,datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'end',align:'top',color:'#334155',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:3,right:7,bottom:3,left:7},font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():'',offset:6}}]},options:{...bOpts,layout:{padding:{top:36,right:10}},plugins:{...bOpts.plugins,legend:{...bOpts.plugins.legend,labels:{...bOpts.plugins.legend.labels,filter:item=>item.text!=='Total'}},datalabels:{display:false}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}});
        // ‚îÄ‚îÄ Daily PPM Trend (shares dYieldFilter) ‚îÄ‚îÄ
        if(document.getElementById('dChartPpm')){
            const isTeamPpm=['SMT','TEST'].includes(dYieldFilter);
            const isProcPpm=['SMD','ROUTER','ATE','PCT','AVI','TC'].includes(dYieldFilter);
            let ppmDS;
            if(isTeamPpm){
                const procs=dYieldFilter==='SMT'?['SMD','ROUTER']:['ATE','PCT','AVI','TC'];
                const c=dYieldFilter==='SMT'?'#6366f1':'#0891b2';
                ppmDS=[{label:dYieldFilter+' PPM',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&procs.includes(r.proc));const i=d.reduce((a,b)=>a+b.inspQty,0);const def=d.reduce((a,b)=>a+(b.defectQty||0),0);return i>0?Math.round(def/i*1000000):null;}),borderColor:c,backgroundColor:c+'12',fill:true,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
            } else if(isProcPpm){
                const c={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981',TC:'#f97316'}[dYieldFilter]||'#6366f1';
                ppmDS=[{label:dYieldFilter+' PPM',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.proc===dYieldFilter);const i=d.reduce((a,b)=>a+b.inspQty,0);const def=d.reduce((a,b)=>a+(b.defectQty||0),0);return i>0?Math.round(def/i*1000000):null;}),borderColor:c,backgroundColor:c+'12',fill:true,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
            } else {
                const models=dYieldFilter==='Ï†ÑÏ≤¥'?['RDIMM','SODIMM','UDIMM']:[dYieldFilter];
                const pColors={RDIMM:'#f43f5e',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
                ppmDS=models.map(p=>({label:p+' PPM',borderColor:pColors[p]||'#6366f1',backgroundColor:(pColors[p]||'#6366f1')+'12',fill:true,tension:.4,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'white',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.model===p);const i=d.reduce((a,b)=>a+b.inspQty,0);const def=d.reduce((a,b)=>a+(b.defectQty||0),0);return i>0?Math.round(def/i*1000000):null;})}));
            }
            const ppmLabelOpts={display:ctx=>ctx.dataset.data[ctx.dataIndex]!==null,color:ctx=>{const c=['#f43f5e','#0891b2','#f59e0b','#6366f1','#10b981'];return c[ctx.datasetIndex]||'#334155';},backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:3,right:8,bottom:3,left:8},font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},anchor:'end',align:'top',offset:6,clip:false,formatter:v=>v!==null?v.toLocaleString():''};
            dCharts.ppm=new Chart(document.getElementById('dChartPpm'),{type:'line',data:{labels:smartDateLabels(dates),datasets:ppmDS},options:{...bOpts,layout:{padding:{top:40,right:50,bottom:10,left:20}},plugins:{...bOpts.plugins,datalabels:ppmLabelOpts},scales:{...bOpts.scales,x:{...bOpts.scales.x,offset:true},y:{...bOpts.scales.y,beginAtZero:true,grace:'20%'}}}});
        }

        // ‚îÄ‚îÄ FIX 8: Daily Production by Process chart ‚îÄ‚îÄ
        const procColors={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981',TC:'#f97316'};
        const procs2=['SMD','ROUTER','ATE','PCT','AVI','TC'];
        const pDS=procs2.map(p=>({label:p,data:dates.map(dt=>data.filter(r=>r.date===dt&&r.proc===p).reduce((a,b)=>a+b.inspQty,0)),backgroundColor:procColors[p],borderRadius:3,borderSkipped:false,stack:'p0',
            datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',font:{weight:'700',size:9,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}}));
        if(document.getElementById('dChartProcVol')){
            if(dCharts.procVol) dCharts.procVol.destroy();
            dCharts.procVol=new Chart(document.getElementById('dChartProcVol'),{type:'bar',data:{labels:smartDateLabels(dates),datasets:pDS},options:{...bOpts,layout:{padding:{top:10}},plugins:{...bOpts.plugins,datalabels:{display:false}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}});
        }

        // ‚îÄ‚îÄ Defect Bar & Pie ‚îÄ‚îÄ
        const fDef=dDefectTeamFilter==='Ï†ÑÏ≤¥'?defData:defData.filter(d=>d.team===dDefectTeamFilter);
        const codeMap={};fDef.forEach(d=>{if(!codeMap[d.defectCode])codeMap[d.defectCode]={name:d.defectName,team:d.team,qty:0};codeMap[d.defectCode].qty+=d.qty;});
        const top10=Object.entries(codeMap).sort((a,b)=>b[1].qty-a[1].qty).slice(0,10);
        if(top10.length){
            const dColors=top10.map(([,v])=>v.team==='SMT'?'rgba(99,102,241,0.85)':'rgba(8,145,178,0.85)');
            dCharts.defBar=new Chart(document.getElementById('dChartDefectBar'),{type:'bar',data:{labels:top10.map(([k,v])=>`${k} ${v.name.slice(0,18)}`),datasets:[{label:lang==='ko'?'Î∂àÎüâ ÏàòÎüâ':'Defect Qty',data:top10.map(([,v])=>v.qty),backgroundColor:dColors,borderRadius:4,borderSkipped:false}]},options:{...bOpts,indexAxis:'y',layout:{padding:{right:60}},plugins:{...bOpts.plugins,legend:{display:false},datalabels:{display:true,anchor:'end',align:'end',color:'#334155',font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},formatter:v=>v.toLocaleString()}},scales:{x:{grid:{display:false},ticks:{font:{size:11,family:'JetBrains Mono,monospace'},color:'#94a3b8'},border:{display:false}},y:{grid:{display:false},ticks:{font:{size:11,family:'JetBrains Mono,monospace',weight:'600'},color:'#334155'},border:{display:false}}}}});
            const pieColors=['#6366f1','#0891b2','#f59e0b','#10b981','#ec4899','#8b5cf6','#ef4444','#06b6d4','#84cc16','#f97316'];
            const pieLabels=top10.map(([k,v])=>`${k} ${v.name.slice(0,20)}`);
            dCharts.defPie=new Chart(document.getElementById('dChartDefectPie'),{type:'doughnut',data:{labels:pieLabels,datasets:[{data:top10.map(([,v])=>v.qty),backgroundColor:top10.map(([,v],i)=>v.team==='SMT'?['#6366f1','#8b5cf6','#a78bfa','#c4b5fd','#e0e7ff'][i%5]:['#0891b2','#06b6d4','#22d3ee','#67e8f9','#cffafe'][i%5]),borderWidth:3,borderColor:'white',hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'45%',layout:{padding:{top:8,bottom:8,left:8,right:8}},plugins:{legend:{position:'bottom',align:'start',labels:{font:{size:10,family:'JetBrains Mono,monospace',weight:'600'},padding:6,usePointStyle:true,pointStyleWidth:8,boxWidth:10,boxHeight:10,generateLabels:(chart)=>{const data=chart.data;return data.labels.map((l,i)=>({text:l,fillStyle:data.datasets[0].backgroundColor[i],strokeStyle:'white',lineWidth:1,pointStyle:'circle',index:i}));}}},datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]/ctx.dataset.data.reduce((a,b)=>a+b,0)>0.03,color:'white',font:{weight:'800',size:11,family:'JetBrains Mono,monospace'},textStrokeColor:'rgba(0,0,0,0.5)',textStrokeWidth:3,formatter:(v,ctx)=>{const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);return v>0?(v*100/total).toFixed(1)+'%':'';},anchor:'center',align:'center'}}}});
        }
        // ‚îÄ‚îÄ FIX: ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ ÏÑπÏÖò Ï∞®Ìä∏ ‚îÄ‚îÄ
        const tblData2 = getDailyFiltered(); // ÌÖåÏù¥Î∏î ÌïÑÌÑ∞ÏôÄ Î¨¥Í¥ÄÌïòÍ≤å Ï†ÑÏ≤¥ ÏÇ¨Ïö©
        if(tblData2.length){
            // (1) Í≥µÏ†ïÎ≥Ñ Ìà¨ÏûÖÏàòÎüâ (ÎÇ†Ïßú xÏ∂ï, Í≥µÏ†ï Ïä§ÌÉù)
            const pColors2={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981',TC:'#f97316'};
            const allDates=[...new Set(tblData2.map(d=>d.date))].sort();
            const procDS=['SMD','ROUTER','ATE','PCT','AVI','TC'].map(p=>({
                label:p, backgroundColor:pColors2[p], borderRadius:3, borderSkipped:false, stack:'pp',
                hidden:dProcVolFilter!=='Ï†ÑÏ≤¥'&&p!==dProcVolFilter,
                data:allDates.map(dt=>tblData2.filter(r=>r.date===dt&&r.proc===p).reduce((a,b)=>a+b.inspQty,0)),
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',font:{weight:'700',size:9,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}
            }));
            if(dCharts.prodByProc){dCharts.prodByProc.destroy();}
            if(document.getElementById('dChartProdByProc')){
                dCharts.prodByProc=new Chart(document.getElementById('dChartProdByProc'),{
                    type:'bar',data:{labels:smartDateLabels(allDates),datasets:procDS},
                    options:{...bOpts,layout:{padding:{top:10}},plugins:{...bOpts.plugins,datalabels:{display:false}},
                    scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},
                            y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}
                });
            }
            // (2) Î™®Îç∏Î≥Ñ Ìà¨ÏûÖÏàòÎüâ (SMD Í∏∞Ï§Ä)
            const mColors2={RDIMM:'#6366f1',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
            const modelDS2=['RDIMM','SODIMM','UDIMM'].map(m=>({
                label:m, backgroundColor:mColors2[m], borderRadius:3, borderSkipped:false, stack:'mm',
                hidden:dModelVolFilter!=='Ï†ÑÏ≤¥'&&m!==dModelVolFilter,
                data:allDates.map(dt=>{
                    // SMD Í∏∞Ï§Ä Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ Ï≤´Î≤àÏß∏ Í≥µÏ†ï
                    const smdRow=tblData2.find(r=>r.date===dt&&r.model===m&&r.proc==='SMD');
                    if(smdRow) return smdRow.inspQty;
                    const rows=tblData2.filter(r=>r.date===dt&&r.model===m);
                    if(!rows.length) return 0;
                    rows.sort((a,b)=>['SMD','ROUTER','ATE','PCT','AVI','TC'].indexOf(a.proc)-['SMD','ROUTER','ATE','PCT','AVI','TC'].indexOf(b.proc));
                    return rows[0].inspQty;
                }),
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',font:{weight:'700',size:9,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}
            }));
            if(dCharts.prodByModel){dCharts.prodByModel.destroy();}
            if(document.getElementById('dChartProdByModel')){
                dCharts.prodByModel=new Chart(document.getElementById('dChartProdByModel'),{
                    type:'bar',data:{labels:smartDateLabels(allDates),datasets:modelDS2},
                    options:{...bOpts,layout:{padding:{top:10}},plugins:{...bOpts.plugins,datalabels:{display:false}},
                    scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},
                            y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}
                });
            }
            // (3) ÎÇ†ÏßúÎ≥Ñ ÏàòÏú® & Î∂àÎüâ Î≥µÌï© Ï∞®Ìä∏ (SMD Í∏∞Ï§Ä Ï†ÑÏ≤¥ ÏàòÏú® ÎùºÏù∏ + Î∂àÎüâ ÎßâÎåÄ)
            // Î™®Îç∏ ÌïÑÌÑ∞
            const pdMF=document.getElementById('dProdChartModelFilter');
            if(pdMF&&!pdMF.dataset.init){
                pdMF.dataset.init='1';
                ['Ï†ÑÏ≤¥','RDIMM','SODIMM','UDIMM'].forEach(m=>{
                    const b=document.createElement('button');
                    b.className='mini-btn'+(m==='Ï†ÑÏ≤¥'?' active':'');
                    b.innerText=m==='Ï†ÑÏ≤¥'?(lang==='ko'?'Ï†ÑÏ≤¥':'All'):m;
                    b.dataset.model=m;
                    b.onclick=()=>{
                        pdMF.querySelectorAll('.mini-btn').forEach(x=>x.classList.remove('active'));
                        b.classList.add('active');
                        drawProdYieldDefChart(b.dataset.model);
                    };
                    pdMF.appendChild(b);
                });
            }
            drawProdYieldDefChart('Ï†ÑÏ≤¥');
        }
    }catch(e){console.error('ÏùºÎ≥Ñ Ï∞®Ìä∏ Ïò§Î•ò:',e);}
}

function drawProdYieldDefChart(modelFilter){
    if(dCharts.prodYieldDef){dCharts.prodYieldDef.destroy();}
    const canvas=document.getElementById('dChartProdYieldDef');
    if(!canvas) return;
    const data=getDailyFiltered().filter(d=>modelFilter==='Ï†ÑÏ≤¥'||d.model===modelFilter);
    const allDates=[...new Set(data.map(d=>d.date))].sort();
    if(!allDates.length) return;
    const procOrder=['SMD','ROUTER','ATE','PCT','AVI','TC'];
    // ÎÇ†ÏßúÎ≥Ñ SMD Í∏∞Ï§Ä Ìà¨ÏûÖ, Ï†ÑÏ≤¥ Î∂àÎüâ
    const dateInsp=allDates.map(dt=>{
        const smdRows=data.filter(r=>r.date===dt&&r.proc==='SMD');
        if(smdRows.length) return smdRows.reduce((a,b)=>a+b.inspQty,0);
        const rows=data.filter(r=>r.date===dt);
        if(!rows.length) return 0;
        rows.sort((a,b)=>procOrder.indexOf(a.proc)-procOrder.indexOf(b.proc));
        return rows[0]?.inspQty||0;
    });
    const dateDef=allDates.map(dt=>data.filter(r=>r.date===dt).reduce((a,b)=>a+(b.defectQty||0),0));
    const dateYield=allDates.map((dt,i)=>dateInsp[i]>0?+((dateInsp[i]-dateDef[i])/dateInsp[i]*100).toFixed(2):null);
    dCharts.prodYieldDef=new Chart(canvas,{
        type:'bar',
        data:{labels:smartDateLabels(allDates),datasets:[
            {type:'line',label:lang==='ko'?'ÏàòÏú®(%)':'Yield(%)',data:dateYield,borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.05)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'white',pointBorderColor:'#6366f1',pointBorderWidth:2,yAxisID:'y1',
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]!==null,anchor:'end',align:'top',color:'#6366f1',backgroundColor:'rgba(255,255,255,0.9)',borderRadius:5,padding:{top:2,right:6,bottom:2,left:6},font:{weight:'700',size:10,family:'JetBrains Mono,monospace'},formatter:v=>v?v.toFixed(2)+'%':'',offset:4,clip:false}},
            {type:'bar',label:lang==='ko'?'Î∂àÎüâÏàò':'Defects',data:dateDef,backgroundColor:'rgba(244,63,94,0.75)',borderRadius:4,borderSkipped:false,yAxisID:'y2',
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'end',align:'top',color:'#e11d48',font:{weight:'700',size:10,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}}
        ]},
        options:{responsive:true,maintainAspectRatio:false,
            layout:{padding:{top:36,right:20,bottom:0,left:10}},
            plugins:{legend:{position:'bottom',labels:{font:{size:11,family:'Noto Sans KR,sans-serif',weight:'600'},usePointStyle:true,padding:12}},
                     datalabels:{display:false}},
            scales:{
                x:{grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},
                y1:{position:'left',min:90,max:101,grid:{color:'#f1f5f9'},ticks:{font:{size:10},color:'#6366f1'},border:{display:false},title:{display:true,text:lang==='ko'?'ÏàòÏú®(%)':'Yield(%)',color:'#6366f1',font:{size:10,weight:'700'}}},
                y2:{position:'right',min:0,grid:{display:false},ticks:{font:{size:10},color:'#e11d48'},border:{display:false},title:{display:true,text:lang==='ko'?'Î∂àÎüâÏàò':'Defects',color:'#e11d48',font:{size:10,weight:'700'}}}
            }
        }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY PROD MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDailyProdModal(){
    requirePassword(()=>{
        document.getElementById('modalDailyProd').style.display='block';
        if(!document.querySelector('#tblDailyProdEntry tbody tr')) addDailyProdRow();
    });
}

function addDailyProdRow(date='',model='',proc='',insp='',good='',def=''){
    const today=new Date().toISOString().slice(0,10);
    const tbody=document.querySelector('#tblDailyProdEntry tbody');
    const tr=document.createElement('tr');
    tr.innerHTML=`
        <td><input type="date" style="padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;width:138px;" value="${date||today}"></td>
        <td><select style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;">
            <option value="">${lang==='ko'?'ÏÑ†ÌÉù':'Select'}</option>
            <option value="RDIMM"${model==='RDIMM'?' selected':''}>RDIMM</option>
            <option value="SODIMM"${model==='SODIMM'?' selected':''}>SODIMM</option>
            <option value="UDIMM"${model==='UDIMM'?' selected':''}>UDIMM</option>
        </select></td>
        <td><select style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;" onchange="this.closest('tr').querySelector('.tc').innerHTML=getTeamBadge(this.value)">
            <option value="">${lang==='ko'?'ÏÑ†ÌÉù':'Select'}</option>
            <option value="SMD"${proc==='SMD'?' selected':''}>SMD</option>
            <option value="ROUTER"${proc==='ROUTER'?' selected':''}>ROUTER</option>
            <option value="ATE"${proc==='ATE'?' selected':''}>ATE</option>
            <option value="PCT"${proc==='PCT'?' selected':''}>PCT</option>
            <option value="AVI"${proc==='AVI'?' selected':''}>AVI</option>
            <option value="TC"${proc==='TC'?' selected':''}>TC</option>
        </select></td>
        <td class="tc">${getTeamBadge(proc)}</td>
        <td><input type="number" style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" value="${insp}" placeholder="${lang==='ko'?'Ìà¨ÏûÖ':'Input'}" min="0"></td>
        <td><input type="number" style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" value="${good}" placeholder="${lang==='ko'?'ÏñëÌíà':'Good'}" min="0"></td>
        <td><input type="number" style="width:80px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" value="${def}" placeholder="0" min="0"></td>
        <td><button class="btn-del" onclick="this.closest('tr').remove()">${lang==='ko'?'ÏÇ≠Ï†ú':'Del'}</button></td>`;
    tbody.appendChild(tr);
    tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function parseDailyPaste(){
    const raw=document.getElementById('pasteDailyProd').value.trim();if(!raw)return;
    const rows=raw.split('\n').filter(r=>r.trim());
    document.querySelector('#tblDailyProdEntry tbody').innerHTML='';
    let skipped=0;
    rows.forEach(r=>{
        const c=r.split('\t').map(x=>x.trim());
        // Excel ÏàúÏÑú: ÎÇ†Ïßú(0) | Î™®Îç∏(1) | Í≥µÏ†ï(2) | ÌåÄ(3) | Ìà¨ÏûÖÏàòÎüâ(4) | ÏñëÌíàÏàòÎüâ(5) | Î∂àÎüâÏàòÎüâ(6)
        const insp=Number(c[4])||0;
        // Ìà¨ÏûÖÏàòÎüâ 0Ïù∏ ÌñâÏùÄ Í±¥ÎÑàÎúÄ
        if(insp<=0){skipped++;return;}
        // addDailyProdRow(date, model, proc, insp, good, def) - ÌåÄ(c[3])ÏùÄ ÏûêÎèô Í≥ÑÏÇ∞ÎêòÎØÄÎ°ú Í±¥ÎÑàÎúÄ
        addDailyProdRow(c[0]||'',c[1]||'',c[2]||'',c[4]||'',c[5]||'',c[6]||'');
    });
    document.getElementById('pasteDailyProd').value='';
    if(skipped>0){
        const hint=document.getElementById('pasteSkipHint');
        if(hint) hint.innerText=(lang==='ko'?`‚ÑπÔ∏è Ìà¨ÏûÖÏàòÎüâ 0Ïù∏ ${skipped}ÌñâÏùÄ Ï†úÏô∏ÎêòÏóàÏäµÎãàÎã§`:`‚ÑπÔ∏è ${skipped} zero-qty rows skipped`);
        setTimeout(()=>{const h=document.getElementById('pasteSkipHint');if(h)h.innerText='';},4000);
    }
}

function clearAllDailyProdData(){
    const msg=lang==='ko'?'‚ö†Ô∏è Firebase ÏùºÎ≥Ñ ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÎ∂Ä ÏÇ≠Ï†úÌï©ÎãàÎã§. Î≥µÍµ¨ Î∂àÍ∞Ä. Í≥ÑÏÜç?':'‚ö†Ô∏è DELETE ALL daily production data? Cannot be undone.';
    if(!confirm(msg))return;
    saveToFirebase('dprod',[]).then(()=>{
        alert(lang==='ko'?'‚úÖ ÏùºÎ≥Ñ ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä Î™®Îëê ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.':'‚úÖ All daily production data deleted.');
        document.getElementById('modalDailyProd').style.display='none';
    });
}

function saveDailyProd(){
    const rows=document.querySelectorAll('#tblDailyProdEntry tbody tr');
    const newData=[];
    rows.forEach(r=>{
        const sels=r.querySelectorAll('select');
        const inps=r.querySelectorAll('input');
        const model=sels[0]?.value, proc=sels[1]?.value;
        const date=inps[0]?.value;
        const insp=cleanNum(inps[1]?.value);
        const goodRaw=inps[2]?.value.trim();
        const defRaw=inps[3]?.value.trim();
        const def=cleanNum(defRaw);
        // goodQty: Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏûÖÎ†•Îêú Í≤ΩÏö∞ Í∑∏ Í∞í ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ insp-def Í≥ÑÏÇ∞
        const good = goodRaw!=='' ? cleanNum(goodRaw) : Math.max(0, insp - def);
        if(!model||!proc||!date||insp<=0) return; // 0Í±¥ Ìñâ Ï†úÏô∏
        // Í∏∞Î≥∏ Í≤ÄÏ¶ù
        if(good < 0 || def < 0 || good > insp){
            console.warn(`Í±¥ÎÑàÎúÄ: ${date} ${model} ${proc} - ÏàòÎüâ Ïò§Î•ò (Ìà¨ÏûÖ:${insp} ÏñëÌíà:${good} Î∂àÎüâ:${def})`);
            return;
        }
        newData.push({model,date,proc,team:getTeam(proc),inspQty:insp,goodQty:good,defectQty:Math.max(0,insp-good),month:extractYM(date)});
    });
    if(!newData.length){alert(lang==='ko'?'Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. (Ìà¨ÏûÖÏàòÎüâ > 0 Ïù¥Ïñ¥Ïïº Ìï©ÎãàÎã§)':'No valid data. (Input Qty must be > 0)');return;}
    
    // ‚òÖ ÌïµÏã¨: ÏûÖÎ†•Ìïú Î™®Îç∏+Í≥µÏ†ï Ï°∞Ìï©ÏùÑ ÌÜµÏß∏Î°ú ÍµêÏ≤¥
    // - ÏÉàÎ°ú ÏûÖÎ†•Îêú Î™®Îç∏+Í≥µÏ†ï Ï°∞Ìï©Ïóê Ìï¥ÎãπÌïòÎäî Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï†ÑÎ∂Ä ÏÇ≠Ï†ú
    // - ÏûÖÎ†•ÌïòÏßÄ ÏïäÏùÄ Î™®Îç∏+Í≥µÏ†ï Ï°∞Ìï©ÏùÄ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
    // ‚Üí Firebase Ïò§Ïóº Îç∞Ïù¥ÌÑ∞Í∞Ä ÎÇ®Îäî Î¨∏Ï†ú ÏôÑÏ†Ñ Ìï¥Í≤∞
    const newModelProcs = new Set(newData.map(d=>d.model+'|'+d.proc));
    const kept = dailyProdData.filter(d=>!newModelProcs.has(d.model+'|'+d.proc));
    const merged = [...kept, ...newData];
    
    const msg=lang==='ko'
        ? `‚úÖ Ï†ÄÏû• ÏôÑÎ£å! (${newData.length}Í±¥)
ÍµêÏ≤¥Îêú Î™®Îç∏+Í≥µÏ†ï: ${[...newModelProcs].join(', ')}`
        : `‚úÖ Saved! (${newData.length} records)
Replaced: ${[...newModelProcs].join(', ')}`;
    
    saveToFirebase('dprod',merged).then(()=>{
        document.getElementById('modalDailyProd').style.display='none';
        document.querySelector('#tblDailyProdEntry tbody').innerHTML='';
        alert(msg);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY DEFECT MODAL (with qty limit validation)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDailyDefModal(){
    requirePassword(()=>{
        document.getElementById('modalDailyDef').style.display='block';
        refreshAvailDefects();
        if(!document.querySelector('#tblDailyDefEntry tbody tr')) addDailyDefRow();
    });
}

// Build a lookup: date+model+proc ‚Üí available defect qty (from dailyProdData minus already-assigned)
function getAvailableDefects(){
    const available={};
    dailyProdData.forEach(d=>{
        const key=`${d.date}|${d.model}|${d.proc}`;
        if(!available[key]) available[key]={date:d.date,model:d.model,proc:d.proc,team:getTeam(d.proc),total:d.defectQty,assigned:0};
        else available[key].total+=d.defectQty;
    });
    dailyDefectData.forEach(d=>{
        const key=`${d.date}|${d.model}|${d.proc}`;
        if(available[key]) available[key].assigned+=d.qty;
    });
    return available;
}

function refreshAvailDefects(){
    const available=getAvailableDefects();
    const panel=document.getElementById('ddefAvailList');
    const items=Object.values(available).filter(a=>a.total>0).sort((a,b)=>a.date<b.date?1:-1);
    if(!items.length){
        panel.innerHTML=lang==='ko'?'<span style="color:#94a3b8">ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞Ïóê Î∂àÎüâ ÏàòÎüâÏù¥ ÏóÜÏäµÎãàÎã§</span>':'<span style="color:#94a3b8">No defect qty in production data</span>';
        return;
    }
    panel.innerHTML=items.map(a=>{
        const rem=a.total-a.assigned;
        const color=rem<=0?'#e11d48':rem<a.total?'#f59e0b':'#16a34a';
        return`<span style="display:inline-block;margin:2px 4px;padding:3px 10px;background:#f0f4fb;border-radius:20px;font-size:11px;font-family:'JetBrains Mono',monospace;border:1px solid ${color}20">
            <strong>${a.date} ${a.model} ${a.proc}</strong>: <span style="color:${color};font-weight:700;">${rem}/${a.total}</span>${lang==='ko'?' ÏûîÏó¨':' left'}</span>`;
    }).join('');
}

function addDailyDefRow(model='',date='',proc='',defCode='',defName='',qty=''){
    const today=new Date().toISOString().slice(0,10);
    const rowId='dr'+Date.now().toString(36)+Math.random().toString(36).slice(2,5);
    const tbody=document.querySelector('#tblDailyDefEntry tbody');
    const tr=document.createElement('tr');
    tr.innerHTML=`
        <td><select style="width:80px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;" onchange="refreshAvailDefects()">
            <option value="">${lang==='ko'?'ÏÑ†ÌÉù':'Sel'}</option>
            <option value="RDIMM"${model==='RDIMM'?' selected':''}>RDIMM</option>
            <option value="SODIMM"${model==='SODIMM'?' selected':''}>SODIMM</option>
            <option value="UDIMM"${model==='UDIMM'?' selected':''}>UDIMM</option>
        </select></td>
        <td><input type="date" style="padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;width:128px;" value="${date||today}" onchange="refreshAvailDefects()"></td>
        <td><select style="width:80px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;" onchange="onDefProcChange(this,'${rowId}')">
            <option value="">${lang==='ko'?'ÏÑ†ÌÉù':'Sel'}</option>
            <option value="SMD"${proc==='SMD'?' selected':''}>SMD</option>
            <option value="ROUTER"${proc==='ROUTER'?' selected':''}>ROUTER</option>
            <option value="ATE"${proc==='ATE'?' selected':''}>ATE</option>
            <option value="PCT"${proc==='PCT'?' selected':''}>PCT</option>
            <option value="AVI"${proc==='AVI'?' selected':''}>AVI</option>
            <option value="TC"${proc==='TC'?' selected':''}>TC</option>
        </select></td>
        <td class="tc-${rowId}">${getTeamBadge(proc)}</td>
        <td><div class="search-select-wrap" id="ssw_${rowId}">
            <input type="text" class="search-select-input" placeholder="${lang==='ko'?'ÏΩîÎìú/Ïù¥Î¶Ñ Í≤ÄÏÉâ...':'Search code/name...'}" 
                value="${defCode?(defCode+' '+defName).trim():''}" data-code="${defCode}" data-name="${defName}"
                oninput="filterDefDD(this,'${rowId}')" onfocus="openDefDD('${rowId}')" autocomplete="off">
            <div class="search-dropdown" id="dd_${rowId}"></div>
        </div></td>
        <td>
            <input type="number" class="def-qty-input" style="width:70px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" 
                value="${qty}" placeholder="0" min="0" 
                oninput="validateDefQty(this,'${rowId}')" onchange="refreshAvailDefects()">
            <div class="def-avail-hint" id="hint_${rowId}" style="font-size:10px;color:#94a3b8;margin-top:2px;text-align:center;"></div>
        </td>
        <td><button class="btn-del" onclick="this.closest('tr').remove();refreshAvailDefects()">${lang==='ko'?'ÏÇ≠Ï†ú':'Del'}</button></td>`;
    tbody.appendChild(tr);
    if(proc) buildDefDD(rowId,proc,'');
    tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function validateDefQty(input,rowId){
    const row=input.closest('tr');
    const sels=row.querySelectorAll('select');
    const dateInp=row.querySelector('input[type="date"]');
    const model=sels[0]?.value,proc=sels[1]?.value,date=dateInp?.value;
    if(!model||!proc||!date){return;}
    const key=`${date}|${model}|${proc}`;
    const available=getAvailableDefects();
    const avail=available[key];
    const hint=document.getElementById('hint_'+rowId);
    if(!avail||avail.total===0){
        if(hint) hint.innerHTML=`<span style="color:#e11d48">${lang==='ko'?'ÏÉùÏÇ∞ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå':'No prod data'}</span>`;
        return;
    }
    // Calculate already entered in this modal for same key (excluding current row)
    let thisRowQty=parseInt(input.value)||0;
    let otherRowsQty=0;
    document.querySelectorAll('#tblDailyDefEntry tbody tr').forEach(r=>{
        if(r===row) return;
        const rs=r.querySelectorAll('select');
        const rd=r.querySelector('input[type="date"]');
        const rq=r.querySelector('.def-qty-input');
        if(rs[0]?.value===model&&rs[1]?.value===proc&&rd?.value===date){
            otherRowsQty+=parseInt(rq?.value)||0;
        }
    });
    const alreadySaved=avail.assigned;
    const maxAllowed=avail.total-alreadySaved-otherRowsQty;
    if(thisRowQty>maxAllowed){
        input.value=Math.max(0,maxAllowed);
        input.style.borderColor='#e11d48';
        if(hint) hint.innerHTML=`<span style="color:#e11d48">Max: ${maxAllowed}</span>`;
    } else {
        input.style.borderColor=thisRowQty>0?'#10b981':'var(--border)';
        if(hint) hint.innerHTML=avail?`<span style="color:#94a3b8">${lang==='ko'?'Í∞ÄÎä•:':'Avail:'} ${Math.max(0,maxAllowed)}</span>`:'';
    }
}

function onDefProcChange(sel,rowId){
    const proc=sel.value;
    const tc=document.querySelector('.tc-'+rowId);
    if(tc) tc.innerHTML=getTeamBadge(proc);
    buildDefDD(rowId,proc,'');
    refreshAvailDefects();
}

function buildDefDD(rowId,proc,query){
    const dd=document.getElementById('dd_'+rowId);if(!dd)return;
    const codes=getDefectsForProc(proc);
    const q=(query||'').toLowerCase();
    const filtered=q?codes.filter(c=>c.code.includes(q)||c.name.toLowerCase().includes(q)):codes;
    dd.innerHTML=filtered.slice(0,25).map(c=>
        `<div class="search-option" onclick="selDefCode('${rowId}','${c.code}','${c.name.replace(/'/g,"\\'")}')">
            <span class="opt-code">${c.code}</span><span class="opt-name">${c.name}</span>
        </div>`
    ).join('');
    if(!filtered.length) dd.innerHTML=`<div class="search-option" style="color:var(--text-muted);cursor:default;">${lang==='ko'?'Í≤∞Í≥º ÏóÜÏùå ‚Äî ÏßÅÏ†ë ÏûÖÎ†• Í∞ÄÎä•':'Not found ‚Äî manual entry OK'}</div>`;
}

function filterDefDD(input,rowId){
    const row=input.closest('tr');
    const proc=row.querySelectorAll('select')[1]?.value||'';
    buildDefDD(rowId,proc,input.value);
    document.getElementById('dd_'+rowId).classList.add('open');
}
function openDefDD(rowId){
    const row=document.getElementById('ssw_'+rowId).closest('tr');
    const proc=row.querySelectorAll('select')[1]?.value||'';
    const val=row.querySelector('.search-select-input')?.value||'';
    buildDefDD(rowId,proc,val);
    document.getElementById('dd_'+rowId).classList.add('open');
}
function selDefCode(rowId,code,name){
    const inp=document.querySelector('#ssw_'+rowId+' input');
    if(inp){inp.value=code+' '+name;inp.dataset.code=code;inp.dataset.name=name;}
    document.getElementById('dd_'+rowId).classList.remove('open');
}
document.addEventListener('click',e=>{
    if(!e.target.closest('.search-select-wrap'))
        document.querySelectorAll('.search-dropdown').forEach(d=>d.classList.remove('open'));
});

function saveDailyDef(){
    const rows=document.querySelectorAll('#tblDailyDefEntry tbody tr');
    const newData=[];
    let valid=true;
    rows.forEach(r=>{
        const sels=r.querySelectorAll('select');
        const dateInp=r.querySelector('input[type="date"]');
        const codeInp=r.querySelector('.search-select-input');
        const qtyInp=r.querySelector('.def-qty-input');
        const model=sels[0]?.value,proc=sels[1]?.value,date=dateInp?.value;
        const raw=codeInp?.value||'';
        const defCode=codeInp?.dataset.code||(raw.split(' ')[0]||'');
        const defName=codeInp?.dataset.name||(raw.split(' ').slice(1).join(' ')||'');
        const qty=cleanNum(qtyInp?.value);
        if(!model||!proc||!date||!defCode){return;}
        if(qty<=0) return;
        newData.push({model,date,proc,team:getTeam(proc),defectCode:defCode,defectName:defName,qty,month:extractYM(date)});
    });
    if(!newData.length){alert(lang==='ko'?'Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.':'No data to save.');return;}
    // Final validation: check totals don't exceed prod data
    const available=getAvailableDefects();
    const checkMap={};
    newData.forEach(d=>{
        const k=`${d.date}|${d.model}|${d.proc}`;
        checkMap[k]=(checkMap[k]||0)+d.qty;
    });
    for(const [k,total] of Object.entries(checkMap)){
        const a=available[k];
        if(a&&(a.assigned+total)>a.total){
            alert(lang==='ko'?`‚ö†Ô∏è [${k.replace(/\|/g,' ')}] Î∂àÎüâ ÏΩîÎìú Ìï©Í≥Ñ(${a.assigned+total})Í∞Ä Î∂àÎüâ ÏàòÎüâ(${a.total})ÏùÑ Ï¥àÍ≥ºÌï©ÎãàÎã§.`:`‚ö†Ô∏è [${k.replace(/\|/g,' ')}] Defect codes total(${a.assigned+total}) exceeds defect qty(${a.total}).`);
            return;
        }
    }
    const merged=[...dailyDefectData,...newData];
    saveToFirebase('ddef',merged).then(()=>{
        document.getElementById('modalDailyDef').style.display='none';
        document.querySelector('#tblDailyDefEntry tbody').innerHTML='';
        alert(lang==='ko'?`‚úÖ ${newData.length}Í±¥Ïùò Î∂àÎüâ ÏΩîÎìúÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`:`‚úÖ ${newData.length} defect code records saved!`);
    });
}

window.onclick=e=>{
    if(e.target.classList.contains('modal')) e.target.style.display='none';
    if(e.target.id==='backupModal') closeBackupModal();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECTION TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSection(bodyId, hdEl){
    const body=document.getElementById(bodyId);
    const icon=hdEl.querySelector('.section-toggle');
    if(!body) return;
    if(body.style.display==='none'){
        body.style.display='';
        if(icon) icon.classList.remove('collapsed');
    } else {
        body.style.display='none';
        if(icon) icon.classList.add('collapsed');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ATTENDANCE VIEW - LOGIN BYPASS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let attOnlyMode=false;
function goAttendance(){
    document.getElementById('loginModal').style.display='none';
    document.getElementById('loadingOverlay').style.display='flex';
    attOnlyMode=true;
    initFirebase();
}

function initAttFilters(){
    const now=new Date(),y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0');
    const from=document.getElementById('attFilterFrom');
    const to=document.getElementById('attFilterTo');
    if(!from.value){
        from.value=`${y}-${m}-01`;
        const last=new Date(y,now.getMonth()+1,0);
        to.value=`${y}-${m}-${String(last.getDate()).padStart(2,'0')}`;
    }
}

function setAttDatePreset(p){
    const now=new Date(),y=now.getFullYear(),m=now.getMonth(),d=now.getDate();
    const from=document.getElementById('attFilterFrom');
    const to=document.getElementById('attFilterTo');
    const fmt=dt=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
    if(p==='today'){from.value=to.value=fmt(now);}
    else if(p==='thisWeek'){
        const day=now.getDay()||7;
        const mon=new Date(y,m,d-day+1);
        const sun=new Date(y,m,d-day+7);
        from.value=fmt(mon);to.value=fmt(sun);
    } else if(p==='thisMonth'){
        from.value=`${y}-${String(m+1).padStart(2,'0')}-01`;
        const last=new Date(y,m+1,0);
        to.value=fmt(last);
    }
    updateAttendanceUI();drawAttendanceCharts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ATTENDANCE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getAttFiltered(){
    const fromEl=document.getElementById('attFilterFrom');
    const toEl=document.getElementById('attFilterTo');
    const from=fromEl?fromEl.value:'', to=toEl?toEl.value:'';
    return attendanceData.filter(d=>{
        if(from&&d.date<from) return false;
        if(to&&d.date>to) return false;
        return true;
    });
}

function openAttendanceModal(){
    document.getElementById('modalAttendance').style.display='block';
    const di=document.getElementById('attDateInput');
    if(di&&!di.value) di.value=new Date().toISOString().slice(0,10);
    attTeamTab=ATT_TEAMS[0];
    renderAttTeamTabs();
    renderAttTeamTab(attTeamTab);
}

function renderAttTeamTabs(){
    const c=document.getElementById('attTeamTabs');
    if(!c) return;
    c.innerHTML=ATT_TEAMS.map(t=>
        `<button class="att-tab${t===attTeamTab?' active':''}" onclick="attTeamTab='${t}';renderAttTeamTabs();renderAttTeamTab('${t}')">${t} (${(teamMembers[t]||[]).length})</button>`
    ).join('');
}

function renderAttTeamTab(team){
    const tbody=document.querySelector('#tblAttEntry tbody');
    if(!tbody) return;
    const members=teamMembers[team]||[];
    const date=document.getElementById('attDateInput')?.value||'';
    const existing=attendanceData.filter(d=>d.date===date&&d.team===team);
    tbody.innerHTML=members.map((m,i)=>{
        const rec=existing.find(e=>e.name===m.name);
        const st=rec?rec.status:'Work';
        return `<tr>
            <td style="font-weight:600">${m.name}</td>
            <td style="color:#64748b;font-size:12px">${m.position}</td>
            <td><select class="att-status-sel" data-idx="${i}" style="padding:5px 8px;border:1px solid var(--border);border-radius:7px;font-size:12px;background:white;">
                ${ATT_STATUS.map(s=>`<option value="${s}"${s===st?' selected':''}>${getAttStatusLabel(s)}</option>`).join('')}
            </select></td>
        </tr>`;
    }).join('');
}

function getAttStatusLabel(s){
    const map={
        'Work':lang==='ko'?'Ï∂úÍ∑º':'Work',
        'Vacation':lang==='ko'?'Ìú¥Í∞Ä':'Vacation',
        'Unauthorized absence':lang==='ko'?'Î¨¥Îã®Í≤∞Í∑º':'Unauthorized absence',
        'Early retirement':lang==='ko'?'Ï°∞Í∏∞Ìá¥Í∑º':'Early retirement'
    };
    return map[s]||s;
}

function setAllAttStatus(status){
    document.querySelectorAll('#tblAttEntry .att-status-sel').forEach(sel=>sel.value=status);
}

function saveAttendance(){
    const date=document.getElementById('attDateInput')?.value;
    if(!date){alert(lang==='ko'?'ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî':'Select a date');return;}
    const team=attTeamTab;
    const members=teamMembers[team]||[];
    const sels=document.querySelectorAll('#tblAttEntry .att-status-sel');
    const newRecords=[];
    sels.forEach((sel,i)=>{
        if(i<members.length){
            newRecords.push({date,team,name:members[i].name,position:members[i].position,status:sel.value});
        }
    });
    // Remove existing records for this date+team, then add new
    const kept=attendanceData.filter(d=>!(d.date===date&&d.team===team));
    const merged=[...kept,...newRecords];
    saveToFirebase('att',merged).then(()=>{
        alert(lang==='ko'?`‚úÖ ${team} ${date} Ï∂úÍ∑º Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å (${newRecords.length}Î™Ö)`:`‚úÖ ${team} ${date} attendance saved (${newRecords.length} members)`);
        document.getElementById('modalAttendance').style.display='none';
    });
}

function openMemberModal(){
    document.getElementById('modalMemberMgmt').style.display='block';
    memberTeamTab=ATT_TEAMS[0];
    renderMemberTeamTabs();
    renderMemberTeamTab(memberTeamTab);
}

function renderMemberTeamTabs(){
    const c=document.getElementById('memberTeamTabs');
    if(!c) return;
    c.innerHTML=ATT_TEAMS.map(t=>
        `<button class="att-tab${t===memberTeamTab?' active':''}" onclick="memberTeamTab='${t}';renderMemberTeamTabs();renderMemberTeamTab('${t}')">${t} (${(teamMembers[t]||[]).length})</button>`
    ).join('');
}

function renderMemberTeamTab(team){
    const tbody=document.querySelector('#tblMemberEntry tbody');
    if(!tbody) return;
    const members=teamMembers[team]||[];
    tbody.innerHTML=members.map((m,i)=>
        `<tr>
            <td style="font-weight:600">${m.name}</td>
            <td style="color:#64748b;font-size:12px">${m.position}</td>
            <td><button class="btn-del" onclick="removeMember('${team}',${i})">‚úï</button></td>
        </tr>`
    ).join('');
}

function removeMember(team,idx){
    if(!teamMembers[team]) return;
    const m=teamMembers[team][idx];
    if(!confirm(lang==='ko'?`${m.name}ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`:`Delete ${m.name}?`)) return;
    teamMembers[team].splice(idx,1);
    renderMemberTeamTabs();
    renderMemberTeamTab(team);
}

function addNewMember(){
    const nameIn=document.getElementById('newMemberName');
    const posIn=document.getElementById('newMemberPos');
    const name=(nameIn?.value||'').trim();
    const pos=(posIn?.value||'').trim();
    if(!name){alert(lang==='ko'?'Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî':'Enter name');return;}
    if(!teamMembers[memberTeamTab]) teamMembers[memberTeamTab]=[];
    teamMembers[memberTeamTab].push({name,position:pos||'Staff'});
    renderMemberTeamTabs();
    renderMemberTeamTab(memberTeamTab);
    if(nameIn) nameIn.value='';
    if(posIn) posIn.value='';
}

function saveMemberData(){
    saveToFirebase('members',teamMembers).then(()=>{
        alert(lang==='ko'?'‚úÖ ÌåÄÏõê Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§':'‚úÖ Team member data saved');
        document.getElementById('modalMemberMgmt').style.display='none';
    });
}

function updateAttendanceUI(){
    const data=getAttFiltered();
    // Count total members
    let totalMembers=0;
    ATT_TEAMS.forEach(t=>totalMembers+=(teamMembers[t]||[]).length);
    // Count by status
    const countByStatus={Work:0,Vacation:0,'Unauthorized absence':0,'Early retirement':0};
    data.forEach(d=>{if(countByStatus.hasOwnProperty(d.status)) countByStatus[d.status]++;});
    // Get unique dates in data
    const dates=[...new Set(data.map(d=>d.date))].sort();
    const latestDate=dates.length?dates[dates.length-1]:null;
    const latestData=latestDate?data.filter(d=>d.date===latestDate):[];
    const latestWork=latestData.filter(d=>d.status==='Work').length;
    const latestVac=latestData.filter(d=>d.status==='Vacation').length;
    const latestAbs=latestData.filter(d=>d.status==='Unauthorized absence'||d.status==='Early retirement').length;
    const latestTotal=latestData.length||totalMembers;
    const latestRate=latestTotal>0?(latestWork/latestTotal*100).toFixed(1):'0.0';

    // KPI cards
    const el=id=>document.getElementById(id);
    if(el('attKpiRateVal')) el('attKpiRateVal').innerText=latestRate+'%';
    if(el('attKpiWorkVal')) el('attKpiWorkVal').innerText=latestWork+(lang==='ko'?'Î™Ö':' persons');
    if(el('attKpiVacationVal')) el('attKpiVacationVal').innerText=latestVac+(lang==='ko'?'Î™Ö':' persons');
    if(el('attKpiAbsentVal')) el('attKpiAbsentVal').innerText=(latestAbs)+(lang==='ko'?'Î™Ö':' persons');

    // Team cards
    const grid=el('attTeamGrid');
    if(grid){
        grid.innerHTML=ATT_TEAMS.map(team=>{
            const members=teamMembers[team]||[];
            const teamLatest=latestDate?data.filter(d=>d.date===latestDate&&d.team===team):[];
            const tw=teamLatest.filter(d=>d.status==='Work').length;
            const tv=teamLatest.filter(d=>d.status==='Vacation').length;
            const ta=teamLatest.filter(d=>d.status==='Unauthorized absence'||d.status==='Early retirement').length;
            const tt=teamLatest.length||members.length;
            const rate=tt>0?(tw/tt*100).toFixed(1):'0.0';
            return `<div class="att-team-card">
                <div class="att-team-name">${team}</div>
                <div style="font-size:12px;color:#64748b;margin-bottom:6px">${members.length}${lang==='ko'?'Î™Ö':' members'}</div>
                <div class="att-team-rate" style="color:${parseFloat(rate)>=90?'#10b981':parseFloat(rate)>=70?'#f59e0b':'#ef4444'}">${rate}%</div>
                <div class="att-stat-row">
                    <span class="att-stat"><span class="att-badge att-badge-work"></span>${lang==='ko'?'Ï∂úÍ∑º':'Work'} ${tw}</span>
                    <span class="att-stat"><span class="att-badge att-badge-vacation"></span>${lang==='ko'?'Ìú¥Í∞Ä':'Vac'} ${tv}</span>
                    <span class="att-stat"><span class="att-badge att-badge-absence"></span>${lang==='ko'?'Í≤∞Í∑º¬∑Ï°∞Ìá¥':'Abs'} ${ta}</span>
                </div>
            </div>`;
        }).join('');
    }

}

function drawAttendanceCharts(){
    Object.values(attCharts).forEach(c=>c&&c.destroy());attCharts={};
    const data=getAttFiltered();
    if(!data.length) return;

    const dates=[...new Set(data.map(d=>d.date))].sort();

    // ‚îÄ‚îÄ Donut Chart: overall status distribution ‚îÄ‚îÄ
    const donutCanvas=document.getElementById('attChartDonut');
    if(donutCanvas){
        const statusCounts=ATT_STATUS.map(s=>data.filter(d=>d.status===s).length);
        const statusColors=['#10b981','#3b82f6','#ef4444','#f59e0b'];
        const statusLabels=ATT_STATUS.map(s=>getAttStatusLabel(s));
        attCharts.donut=new Chart(donutCanvas,{
            type:'doughnut',
            data:{labels:statusLabels,datasets:[{data:statusCounts,backgroundColor:statusColors,borderWidth:3,borderColor:'white',hoverOffset:8}]},
            options:{responsive:true,maintainAspectRatio:false,cutout:'50%',
                layout:{padding:{top:8,bottom:8}},
                plugins:{legend:{position:'bottom',labels:{font:{size:11,weight:'600',family:'Noto Sans KR,Inter,sans-serif'},usePointStyle:true,padding:10,boxWidth:10}},
                    datalabels:{display:ctx=>{const total=ctx.dataset.data.reduce((a,b)=>a+b,0);return total>0&&ctx.dataset.data[ctx.dataIndex]/total>0.03;},
                        color:'white',font:{weight:'800',size:12,family:'JetBrains Mono,monospace'},
                        textStrokeColor:'rgba(0,0,0,0.4)',textStrokeWidth:2,
                        formatter:(v,ctx)=>{const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);return total>0?(v*100/total).toFixed(1)+'%':'';},
                        anchor:'center',align:'center'}}}
        });
    }

    // ‚îÄ‚îÄ Stacked Bar Chart: daily attendance by status ‚îÄ‚îÄ
    const barCanvas=document.getElementById('attChartBar');
    if(barCanvas){
        const statusColors=['#10b981','#3b82f6','#ef4444','#f59e0b'];
        const statusLabels=ATT_STATUS.map(s=>getAttStatusLabel(s));
        const datasets=ATT_STATUS.map((s,si)=>({
            label:statusLabels[si],
            backgroundColor:statusColors[si],
            borderRadius:si===0?{topLeft:4,topRight:4}:0,
            data:dates.map(dt=>data.filter(d=>d.date===dt&&d.status===s).length)
        }));
        attCharts.bar=new Chart(barCanvas,{
            type:'bar',
            data:{labels:smartDateLabels(dates),datasets},
            options:{responsive:true,maintainAspectRatio:false,
                layout:{padding:{top:20,left:10,right:10}},
                plugins:{legend:{position:'bottom',labels:{font:{size:11,weight:'600',family:'Noto Sans KR,Inter,sans-serif'},usePointStyle:true,padding:10,boxWidth:10}},
                    datalabels:{display:false}},
                scales:{
                    x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},
                    y:{stacked:true,beginAtZero:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8',stepSize:5,callback:v=>v+(lang==='ko'?'Î™Ö':'')},border:{display:false},
                        afterFit:function(axis){axis.paddingLeft=10;}}
                }}
        });
    }
}

</script>
</body>
</html>
