<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Quality Performance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        :root {
            --navy:       #0c1e3e;
            --navy-mid:   #152d56;
            --navy-light: #1e3d6e;
            --gold:       #e8a020;
            --gold-light: #f5c55a;
            --gold-pale:  #fdf3de;
            --cyan:       #38bdf8;
            --success:    #10b981;
            --danger:     #f43f5e;
            --warning:    #f59e0b;
            --bg:         #f0f4fb;
            --surface:    #ffffff;
            --surface2:   #f8faff;
            --border:     #e0e8f5;
            --text:       #0c1e3e;
            --text-sub:   #5a7099;
            --text-muted: #94a3b8;
            --shadow-sm:  0 2px 8px rgba(12,30,62,0.07);
            --shadow-md:  0 8px 24px rgba(12,30,62,0.10);
            --shadow-lg:  0 20px 48px rgba(12,30,62,0.14);
            --r:          14px;
            --r-lg:       20px;
        }

        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 28px;
            background-image:
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(56,189,248,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(232,160,32,0.05) 0%, transparent 50%);
            word-break: keep-all;
            -webkit-font-smoothing: antialiased;
        }

        /* â”€â”€â”€ Loading â”€â”€â”€ */
        #loadingOverlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #0c1e3e 0%, #152d56 100%);
            z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .loading-logo { font-size: 36px; font-weight: 800; color: white; letter-spacing: -1px; font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        .loading-logo span { color: var(--gold); }
        .loading-bar {
            width: 200px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;
        }
        .loading-bar-inner {
            height: 100%; width: 0%; background: linear-gradient(90deg, var(--gold), var(--cyan));
            border-radius: 2px; animation: loadBar 1.8s ease-in-out forwards;
        }
        @keyframes loadBar { to { width: 100%; } }
        .loading-text { font-size: 13px; color: rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 0.3px; font-family: 'Noto Sans KR', sans-serif; }

        /* â”€â”€â”€ Sync Status â”€â”€â”€ */
        #syncStatus {
            position: fixed; bottom: 24px; right: 24px;
            padding: 10px 18px; border-radius: 40px;
            font-size: 12px; font-weight: 700; z-index: 9999;
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(12px); letter-spacing: 0.3px;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .sync-online  { background: rgba(16,185,129,0.15); color: #059669; border-color: rgba(16,185,129,0.3); }
        .sync-saving  { background: rgba(245,158,11,0.15); color: #d97706; border-color: rgba(245,158,11,0.3); }
        .sync-offline { background: rgba(244,63,94,0.15);  color: #e11d48; border-color: rgba(244,63,94,0.3); }
        .sync-dot { width: 7px; height: 7px; border-radius: 50%; }
        .sync-online  .sync-dot { background: #059669; animation: blink 2s infinite; }
        .sync-saving  .sync-dot { background: #d97706; animation: blink 0.6s infinite; }
        .sync-offline .sync-dot { background: #e11d48; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* â”€â”€â”€ Save Toast â”€â”€â”€ */
        .save-toast {
            position: fixed; top: 28px; right: 28px;
            background: var(--navy); color: white;
            padding: 14px 22px; border-radius: var(--r);
            font-size: 14px; font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 9999; display: none;
            border-left: 4px solid var(--gold);
            animation: toastIn 0.4s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes toastIn { from{transform:translateY(-80px);opacity:0} to{transform:translateY(0);opacity:1} }

        /* â”€â”€â”€ Page Enter Animation â”€â”€â”€ */
        .fade-up {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeUp 0.5s ease forwards;
        }
        @keyframes fadeUp { to { opacity:1; transform:translateY(0); } }

        /* â”€â”€â”€ Header â”€â”€â”€ */
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border-radius: var(--r-lg);
            padding: 32px 36px;
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: fadeUp 0.5s ease forwards;
        }
        .header::before {
            content: '';
            position: absolute; top: -60px; right: -60px;
            width: 240px; height: 240px;
            background: radial-gradient(circle, rgba(232,160,32,0.15) 0%, transparent 70%);
            pointer-events: none;
        }
        .header::after {
            content: '';
            position: absolute; bottom: -40px; left: 30%;
            width: 300px; height: 180px;
            background: radial-gradient(ellipse, rgba(56,189,248,0.08) 0%, transparent 70%);
            pointer-events: none;
        }
        .header-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: start;
            gap: 24px;
            position: relative; z-index: 1;
        }
        .header-brand { display: flex; align-items: center; gap: 16px; margin-bottom: 6px; }
        .brand-badge {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; box-shadow: 0 4px 12px rgba(232,160,32,0.4);
        }
        .header h1 {
            font-size: 24px; font-weight: 800; color: white;
            letter-spacing: -0.3px; line-height: 1.2;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        .header-sub {
            font-size: 12px; color: rgba(255,255,255,0.45);
            font-weight: 400; margin-top: 4px; letter-spacing: 0.2px;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .logo-text {
            font-family: 'Inter', sans-serif;
            font-weight: 800; font-size: 26px;
            color: white; letter-spacing: -1px;
            line-height: 1;
        }
        .logo-text span { color: var(--gold); }
        .logo-sub { font-size: 10px; color: rgba(255,255,255,0.4); letter-spacing: 2px; text-transform: uppercase; margin-top: 3px; font-family: 'Inter', sans-serif; }

        /* â”€â”€â”€ Controls Row â”€â”€â”€ */
        .controls-row {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
            margin-top: 24px; padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            position: relative; z-index: 1;
        }
        .lang-switch {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; padding: 3px; display: flex; gap: 2px;
        }
        .lang-btn {
            border: none; background: transparent; color: rgba(255,255,255,0.5);
            padding: 7px 16px; border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 700; transition: all 0.2s;
            font-family: 'Noto Sans KR', sans-serif; letter-spacing: 0;
        }
        .lang-btn.active { background: rgba(255,255,255,0.18); color: white; }

        .btn {
            padding: 9px 16px; border: none; border-radius: 10px; cursor: pointer;
            font-size: 13px; font-weight: 700; display: inline-flex; align-items: center;
            gap: 6px; transition: all 0.2s; font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; white-space: nowrap;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn-prod  { background: linear-gradient(135deg, #6366f1, #818cf8); color: white; box-shadow: 0 4px 12px rgba(99,102,241,0.35); }
        .btn-ship  { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; box-shadow: 0 4px 12px rgba(139,92,246,0.35); }
        .btn-def   { background: linear-gradient(135deg, var(--gold), #f5c55a); color: var(--navy); box-shadow: 0 4px 12px rgba(232,160,32,0.35); }
        .btn-excel { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.15); }
        .btn-excel:hover { background: rgba(255,255,255,0.18); }

        /* â”€â”€â”€ Filter Row â”€â”€â”€ */
        .filter-section {
            background: white; border-radius: var(--r-lg);
            padding: 18px 24px; margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            animation: fadeUp 0.5s 0.1s ease both;
        }
        .filter-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .filter-row + .filter-row { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }
        .filter-label {
            font-size: 11px; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; min-width: 44px;
            font-family: 'Inter', sans-serif;
        }
        .filter-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        .filter-btn {
            background: var(--surface2); border: 1.5px solid var(--border);
            color: var(--text-sub); padding: 6px 14px; border-radius: 30px;
            font-size: 12px; cursor: pointer; transition: all 0.18s ease;
            font-weight: 600; font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; line-height: 1.4;
        }
        .filter-btn:hover { border-color: #6366f1; color: #4f46e5; background: #eef2ff; }
        .filter-btn.active {
            background: var(--navy); color: white; border-color: var(--navy);
            box-shadow: 0 2px 8px rgba(12,30,62,0.20);
        }

        /* â”€â”€â”€ KPI Cards â”€â”€â”€ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .kpi-card {
            background: white; border-radius: var(--r);
            padding: 22px 24px;
            border: 1px solid var(--border);
            position: relative; overflow: hidden;
            transition: all 0.25s;
            box-shadow: var(--shadow-sm);
            animation: fadeUp 0.5s ease both;
        }
        .kpi-card:nth-child(1){animation-delay:0.1s}
        .kpi-card:nth-child(2){animation-delay:0.15s}
        .kpi-card:nth-child(3){animation-delay:0.2s}
        .kpi-card:nth-child(4){animation-delay:0.25s}
        .kpi-card:nth-child(5){animation-delay:0.3s}
        .kpi-card:nth-child(6){animation-delay:0.35s}
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .kpi-card::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
        }
        .kpi-card.c-blue::after  { background: linear-gradient(90deg,#6366f1,#818cf8); }
        .kpi-card.c-red::after   { background: linear-gradient(90deg,#f43f5e,#fb7185); }
        .kpi-card.c-slate::after { background: linear-gradient(90deg,#475569,#64748b); }
        .kpi-card.c-orange::after{ background: linear-gradient(90deg,var(--gold),#f5c55a); }

        .kpi-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; margin-bottom: 14px;
        }
        .c-blue  .kpi-icon { background: #eef2ff; }
        .c-red   .kpi-icon { background: #fff1f2; }
        .c-slate .kpi-icon { background: #f1f5f9; }
        .c-orange .kpi-icon { background: #fffbeb; }
        .kpi-value {
            font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
            font-family: 'JetBrains Mono', 'Inter', monospace; margin-bottom: 4px; line-height: 1.1;
        }
        .c-blue   .kpi-value { color: #4f46e5; }
        .c-red    .kpi-value { color: #e11d48; }
        .c-slate  .kpi-value { color: #334155; }
        .c-orange .kpi-value { color: #b45309; }
        .kpi-label {
            font-size: 11px; color: var(--text-muted); font-weight: 500;
            letter-spacing: 0.3px; font-family: 'Noto Sans KR', sans-serif;
        }

        /* â”€â”€â”€ Section Header â”€â”€â”€ */
        .section-hd {
            display: flex; align-items: center; gap: 12px;
            margin: 36px 0 18px;
        }
        .section-hd-line {
            flex: 1; height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }
        .section-hd-title {
            font-size: 13px; font-weight: 800; color: var(--text-sub);
            text-transform: uppercase; letter-spacing: 1.5px;
            white-space: nowrap;
        }

        /* â”€â”€â”€ Grid Layouts â”€â”€â”€ */
        .g2 { display: grid; grid-template-columns: repeat(auto-fit,minmax(440px,1fr)); gap: 20px; margin-bottom: 20px; }
        .g3 { display: grid; grid-template-columns: repeat(auto-fit,minmax(340px,1fr)); gap: 20px; margin-bottom: 20px; }
        .g-full { width: 100%; margin-bottom: 20px; }

        /* â”€â”€â”€ Card â”€â”€â”€ */
        .card {
            background: white; border-radius: var(--r);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
            transition: box-shadow 0.2s;
            overflow: hidden;
        }
        .card:hover { box-shadow: var(--shadow-md); }
        .card-head {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 22px 0;
        }
        .card-title {
            font-size: 13px; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 8px;
            letter-spacing: 0; font-family: 'Noto Sans KR', sans-serif;
        }
        .card-title-dot {
            width: 8px; height: 8px; border-radius: 2px;
            background: linear-gradient(135deg, #6366f1, #818cf8);
            flex-shrink: 0;
        }
        .card-body { padding: 16px 22px 22px; flex: 1; }

        /* â”€â”€â”€ Tables â”€â”€â”€ */
        .tbl-wrap { overflow-x: auto; }
        .tbl-wrap::-webkit-scrollbar { height: 5px; }
        .tbl-wrap::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .tbl-wrap::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th {
            background: var(--surface2); color: var(--text-sub);
            padding: 10px 14px; text-align: center; font-weight: 700;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky; top: 0; z-index: 5;
            font-family: 'Inter', sans-serif;
        }
        thead th:first-child { text-align: left; }
        tbody td {
            padding: 10px 14px; border-bottom: 1px solid #f1f5f9;
            text-align: center; color: var(--text);
            font-variant-numeric: tabular-nums;
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        tbody td:first-child { text-align: left; font-weight: 600; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background: #f8faff; }

        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 800; letter-spacing: 0.3px;
        }
        .badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; }
        .badge-ok   { background: #f0fdf4; color: #16a34a; }
        .badge-ok::before { background: #16a34a; }
        .badge-ng   { background: #fff1f2; color: #e11d48; }
        .badge-ng::before { background: #e11d48; }

        .yield-good { color: #16a34a; font-weight: 700; font-family:'JetBrains Mono','Inter',monospace; }
        .yield-bad  { color: #e11d48; font-weight: 700; font-family:'JetBrains Mono','Inter',monospace; }

        /* â”€â”€â”€ Chart Boxes â”€â”€â”€ */
        .ch-sm  { position: relative; height: 190px; }
        .ch-md  { position: relative; height: 270px; }
        .ch-lg  { position: relative; height: 310px; }

        /* â”€â”€â”€ Defect Table â”€â”€â”€ */
        #tblDefectType thead th {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: rgba(255,255,255,0.9); border-bottom: none;
            font-family: 'Inter', sans-serif; font-size: 11px;
            letter-spacing: 0.5px; padding: 12px 14px;
        }
        #tblDefectType thead th:first-child { text-align: left; }
        #tblDefectType tbody td {
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        #tblDefectType tbody td:first-child {
            font-family: 'Noto Sans KR', sans-serif; font-weight: 600; color: var(--text);
        }
        #tblDefectType tbody td:last-child {
            color: #4f46e5; font-weight: 700;
            font-family: 'JetBrains Mono', monospace; font-size: 13px;
        }
        #tblDefectType tbody tr.grand-row td {
            background: #f0f4fb !important; font-weight: 700;
            border-top: 2px solid var(--navy); color: var(--navy);
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        #tblDefectType tbody tr.grand-row td:first-child {
            font-family: 'Noto Sans KR', sans-serif;
        }
        #tblDefectType tbody tr.grand-row td:last-child {
            background: var(--navy) !important; color: white;
            font-family: 'JetBrains Mono', monospace;
        }
        .d-zero   { color: #c8d6e5; font-style: normal; font-size: 15px; line-height: 1; }
        .d-low    { color: #d97706; font-weight: 700; font-family: 'JetBrains Mono', monospace !important; }
        .d-med    { color: #ea580c; font-weight: 700; font-family: 'JetBrains Mono', monospace !important; }
        .d-high   { color: #dc2626; font-weight: 800; font-family: 'JetBrains Mono', monospace !important; }

        /* â”€â”€â”€ Modal â”€â”€â”€ */
        .modal {
            display: none; position: fixed; inset: 0; z-index: 2000;
            background: rgba(12,30,62,0.65); backdrop-filter: blur(6px);
        }
        .modal-box {
            background: white; width: 92%; max-width: 980px;
            margin: 36px auto; padding: 36px; border-radius: var(--r-lg);
            max-height: 88vh; overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes modalUp { from{transform:translateY(40px);opacity:0} to{transform:translateY(0);opacity:1} }
        .modal-title { font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 6px; font-family: 'Noto Sans KR', sans-serif; }
        .modal-desc { font-size: 13px; color: var(--text-sub); margin-bottom: 20px; line-height: 1.7; font-family: 'Noto Sans KR', sans-serif; }
        .paste-area {
            width: 100%; height: 90px; padding: 14px;
            border: 2px dashed var(--border); border-radius: var(--r);
            background: var(--surface2); font-family: 'DM Mono', monospace;
            font-size: 12px; margin-bottom: 16px; resize: vertical;
            transition: border-color 0.2s;
        }
        .paste-area:focus { outline: none; border-color: #6366f1; background: #eef2ff; }
        .modal-footer {
            display: flex; gap: 12px; margin-top: 24px;
            padding-top: 20px; border-top: 1px solid var(--border);
        }
        .btn-full { flex: 1; padding: 13px; font-size: 14px; border-radius: 10px; }
        .btn-save   { background: linear-gradient(135deg,var(--navy),var(--navy-light)); color:white; border:none; cursor:pointer; font-family:inherit; font-weight:700; transition:all .2s; }
        .btn-save:hover { box-shadow: 0 6px 18px rgba(12,30,62,0.3); transform:translateY(-2px); }
        .btn-cancel { background: var(--surface2); color: var(--text-sub); border:1px solid var(--border); cursor:pointer; font-family:inherit; font-weight:600; transition:all .2s; }
        .btn-cancel:hover { border-color: var(--text-sub); }
        .btn-parse  { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; cursor:pointer; padding:10px 16px; border-radius:8px; font-family:inherit; font-weight:700; font-size:13px; flex:1; transition:all .2s; }
        .btn-parse:hover { background: #e0e7ff; }
        .btn-clr    { background: #fff1f2; color: #e11d48; border:1px solid #fecdd3; cursor:pointer; padding:10px 16px; border-radius:8px; font-family:inherit; font-weight:700; font-size:13px; width:110px; transition:all .2s; }
        .btn-clr:hover { background:#ffe4e6; }
        .btn-addrow { width:100%; margin-top:12px; padding:10px; background:var(--surface2); border:1px dashed var(--border); border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600; font-size:13px; color:var(--text-sub); transition:all .2s; }
        .btn-addrow:hover { border-color:#6366f1; color:#4f46e5; background:#eef2ff; }

        .entry-tbl { width:100%; border-collapse:collapse; font-size:13px; }
        .entry-tbl th { background:#f8faff; color:var(--text-sub); padding:9px 10px; text-align:center; font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid var(--border); font-family:'Inter',sans-serif; }
        .entry-tbl td { padding:6px 6px; border-bottom:1px solid #f1f5f9; }
        .entry-tbl input, .entry-tbl select {
            width:100%; padding:8px 10px; border:1px solid var(--border);
            border-radius:7px; font-size:13px; font-family:'Noto Sans KR','Inter',sans-serif;
            background:white; transition:all .2s; color:var(--text);
        }
        .entry-tbl input:focus, .entry-tbl select:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
        .entry-tbl select { cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%236366f1' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; padding-right:30px; }
        .btn-del { background:#fff1f2; color:#e11d48; border:1px solid #fecdd3; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:700; transition:all .2s; font-family:'Noto Sans KR',sans-serif; }
        .btn-del:hover { background:#ffe4e6; }

        /* â”€â”€â”€ Config Banner â”€â”€â”€ */
        #configBanner {
            background: linear-gradient(135deg,#fffbeb,#fef3c7);
            border: 2px solid #fcd34d; border-radius: var(--r);
            padding: 20px 24px; margin-bottom: 20px; display: none;
        }
        #configBanner h3 { color: #92400e; margin-bottom: 6px; font-size: 16px; }
        #configBanner p  { color: #78350f; font-size: 13px; line-height: 1.7; }
        #configBanner code { background:rgba(0,0,0,0.07); padding:2px 7px; border-radius:5px; font-family:'DM Mono',monospace; font-size:12px; }

        /* â”€â”€â”€ Chart filter mini-btns â”€â”€â”€ */
        .mini-filters { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:12px; }
        .mini-btn {
            padding: 5px 13px; border-radius: 30px; border: 1.5px solid var(--border);
            background: var(--surface2); color: var(--text-sub);
            font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s;
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; line-height: 1.4;
        }
        .mini-btn:hover { border-color: #6366f1; color: #4f46e5; background: #eef2ff; }
        .mini-btn.active { background: var(--navy); color: white; border-color: var(--navy); box-shadow: 0 2px 6px rgba(12,30,62,0.15); }

        @media(max-width:768px){
            body{padding:14px;}
            .header-grid{grid-template-columns:1fr;}
            .g2,.g3{grid-template-columns:1fr;}
            .kpi-grid{grid-template-columns:repeat(2,1fr);}
        }

        /* â”€â”€â”€ Password Modal â”€â”€â”€ */
        #pwModal {
            display:none; position:fixed; inset:0; z-index:3000;
            background:rgba(12,30,62,0.75); backdrop-filter:blur(8px);
            align-items:center; justify-content:center;
        }
        #pwModal.open { display:flex; }
        .pw-box {
            background:white; border-radius:var(--r-lg);
            padding:36px 40px; width:360px;
            box-shadow:var(--shadow-lg); text-align:center;
            animation:modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        .pw-icon { font-size:40px; margin-bottom:16px; }
        .pw-title { font-size:18px; font-weight:800; color:var(--navy); margin-bottom:6px; font-family:'Noto Sans KR',sans-serif; }
        .pw-sub { font-size:13px; color:var(--text-sub); margin-bottom:22px; font-family:'Noto Sans KR',sans-serif; }
        .pw-input {
            width:100%; padding:13px 16px; border:2px solid var(--border);
            border-radius:10px; font-size:16px; text-align:center;
            font-family:'JetBrains Mono',monospace; letter-spacing:4px;
            transition:all .2s; margin-bottom:16px;
        }
        .pw-input:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
        .pw-err { font-size:12px; color:#e11d48; margin-bottom:12px; height:16px; font-family:'Noto Sans KR',sans-serif; }
        .pw-btns { display:flex; gap:10px; }
        .pw-ok { flex:1; padding:12px; background:linear-gradient(135deg,var(--navy),var(--navy-light)); color:white; border:none; border-radius:10px; cursor:pointer; font-size:14px; font-weight:700; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .pw-ok:hover { box-shadow:0 4px 14px rgba(12,30,62,0.3); transform:translateY(-1px); }
        .pw-cancel { padding:12px 20px; background:var(--surface2); color:var(--text-sub); border:1px solid var(--border); border-radius:10px; cursor:pointer; font-size:14px; font-weight:600; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .pw-cancel:hover { border-color:var(--text-sub); }

        /* â”€â”€â”€ Backup Button â”€â”€â”€ */
        .btn-backup { background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.8); border:1px solid rgba(255,255,255,0.15); font-size:12px; padding:8px 14px; }
        .btn-backup:hover { background:rgba(255,255,255,0.15); color:white; }

        /* â”€â”€â”€ Backup Modal â”€â”€â”€ */
        #backupModal {
            display:none; position:fixed; inset:0; z-index:3000;
            background:rgba(12,30,62,0.75); backdrop-filter:blur(8px);
            align-items:center; justify-content:center;
        }
        #backupModal.open { display:flex; }
        .backup-box {
            background:white; border-radius:var(--r-lg); padding:36px;
            width:500px; max-height:80vh; overflow-y:auto;
            box-shadow:var(--shadow-lg);
            animation:modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        .backup-item {
            display:flex; align-items:center; justify-content:space-between;
            padding:12px 16px; border:1px solid var(--border); border-radius:10px;
            margin-bottom:8px; transition:all .2s;
        }
        .backup-item:hover { border-color:#6366f1; background:#fafbff; }
        .backup-item-info { font-size:13px; }
        .backup-item-time { font-weight:700; color:var(--navy); font-family:'JetBrains Mono',monospace; }
        .backup-item-size { font-size:11px; color:var(--text-muted); margin-top:2px; }
        .backup-restore-btn { padding:7px 14px; background:#eef2ff; color:#4f46e5; border:1px solid #c7d2fe; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .backup-restore-btn:hover { background:#e0e7ff; }
        .backup-del-btn { padding:7px 10px; background:#fff1f2; color:#e11d48; border:1px solid #fecdd3; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700; margin-left:6px; transition:all .2s; }
        .backup-del-btn:hover { background:#ffe4e6; }
    </style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay">
    <div class="loading-logo">DREAM<span>TECH</span></div>
    <div class="loading-bar"><div class="loading-bar-inner"></div></div>
    <div class="loading-text">ğŸ”¥ Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div id="syncStatus" class="sync-online">
    <div class="sync-dot"></div>
    <span id="syncText">ì‹¤ì‹œê°„ ì—°ê²°ë¨</span>
</div>

<div id="saveSuccess" class="save-toast">âœ… ì €ì¥ ì™„ë£Œ! ëª¨ë“  íŒ€ì›ì—ê²Œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
<div id="configBanner">
    <h3>âš ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
    <p>íŒŒì¼ì˜ <code>FIREBASE_CONFIG</code> ê°’ì„ ì‹¤ì œ Firebase í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´í•´ ì£¼ì„¸ìš”.</p>
</div>

<!-- Header -->
<div class="header">
    <div class="header-grid">
        <div>
            <div class="header-brand">
                <div class="brand-badge">ğŸ“Š</div>
                <div>
                    <h1 id="mainTitle">DS Quality Performance</h1>
                    <div class="header-sub" id="lastUpdate">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
        <div style="text-align:right">
            <div class="logo-text">DREAM<span>TECH</span></div>
            <div class="logo-sub">DS Division</div>
        </div>
    </div>
    <div class="controls-row">
        <div class="lang-switch">
            <button class="lang-btn active" onclick="setLang('ko')" id="btnKo">í•œê¸€</button>
            <button class="lang-btn" onclick="setLang('en')" id="btnEn">English</button>
        </div>
        <button class="btn btn-prod" onclick="openModal('prod')" id="btnProd">âœï¸ ìƒì‚° ì…ë ¥</button>
        <button class="btn btn-ship" onclick="openModal('ship')" id="btnShip">ğŸ“¦ ì¶œí•˜ ì…ë ¥</button>
        <button class="btn btn-def"  onclick="openModal('defect')" id="btnDefect">ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ì…ë ¥</button>
        <button class="btn btn-excel" onclick="exportExcel()">ğŸ“Š Excel</button>
        <button class="btn btn-backup" onclick="openBackupModal()">ğŸ’¾ ë°±ì—…</button>
    </div>
</div>

<!-- Filters -->
<div class="filter-section">
    <div class="filter-row">
        <div class="filter-label" id="lblProd">ì œí’ˆ</div>
        <div class="filter-btns" id="filterProduct"></div>
    </div>
    <div class="filter-row">
        <div class="filter-label" id="lblPeriod">ê¸°ê°„</div>
        <div class="filter-btns" id="filterMonth"></div>
    </div>
    <div class="filter-row">
        <div class="filter-label" id="lblProcess">ê³µì •</div>
        <div class="filter-btns" id="filterProcess"></div>
    </div>
</div>

<!-- KPI -->
<div class="kpi-grid">
    <div class="kpi-card c-blue">
        <div class="kpi-icon">ğŸ“ˆ</div>
        <div class="kpi-value" id="kpiYield">â€”</div>
        <div class="kpi-label" id="lblKpiYield">ì¢…í•© ìˆ˜ìœ¨</div>
    </div>
    <div class="kpi-card c-red">
        <div class="kpi-icon">âš ï¸</div>
        <div class="kpi-value" id="kpiPPM">â€”</div>
        <div class="kpi-label" id="lblKpiPPM">ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ë¥ </div>
    </div>
    <div class="kpi-card c-slate">
        <div class="kpi-icon">ğŸ“¥</div>
        <div class="kpi-value" id="kpiInput">â€”</div>
        <div class="kpi-label" id="lblKpiInput">ì´ íˆ¬ì… ìˆ˜ëŸ‰</div>
    </div>
    <div class="kpi-card c-slate">
        <div class="kpi-icon">ğŸ“¤</div>
        <div class="kpi-value" id="kpiOutput">â€”</div>
        <div class="kpi-label" id="lblKpiOutput">ì´ ì‚°ì¶œ ìˆ˜ëŸ‰</div>
    </div>
    <div class="kpi-card c-red">
        <div class="kpi-icon">âŒ</div>
        <div class="kpi-value" id="kpiDefect">â€”</div>
        <div class="kpi-label" id="lblKpiDefect">ì´ ë¶ˆëŸ‰ ìˆ˜ëŸ‰</div>
    </div>
    <div class="kpi-card c-orange">
        <div class="kpi-icon">ğŸ­</div>
        <div class="kpi-value" id="kpiCompDefect">â€”</div>
        <div class="kpi-label" id="lblKpiCompDefect">ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰</div>
    </div>
</div>

<!-- Tables row -->
<div class="g3">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProcYield">ê³µì •ë³„ ìˆ˜ìœ¨ í˜„í™©</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblProcYield">
                    <thead><tr><th id="thProc">ê³µì •</th><th id="thIn">íˆ¬ì…</th><th id="thOut">ì‚°ì¶œ</th><th id="thFail">ë¶ˆëŸ‰</th><th id="thYld">ìˆ˜ìœ¨</th><th id="thStat">íŒì •</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titMonthYield">ê³µì •ë³„ ì›”ë³„ ìˆ˜ìœ¨ ì¶”ì´</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblMonthYield">
                    <thead><tr><th id="thMonth">ê¸°ê°„</th><th>SMD</th><th>ROUTER</th><th>ATE</th><th>PCT</th><th>AVI</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdYield">ì œí’ˆë³„ ìˆ˜ìœ¨ í˜„í™©</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblProdYield">
                    <thead><tr><th id="thProd">ì œí’ˆ</th><th id="thIn2">íˆ¬ì…</th><th id="thOut2">ì‚°ì¶œ</th><th id="thFail2">ë¶ˆëŸ‰</th><th id="thYld2">ìˆ˜ìœ¨</th><th id="thStat2">íŒì •</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Total Yield Trend -->
<div class="g-full">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titTotalTrend">ì¢…í•© ìˆ˜ìœ¨ ì›”ë³„ íŠ¸ë Œë“œ (%)</span></div></div>
        <div class="card-body"><div class="ch-sm"><canvas id="chartTotalYield"></canvas></div></div>
    </div>
</div>

<!-- 3 charts -->
<div class="g3">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdTrend">ì œí’ˆë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="prodChartFilter"></div>
            <div class="ch-md"><canvas id="chartProdYield"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProcTrend">ê³µì •ë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="procChartFilter"></div>
            <div class="ch-md"><canvas id="chartProcYield"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdVol">DS ìƒì‚° ì‹¤ì </span></div></div>
        <div class="card-body"><div class="ch-md"><canvas id="chartProdVol"></canvas></div></div>
    </div>
</div>

<!-- Defect Section -->
<div class="section-hd">
    <div class="section-hd-title" id="titDefectSection">ğŸ“‰ ë¶ˆëŸ‰ ë¶„ì„ ë° ìƒì„¸ í˜„í™©</div>
    <div class="section-hd-line"></div>
</div>

<div class="g2">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titTotalDefect">ì›”ë³„ ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartTotalDefect"></canvas></div></div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titCompDefect">ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartCompDefect"></canvas></div></div>
    </div>
</div>

<div class="g3">
    <div class="card">
        <div class="card-head">
            <div class="card-title"><div class="card-title-dot"></div><span id="titDefectType">ë¶ˆëŸ‰ ìœ í˜• ì°¨íŠ¸</span></div>
            <button class="btn-del" onclick="openModal('defect')">ìˆ˜ì •</button>
        </div>
        <div class="card-body">
            <div class="mini-filters" id="defectTypeFilters"></div>
            <div class="ch-lg"><canvas id="chartDefectType"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span>ë¶ˆëŸ‰ ìœ í˜• ë¹„ìœ¨ (Pie)</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartDefectTypePie"></canvas></div></div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titDefectTable">ë¶ˆëŸ‰ ìœ í˜• ìƒì„¸ í˜„í™©</span></div></div>
        <div class="card-body" style="padding-top:0;">
            <div class="tbl-wrap" style="max-height:320px;overflow-y:auto;">
                <table id="tblDefectType">
                    <thead><tr><th>ê¸°ê°„</th><th>Human Error</th><th>Handling Damage</th><th>Component Lifting</th><th>í•©ê³„</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Shipment Section -->
<div class="section-hd">
    <div class="section-hd-title" id="titShipSection">ğŸ“¦ ì¶œí•˜ ì‹¤ì </div>
    <div class="section-hd-line"></div>
</div>
<div class="g2">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titShipTable">ì›”ë³„ ì¶œí•˜ ìˆ˜ëŸ‰</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblShipment">
                    <thead><tr><th id="thShipMonth">ê¸°ê°„</th><th>RDIMM</th><th>SODIMM</th><th>UDIMM</th><th id="thTotal">í•©ê³„</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titShipChart">ì›”ë³„ ì¶œí•˜ ì‹¤ì  ì¶”ì´</span></div></div>
        <div class="card-body"><div class="ch-md"><canvas id="chartShipment"></canvas></div></div>
    </div>
</div>

<!-- Modals -->
<div id="modalProd" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitProd">âœï¸ ìƒì‚° ë°ì´í„° ì…ë ¥</div>
        <div class="modal-desc">Excelì—ì„œ <strong>[ì œí’ˆ | ê¸°ê°„ | ê³µì • | íˆ¬ì… | ì‚°ì¶œ | ë¶ˆëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <textarea class="paste-area" id="pasteProd" placeholder="Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('prod')">ğŸ“‹ ë°ì´í„° ì ìš©</button>
            <button class="btn-clr" onclick="clearTable('prod')">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryProd">
                <thead><tr><th>ì œí’ˆ</th><th>ê¸°ê°„</th><th>ê³µì •</th><th>íˆ¬ì…</th><th>ì‚°ì¶œ</th><th>ë¶ˆëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('prod')">+ í–‰ ì¶”ê°€</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('prod')">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('prod')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="modalShip" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitShip">ğŸ“¦ ì¶œí•˜ ë°ì´í„° ì…ë ¥</div>
        <div class="modal-desc">Excelì—ì„œ <strong>[ëª¨ë¸ | ëª¨ë¸ëª… | ë‚ ì§œ | ìˆ˜ëŸ‰ | ì‚¬ìœ ]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <textarea class="paste-area" id="pasteShip" placeholder="Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('ship')">ğŸ“‹ ë°ì´í„° ì ìš©</button>
            <button class="btn-clr" onclick="clearTable('ship')">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryShip">
                <thead><tr><th>ëª¨ë¸</th><th>ëª¨ë¸ëª…</th><th>ë‚ ì§œ</th><th>ìˆ˜ëŸ‰</th><th>ì‚¬ìœ </th><th>ê¸°ê°„(ìë™)</th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('ship')">+ í–‰ ì¶”ê°€</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('ship')">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('ship')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="modalDefect" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitDefect">ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ë°ì´í„° ì…ë ¥</div>
        <div class="modal-desc">Excelì—ì„œ <strong>[ë¶ˆëŸ‰ëª… | ê¸°ê°„(YY.MM) | ìˆ˜ëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <textarea class="paste-area" id="pasteDefect" placeholder="ì˜ˆì‹œ: Human Error&#9;26.02&#9;5"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('defect')">ğŸ“‹ ë°ì´í„° ì ìš©</button>
            <button class="btn-clr" onclick="clearTable('defect')">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryDefect">
                <thead><tr><th>ë¶ˆëŸ‰ëª…</th><th>ê¸°ê°„ (YY.MM)</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('defect')">+ í–‰ ì¶”ê°€</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('defect')">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('defect')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div id="pwModal">
    <div class="pw-box">
        <div class="pw-icon">ğŸ”’</div>
        <div class="pw-title" id="pwTitle">ë°ì´í„° ì…ë ¥ ë¹„ë°€ë²ˆí˜¸</div>
        <div class="pw-sub" id="pwSub">ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        <input type="password" class="pw-input" id="pwInput" placeholder="â€¢â€¢â€¢â€¢" maxlength="20" onkeydown="if(event.key==='Enter')pwConfirm()">
        <div class="pw-err" id="pwErr"></div>
        <div class="pw-btns">
            <button class="pw-cancel" onclick="pwCancel()" id="pwCancelBtn">ì·¨ì†Œ</button>
            <button class="pw-ok" onclick="pwConfirm()" id="pwOkBtn">í™•ì¸</button>
        </div>
    </div>
</div>

<!-- Backup Modal -->
<div id="backupModal">
    <div class="backup-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div>
                <div style="font-size:20px;font-weight:800;color:var(--navy);font-family:'Noto Sans KR',sans-serif;" id="backupTitle">ğŸ’¾ ë°ì´í„° ë°±ì—… ê´€ë¦¬</div>
                <div style="font-size:12px;color:var(--text-sub);margin-top:4px;font-family:'Noto Sans KR',sans-serif;" id="backupSubTitle">ìµœëŒ€ 10ê°œ ë°±ì—… ì €ì¥ Â· ì˜ëª» ì…ë ¥ ì‹œ ë³µì› ê°€ëŠ¥</div>
            </div>
            <button onclick="closeBackupModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);">âœ•</button>
        </div>
        <button onclick="createBackup()" style="width:100%;padding:13px;background:linear-gradient(135deg,var(--navy),var(--navy-light));color:white;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;margin-bottom:20px;transition:all .2s;" id="backupNowBtn" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">ğŸ“¸ ì§€ê¸ˆ ë°±ì—… ìƒì„±</button>
        <div id="backupList"><div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
    </div>
</div>

<script>
// ============================================================
// ğŸ”¥ FIREBASE ì„¤ì •
// ============================================================
const FIREBASE_CONFIG = {
    apiKey:            "AIzaSyAQAqYYenEzp0ps71LRxF9ikcYywq8WwQo",
    authDomain:        "ds-quality-41ad2.firebaseapp.com",
    databaseURL:       "https://ds-quality-41ad2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:         "ds-quality-41ad2",
    storageBucket:     "ds-quality-41ad2.firebasestorage.app",
    messagingSenderId: "910427066275",
    appId:             "1:910427066275:web:3aa0c8009e17619ad3d416"
};
// ============================================================

const isConfigured = !Object.values(FIREBASE_CONFIG).some(v=>v.includes('YOUR_'));
let db=null, prodData=[], shipData=[], defectTypeData=[];
let filters={product:'ì „ì²´',month:'ì „ì²´',process:'ì „ì²´',defectType:'ì „ì²´'};
let procChartFilter='ì „ì²´', prodChartFilter='ì „ì²´';
let charts={}, lang='ko';
let dataLoaded={prod:false,ship:false,defect:false};

// â”€â”€â”€ PASSWORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DATA_PASSWORD = "ds2025"; // â† ì—¬ê¸°ì„œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ì„¸ìš”!
let pwCallback = null;

function requirePassword(cb){
    pwCallback = cb;
    document.getElementById('pwInput').value='';
    document.getElementById('pwErr').innerText='';
    document.getElementById('pwModal').classList.add('open');
    setTimeout(()=>document.getElementById('pwInput').focus(),100);
}
function pwConfirm(){
    const v=document.getElementById('pwInput').value;
    if(v===DATA_PASSWORD){ document.getElementById('pwModal').classList.remove('open'); if(pwCallback){pwCallback();pwCallback=null;} }
    else{ document.getElementById('pwErr').innerText=lang==='ko'?'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤':'âŒ Incorrect password'; document.getElementById('pwInput').value=''; document.getElementById('pwInput').focus(); }
}
function pwCancel(){ document.getElementById('pwModal').classList.remove('open'); pwCallback=null; }

// â”€â”€â”€ BACKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createBackup(){
    const now=new Date(), p=x=>String(x).padStart(2,'0');
    const ts=`${now.getFullYear()}-${p(now.getMonth()+1)}-${p(now.getDate())} ${p(now.getHours())}:${p(now.getMinutes())}:${p(now.getSeconds())}`;
    const key=`backup_${now.getTime()}`;
    const snapshot={ts,prodData:[...prodData],shipData:[...shipData],defectTypeData:[...defectTypeData]};
    if(db){
        db.ref('backups/'+key).set(snapshot).then(()=>{
            cleanOldBackups(); loadBackupList();
            alert(lang==='ko'?'âœ… ë°±ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!':'âœ… Backup created successfully!');
        }).catch(()=>alert(lang==='ko'?'âš ï¸ ë°±ì—… ì €ì¥ ì‹¤íŒ¨':'âš ï¸ Backup failed'));
    } else {
        try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');bs[key]=snapshot;const keys=Object.keys(bs).sort();if(keys.length>10){delete bs[keys[0]];}localStorage.setItem('ds_backups',JSON.stringify(bs));loadBackupList();alert(lang==='ko'?'âœ… ë°±ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¡œì»¬ ì €ì¥)':'âœ… Backup created (local)!');}catch(e){alert('ë°±ì—… ì˜¤ë¥˜');}
    }
}
function cleanOldBackups(){
    if(!db)return;
    db.ref('backups').once('value',s=>{
        const bks=s.val(); if(!bks)return;
        const keys=Object.keys(bks).sort();
        if(keys.length>10){ const toDelete=keys.slice(0,keys.length-10); toDelete.forEach(k=>db.ref('backups/'+k).remove()); }
    });
}
function loadBackupList(){
    const list=document.getElementById('backupList'); if(!list)return;
    if(db){
        db.ref('backups').orderByKey().limitToLast(10).once('value',s=>{
            const bks=s.val();
            if(!bks){list.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">${lang==='ko'?'ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤':'No backups'}</div>`;return;}
            const keys=Object.keys(bks).sort().reverse();
            list.innerHTML=keys.map((k,i)=>`<div class="backup-item"><div class="backup-item-info"><div class="backup-item-time">${bks[k].ts}</div><div class="backup-item-size">${lang==='ko'?`ìƒì‚° ${bks[k].prodData?.length||0}ê±´ Â· ì¶œí•˜ ${bks[k].shipData?.length||0}ê±´ Â· ë¶ˆëŸ‰ ${bks[k].defectTypeData?.length||0}ê±´`:`Prod ${bks[k].prodData?.length||0} Â· Ship ${bks[k].shipData?.length||0} Â· Defect ${bks[k].defectTypeData?.length||0}`}</div></div><div style="display:flex;align-items:center;gap:6px;"><button class="backup-restore-btn" onclick="restoreBackup('${k}')">${lang==='ko'?'ë³µì›':'Restore'}</button><button class="backup-del-btn" onclick="deleteBackup('${k}')">âœ•</button></div></div>`).join('');
        });
    } else {
        try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');const keys=Object.keys(bs).sort().reverse();if(!keys.length){list.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">${lang==='ko'?'ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤':'No backups'}</div>`;return;}list.innerHTML=keys.map(k=>`<div class="backup-item"><div class="backup-item-info"><div class="backup-item-time">${bs[k].ts}</div><div class="backup-item-size">${lang==='ko'?`ìƒì‚° ${bs[k].prodData?.length||0}ê±´ Â· ì¶œí•˜ ${bs[k].shipData?.length||0}ê±´ Â· ë¶ˆëŸ‰ ${bs[k].defectTypeData?.length||0}ê±´`:`Prod ${bs[k].prodData?.length||0} Â· Ship ${bs[k].shipData?.length||0} Â· Defect ${bs[k].defectTypeData?.length||0}`}</div></div><div style="display:flex;align-items:center;gap:6px;"><button class="backup-restore-btn" onclick="restoreBackup('${k}')">${lang==='ko'?'ë³µì›':'Restore'}</button><button class="backup-del-btn" onclick="deleteBackup('${k}')">âœ•</button></div></div>`).join('');}catch(e){}
    }
}
function restoreBackup(key){
    if(!confirm(lang==='ko'?'âš ï¸ ì´ ë°±ì—…ìœ¼ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.':'âš ï¸ Restore from this backup?\nCurrent data will be overwritten.'))return;
    const doRestore=(snap)=>{
        if(!snap)return;
        prodData=snap.prodData||[]; shipData=snap.shipData||[]; defectTypeData=snap.defectTypeData||[];
        if(db){saveToFirebase('prod',prodData);saveToFirebase('ship',shipData);saveToFirebase('defect',defectTypeData);}
        updateSmartLists(); updateUI(); updateLastUpdate(); closeBackupModal();
        alert(lang==='ko'?'âœ… ë³µì› ì™„ë£Œ!':'âœ… Restore complete!');
    };
    if(db){db.ref('backups/'+key).once('value',s=>doRestore(s.val()));}
    else{try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');doRestore(bs[key]);}catch(e){}}
}
function deleteBackup(key){
    if(!confirm(lang==='ko'?'ì´ ë°±ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?':'Delete this backup?'))return;
    if(db){db.ref('backups/'+key).remove().then(()=>loadBackupList());}
    else{try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');delete bs[key];localStorage.setItem('ds_backups',JSON.stringify(bs));loadBackupList();}catch(e){}}
}
function openBackupModal(){ document.getElementById('backupModal').classList.add('open'); loadBackupList(); }
function closeBackupModal(){ document.getElementById('backupModal').classList.remove('open'); }

Chart.register(ChartDataLabels);

function initFirebase(){
    if(!isConfigured){
        document.getElementById('configBanner').style.display='block';
        document.getElementById('loadingOverlay').style.display='none';
        setSyncStatus('offline','âš ï¸ Firebase ë¯¸ì„¤ì •');
        prodData=getDefaultProdData(); shipData=getDefaultShipData(); defectTypeData=getDefaultDefectData();
        initUI(); return;
    }
    try{
        firebase.initializeApp(FIREBASE_CONFIG); db=firebase.database();
        setupListeners();
    }catch(e){ setSyncStatus('offline','ì—°ê²° ì˜¤ë¥˜'); document.getElementById('loadingOverlay').style.display='none'; }
}

function setupListeners(){
    setSyncStatus('saving','ë°ì´í„° ë¡œë”© ì¤‘...');
    db.ref('prodData').on('value',s=>{ prodData=s.val()?Object.values(s.val()):getDefaultProdData(); dataLoaded.prod=true; checkLoaded(); });
    db.ref('shipData').on('value',s=>{ shipData=s.val()?Object.values(s.val()):getDefaultShipData(); dataLoaded.ship=true; checkLoaded(); });
    db.ref('defectTypeData').on('value',s=>{ defectTypeData=s.val()?Object.values(s.val()):getDefaultDefectData(); dataLoaded.defect=true; checkLoaded(); });
    firebase.database().ref('.info/connected').on('value',s=>setSyncStatus(s.val()?'online':'offline',s.val()?'ì‹¤ì‹œê°„ ì—°ê²°ë¨':'ì˜¤í”„ë¼ì¸'));
}

function checkLoaded(){ if(dataLoaded.prod&&dataLoaded.ship&&dataLoaded.defect){ document.getElementById('loadingOverlay').style.display='none'; initUI(); } }
function initUI(){ updateSmartLists(); renderFilterButtons(); updateUI(); updateLastUpdate(); }
function setSyncStatus(t,x){ const e=document.getElementById('syncStatus'); e.className='sync-'+t; document.getElementById('syncText').textContent=x; }

function saveToFirebase(type,data){
    if(!db) return Promise.resolve();
    setSyncStatus('saving','ì €ì¥ ì¤‘...');
    const k=type==='prod'?'prodData':type==='ship'?'shipData':'defectTypeData';
    return db.ref(k).set(data).then(()=>setSyncStatus('online','ì‹¤ì‹œê°„ ì—°ê²°ë¨')).catch(()=>setSyncStatus('offline','ì €ì¥ ì‹¤íŒ¨'));
}

function getDefaultProdData(){return[{"prod":"RDIMM","month":"10ì›”","proc":"SMD","in":3450,"out":3450,"fail":0},{"prod":"RDIMM","month":"10ì›”","proc":"ROUTER","in":3450,"out":3450,"fail":0},{"prod":"RDIMM","month":"10ì›”","proc":"ATE","in":3450,"out":3448,"fail":2},{"prod":"RDIMM","month":"10ì›”","proc":"PCT","in":3448,"out":3418,"fail":30},{"prod":"RDIMM","month":"10ì›”","proc":"AVI","in":3418,"out":3413,"fail":5},{"prod":"RDIMM","month":"11ì›”","proc":"SMD","in":1410,"out":1410,"fail":0},{"prod":"RDIMM","month":"11ì›”","proc":"ROUTER","in":1410,"out":1409,"fail":1},{"prod":"RDIMM","month":"11ì›”","proc":"ATE","in":1409,"out":1407,"fail":2},{"prod":"RDIMM","month":"11ì›”","proc":"PCT","in":1407,"out":1386,"fail":21},{"prod":"RDIMM","month":"11ì›”","proc":"AVI","in":1386,"out":1384,"fail":2},{"prod":"RDIMM","month":"12ì›”","proc":"SMD","in":7632,"out":7630,"fail":2},{"prod":"RDIMM","month":"12ì›”","proc":"ROUTER","in":7630,"out":7628,"fail":2},{"prod":"RDIMM","month":"12ì›”","proc":"ATE","in":7628,"out":7622,"fail":6},{"prod":"RDIMM","month":"12ì›”","proc":"PCT","in":7622,"out":7581,"fail":41},{"prod":"RDIMM","month":"12ì›”","proc":"AVI","in":7581,"out":7576,"fail":5},{"prod":"RDIMM","month":"1ì›”","proc":"SMD","in":3204,"out":3204,"fail":0},{"prod":"RDIMM","month":"1ì›”","proc":"ROUTER","in":3204,"out":3204,"fail":0},{"prod":"RDIMM","month":"1ì›”","proc":"ATE","in":3204,"out":3201,"fail":3},{"prod":"RDIMM","month":"1ì›”","proc":"PCT","in":3201,"out":3179,"fail":22},{"prod":"RDIMM","month":"1ì›”","proc":"AVI","in":3179,"out":3179,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"SMD","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"ROUTER","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"ATE","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"PCT","in":2574,"out":2562,"fail":12},{"prod":"SODIMM","month":"11ì›”","proc":"AVI","in":2562,"out":2559,"fail":3},{"prod":"SODIMM","month":"12ì›”","proc":"SMD","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12ì›”","proc":"ROUTER","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12ì›”","proc":"ATE","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12ì›”","proc":"PCT","in":1404,"out":1399,"fail":5},{"prod":"SODIMM","month":"12ì›”","proc":"AVI","in":1399,"out":1398,"fail":1},{"prod":"UDIMM","month":"12ì›”","proc":"SMD","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12ì›”","proc":"ROUTER","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12ì›”","proc":"ATE","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12ì›”","proc":"PCT","in":4212,"out":4198,"fail":14},{"prod":"UDIMM","month":"12ì›”","proc":"AVI","in":4198,"out":4198,"fail":0},{"prod":"UDIMM","month":"1ì›”","proc":"SMD","in":2046,"out":2046,"fail":0},{"prod":"UDIMM","month":"1ì›”","proc":"ROUTER","in":2046,"out":2046,"fail":0},{"prod":"UDIMM","month":"1ì›”","proc":"ATE","in":2046,"out":2045,"fail":1},{"prod":"UDIMM","month":"1ì›”","proc":"PCT","in":2045,"out":2042,"fail":3},{"prod":"UDIMM","month":"1ì›”","proc":"AVI","in":2042,"out":2042,"fail":0}];}
function getDefaultShipData(){return[{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-10-28","qty":1026,"reason":"Mass Production","month":"25.10"},{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-11-06","qty":4304,"reason":"Mass Production","month":"25.11"},{"model":"UDIMM","name":"M323R2GA3EB0-CWMOL-IYB","date":"2025-11-25","qty":2000,"reason":"Mass Production","month":"25.11"},{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-12-16","qty":2344,"reason":"Mass Production","month":"25.12"},{"model":"SODIMM","name":"M425R2GA3EB0-CWMOL-IYB","date":"2025-12-16","qty":1935,"reason":"Mass Production","month":"25.12"}];}
function getDefaultDefectData(){return[{"reason":"Human Error","month":"25.10","qty":0},{"reason":"Human Error","month":"25.11","qty":3},{"reason":"Human Error","month":"25.12","qty":1},{"reason":"Human Error","month":"26.01","qty":0},{"reason":"Handling Damage","month":"25.10","qty":5},{"reason":"Handling Damage","month":"25.11","qty":3},{"reason":"Handling Damage","month":"25.12","qty":8},{"reason":"Handling Damage","month":"26.01","qty":0},{"reason":"Component Lifting","month":"25.10","qty":0},{"reason":"Component Lifting","month":"25.11","qty":0},{"reason":"Component Lifting","month":"25.12","qty":1},{"reason":"Component Lifting","month":"26.01","qty":0}];}

const T={ko:{mainTitle:'ğŸ“Š DS Quality Performance',lblProd:'ì œí’ˆ',lblPeriod:'ê¸°ê°„',lblProcess:'ê³µì •',btnProd:'âœï¸ ìƒì‚° ì…ë ¥',btnShip:'ğŸ“¦ ì¶œí•˜ ì…ë ¥',btnDefect:'ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ì…ë ¥',lblKpiYield:'ì¢…í•© ìˆ˜ìœ¨',lblKpiPPM:'ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ë¥ ',lblKpiInput:'ì´ íˆ¬ì… ìˆ˜ëŸ‰',lblKpiOutput:'ì´ ì‚°ì¶œ ìˆ˜ëŸ‰',lblKpiDefect:'ì´ ë¶ˆëŸ‰ ìˆ˜ëŸ‰',lblKpiCompDefect:'ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰',titProcYield:'ê³µì •ë³„ ìˆ˜ìœ¨ í˜„í™©',titMonthYield:'ê³µì •ë³„ ì›”ë³„ ìˆ˜ìœ¨ ì¶”ì´',titProdYield:'ì œí’ˆë³„ ìˆ˜ìœ¨ í˜„í™©',titTotalTrend:'ì¢…í•© ìˆ˜ìœ¨ ì›”ë³„ íŠ¸ë Œë“œ (%)',titProdTrend:'ì œí’ˆë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)',titProcTrend:'ê³µì •ë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)',titProdVol:'DS ìƒì‚° ì‹¤ì ',titTotalDefect:'ì›”ë³„ ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ',titCompDefect:'ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ',titDefectType:'ë¶ˆëŸ‰ ìœ í˜• ì°¨íŠ¸',titDefectTable:'ë¶ˆëŸ‰ ìœ í˜• ìƒì„¸ í˜„í™©',titDefectSection:'ğŸ“‰ ë¶ˆëŸ‰ ë¶„ì„ ë° ìƒì„¸ í˜„í™©',titShipSection:'ğŸ“¦ ì¶œí•˜ ì‹¤ì ',titShipTable:'ì›”ë³„ ì¶œí•˜ ìˆ˜ëŸ‰',titShipChart:'ì›”ë³„ ì¶œí•˜ ì‹¤ì  ì¶”ì´',thProc:'ê³µì •',thIn:'íˆ¬ì…',thOut:'ì‚°ì¶œ',thFail:'ë¶ˆëŸ‰',thYld:'ìˆ˜ìœ¨',thStat:'íŒì •',thMonth:'ê¸°ê°„',thProd:'ì œí’ˆ',thIn2:'íˆ¬ì…',thOut2:'ì‚°ì¶œ',thFail2:'ë¶ˆëŸ‰',thYld2:'ìˆ˜ìœ¨',thStat2:'íŒì •',thShipMonth:'ê¸°ê°„',thTotal:'í•©ê³„',moTitProd:'âœï¸ ìƒì‚° ë°ì´í„° ì…ë ¥',moTitShip:'ğŸ“¦ ì¶œí•˜ ë°ì´í„° ì…ë ¥',moTitDefect:'ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ë°ì´í„° ì…ë ¥',all:'ì „ì²´',good:'ì–‘í˜¸',warn:'ê²½ê³ '},en:{mainTitle:'ğŸ“Š DS Quality Performance',lblProd:'Product',lblPeriod:'Period',lblProcess:'Process',btnProd:'âœï¸ Production',btnShip:'ğŸ“¦ Shipment',btnDefect:'ğŸ› ï¸ Defect Types',lblKpiYield:'Overall Yield',lblKpiPPM:'Defect Rate (PPM)',lblKpiInput:'Total Input',lblKpiOutput:'Total Output',lblKpiDefect:'Total Defects',lblKpiCompDefect:'Company Defects',titProcYield:'Process Yield',titMonthYield:'Monthly Process Yield',titProdYield:'Product Yield',titTotalTrend:'Overall Yield Trend (%)',titProdTrend:'Product Yield Trend (%)',titProcTrend:'Process Yield Trend (%)',titProdVol:'Production Volume',titTotalDefect:'Total Defect Trend',titCompDefect:'Company Defect Trend',titDefectType:'Defect Type Chart',titDefectTable:'Defect Type Details',titDefectSection:'ğŸ“‰ Defect Analysis',titShipSection:'ğŸ“¦ Shipment Performance',titShipTable:'Monthly Shipment',titShipChart:'Shipment Trend',thProc:'Process',thIn:'Input',thOut:'Output',thFail:'Defect',thYld:'Yield',thStat:'Status',thMonth:'Period',thProd:'Product',thIn2:'Input',thOut2:'Output',thFail2:'Defect',thYld2:'Yield',thStat2:'Status',thShipMonth:'Period',thTotal:'Total',moTitProd:'âœï¸ Production Data Entry',moTitShip:'ğŸ“¦ Shipment Data Entry',moTitDefect:'ğŸ› ï¸ Defect Type Data Entry',all:'All',good:'Good',warn:'Warning'}};

function getUV(a,k){return[...new Set(a.map(d=>d[k]))].filter(v=>v&&v.toString().trim()).sort();}
function updateSmartLists(){
    document.querySelectorAll('datalist').forEach(d=>d.remove());
    const months=[...new Set([...prodData.map(d=>d.month),...shipData.map(d=>d.month),...defectTypeData.map(d=>d.month)])];
    const dReasons=[...new Set([...getUV(defectTypeData,'reason'),'Human Error','Handling Damage','Component Lifting'])];
    const sReasons=[...new Set([...getUV(shipData,'reason'),'Mass Production','Sample','RMA'])];
    document.body.insertAdjacentHTML('beforeend',`<datalist id="list-products"><option value="RDIMM"><option value="SODIMM"><option value="UDIMM"></datalist><datalist id="list-months">${months.map(m=>`<option value="${m}">`).join('')}</datalist><datalist id="list-model-names">${getUV(shipData,'name').map(n=>`<option value="${n}">`).join('')}</datalist><datalist id="list-ship-reasons">${sReasons.map(r=>`<option value="${r}">`).join('')}</datalist><datalist id="list-defect-reasons">${dReasons.map(r=>`<option value="${r}">`).join('')}</datalist>`);
}
function updateLastUpdate(){
    const el=document.getElementById('lastUpdate'); if(!el)return;
    const n=new Date(), p=x=>String(x).padStart(2,'0');
    el.innerText=(lang==='ko'?'ìµœì¢… ì—…ë°ì´íŠ¸: ':'Last Update: ')+`${n.getFullYear()}-${p(n.getMonth()+1)}-${p(n.getDate())} ${p(n.getHours())}:${p(n.getMinutes())}:${p(n.getSeconds())}`;
}
window.onload=initFirebase;

function extractYM(s){
    if(!s)return''; const c=s.toString().trim();
    if(/^\d{2}\.\d{2}$/.test(c))return c;
    const km=c.match(/(\d{2,4})\s*ë…„\s*(\d{1,2})\s*ì›”?/);
    if(km){let y=km[1];const m=km[2].padStart(2,'0');if(y.length===4)y=y.slice(2);return`${y}.${m}`;}
    const dm=c.match(/(\d{4})[-/](\d{1,2})/);
    if(dm)return`${dm[1].slice(2)}.${dm[2].padStart(2,'0')}`;
    return c;
}
function fmtPeriod(p){
    if(!/^\d{2}\.\d{2}$/.test(p))return p;
    const[y,m]=p.split('.'),mn=parseInt(m);
    if(lang==='en'){const ns=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${ns[mn]} ${y}`;}
    return`${y}ë…„ ${mn}ì›”`;
}
function getPM(){return[...new Set(prodData.map(d=>d.month))].sort();}
function getSM(){return[...new Set(shipData.map(d=>d.month))].sort();}
function getDM(){return[...new Set(defectTypeData.map(d=>d.month))].sort();}
function getAM(){return[...new Set([...prodData.map(d=>d.month),...shipData.map(d=>d.month),...defectTypeData.map(d=>d.month)])].sort();}
function getFD(){return prodData.filter(d=>(filters.product==='ì „ì²´'||d.prod===filters.product)&&(filters.month==='ì „ì²´'||d.month===filters.month)&&(filters.process==='ì „ì²´'||d.proc===filters.process));}
function cleanNum(v){return Number((v||'').toString().replace(/[,\s]/g,''))||0;}

function saveData(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const rows=document.querySelector(`#${tid} tbody`).querySelectorAll('tr');
    const nd=[];
    rows.forEach(tr=>{
        const i=tr.querySelectorAll('input,select');
        if(type==='prod'&&i[0].value)nd.push({prod:i[0].value,month:i[1].value.trim(),proc:i[2].value,in:cleanNum(i[3].value),out:cleanNum(i[4].value),fail:cleanNum(i[5].value)});
        else if(type==='ship'&&i[0].value.trim())nd.push({model:i[0].value.trim(),name:i[1].value.trim(),date:i[2].value.trim(),qty:cleanNum(i[3].value),reason:i[4].value.trim(),month:i[5].value.trim()});
        else if(type==='defect'&&i[0].value.trim())nd.push({reason:i[0].value.trim(),month:i[1].value.trim(),qty:cleanNum(i[2].value)});
    });
    if(!nd.length){alert('âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
    if(type==='prod')prodData=nd; else if(type==='ship')shipData=nd; else defectTypeData=nd;
    saveToFirebase(type,nd).then(()=>{
        closeModal(type); updateSmartLists(); updateUI(); updateLastUpdate();
        const s=document.getElementById('saveSuccess'); s.style.display='block'; setTimeout(()=>s.style.display='none',3000);
    });
}

function setLang(l){
    lang=l;
    document.getElementById('btnKo').className=l==='ko'?'lang-btn active':'lang-btn';
    document.getElementById('btnEn').className=l==='en'?'lang-btn active':'lang-btn';
    for(let k in T[lang]){const e=document.getElementById(k);if(e)e.innerText=T[lang][k];}
    updateUI(); updateLastUpdate(); updateModalLang();
}
function filter(t,v){filters[t]=v; updateUI();}

function renderProdChartBtns(){
    const c=document.getElementById('prodChartFilter'); if(!c)return; c.innerHTML='';
    ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(prodChartFilter===p?' active':'');
        b.innerText=p==='ì „ì²´'?T[lang].all:p; b.onclick=()=>setPCF(p); c.appendChild(b);
    });
}
function setPCF(v){
    prodChartFilter=v;
    if(charts.prodYield){charts.prodYield.data.datasets.forEach((ds,i)=>charts.prodYield.setDatasetVisibility(i,v==='ì „ì²´'||ds.label===v));charts.prodYield.update();}
    renderProdChartBtns();
}
function renderProcChartBtns(){
    const c=document.getElementById('procChartFilter'); if(!c)return; c.innerHTML='';
    ['ì „ì²´','SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(procChartFilter===p?' active':'');
        b.innerText=p==='ì „ì²´'?T[lang].all:p; b.onclick=()=>setRCF(p); c.appendChild(b);
    });
}
function setRCF(v){
    procChartFilter=v;
    if(charts.procYield){charts.procYield.data.datasets.forEach((ds,i)=>charts.procYield.setDatasetVisibility(i,v==='ì „ì²´'||ds.label===v));charts.procYield.update();}
    renderProcChartBtns();
}
function renderDefectBtns(){
    const c=document.getElementById('defectTypeFilters'); if(!c)return; c.innerHTML='';
    const rs=[...new Set(defectTypeData.map(d=>d.reason))].sort();
    ['ì „ì²´',...rs].forEach(r=>{
        const b=document.createElement('button'); b.className='mini-btn'+(filters.defectType===r?' active':'');
        b.innerText=r==='ì „ì²´'?T[lang].all:r; b.onclick=()=>filter('defectType',r); c.appendChild(b);
    });
}

function updateDefectTable(){
    const tbl=document.getElementById('tblDefectType'); if(!tbl)return;
    const thead=tbl.querySelector('thead'), tbody=tbl.querySelector('tbody');
    const months=getDM(), reasons=[...new Set(defectTypeData.map(d=>d.reason))].sort();
    thead.innerHTML=`<tr><th>${lang==='ko'?'ê¸°ê°„':'Period'}</th>${reasons.map(r=>`<th>${r}</th>`).join('')}<th>${lang==='ko'?'í•©ê³„':'Total'}</th></tr>`;
    if(!months.length||!reasons.length){tbody.innerHTML=`<tr><td colspan="${reasons.length+2}" style="text-align:center;color:#94a3b8;padding:30px;">${lang==='ko'?'ë°ì´í„° ì—†ìŒ':'No data'}</td></tr>`;return;}
    const rt={};reasons.forEach(r=>rt[r]=defectTypeData.filter(d=>d.reason===r).reduce((a,b)=>a+b.qty,0));
    tbody.innerHTML=''; let grand=0;
    months.forEach(m=>{
        let rt2=0,row=`<tr><td><strong>${fmtPeriod(m)}</strong></td>`;
        reasons.forEach(r=>{
            const item=defectTypeData.find(d=>d.month===m&&d.reason===r), q=item?item.qty:0; rt2+=q;
            let cls='',dsp='';
            if(q===0){cls='d-zero';dsp='-';}else if(q<=2){cls='d-low';dsp=q.toLocaleString();}else if(q<=5){cls='d-med';dsp=q.toLocaleString();}else{cls='d-high';dsp=q.toLocaleString();}
            row+=`<td class="${cls}">${dsp}</td>`;
        });
        row+=`<td>${rt2.toLocaleString()}</td></tr>`;
        tbody.innerHTML+=row; grand+=rt2;
    });
    tbody.innerHTML+=`<tr class="grand-row"><td>${lang==='ko'?'ì „ì²´ í•©ê³„':'Grand Total'}</td>${reasons.map(r=>`<td>${rt[r].toLocaleString()}</td>`).join('')}<td>${grand.toLocaleString()}</td></tr>`;
}

function renderFilterButtons(){
    const pc=document.getElementById('filterProduct'); pc.innerHTML='';
    ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{const b=document.createElement('button');b.className='filter-btn'+(filters.product===p?' active':'');b.innerText=p==='ì „ì²´'?T[lang].all:p;b.onclick=()=>filter('product',p);pc.appendChild(b);});
    const mc=document.getElementById('filterMonth'); mc.innerHTML='';
    ['',...getAM()].forEach((m,i)=>{const b=document.createElement('button');const v=i===0?'ì „ì²´':m;b.className='filter-btn'+(filters.month===v?' active':'');b.innerText=i===0?T[lang].all:fmtPeriod(m);b.onclick=()=>filter('month',v);mc.appendChild(b);});
    const proc=document.getElementById('filterProcess'); proc.innerHTML='';
    ['ì „ì²´','SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{const b=document.createElement('button');b.className='filter-btn'+(filters.process===p?' active':'');b.innerText=p==='ì „ì²´'?T[lang].all:p;b.onclick=()=>filter('process',p);proc.appendChild(b);});
}

function updateUI(){
    renderFilterButtons(); renderProdChartBtns(); renderProcChartBtns(); renderDefectBtns();
    const data=getFD();
    let tI=0,tO=0,tF=0,cF=0;
    if(filters.process!=='ì „ì²´'){tI=data.reduce((a,b)=>a+b.in,0);tO=data.reduce((a,b)=>a+b.out,0);}
    else{tI=data.filter(d=>d.proc==='SMD').reduce((a,b)=>a+b.in,0);tO=data.filter(d=>d.proc==='AVI').reduce((a,b)=>a+b.out,0);}
    tF=data.reduce((a,b)=>a+b.fail,0);
    cF=data.filter(d=>['SMD','ROUTER','AVI'].includes(d.proc)).reduce((a,b)=>a+b.fail,0);
    const yv=tI>0?tO/tI*100:0, ppm=tI>0?cF/tI*1000000:0;
    document.getElementById('kpiYield').innerText=yv.toFixed(2)+'%';
    document.getElementById('kpiPPM').innerText=Math.round(ppm).toLocaleString()+' PPM';
    document.getElementById('kpiInput').innerText=tI.toLocaleString();
    document.getElementById('kpiOutput').innerText=tO.toLocaleString();
    document.getElementById('kpiDefect').innerText=tF.toLocaleString();
    document.getElementById('kpiCompDefect').innerText=cF.toLocaleString();
    updateTables(data); updateDefectTable(); drawCharts(data);
}

function updateTables(data){
    const t=T[lang];
    const pb=document.querySelector('#tblProcYield tbody'); pb.innerHTML='';
    ['SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
        const d=data.filter(r=>r.proc===p);
        const ti=d.reduce((a,b)=>a+b.in,0),to=d.reduce((a,b)=>a+b.out,0),tf=d.reduce((a,b)=>a+b.fail,0);
        const y=ti>0?to/ti*100:0, ok=y>=99.5;
        pb.innerHTML+=`<tr><td><strong>${p}</strong></td><td>${ti.toLocaleString()}</td><td>${to.toLocaleString()}</td><td>${tf.toLocaleString()}</td><td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td><td><span class="badge ${ok?'badge-ok':'badge-ng'}">${ok?t.good:t.warn}</span></td></tr>`;
    });
    const mb=document.querySelector('#tblMonthYield tbody'); mb.innerHTML='';
    getPM().forEach(m=>{
        const d=data.filter(r=>r.month===m); if(!d.length)return;
        let row=`<tr><td><strong>${fmtPeriod(m)}</strong></td>`;
        ['SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
            const pd=d.filter(r=>r.proc===p);
            const ti=pd.reduce((a,b)=>a+b.in,0),to=pd.reduce((a,b)=>a+b.out,0);
            row+=`<td class="${ti>0&&to/ti*100>=99.5?'yield-good':'yield-bad'}">${ti>0?(to/ti*100).toFixed(2)+'%':'-'}</td>`;
        });
        mb.innerHTML+=row+'</tr>';
    });
    const prb=document.querySelector('#tblProdYield tbody'); prb.innerHTML='';
    ['RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const d=data.filter(r=>r.prod===p);
        const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0),to=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0),tf=d.reduce((a,b)=>a+b.fail,0);
        const y=ti>0?to/ti*100:0, ok=y>=99.5;
        prb.innerHTML+=`<tr><td><strong>${p}</strong></td><td>${ti.toLocaleString()}</td><td>${to.toLocaleString()}</td><td>${tf.toLocaleString()}</td><td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td><td><span class="badge ${ok?'badge-ok':'badge-ng'}">${ok?t.good:t.warn}</span></td></tr>`;
    });
    const sb=document.querySelector('#tblShipment tbody'); sb.innerHTML='';
    getSM().forEach(m=>{
        const d=shipData.filter(r=>r.month===m); if(!d.length)return;
        const r=d.filter(x=>x.model.toUpperCase()==='RDIMM').reduce((a,b)=>a+b.qty,0);
        const s=d.filter(x=>x.model.toUpperCase()==='SODIMM').reduce((a,b)=>a+b.qty,0);
        const u=d.filter(x=>x.model.toUpperCase()==='UDIMM').reduce((a,b)=>a+b.qty,0);
        sb.innerHTML+=`<tr><td><strong>${fmtPeriod(m)}</strong></td><td>${r.toLocaleString()}</td><td>${s.toLocaleString()}</td><td>${u.toLocaleString()}</td><td style="font-weight:800;color:#4f46e5;font-family:'DM Mono',monospace">${(r+s+u).toLocaleString()}</td></tr>`;
    });
}

function drawCharts(data){
    const pm=getPM(), pl=pm.map(m=>fmtPeriod(m));
    const sm=getSM(), sl=sm.map(m=>fmtPeriod(m));
    const dm=getDM(), dl=dm.map(m=>fmtPeriod(m));
    const reasons=[...new Set(defectTypeData.map(d=>d.reason))];
    Object.values(charts).forEach(c=>c&&c.destroy()); charts={};

    const baseOpts={
        responsive:true, maintainAspectRatio:false,
        layout:{padding:{top:40}},
        plugins:{
            legend:{position:'bottom',labels:{boxWidth:10,boxHeight:10,padding:14,font:{size:12,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:10}},
            datalabels:{color:'#0c1e3e',backgroundColor:'rgba(255,255,255,0.92)',borderRadius:5,padding:{top:3,right:7,bottom:3,left:7},font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},anchor:'end',align:'end',offset:8,clip:false,display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,formatter:v=>v?v.toLocaleString():''}
        },
        scales:{
            x:{grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},color:'#94a3b8'},border:{display:false}},
            y:{grid:{color:'#f1f5f9',drawBorder:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false},grace:'20%'}
        }
    };

    try{
        const totalY=pm.map(m=>{const d=data.filter(r=>r.month===m);const i=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);const o=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0);return i>0?o/i*100:null;});
        // Fix 1: Extra left/right padding so labels don't overlap Y axis
        charts.totalYield=new Chart(document.getElementById('chartTotalYield'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiYield,data:totalY,borderColor:'#4f46e5',backgroundColor:'rgba(79,70,229,0.06)',fill:true,tension:0.4,pointBackgroundColor:'white',pointBorderColor:'#4f46e5',pointBorderWidth:2.5,pointRadius:5,borderWidth:2.5}]},options:{...baseOpts,layout:{padding:{left:10,right:30,top:36,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{...baseOpts.plugins.datalabels,formatter:v=>v?v.toFixed(2)+'%':'',color:'#4f46e5',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:8,bottom:4,left:8},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},offset:10}},scales:{...baseOpts.scales,y:{...baseOpts.scales.y,min:95,max:101}}}});

        charts.prodYield=new Chart(document.getElementById('chartProdYield'),{type:'line',data:{labels:pl,datasets:['RDIMM','SODIMM','UDIMM'].map((p,i)=>({label:p,borderColor:['#f43f5e','#0891b2','#f59e0b'][i],backgroundColor:['rgba(244,63,94,0.05)','rgba(8,145,178,0.05)','rgba(245,158,11,0.05)'][i],fill:true,tension:0.4,borderWidth:2.5,pointRadius:4,pointBorderWidth:2,pointBackgroundColor:'white',data:pm.map(m=>{const d=data.filter(r=>r.month===m&&r.prod===p);const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);const to=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0);return ti>0?to/ti*100:null;})}))},options:{...baseOpts,plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{display:false}},scales:{...baseOpts.scales,y:{...baseOpts.scales.y,min:95,max:101}}}});

        charts.procYield=new Chart(document.getElementById('chartProcYield'),{type:'line',data:{labels:pl,datasets:['SMD','ROUTER','ATE','PCT','AVI'].map((p,i)=>({label:p,borderColor:['#8b5cf6','#ec4899','#6366f1','#f59e0b','#10b981'][i],tension:0.4,borderWidth:2.5,pointRadius:4,pointBorderWidth:2,pointBackgroundColor:'white',data:pm.map(m=>{const d=data.filter(r=>r.month===m&&r.proc===p);const ti=d.reduce((a,b)=>a+b.in,0);const to=d.reduce((a,b)=>a+b.out,0);return ti>0?to/ti*100:null;})}))},options:{...baseOpts,plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{display:false}},scales:{...baseOpts.scales,y:{...baseOpts.scales.y,min:95,max:101}}}});

        charts.prodVol=new Chart(document.getElementById('chartProdVol'),{type:'bar',data:{labels:pl,datasets:[{label:T[lang].lblKpiInput,data:pm.map(m=>data.filter(r=>r.month===m&&r.proc==='SMD').reduce((a,b)=>a+b.in,0)),backgroundColor:'rgba(79,70,229,0.7)',borderRadius:6,borderSkipped:false,hoverBackgroundColor:'rgba(79,70,229,0.9)'}]},options:{...baseOpts,plugins:{...baseOpts.plugins,datalabels:{...baseOpts.plugins.datalabels,color:'#4f46e5'}}}});

        const defData=pm.map(m=>data.filter(r=>r.month===m).reduce((a,b)=>a+b.fail,0));
        charts.totalDefect=new Chart(document.getElementById('chartTotalDefect'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiDefect,data:defData,borderColor:'#f43f5e',backgroundColor:'rgba(244,63,94,0.07)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:'#f43f5e',pointBorderWidth:2.5}]},options:{...baseOpts,plugins:{...baseOpts.plugins,datalabels:{...baseOpts.plugins.datalabels,color:'#f43f5e',offset:10}}}});

        const compDef=pm.map(m=>data.filter(r=>r.month===m&&['SMD','ROUTER','AVI'].includes(r.proc)).reduce((a,b)=>a+b.fail,0));
        charts.compDefect=new Chart(document.getElementById('chartCompDefect'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiCompDefect,data:compDef,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.07)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:'#f59e0b',pointBorderWidth:2.5}]},options:{...baseOpts,plugins:{...baseOpts.plugins,datalabels:{...baseOpts.plugins.datalabels,color:'#d97706',offset:10}}}});

        const sColors=['#3b82f6','#10b981','#f59e0b'];
        const sDS=['RDIMM','SODIMM','UDIMM'].map((m,i)=>({label:m,data:sm.map(mo=>shipData.filter(r=>r.month===mo&&r.model===m).reduce((a,b)=>a+b.qty,0)),backgroundColor:sColors[i],borderRadius:5,stack:'s0',datalabels:{display:true,color:'white',font:{weight:'bold',size:11,family:'DM Mono'},anchor:'center',align:'center',formatter:v=>v>0?v.toLocaleString():''}}));
        const sTotals=sm.map(mo=>shipData.filter(r=>r.month===mo).reduce((a,b)=>a+b.qty,0));
        charts.shipment=new Chart(document.getElementById('chartShipment'),{type:'bar',data:{labels:sl,datasets:[...sDS,{type:'line',label:'Total',data:sTotals,borderColor:'transparent',backgroundColor:'transparent',pointRadius:0,datalabels:{display:true,anchor:'end',align:'end',color:'#0c1e3e',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:8,bottom:4,left:8},font:{weight:'bold',size:12,family:'DM Mono'},formatter:v=>v.toLocaleString(),offset:14},order:-1}]},options:{...baseOpts,layout:{padding:{top:50}},plugins:{...baseOpts.plugins,legend:{...baseOpts.plugins.legend,labels:{...baseOpts.plugins.legend.labels,filter:item=>item.text!=='Total'}},datalabels:{display:false}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Plus Jakarta Sans',weight:'600'},color:'#94a3b8'},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Plus Jakarta Sans'},color:'#94a3b8'},border:{display:false}}}}});

        const palCols=['#6366f1','#06b6d4','#f59e0b','#f43f5e','#10b981'];
        let dDS=reasons.map((r,i)=>({label:r,data:dm.map(m=>{const d=defectTypeData.find(x=>x.month===m&&x.reason===r);return d?d.qty:0;}),backgroundColor:palCols[i%5],borderRadius:4,borderSkipped:false,stack:'s0'}));
        if(filters.defectType!=='ì „ì²´')dDS=dDS.filter(ds=>ds.label===filters.defectType);
        charts.defectType=new Chart(document.getElementById('chartDefectType'),{type:'bar',data:{labels:dl,datasets:dDS},options:{...baseOpts,plugins:{...baseOpts.plugins,datalabels:{...baseOpts.plugins.datalabels,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',font:{weight:'bold',size:11,family:'JetBrains Mono, monospace'}}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false},grace:'20%'}}}});

        // Pie chart
        const pieVals=reasons.map(r=>defectTypeData.filter(d=>d.reason===r).reduce((a,b)=>a+b.qty,0));
        charts.defectTypePie=new Chart(document.getElementById('chartDefectTypePie'),{
            type:'doughnut',
            data:{labels:reasons,datasets:[{data:pieVals,backgroundColor:palCols,borderWidth:3,borderColor:'white',hoverBorderWidth:5,hoverOffset:6}]},
            options:{
                responsive:true, maintainAspectRatio:false, cutout:'52%',
                layout:{padding:{top:20,bottom:20,left:20,right:20}},
                plugins:{
                    legend:{
                        position:'right',
                        labels:{font:{size:12,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},padding:14,usePointStyle:true,pointStyleWidth:10,color:'#334155'}
                    },
                    datalabels:{
                        display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,
                        color:'white',
                        backgroundColor:'rgba(0,0,0,0.0)',
                        font:{weight:'800',size:13,family:'JetBrains Mono, monospace'},
                        textStrokeColor:'rgba(0,0,0,0.4)',
                        textStrokeWidth:3,
                        formatter:(v,ctx)=>{
                            const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                            const pct=(v*100/total).toFixed(1);
                            return v>0?pct+'%':'';
                        },
                        anchor:'center', align:'center', offset:0
                    }
                }
            }
        });
    }catch(e){console.error('ì°¨íŠ¸ ì˜¤ë¥˜:',e);}
}

function openModal(t){
    requirePassword(()=>{
        document.getElementById(t==='prod'?'modalProd':t==='ship'?'modalShip':'modalDefect').style.display='block';
        renderEntryTable(t);
        updateModalLang();
    });
}
function closeModal(t){document.getElementById(t==='prod'?'modalProd':t==='ship'?'modalShip':'modalDefect').style.display='none';}
function clearTable(t){if(!confirm(lang==='ko'?'âš ï¸ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?':'âš ï¸ Reset all data?'))return;document.querySelector(`#${t==='prod'?'tblEntryProd':t==='ship'?'tblEntryShip':'tblEntryDefect'} tbody`).innerHTML='';document.getElementById(t==='prod'?'pasteProd':t==='ship'?'pasteShip':'pasteDefect').value='';}

function updateModalLang(){
    const t=T[lang];
    // Password modal
    document.getElementById('pwTitle').innerText=lang==='ko'?'ë°ì´í„° ì…ë ¥ ë¹„ë°€ë²ˆí˜¸':'Password Required';
    document.getElementById('pwSub').innerText=lang==='ko'?'ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”':'Enter password to edit data';
    document.getElementById('pwOkBtn').innerText=lang==='ko'?'í™•ì¸':'Confirm';
    document.getElementById('pwCancelBtn').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Prod modal
    document.getElementById('moTitProd').innerText=t.moTitProd;
    document.querySelector('#modalProd .modal-desc').innerHTML=lang==='ko'?'Excelì—ì„œ <strong>[ì œí’ˆ | ê¸°ê°„ | ê³µì • | íˆ¬ì… | ì‚°ì¶œ | ë¶ˆëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.':'Paste from Excel in order: <strong>[Product | Period | Process | Input | Output | Defect]</strong>';
    document.getElementById('pasteProd').placeholder=lang==='ko'?'Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)':'Paste Excel data here (Ctrl+V)';
    document.querySelector('#modalProd .btn-parse').innerText=lang==='ko'?'ğŸ“‹ ë°ì´í„° ì ìš©':'ğŸ“‹ Apply Data';
    document.querySelector('#modalProd .btn-clr').innerText=lang==='ko'?'ğŸ—‘ï¸ ì´ˆê¸°í™”':'ğŸ—‘ï¸ Reset';
    document.querySelector('#tblEntryProd thead tr').innerHTML=`<th>${lang==='ko'?'ì œí’ˆ':'Product'}</th><th>${lang==='ko'?'ê¸°ê°„':'Period'}</th><th>${lang==='ko'?'ê³µì •':'Process'}</th><th>${lang==='ko'?'íˆ¬ì…':'Input'}</th><th>${lang==='ko'?'ì‚°ì¶œ':'Output'}</th><th>${lang==='ko'?'ë¶ˆëŸ‰':'Defect'}</th><th>${lang==='ko'?'ì‚­ì œ':'Del'}</th>`;
    document.querySelector('#modalProd .btn-addrow').innerText=lang==='ko'?'+ í–‰ ì¶”ê°€':'+ Add Row';
    document.querySelector('#modalProd .btn-save').innerText=lang==='ko'?'ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)':'ğŸ’¾ Save (Sync Now)';
    document.querySelector('#modalProd .btn-cancel').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Ship modal
    document.getElementById('moTitShip').innerText=t.moTitShip;
    document.querySelector('#modalShip .modal-desc').innerHTML=lang==='ko'?'Excelì—ì„œ <strong>[ëª¨ë¸ | ëª¨ë¸ëª… | ë‚ ì§œ | ìˆ˜ëŸ‰ | ì‚¬ìœ ]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.':'Paste from Excel: <strong>[Model | Name | Date | Qty | Reason]</strong>';
    document.getElementById('pasteShip').placeholder=lang==='ko'?'Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)':'Paste Excel data here (Ctrl+V)';
    document.querySelector('#modalShip .btn-parse').innerText=lang==='ko'?'ğŸ“‹ ë°ì´í„° ì ìš©':'ğŸ“‹ Apply Data';
    document.querySelector('#modalShip .btn-clr').innerText=lang==='ko'?'ğŸ—‘ï¸ ì´ˆê¸°í™”':'ğŸ—‘ï¸ Reset';
    document.querySelector('#tblEntryShip thead tr').innerHTML=`<th>${lang==='ko'?'ëª¨ë¸':'Model'}</th><th>${lang==='ko'?'ëª¨ë¸ëª…':'Name'}</th><th>${lang==='ko'?'ë‚ ì§œ':'Date'}</th><th>${lang==='ko'?'ìˆ˜ëŸ‰':'Qty'}</th><th>${lang==='ko'?'ì‚¬ìœ ':'Reason'}</th><th>${lang==='ko'?'ê¸°ê°„(ìë™)':'Period(auto)'}</th><th>${lang==='ko'?'ì‚­ì œ':'Del'}</th>`;
    document.querySelector('#modalShip .btn-addrow').innerText=lang==='ko'?'+ í–‰ ì¶”ê°€':'+ Add Row';
    document.querySelector('#modalShip .btn-save').innerText=lang==='ko'?'ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)':'ğŸ’¾ Save (Sync Now)';
    document.querySelector('#modalShip .btn-cancel').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Defect modal
    document.getElementById('moTitDefect').innerText=t.moTitDefect;
    document.querySelector('#modalDefect .modal-desc').innerHTML=lang==='ko'?'Excelì—ì„œ <strong>[ë¶ˆëŸ‰ëª… | ê¸°ê°„(YY.MM) | ìˆ˜ëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.':'Paste from Excel: <strong>[Defect Name | Period(YY.MM) | Qty]</strong>';
    document.getElementById('pasteDefect').placeholder=lang==='ko'?'ì˜ˆì‹œ: Human Error\t26.02\t5':'Example: Human Error\t26.02\t5';
    document.querySelector('#modalDefect .btn-parse').innerText=lang==='ko'?'ğŸ“‹ ë°ì´í„° ì ìš©':'ğŸ“‹ Apply Data';
    document.querySelector('#modalDefect .btn-clr').innerText=lang==='ko'?'ğŸ—‘ï¸ ì´ˆê¸°í™”':'ğŸ—‘ï¸ Reset';
    document.querySelector('#tblEntryDefect thead tr').innerHTML=`<th>${lang==='ko'?'ë¶ˆëŸ‰ëª…':'Defect Name'}</th><th>${lang==='ko'?'ê¸°ê°„ (YY.MM)':'Period (YY.MM)'}</th><th>${lang==='ko'?'ìˆ˜ëŸ‰':'Qty'}</th><th>${lang==='ko'?'ì‚­ì œ':'Del'}</th>`;
    document.querySelector('#modalDefect .btn-addrow').innerText=lang==='ko'?'+ í–‰ ì¶”ê°€':'+ Add Row';
    document.querySelector('#modalDefect .btn-save').innerText=lang==='ko'?'ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)':'ğŸ’¾ Save (Sync Now)';
    document.querySelector('#modalDefect .btn-cancel').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Backup modal
    document.getElementById('backupTitle').innerText=lang==='ko'?'ğŸ’¾ ë°ì´í„° ë°±ì—… ê´€ë¦¬':'ğŸ’¾ Backup Manager';
    document.getElementById('backupSubTitle').innerText=lang==='ko'?'ìµœëŒ€ 10ê°œ ë°±ì—… ì €ì¥ Â· ì˜ëª» ì…ë ¥ ì‹œ ë³µì› ê°€ëŠ¥':'Up to 10 backups Â· Restore anytime';
    document.getElementById('backupNowBtn').innerText=lang==='ko'?'ğŸ“¸ ì§€ê¸ˆ ë°±ì—… ìƒì„±':'ğŸ“¸ Create Backup Now';
}

function renderEntryTable(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`); tbody.innerHTML='';
    const src=type==='prod'?prodData:type==='ship'?shipData:defectTypeData;
    src.forEach(d=>{
        const tr=document.createElement('tr');
        if(type==='prod'){tr.innerHTML=`<td><select><option value="">ì„ íƒ</option><option value="RDIMM"${d.prod==='RDIMM'?' selected':''}>RDIMM</option><option value="SODIMM"${d.prod==='SODIMM'?' selected':''}>SODIMM</option><option value="UDIMM"${d.prod==='UDIMM'?' selected':''}>UDIMM</option></select></td><td><input list="list-months" value="${d.month}"></td><td><select><option value="">ì„ íƒ</option><option value="SMD"${d.proc==='SMD'?' selected':''}>SMD</option><option value="ROUTER"${d.proc==='ROUTER'?' selected':''}>ROUTER</option><option value="ATE"${d.proc==='ATE'?' selected':''}>ATE</option><option value="PCT"${d.proc==='PCT'?' selected':''}>PCT</option><option value="AVI"${d.proc==='AVI'?' selected':''}>AVI</option></select></td><td><input type="number" value="${d.in}"></td><td><input type="number" value="${d.out}"></td><td><input type="number" value="${d.fail}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
        else if(type==='ship'){tr.innerHTML=`<td><input list="list-products" value="${d.model}"></td><td><input list="list-model-names" value="${d.name}"></td><td><input type="date" value="${d.date}"></td><td><input type="number" value="${d.qty}"></td><td><input list="list-ship-reasons" value="${d.reason}"></td><td><input list="list-months" value="${d.month}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
        else{tr.innerHTML=`<td><input list="list-defect-reasons" value="${d.reason||''}"></td><td><input list="list-months" value="${d.month||''}"></td><td><input type="number" value="${d.qty||0}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
        tbody.appendChild(tr);
    });
}

function addRow(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`);
    const tr=document.createElement('tr');
    if(type==='prod'){tr.innerHTML=`<td><select><option value="">ì„ íƒ</option><option value="RDIMM">RDIMM</option><option value="SODIMM">SODIMM</option><option value="UDIMM">UDIMM</option></select></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><select><option value="">ì„ íƒ</option><option value="SMD">SMD</option><option value="ROUTER">ROUTER</option><option value="ATE">ATE</option><option value="PCT">PCT</option><option value="AVI">AVI</option></select></td><td><input type="number" placeholder="1000"></td><td><input type="number" placeholder="995"></td><td><input type="number" value="0"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
    else if(type==='ship'){tr.innerHTML=`<td><input list="list-products" placeholder="RDIMM"></td><td><input list="list-model-names" placeholder="ëª¨ë¸ëª…"></td><td><input type="date"></td><td><input type="number" placeholder="1000"></td><td><input list="list-ship-reasons" placeholder="Mass Production"></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
    else{tr.innerHTML=`<td><input list="list-defect-reasons" placeholder="Human Error"></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><input type="number" value="0"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
    tbody.appendChild(tr); tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function parsePaste(type){
    const pid=type==='prod'?'pasteProd':type==='ship'?'pasteShip':'pasteDefect';
    const txt=document.getElementById(pid).value.trim();
    if(!txt){alert('ë¶™ì—¬ë„£ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`); let cnt=0;
    txt.split('\n').forEach(row=>{
        const c=row.split(/\t/); const tr=document.createElement('tr');
        if(type==='prod'&&c.length>=6){const mv=extractYM(c[1].trim());tr.innerHTML=`<td><select><option value="">ì„ íƒ</option><option value="RDIMM"${c[0].trim()==='RDIMM'?' selected':''}>RDIMM</option><option value="SODIMM"${c[0].trim()==='SODIMM'?' selected':''}>SODIMM</option><option value="UDIMM"${c[0].trim()==='UDIMM'?' selected':''}>UDIMM</option></select></td><td><input list="list-months" value="${mv}"></td><td><select><option value="">ì„ íƒ</option><option value="SMD"${c[2].trim()==='SMD'?' selected':''}>SMD</option><option value="ROUTER"${c[2].trim()==='ROUTER'?' selected':''}>ROUTER</option><option value="ATE"${c[2].trim()==='ATE'?' selected':''}>ATE</option><option value="PCT"${c[2].trim()==='PCT'?' selected':''}>PCT</option><option value="AVI"${c[2].trim()==='AVI'?' selected':''}>AVI</option></select></td><td><input type="number" value="${cleanNum(c[3])}"></td><td><input type="number" value="${cleanNum(c[4])}"></td><td><input type="number" value="${cleanNum(c[5])}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;tbody.appendChild(tr);cnt++;}
        else if(type==='ship'&&c.length>=5){const mv=c.length>=6&&c[5].trim()?extractYM(c[5].trim()):extractYM(c[2].trim());tr.innerHTML=`<td><input list="list-products" value="${c[0].trim()}"></td><td><input list="list-model-names" value="${c[1].trim()}"></td><td><input type="date" value="${c[2].trim()}"></td><td><input type="number" value="${cleanNum(c[3])}"></td><td><input list="list-ship-reasons" value="${c[4].trim()}"></td><td><input list="list-months" value="${mv}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;tbody.appendChild(tr);cnt++;}
        else if(type==='defect'&&c.length>=3){const mv=extractYM(c[1].trim());tr.innerHTML=`<td><input list="list-defect-reasons" value="${c[0].trim()}"></td><td><input list="list-months" value="${mv}"></td><td><input type="number" value="${cleanNum(c[2])}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;tbody.appendChild(tr);cnt++;}
    });
    if(cnt>0){alert(`âœ… ${cnt}ê°œ ë°ì´í„° ì¶”ê°€ë¨. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);document.getElementById(pid).value='';}
    else alert('âš ï¸ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
}

function exportExcel(){
    try{
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(prodData.map(d=>({'ì œí’ˆ':d.prod,'ê¸°ê°„':fmtPeriod(d.month),'ê³µì •':d.proc,'íˆ¬ì…':d.in,'ì‚°ì¶œ':d.out,'ë¶ˆëŸ‰':d.fail}))),"ìƒì‚°ë°ì´í„°");
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(shipData.map(d=>({'ëª¨ë¸':d.model,'ëª¨ë¸ëª…':d.name,'ì¶œí•˜ì¼':d.date,'ìˆ˜ëŸ‰':d.qty,'ì‚¬ìœ ':d.reason,'ê¸°ê°„':fmtPeriod(d.month)}))),"ì¶œí•˜ë°ì´í„°");
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(defectTypeData.map(d=>({'ë¶ˆëŸ‰ëª…':d.reason,'ê¸°ê°„':fmtPeriod(d.month),'ìˆ˜ëŸ‰':d.qty}))),"ë¶ˆëŸ‰ìœ í˜•ë°ì´í„°");
        XLSX.writeFile(wb,`DS_Quality_Performance_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.xlsx`);
        alert('âœ… Excel íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }catch(e){alert('Excel ì˜¤ë¥˜: '+e.message);}
}
window.onclick=e=>{
    if(e.target.classList.contains('modal'))e.target.style.display='none';
    if(e.target.id==='backupModal')closeBackupModal();
};
</script>
</body>
</html>
