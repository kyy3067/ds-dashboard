<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Quality Performance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        :root {
            --navy:       #00234d;
            --navy-mid:   #003470;
            --navy-light: #004B87;
            --gold:       #0074d9;
            --gold-light: #3498f0;
            --gold-pale:  #e8f4ff;
            --cyan:       #38bdf8;
            --success:    #10b981;
            --danger:     #f43f5e;
            --warning:    #f59e0b;
            --bg:         #f0f4fb;
            --surface:    #ffffff;
            --surface2:   #f8faff;
            --border:     #e0e8f5;
            --text:       #0c1e3e;
            --text-sub:   #5a7099;
            --text-muted: #94a3b8;
            --shadow-sm:  0 2px 8px rgba(12,30,62,0.07);
            --shadow-md:  0 8px 24px rgba(12,30,62,0.10);
            --shadow-lg:  0 20px 48px rgba(12,30,62,0.14);
            --r:          14px;
            --r-lg:       20px;
        }

        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 28px;
            background-image:
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0,116,217,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(91,184,255,0.06) 0%, transparent 50%);
            word-break: keep-all;
            -webkit-font-smoothing: antialiased;
        }

        /* â”€â”€â”€ Loading â”€â”€â”€ */
        #loadingOverlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #0c1e3e 0%, #152d56 100%);
            z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .loading-logo { font-size: 36px; font-weight: 900; color: white; letter-spacing: 3px; font-family: 'Inter', 'Noto Sans KR', sans-serif; text-transform: uppercase; }
        .loading-logo span { color: #5bb8ff; }
        .loading-bar {
            width: 200px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;
        }
        .loading-bar-inner {
            height: 100%; width: 0%; background: linear-gradient(90deg, #0074d9, #5bb8ff);
            border-radius: 2px; animation: loadBar 1.8s ease-in-out forwards;
        }
        @keyframes loadBar { to { width: 100%; } }
        .loading-text { font-size: 13px; color: rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 0.3px; font-family: 'Noto Sans KR', sans-serif; }

        /* â”€â”€â”€ Sync Status â”€â”€â”€ */
        #syncStatus {
            position: fixed; bottom: 24px; right: 24px;
            padding: 10px 18px; border-radius: 40px;
            font-size: 12px; font-weight: 700; z-index: 9999;
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(12px); letter-spacing: 0.3px;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .sync-online  { background: rgba(16,185,129,0.15); color: #059669; border-color: rgba(16,185,129,0.3); }
        .sync-saving  { background: rgba(245,158,11,0.15); color: #d97706; border-color: rgba(245,158,11,0.3); }
        .sync-offline { background: rgba(244,63,94,0.15);  color: #e11d48; border-color: rgba(244,63,94,0.3); }
        .sync-dot { width: 7px; height: 7px; border-radius: 50%; }
        .sync-online  .sync-dot { background: #059669; animation: blink 2s infinite; }
        .sync-saving  .sync-dot { background: #d97706; animation: blink 0.6s infinite; }
        .sync-offline .sync-dot { background: #e11d48; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* â”€â”€â”€ Save Toast â”€â”€â”€ */
        .save-toast {
            position: fixed; top: 28px; right: 28px;
            background: var(--navy); color: white;
            padding: 14px 22px; border-radius: var(--r);
            font-size: 14px; font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 9999; display: none;
            border-left: 4px solid var(--gold);
            animation: toastIn 0.4s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes toastIn { from{transform:translateY(-80px);opacity:0} to{transform:translateY(0);opacity:1} }

        /* â”€â”€â”€ Page Enter Animation â”€â”€â”€ */
        .fade-up {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeUp 0.5s ease forwards;
        }
        @keyframes fadeUp { to { opacity:1; transform:translateY(0); } }

        /* â”€â”€â”€ Header â”€â”€â”€ */
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border-radius: var(--r-lg);
            padding: 32px 36px;
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: fadeUp 0.5s ease forwards;
        }
        .header::before {
            content: '';
            position: absolute; top: -60px; right: -60px;
            width: 240px; height: 240px;
            background: radial-gradient(circle, rgba(91,184,255,0.15) 0%, transparent 70%);
            pointer-events: none;
        }
        .header::after {
            content: '';
            position: absolute; bottom: -40px; left: 30%;
            width: 300px; height: 180px;
            background: radial-gradient(ellipse, rgba(56,189,248,0.08) 0%, transparent 70%);
            pointer-events: none;
        }
        .header-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: start;
            gap: 24px;
            position: relative; z-index: 1;
        }
        .header-brand { display: flex; align-items: center; gap: 16px; margin-bottom: 6px; }
        .brand-badge {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #0074d9, #5bb8ff);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; box-shadow: 0 4px 12px rgba(0,116,217,0.4);
        }
        .header h1 {
            font-size: 24px; font-weight: 800; color: white;
            letter-spacing: -0.3px; line-height: 1.2;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        .header-sub {
            font-size: 12px; color: rgba(255,255,255,0.45);
            font-weight: 400; margin-top: 4px; letter-spacing: 0.2px;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .logo-area { text-align: right; }
        .logo-text {
            font-family: 'Inter', sans-serif;
            font-weight: 900; font-size: 28px;
            color: white; letter-spacing: 2px;
            line-height: 1; text-transform: uppercase;
        }
        .logo-text span { color: #5bb8ff; font-weight: 900; }
        .logo-sub {
            font-size: 9px; color: rgba(255,255,255,0.35);
            letter-spacing: 3px; text-transform: uppercase;
            margin-top: 5px; font-family: 'Inter', sans-serif;
            font-weight: 500;
        }
        .logo-designer {
            font-size: 9px; color: rgba(255,255,255,0.25);
            letter-spacing: 1px; margin-top: 8px;
            font-family: 'Inter', sans-serif; font-weight: 400;
            font-style: italic;
        }

        /* â”€â”€â”€ Controls Row â”€â”€â”€ */
        .controls-row {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
            margin-top: 24px; padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            position: relative; z-index: 1;
        }
        .lang-switch {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; padding: 3px; display: flex; gap: 2px;
        }
        .lang-btn {
            border: none; background: transparent; color: rgba(255,255,255,0.5);
            padding: 7px 16px; border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 700; transition: all 0.2s;
            font-family: 'Noto Sans KR', sans-serif; letter-spacing: 0;
        }
        .lang-btn.active { background: rgba(255,255,255,0.18); color: white; }

        .btn {
            padding: 9px 16px; border: none; border-radius: 10px; cursor: pointer;
            font-size: 13px; font-weight: 700; display: inline-flex; align-items: center;
            gap: 6px; transition: all 0.2s; font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; white-space: nowrap;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn-prod  { background: linear-gradient(135deg, #004B87, #0074d9); color: white; box-shadow: 0 4px 12px rgba(0,75,135,0.35); }
        .btn-ship  { background: linear-gradient(135deg, #0074d9, #3498f0); color: white; box-shadow: 0 4px 12px rgba(0,116,217,0.35); }
        .btn-def   { background: linear-gradient(135deg, #5bb8ff, #82ccff); color: #00234d; box-shadow: 0 4px 12px rgba(91,184,255,0.35); }
        .btn-excel { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.15); }
        .btn-excel:hover { background: rgba(255,255,255,0.18); }

        /* â”€â”€â”€ Filter Row â”€â”€â”€ */
        .filter-section {
            background: white; border-radius: var(--r-lg);
            padding: 18px 24px; margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            animation: fadeUp 0.5s 0.1s ease both;
        }
        .filter-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .filter-row + .filter-row { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }
        .filter-label {
            font-size: 11px; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; min-width: 44px;
            font-family: 'Inter', sans-serif;
        }
        .filter-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        .filter-btn {
            background: var(--surface2); border: 1.5px solid var(--border);
            color: var(--text-sub); padding: 6px 14px; border-radius: 30px;
            font-size: 12px; cursor: pointer; transition: all 0.18s ease;
            font-weight: 600; font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; line-height: 1.4;
        }
        .filter-btn:hover { border-color: #0074d9; color: #004B87; background: #e8f4ff; }
        .filter-btn.active {
            background: var(--navy); color: white; border-color: var(--navy);
            box-shadow: 0 2px 8px rgba(12,30,62,0.20);
        }

        /* â”€â”€â”€ KPI Cards â”€â”€â”€ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .kpi-card {
            background: white; border-radius: var(--r);
            padding: 22px 24px;
            border: 1px solid var(--border);
            position: relative; overflow: hidden;
            transition: all 0.25s;
            box-shadow: var(--shadow-sm);
            animation: fadeUp 0.5s ease both;
        }
        .kpi-card:nth-child(1){animation-delay:0.1s}
        .kpi-card:nth-child(2){animation-delay:0.15s}
        .kpi-card:nth-child(3){animation-delay:0.2s}
        .kpi-card:nth-child(4){animation-delay:0.25s}
        .kpi-card:nth-child(5){animation-delay:0.3s}
        .kpi-card:nth-child(6){animation-delay:0.35s}
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .kpi-card::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
        }
        .kpi-card.c-blue::after  { background: linear-gradient(90deg,#004B87,#0074d9); }
        .kpi-card.c-red::after   { background: linear-gradient(90deg,#f43f5e,#fb7185); }
        .kpi-card.c-slate::after { background: linear-gradient(90deg,#475569,#64748b); }
        .kpi-card.c-orange::after{ background: linear-gradient(90deg,#e8a020,#f5c55a); }

        .kpi-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; margin-bottom: 14px;
        }
        .c-blue  .kpi-icon { background: #e8f4ff; }
        .c-red   .kpi-icon { background: #fff1f2; }
        .c-slate .kpi-icon { background: #f1f5f9; }
        .c-orange .kpi-icon { background: #fff8eb; }
        .kpi-value {
            font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
            font-family: 'JetBrains Mono', 'Inter', monospace; margin-bottom: 4px; line-height: 1.1;
        }
        .c-blue   .kpi-value { color: #004B87; }
        .c-red    .kpi-value { color: #e11d48; }
        .c-slate  .kpi-value { color: #334155; }
        .c-orange .kpi-value { color: #b45309; }
        .kpi-sub-value {
            font-size: 14px; font-weight: 700; letter-spacing: -0.3px;
            font-family: 'JetBrains Mono', 'Inter', monospace;
            margin-bottom: 6px; line-height: 1.1; opacity: 0.7;
        }
        .c-red    .kpi-sub-value { color: #e11d48; }
        .c-orange .kpi-sub-value { color: #b45309; }
        .kpi-label {
            font-size: 11px; color: var(--text-muted); font-weight: 500;
            letter-spacing: 0.3px; font-family: 'Noto Sans KR', sans-serif;
        }

        /* â”€â”€â”€ Section Header â”€â”€â”€ */
        .section-hd {
            display: flex; align-items: center; gap: 12px;
            margin: 36px 0 18px;
        }
        .section-hd-line {
            flex: 1; height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }
        .section-hd-title {
            font-size: 13px; font-weight: 800; color: var(--text-sub);
            text-transform: uppercase; letter-spacing: 1.5px;
            white-space: nowrap;
        }

        /* â”€â”€â”€ Grid Layouts â”€â”€â”€ */
        .g2 { display: grid; grid-template-columns: repeat(auto-fit,minmax(440px,1fr)); gap: 20px; margin-bottom: 20px; }
        .g3 { display: grid; grid-template-columns: repeat(auto-fit,minmax(340px,1fr)); gap: 20px; margin-bottom: 20px; }
        .g-full { width: 100%; margin-bottom: 20px; }

        /* â”€â”€â”€ Card â”€â”€â”€ */
        .card {
            background: white; border-radius: var(--r);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
            transition: box-shadow 0.2s;
            overflow: hidden;
        }
        .card:hover { box-shadow: var(--shadow-md); }
        .card-head {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 22px 0;
        }
        .card-title {
            font-size: 13px; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 8px;
            letter-spacing: 0; font-family: 'Noto Sans KR', sans-serif;
        }
        .card-title-dot {
            width: 8px; height: 8px; border-radius: 2px;
            background: linear-gradient(135deg, #004B87, #0074d9);
            flex-shrink: 0;
        }
        .card-body { padding: 16px 22px 22px; flex: 1; }

        /* â”€â”€â”€ Tables â”€â”€â”€ */
        .tbl-wrap { overflow-x: auto; }
        .tbl-wrap::-webkit-scrollbar { height: 5px; }
        .tbl-wrap::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .tbl-wrap::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th {
            background: var(--surface2); color: var(--text-sub);
            padding: 10px 14px; text-align: center; font-weight: 700;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky; top: 0; z-index: 5;
            font-family: 'Inter', sans-serif;
        }
        thead th:first-child { text-align: left; }
        tbody td {
            padding: 10px 14px; border-bottom: 1px solid #f1f5f9;
            text-align: center; color: var(--text);
            font-variant-numeric: tabular-nums;
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        tbody td:first-child { text-align: left; font-weight: 600; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background: #f8faff; }

        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 800; letter-spacing: 0.3px;
        }
        .badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; }
        .badge-ok   { background: #f0fdf4; color: #16a34a; }
        .badge-ok::before { background: #16a34a; }
        .badge-ng   { background: #fff1f2; color: #e11d48; }
        .badge-ng::before { background: #e11d48; }

        .yield-good { color: #16a34a; font-weight: 700; font-family:'JetBrains Mono','Inter',monospace; }
        .yield-bad  { color: #e11d48; font-weight: 700; font-family:'JetBrains Mono','Inter',monospace; }

        /* â”€â”€â”€ Chart Boxes â”€â”€â”€ */
        .ch-sm  { position: relative; height: 190px; }
        .ch-md  { position: relative; height: 270px; }
        .ch-lg  { position: relative; height: 310px; }

        /* â”€â”€â”€ Defect Table â”€â”€â”€ */
        #tblDefectType thead th {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: rgba(255,255,255,0.9); border-bottom: none;
            font-family: 'Inter', sans-serif; font-size: 11px;
            letter-spacing: 0.5px; padding: 12px 14px;
        }
        #tblDefectType thead th:first-child { text-align: left; }
        #tblDefectType tbody td {
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        #tblDefectType tbody td:first-child {
            font-family: 'Noto Sans KR', sans-serif; font-weight: 600; color: var(--text);
        }
        #tblDefectType tbody td:last-child {
            color: #4f46e5; font-weight: 700;
            font-family: 'JetBrains Mono', monospace; font-size: 13px;
        }
        #tblDefectType tbody tr.grand-row td {
            background: #f0f4fb !important; font-weight: 700;
            border-top: 2px solid var(--navy); color: var(--navy);
            font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
        }
        #tblDefectType tbody tr.grand-row td:first-child {
            font-family: 'Noto Sans KR', sans-serif;
        }
        #tblDefectType tbody tr.grand-row td:last-child {
            background: var(--navy) !important; color: white;
            font-family: 'JetBrains Mono', monospace;
        }
        .d-zero   { color: #c8d6e5; font-style: normal; font-size: 15px; line-height: 1; }
        .d-low    { color: #d97706; font-weight: 700; font-family: 'JetBrains Mono', monospace !important; }
        .d-med    { color: #ea580c; font-weight: 700; font-family: 'JetBrains Mono', monospace !important; }
        .d-high   { color: #dc2626; font-weight: 800; font-family: 'JetBrains Mono', monospace !important; }

        /* â”€â”€â”€ Modal â”€â”€â”€ */
        .modal {
            display: none; position: fixed; inset: 0; z-index: 2000;
            background: rgba(12,30,62,0.65); backdrop-filter: blur(6px);
        }
        .modal-box {
            background: white; width: 92%; max-width: 980px;
            margin: 36px auto; padding: 36px; border-radius: var(--r-lg);
            max-height: 88vh; overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes modalUp { from{transform:translateY(40px);opacity:0} to{transform:translateY(0);opacity:1} }
        .modal-title { font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 6px; font-family: 'Noto Sans KR', sans-serif; }
        .modal-desc { font-size: 13px; color: var(--text-sub); margin-bottom: 20px; line-height: 1.7; font-family: 'Noto Sans KR', sans-serif; }
        .paste-area {
            width: 100%; height: 90px; padding: 14px;
            border: 2px dashed var(--border); border-radius: var(--r);
            background: var(--surface2); font-family: 'DM Mono', monospace;
            font-size: 12px; margin-bottom: 16px; resize: vertical;
            transition: border-color 0.2s;
        }
        .paste-area:focus { outline: none; border-color: #6366f1; background: #eef2ff; }
        .modal-footer {
            display: flex; gap: 12px; margin-top: 24px;
            padding-top: 20px; border-top: 1px solid var(--border);
        }
        .btn-full { flex: 1; padding: 13px; font-size: 14px; border-radius: 10px; }
        .btn-save   { background: linear-gradient(135deg,var(--navy),var(--navy-light)); color:white; border:none; cursor:pointer; font-family:inherit; font-weight:700; transition:all .2s; }
        .btn-save:hover { box-shadow: 0 6px 18px rgba(12,30,62,0.3); transform:translateY(-2px); }
        .btn-cancel { background: var(--surface2); color: var(--text-sub); border:1px solid var(--border); cursor:pointer; font-family:inherit; font-weight:600; transition:all .2s; }
        .btn-cancel:hover { border-color: var(--text-sub); }
        .btn-parse  { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; cursor:pointer; padding:10px 16px; border-radius:8px; font-family:inherit; font-weight:700; font-size:13px; flex:1; transition:all .2s; }
        .btn-parse:hover { background: #e0e7ff; }
        .btn-clr    { background: #fff1f2; color: #e11d48; border:1px solid #fecdd3; cursor:pointer; padding:10px 16px; border-radius:8px; font-family:inherit; font-weight:700; font-size:13px; width:110px; transition:all .2s; }
        .btn-clr:hover { background:#ffe4e6; }
        .btn-addrow { width:100%; margin-top:12px; padding:10px; background:var(--surface2); border:1px dashed var(--border); border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600; font-size:13px; color:var(--text-sub); transition:all .2s; }
        .btn-addrow:hover { border-color:#6366f1; color:#4f46e5; background:#eef2ff; }

        .entry-tbl { width:100%; border-collapse:collapse; font-size:13px; }
        .entry-tbl th { background:#f8faff; color:var(--text-sub); padding:9px 10px; text-align:center; font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid var(--border); font-family:'Inter',sans-serif; }
        .entry-tbl td { padding:6px 6px; border-bottom:1px solid #f1f5f9; }
        .entry-tbl input, .entry-tbl select {
            width:100%; padding:8px 10px; border:1px solid var(--border);
            border-radius:7px; font-size:13px; font-family:'Noto Sans KR','Inter',sans-serif;
            background:white; transition:all .2s; color:var(--text);
        }
        .entry-tbl input:focus, .entry-tbl select:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
        .entry-tbl select { cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%236366f1' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; padding-right:30px; }
        .btn-del { background:#fff1f2; color:#e11d48; border:1px solid #fecdd3; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:700; transition:all .2s; font-family:'Noto Sans KR',sans-serif; }
        .btn-del:hover { background:#ffe4e6; }

        /* â”€â”€â”€ Config Banner â”€â”€â”€ */
        #configBanner {
            background: linear-gradient(135deg,#fffbeb,#fef3c7);
            border: 2px solid #fcd34d; border-radius: var(--r);
            padding: 20px 24px; margin-bottom: 20px; display: none;
        }
        #configBanner h3 { color: #92400e; margin-bottom: 6px; font-size: 16px; }
        #configBanner p  { color: #78350f; font-size: 13px; line-height: 1.7; }
        #configBanner code { background:rgba(0,0,0,0.07); padding:2px 7px; border-radius:5px; font-family:'DM Mono',monospace; font-size:12px; }

        /* â”€â”€â”€ Chart filter mini-btns â”€â”€â”€ */
        .mini-filters { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:12px; }
        .mini-btn {
            padding: 5px 13px; border-radius: 30px; border: 1.5px solid var(--border);
            background: var(--surface2); color: var(--text-sub);
            font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s;
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            letter-spacing: 0; line-height: 1.4;
        }
        .mini-btn:hover { border-color: #6366f1; color: #4f46e5; background: #eef2ff; }
        .mini-btn.active { background: var(--navy); color: white; border-color: var(--navy); box-shadow: 0 2px 6px rgba(12,30,62,0.15); }


        /* â”€â”€â”€ View Switch â”€â”€â”€ */
        .view-switch{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:3px;display:flex;gap:2px;}
        .btn-daily-prod{background:linear-gradient(135deg,#0891b2,#06b6d4);color:white;box-shadow:0 4px 12px rgba(8,145,178,0.35);}
        .btn-daily-def{background:linear-gradient(135deg,#e11d48,#f43f5e);color:white;box-shadow:0 4px 12px rgba(225,29,72,0.35);}
        /* â”€â”€â”€ Team Badges â”€â”€â”€ */
        .team-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;font-family:'Inter',sans-serif;}
        .team-smt{background:#eef2ff;color:#6366f1;}
        .team-test{background:#e0f7fa;color:#0891b2;}
        /* â”€â”€â”€ Date range filter â”€â”€â”€ */
        .date-range{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
        .date-input{padding:7px 12px;border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-family:'JetBrains Mono',monospace;color:var(--text);background:white;cursor:pointer;transition:all .2s;}
        .date-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1);}
        .date-sep{color:var(--text-muted);font-size:12px;font-weight:600;}
        .date-apply{padding:7px 14px;background:var(--navy);color:white;border:none;border-radius:10px;cursor:pointer;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;transition:all .2s;}
        .date-apply:hover{background:var(--navy-light);}
        /* â”€â”€â”€ Daily Summary Cards â”€â”€â”€ */
        .kpi-grid-6{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;margin-bottom:24px;}
        .c-smt::after{background:linear-gradient(90deg,#6366f1,#818cf8);}
        .c-test::after{background:linear-gradient(90deg,#0891b2,#38bdf8);}
        .c-smt .kpi-value{color:#6366f1;}
        .c-test .kpi-value{color:#0891b2;}
        .daily-summary-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}
        .team-card{background:white;border-radius:var(--r-lg);padding:20px 24px;border:1px solid var(--border);box-shadow:var(--shadow-sm);}
        .team-card-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
        .team-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
        .team-stat{text-align:center;}
        .team-stat-value{font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1.1;}
        .team-stat-label{font-size:10px;color:var(--text-muted);font-weight:600;margin-top:2px;}
        /* â”€â”€â”€ Searchable Dropdown â”€â”€â”€ */
        .search-select-wrap{position:relative;}
        .search-select-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:7px;font-size:12px;font-family:'JetBrains Mono','Inter',sans-serif;background:white;transition:all .2s;color:var(--text);}
        .search-select-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1);}
        .search-dropdown{position:absolute;left:0;right:0;top:100%;margin-top:2px;background:white;border:1.5px solid #c7d2fe;border-radius:10px;box-shadow:var(--shadow-md);z-index:500;max-height:180px;overflow-y:auto;display:none;}
        .search-dropdown.open{display:block;}
        .search-option{padding:8px 12px;font-size:12px;cursor:pointer;font-family:'JetBrains Mono',monospace;color:var(--text);transition:all .15s;border-bottom:1px solid #f1f5f9;}
        .search-option:last-child{border-bottom:none;}
        .search-option:hover{background:#eef2ff;color:#4f46e5;}
        .opt-code{font-weight:700;color:#4f46e5;}
        .opt-name{color:var(--text-sub);margin-left:6px;font-size:11px;}
        /* â”€â”€â”€ Daily table â”€â”€â”€ */
        .daily-no-data{text-align:center;padding:48px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;font-size:14px;}
        .filter-btn.active-smt{background:#6366f1;color:white;border-color:#6366f1;}
        .filter-btn-sm{padding:4px 10px;font-size:11px;}
        .mini-btn-sep{display:inline-flex;align-items:center;font-size:9px;font-weight:700;letter-spacing:.5px;padding:0 4px;color:var(--text-muted);}
        .filter-btn.active-test{background:#0891b2;color:white;border-color:#0891b2;}


        /* â”€â”€â”€ Login Modal â”€â”€â”€ */
        #loginModal{display:flex;position:fixed;inset:0;z-index:99998;background:linear-gradient(135deg,#0c1e3e 0%,#152d56 100%);align-items:center;justify-content:center;}
        .login-box{background:white;border-radius:24px;padding:48px 52px;width:400px;text-align:center;box-shadow:0 40px 80px rgba(0,0,0,0.4);animation:modalUp .5s cubic-bezier(.34,1.56,.64,1);}
        .login-logo{font-family:'Inter',sans-serif;font-weight:800;font-size:32px;color:var(--navy);letter-spacing:-1px;margin-bottom:4px;}.login-logo span{color:var(--gold);}
        .login-sub{font-size:12px;color:var(--text-muted);letter-spacing:3px;text-transform:uppercase;margin-bottom:32px;font-family:'Inter',sans-serif;}
        .login-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:8px;font-family:'Noto Sans KR',sans-serif;}
        .login-desc{font-size:13px;color:var(--text-sub);margin-bottom:24px;font-family:'Noto Sans KR',sans-serif;}
        .login-input{width:100%;padding:15px 18px;border:2px solid var(--border);border-radius:12px;font-size:18px;text-align:center;font-family:'JetBrains Mono',monospace;letter-spacing:6px;transition:all .2s;margin-bottom:14px;}
        .login-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 4px rgba(99,102,241,0.12);}
        .login-err{font-size:12px;color:#e11d48;margin-bottom:14px;height:16px;font-family:'Noto Sans KR',sans-serif;transition:all .2s;}
        .login-btn{width:100%;padding:15px;background:linear-gradient(135deg,var(--navy),var(--navy-light));color:white;border:none;border-radius:12px;cursor:pointer;font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;transition:all .2s;letter-spacing:.5px;}
        .login-btn:hover{box-shadow:0 8px 20px rgba(12,30,62,0.35);transform:translateY(-2px);}
        .login-hint{font-size:11px;color:var(--text-muted);margin-top:16px;font-family:'Noto Sans KR',sans-serif;}

        @media(max-width:768px){
            body{padding:14px;}
            .header-grid{grid-template-columns:1fr;}
            .g2,.g3{grid-template-columns:1fr;}
            .kpi-grid{grid-template-columns:repeat(2,1fr);}
        }

        /* â”€â”€â”€ Password Modal â”€â”€â”€ */
        #pwModal {
            display:none; position:fixed; inset:0; z-index:3000;
            background:rgba(12,30,62,0.75); backdrop-filter:blur(8px);
            align-items:center; justify-content:center;
        }
        #pwModal.open { display:flex; }
        .pw-box {
            background:white; border-radius:var(--r-lg);
            padding:36px 40px; width:360px;
            box-shadow:var(--shadow-lg); text-align:center;
            animation:modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        .pw-icon { font-size:40px; margin-bottom:16px; }
        .pw-title { font-size:18px; font-weight:800; color:var(--navy); margin-bottom:6px; font-family:'Noto Sans KR',sans-serif; }
        .pw-sub { font-size:13px; color:var(--text-sub); margin-bottom:22px; font-family:'Noto Sans KR',sans-serif; }
        .pw-input {
            width:100%; padding:13px 16px; border:2px solid var(--border);
            border-radius:10px; font-size:16px; text-align:center;
            font-family:'JetBrains Mono',monospace; letter-spacing:4px;
            transition:all .2s; margin-bottom:16px;
        }
        .pw-input:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
        .pw-err { font-size:12px; color:#e11d48; margin-bottom:12px; height:16px; font-family:'Noto Sans KR',sans-serif; }
        .pw-btns { display:flex; gap:10px; }
        .pw-ok { flex:1; padding:12px; background:linear-gradient(135deg,var(--navy),var(--navy-light)); color:white; border:none; border-radius:10px; cursor:pointer; font-size:14px; font-weight:700; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .pw-ok:hover { box-shadow:0 4px 14px rgba(12,30,62,0.3); transform:translateY(-1px); }
        .pw-cancel { padding:12px 20px; background:var(--surface2); color:var(--text-sub); border:1px solid var(--border); border-radius:10px; cursor:pointer; font-size:14px; font-weight:600; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .pw-cancel:hover { border-color:var(--text-sub); }

        /* â”€â”€â”€ Backup Button â”€â”€â”€ */
        .btn-backup { background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.8); border:1px solid rgba(255,255,255,0.15); font-size:12px; padding:8px 14px; }
        .btn-backup:hover { background:rgba(255,255,255,0.15); color:white; }

        /* â”€â”€â”€ Backup Modal â”€â”€â”€ */
        #backupModal {
            display:none; position:fixed; inset:0; z-index:3000;
            background:rgba(12,30,62,0.75); backdrop-filter:blur(8px);
            align-items:center; justify-content:center;
        }
        #backupModal.open { display:flex; }
        .backup-box {
            background:white; border-radius:var(--r-lg); padding:36px;
            width:500px; max-height:80vh; overflow-y:auto;
            box-shadow:var(--shadow-lg);
            animation:modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        .backup-item {
            display:flex; align-items:center; justify-content:space-between;
            padding:12px 16px; border:1px solid var(--border); border-radius:10px;
            margin-bottom:8px; transition:all .2s;
        }
        .backup-item:hover { border-color:#6366f1; background:#fafbff; }
        .backup-item-info { font-size:13px; }
        .backup-item-time { font-weight:700; color:var(--navy); font-family:'JetBrains Mono',monospace; }
        .backup-item-size { font-size:11px; color:var(--text-muted); margin-top:2px; }
        .backup-restore-btn { padding:7px 14px; background:#eef2ff; color:#4f46e5; border:1px solid #c7d2fe; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700; font-family:'Noto Sans KR',sans-serif; transition:all .2s; }
        .backup-restore-btn:hover { background:#e0e7ff; }
        .backup-del-btn { padding:7px 10px; background:#fff1f2; color:#e11d48; border:1px solid #fecdd3; border-radius:8px; cursor:pointer; font-size:12px; font-weight:700; margin-left:6px; transition:all .2s; }
        .backup-del-btn:hover { background:#ffe4e6; }
    </style>
</head>
<body>


<!-- â•â•â• LOGIN MODAL â•â•â• -->
<div id="loginModal">
    <div class="login-box">
        <div class="login-logo">DREAM<span>TECH</span></div>
        <div class="login-sub">DS Division Â· Quality Dashboard</div>
        <div class="login-title">ğŸ” ë¡œê·¸ì¸</div>
        <div class="login-desc">ì ‘ì† ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        <input type="password" class="login-input" id="loginInput" placeholder="â€¢â€¢â€¢â€¢" maxlength="20" onkeydown="if(event.key==='Enter')doLogin()">
        <div class="login-err" id="loginErr"></div>
        <button class="login-btn" onclick="doLogin()">ì ‘ì†</button>
        <div class="login-hint">ğŸ”‘ ì ‘ì†: <code>LOGIN_PASSWORD</code> &nbsp;|&nbsp; ë°ì´í„°ì…ë ¥: <code>DATA_PASSWORD</code></div>
    </div>
</div>

<!-- Loading -->
<div id="loadingOverlay" style="display:none;">
    <div class="loading-logo">DREAM<span>TECH</span></div>
    <div class="loading-bar"><div class="loading-bar-inner"></div></div>
    <div class="loading-text">ğŸ”¥ Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div id="syncStatus" class="sync-online">
    <div class="sync-dot"></div>
    <span id="syncText">ì‹¤ì‹œê°„ ì—°ê²°ë¨</span>
</div>

<div id="saveSuccess" class="save-toast">âœ… ì €ì¥ ì™„ë£Œ! ëª¨ë“  íŒ€ì›ì—ê²Œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
<div id="configBanner">
    <h3>âš ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
    <p>íŒŒì¼ì˜ <code>FIREBASE_CONFIG</code> ê°’ì„ ì‹¤ì œ Firebase í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´í•´ ì£¼ì„¸ìš”.</p>
</div>

<!-- Header -->
<div class="header">
    <div class="header-grid">
        <div>
            <div class="header-brand">
                <div class="brand-badge">ğŸ“Š</div>
                <div>
                    <h1 id="mainTitle">DS Quality Performance</h1>
                    <div class="header-sub" id="lastUpdate">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
        <div class="logo-area">
            <div class="logo-text">DREAM<span>TECH</span></div>
            <div class="logo-sub">Solutions come from Dreamtech</div>
            <div class="logo-designer">Designed by YU.KIM</div>
        </div>
    </div>
    <div class="controls-row">
        <div class="lang-switch">
            <button class="lang-btn active" onclick="setLang('ko')" id="btnKo">í•œê¸€</button>
            <button class="lang-btn" onclick="setLang('en')" id="btnEn">English</button>
        </div>
        <div class="view-switch">
            <button class="lang-btn active" onclick="setView('monthly')" id="btnViewMonthly">ğŸ“… ì›”ë³„</button>
            <button class="lang-btn" onclick="setView('daily')" id="btnViewDaily">ğŸ“† ì¼ë³„</button>
        </div>
        <span id="monthlyBtns" style="display:inline-flex;gap:8px;align-items:center;">
            <button class="btn btn-prod" onclick="openModal('prod')" id="btnProd">âœï¸ ìƒì‚° ì…ë ¥</button>
            <button class="btn btn-ship" onclick="openModal('ship')" id="btnShip">ğŸ“¦ ì¶œí•˜ ì…ë ¥</button>
            <button class="btn btn-def"  onclick="openModal('defect')" id="btnDefect">ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ì…ë ¥</button>
        </span>
        <span id="dailyBtns" style="display:none;gap:8px;align-items:center;">
            <button class="btn btn-daily-prod" onclick="openDailyProdModal()" id="btnDailyProd">ğŸ“… ì¼ë³„ ìƒì‚° ì…ë ¥</button>
            <button class="btn btn-daily-def"  onclick="openDailyDefModal()" id="btnDailyDef">ğŸ”´ ë¶ˆëŸ‰ ì½”ë“œ ì…ë ¥</button>
        </span>
        <button class="btn btn-excel" onclick="exportExcel()">ğŸ“Š Excel</button>
        <button class="btn btn-backup" onclick="openBackupModal()">ğŸ’¾ ë°±ì—…</button>
    </div>
</div>

<!-- â•â•â• MONTHLY VIEW â•â•â• -->
<div id="viewMonthly">
<!-- Filters -->
<div class="filter-section">
    <div class="filter-row">
        <div class="filter-label" id="lblProd">ì œí’ˆ</div>
        <div class="filter-btns" id="filterProduct"></div>
    </div>
    <div class="filter-row">
        <div class="filter-label" id="lblPeriod">ê¸°ê°„</div>
        <div class="filter-btns" id="filterMonth"></div>
    </div>
    <div class="filter-row">
        <div class="filter-label" id="lblProcess">ê³µì •</div>
        <div class="filter-btns" id="filterProcess"></div>
    </div>
</div>

<!-- KPI -->
<div class="kpi-grid">
    <div class="kpi-card c-blue">
        <div class="kpi-icon">ğŸ“ˆ</div>
        <div class="kpi-value" id="kpiYield">â€”</div>
        <div class="kpi-label" id="lblKpiYield">ì¢…í•© ìˆ˜ìœ¨</div>
    </div>
    <div class="kpi-card c-slate">
        <div class="kpi-icon">ğŸ“¥</div>
        <div class="kpi-value" id="kpiInput">â€”</div>
        <div class="kpi-label" id="lblKpiInput">ì´ íˆ¬ì… ìˆ˜ëŸ‰</div>
    </div>
    <div class="kpi-card c-slate">
        <div class="kpi-icon">ğŸ“¤</div>
        <div class="kpi-value" id="kpiOutput">â€”</div>
        <div class="kpi-label" id="lblKpiOutput">ì´ ì‚°ì¶œ ìˆ˜ëŸ‰</div>
    </div>
    <div class="kpi-card c-red">
        <div class="kpi-icon">âŒ</div>
        <div class="kpi-value" id="kpiDefect">â€”</div>
        <div class="kpi-sub-value" id="kpiDefectPPM">â€” PPM</div>
        <div class="kpi-label" id="lblKpiDefect">ì´ ë¶ˆëŸ‰ ìˆ˜ëŸ‰</div>
    </div>
    <div class="kpi-card c-orange">
        <div class="kpi-icon">ğŸ­</div>
        <div class="kpi-value" id="kpiCompDefect">â€”</div>
        <div class="kpi-sub-value" id="kpiPPM">â€” PPM</div>
        <div class="kpi-label" id="lblKpiCompDefect">ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜</div>
    </div>
</div>

<!-- Tables row -->
<div class="g3">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProcYield">ê³µì •ë³„ ìˆ˜ìœ¨ í˜„í™©</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblProcYield">
                    <thead><tr><th id="thProc">ê³µì •</th><th id="thIn">íˆ¬ì…</th><th id="thOut">ì‚°ì¶œ</th><th id="thFail">ë¶ˆëŸ‰</th><th id="thYld">ìˆ˜ìœ¨</th><th id="thStat">íŒì •</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titMonthYield">ê³µì •ë³„ ì›”ë³„ ìˆ˜ìœ¨ ì¶”ì´</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblMonthYield">
                    <thead><tr><th id="thMonth">ê¸°ê°„</th><th>SMD</th><th>ROUTER</th><th>ATE</th><th>PCT</th><th>AVI</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdYield">ì œí’ˆë³„ ìˆ˜ìœ¨ í˜„í™©</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblProdYield">
                    <thead><tr><th id="thProd">ì œí’ˆ</th><th id="thIn2">íˆ¬ì…</th><th id="thOut2">ì‚°ì¶œ</th><th id="thFail2">ë¶ˆëŸ‰</th><th id="thYld2">ìˆ˜ìœ¨</th><th id="thStat2">íŒì •</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Total Yield Trend -->
<div class="g-full">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titTotalTrend">ì¢…í•© ìˆ˜ìœ¨ ì›”ë³„ íŠ¸ë Œë“œ (%)</span></div></div>
        <div class="card-body"><div class="ch-sm"><canvas id="chartTotalYield"></canvas></div></div>
    </div>
</div>

<!-- PPM Monthly Trend -->
<div class="g-full">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titPpmTrend">ë‹¹ì‚¬ ê·€ì±… PPM ì›”ë³„ íŠ¸ë Œë“œ</span></div></div>
        <div class="card-body"><div class="ch-sm"><canvas id="chartPpmTrend"></canvas></div></div>
    </div>
</div>

<!-- 3 charts -->
<div class="g3">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdTrend">ì œí’ˆë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="prodChartFilter"></div>
            <div class="ch-md"><canvas id="chartProdYield"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProcTrend">ê³µì •ë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="procChartFilter"></div>
            <div class="ch-md"><canvas id="chartProcYield"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titProdVol">DS ìƒì‚° ì‹¤ì </span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="prodVolFilter"></div>
            <div class="ch-md"><canvas id="chartProdVol"></canvas></div>
        </div>
    </div>
</div>

<!-- Defect Section -->
<div class="section-hd">
    <div class="section-hd-title" id="titDefectSection">ğŸ“‰ ë¶ˆëŸ‰ ë¶„ì„ ë° ìƒì„¸ í˜„í™©</div>
    <div class="section-hd-line"></div>
</div>

<div class="g2">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titTotalDefect">ì›”ë³„ ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartTotalDefect"></canvas></div></div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titCompDefect">ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartCompDefect"></canvas></div></div>
    </div>
</div>

<div class="g3">
    <div class="card">
        <div class="card-head">
            <div class="card-title"><div class="card-title-dot"></div><span id="titDefectType">ë¶ˆëŸ‰ ìœ í˜• ì°¨íŠ¸</span></div>
            <button class="btn-del" onclick="openModal('defect')">ìˆ˜ì •</button>
        </div>
        <div class="card-body">
            <div class="mini-filters" id="defectTypeFilters"></div>
            <div class="ch-lg"><canvas id="chartDefectType"></canvas></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span>ë¶ˆëŸ‰ ìœ í˜• ë¹„ìœ¨ (Pie)</span></div></div>
        <div class="card-body"><div class="ch-lg"><canvas id="chartDefectTypePie"></canvas></div></div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titDefectTable">ë¶ˆëŸ‰ ìœ í˜• ìƒì„¸ í˜„í™©</span></div></div>
        <div class="card-body" style="padding-top:0;">
            <div class="tbl-wrap" style="max-height:320px;overflow-y:auto;">
                <table id="tblDefectType">
                    <thead><tr><th>ê¸°ê°„</th><th>Human Error</th><th>Handling Damage</th><th>Component Lifting</th><th>í•©ê³„</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Shipment Section -->
<div class="section-hd">
    <div class="section-hd-title" id="titShipSection">ğŸ“¦ ì¶œí•˜ ì‹¤ì </div>
    <div class="section-hd-line"></div>
</div>
<div class="g2">
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titShipTable">ì›”ë³„ ì¶œí•˜ ìˆ˜ëŸ‰</span></div></div>
        <div class="card-body">
            <div class="tbl-wrap">
                <table id="tblShipment">
                    <thead><tr><th id="thShipMonth">ê¸°ê°„</th><th>RDIMM</th><th>SODIMM</th><th>UDIMM</th><th id="thTotal">í•©ê³„</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="titShipChart">ì›”ë³„ ì¶œí•˜ ì‹¤ì  ì¶”ì´</span></div></div>
        <div class="card-body">
            <div class="mini-filters" id="shipChartFilter"></div>
            <div class="ch-md"><canvas id="chartShipment"></canvas></div>
        </div>
    </div>
</div>


</div><!-- /viewMonthly -->

<!-- â•â•â• DAILY VIEW â•â•â• -->
<div id="viewDaily" style="display:none;">
    <!-- Daily Filters -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-label" id="dlblDate">ë‚ ì§œ</div>
            <div class="date-range" style="flex-wrap:wrap;gap:6px;">
                <input type="date" class="date-input" id="dFilterFrom" onchange="applyDailyFilters()">
                <span class="date-sep">~</span>
                <input type="date" class="date-input" id="dFilterTo" onchange="applyDailyFilters()">
                <button class="date-apply" onclick="setDailyDatePreset('today')" id="btnToday">ì˜¤ëŠ˜</button>
                <button class="date-apply" onclick="setDailyDatePreset('yesterday')" id="btnYesterday" style="background:#0891b2;">ì–´ì œ</button>
                <button class="date-apply" onclick="setDailyDatePreset('week')" id="btnThisWeek" style="background:#4f46e5;">ì´ë²ˆì£¼</button>
                <button class="date-apply" onclick="setDailyDatePreset('month')" id="btnThisMonth" style="background:#059669;">ì´ë²ˆë‹¬</button>
                <button class="date-apply" onclick="setDailyDatePreset('all')" id="btnAllDate" style="background:#475569;">ì „ì²´</button>
                <span class="date-sep" id="lblWeekNum" style="font-size:11px;white-space:nowrap;">ì£¼ì°¨:</span>
                <input type="number" id="weekNumInput" min="1" max="53" placeholder="ì˜ˆ) 8" style="width:70px;padding:6px 10px;border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-family:'JetBrains Mono',monospace;" onkeydown="if(event.key==='Enter')setDailyDatePreset('weeknum')">
                <button class="date-apply" onclick="setDailyDatePreset('weeknum')" style="background:#6366f1;">ì´ë™</button>
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-label" id="dlblProd">ì œí’ˆ</div>
            <div class="filter-btns" id="dFilterProduct"></div>
        </div>
        <div class="filter-row">
            <div class="filter-label" id="dlblTeam">íŒ€</div>
            <div class="filter-btns" id="dFilterTeam"></div>
        </div>
        <div class="filter-row">
            <div class="filter-label" id="dlblProcess">ê³µì •</div>
            <div class="filter-btns" id="dFilterProcess"></div>
        </div>
    </div>

    <!-- Daily KPIs -->
    <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit, minmax(190px, 1fr))">
        <div class="kpi-card c-blue"><div class="kpi-icon">ğŸ“ˆ</div><div class="kpi-value" id="dKpiYield">â€”</div><div class="kpi-label" id="dLblYield">ì¢…í•© ìˆ˜ìœ¨</div></div>
        <div class="kpi-card c-slate"><div class="kpi-icon">ğŸ“¥</div><div class="kpi-value" id="dKpiInput">â€”</div><div class="kpi-label" id="dLblInput">ì´ íˆ¬ì… ìˆ˜ëŸ‰</div></div>
        <div class="kpi-card c-red"><div class="kpi-icon">âŒ</div><div class="kpi-value" id="dKpiDefect">â€”</div><div class="kpi-sub-value" id="dKpiDefectPPM">â€” PPM</div><div class="kpi-label" id="dLblDefect">ì´ ë¶ˆëŸ‰ ìˆ˜ëŸ‰</div></div>
        <div class="kpi-card c-orange"><div class="kpi-icon">ğŸ­</div><div class="kpi-value" id="dKpiCompDefect">â€”</div><div class="kpi-sub-value" id="dKpiPpm">â€” PPM</div><div class="kpi-label" id="dLblCompDefect">ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜</div></div>
    </div>

    <!-- SMT vs TEST Summary -->
    <div class="daily-summary-row">
        <div class="team-card">
            <div class="team-card-header">
                <span style="font-size:28px;">ğŸ”µ</span>
                <div><div style="font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;">SMT Team</div><div style="font-size:11px;color:var(--text-muted);">SMD + ROUTER</div></div>
                <span class="team-badge team-smt" style="margin-left:auto;">SMT</span>
            </div>
            <div class="team-stat-grid">
                <div class="team-stat"><div class="team-stat-value" id="smtYield" style="color:#6366f1;">â€”</div><div class="team-stat-label">ìˆ˜ìœ¨</div></div>
                <div class="team-stat"><div class="team-stat-value" id="smtInput" style="color:#334155;">â€”</div><div class="team-stat-label" id="smtLblInput">íˆ¬ì… ìˆ˜ëŸ‰</div></div>
                <div class="team-stat"><div class="team-stat-value" id="smtDefect" style="color:#e11d48;">â€”</div><div class="team-stat-label">ë¶ˆëŸ‰</div></div>
            </div>
            <div id="smtProcDetail" style="margin-top:10px;padding-top:10px;border-top:1px dashed #e0e8f5;"></div>
        </div>
        <div class="team-card">
            <div class="team-card-header">
                <span style="font-size:28px;">ğŸ”¬</span>
                <div><div style="font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;">TEST Team</div><div style="font-size:11px;color:var(--text-muted);">ATE + PCT + AVI</div></div>
                <span class="team-badge team-test" style="margin-left:auto;">TEST</span>
            </div>
            <div class="team-stat-grid">
                <div class="team-stat"><div class="team-stat-value" id="testYield" style="color:#0891b2;">â€”</div><div class="team-stat-label">ìˆ˜ìœ¨</div></div>
                <div class="team-stat"><div class="team-stat-value" id="testInput" style="color:#334155;">â€”</div><div class="team-stat-label" id="smtLblInput">íˆ¬ì… ìˆ˜ëŸ‰</div></div>
                <div class="team-stat"><div class="team-stat-value" id="testDefect" style="color:#e11d48;">â€”</div><div class="team-stat-label">ë¶ˆëŸ‰</div></div>
            </div>
            <div id="testProcDetail" style="margin-top:10px;padding-top:10px;border-top:1px dashed #e0e8f5;"></div>
        </div>
    </div>

    <!-- Daily Charts -->
    <div class="g2">
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitYieldTrend">ì¼ë³„ ìˆ˜ìœ¨ íŠ¸ë Œë“œ (%)</span></div></div><div class="card-body"><div class="mini-filters" id="dYieldFilter"></div><div class="ch-md"><canvas id="dChartYield"></canvas></div></div></div>
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitVolTrend">ì¼ë³„ íˆ¬ì…ëŸ‰ íŠ¸ë Œë“œ</span></div></div><div class="card-body"><div class="mini-filters" id="dVolFilter"></div><div class="ch-md"><canvas id="dChartVol"></canvas></div></div></div>
    </div>
    <div class="g-full">
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitPpmTrend">ì¼ë³„ ë‹¹ì‚¬ ê·€ì±… PPM íŠ¸ë Œë“œ</span></div></div><div class="card-body"><div class="mini-filters" id="dPpmFilter"></div><div class="ch-sm"><canvas id="dChartPpm"></canvas></div></div></div>
    </div>

    <!-- Defect Code Analysis -->
    <div class="section-hd"><div class="section-hd-title">ğŸ“‰ ë¶ˆëŸ‰ ì½”ë“œ ë¶„ì„</div><div class="section-hd-line"></div></div>
    <div class="g3">
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitDefectBar">ë¶ˆëŸ‰ ì½”ë“œ TOP 10</span></div></div><div class="card-body"><div class="mini-filters" id="dDefectTeamFilter"></div><div style="position:relative;height:340px;"><canvas id="dChartDefectBar"></canvas></div></div></div>
        <div class="card"><div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitDefectPie">ë¶ˆëŸ‰ ì½”ë“œ ë¹„ìœ¨</span></div></div><div class="card-body"><div style="position:relative;height:420px;"><canvas id="dChartDefectPie"></canvas></div></div></div>
    </div>
    <div class="g-full" style="margin-top:0;">
        <div class="card">
            <div class="card-head"><div class="card-title"><div class="card-title-dot"></div><span id="dTitDefectTable">ë¶ˆëŸ‰ ì½”ë“œ ìƒì„¸</span></div></div>
            <div class="card-body" style="padding-top:0;"><div class="tbl-wrap" style="max-height:280px;overflow-y:auto;"><table id="dTblDefect"><thead><tr><th id="dTblDefThCode">ì½”ë“œ</th><th id="dTblDefThName">ë¶ˆëŸ‰ëª…</th><th id="dTblDefThTeam">íŒ€</th><th id="dTblDefThQty">ìˆ˜ëŸ‰</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </div>

    <!-- Daily Production Table -->
    <div class="section-hd"><div class="section-hd-title" id="dTitProdSection">ğŸ“‹ ì¼ë³„ ìƒì‚° ë°ì´í„°</div><div class="section-hd-line"></div></div>
    <div class="g-full">
        <div class="card"><div class="card-body" style="padding-top:16px;">
            <!-- Table-level filters -->
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);">
                <span style="font-size:11px;font-weight:700;color:var(--text-muted);letter-spacing:.5px;">FILTER</span>
                <div class="filter-btns" id="dTblModelFilter"></div>
                <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
                <div class="filter-btns" id="dTblProcFilter"></div>
                <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
                <div class="filter-btns" id="dTblTeamFilter"></div>
                <div style="margin-left:auto;display:flex;align-items:center;gap:6px;">
                    <span style="font-size:11px;color:var(--text-muted);">ì •ë ¬:</span>
                    <select id="dTblSort" style="padding:5px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-family:'Noto Sans KR',sans-serif;" onchange="updateDailyTables(getDailyFiltered(),getDailyDefFiltered())">
                        <option value="date-desc">ë‚ ì§œ â†“</option>
                        <option value="date-asc">ë‚ ì§œ â†‘</option>
                        <option value="yield-asc">ìˆ˜ìœ¨ â†‘</option>
                        <option value="yield-desc">ìˆ˜ìœ¨ â†“</option>
                        <option value="defect-desc">ë¶ˆëŸ‰ â†“</option>
                    </select>
                </div>
            </div>
            <div class="tbl-wrap" style="max-height:400px;overflow-y:auto;">
                <table id="dTblProd">
                    <thead><tr><th>ë‚ ì§œ</th><th>ëª¨ë¸</th><th>ê³µì •</th><th>íŒ€</th><th id="dThInQty">íˆ¬ì…ìˆ˜ëŸ‰</th><th id="dThGoodQty">ì–‘í’ˆìˆ˜ëŸ‰</th><th id="dThDefQty">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th><th id="dThRate">ìˆ˜ìœ¨</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="dTblProdCount" style="text-align:right;font-size:11px;color:var(--text-muted);margin-top:8px;font-family:'JetBrains Mono',monospace;"></div>
        </div></div>
    </div>
    <!-- ìƒì‚° ë°ì´í„° ì°¨íŠ¸ (í…Œì´ë¸” ì•„ë˜) -->
    <div class="g2" style="margin-top:0;">
        <div class="card">
            <div class="card-head">
                <div class="card-title"><div class="card-title-dot"></div><span id="dTitProdBarProc">ê³µì •ë³„ íˆ¬ì…ìˆ˜ëŸ‰</span></div>
            </div>
            <div class="card-body"><div class="mini-filters" id="dProcVolFilter"></div><div style="position:relative;height:260px;"><canvas id="dChartProdByProc"></canvas></div></div>
        </div>
        <div class="card">
            <div class="card-head">
                <div class="card-title"><div class="card-title-dot"></div><span id="dTitProdBarModel">ëª¨ë¸ë³„ íˆ¬ì…ìˆ˜ëŸ‰</span></div>
            </div>
            <div class="card-body"><div class="mini-filters" id="dModelVolFilter"></div><div style="position:relative;height:260px;"><canvas id="dChartProdByModel"></canvas></div></div>
        </div>
    </div>
    <!-- ìˆ˜ìœ¨ vs ë¶ˆëŸ‰ ë³µí•© ì°¨íŠ¸ -->
    <div class="g-full" style="margin-top:0;margin-bottom:24px;">
        <div class="card">
            <div class="card-head">
                <div class="card-title"><div class="card-title-dot"></div><span id="dTitProdYieldDefect">ë‚ ì§œë³„ ìˆ˜ìœ¨ & ë¶ˆëŸ‰ ì¶”ì´</span></div>
                <div class="mini-filters" id="dProdChartModelFilter"></div>
            </div>
            <div class="card-body"><div style="position:relative;height:260px;"><canvas id="dChartProdYieldDef"></canvas></div></div>
        </div>
    </div>
</div><!-- /viewDaily -->

<!-- Modals -->
<div id="modalProd" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitProd">âœï¸ ìƒì‚° ë°ì´í„° ì…ë ¥</div>
        <div class="modal-desc">Excelì—ì„œ <strong>[ì œí’ˆ | ê¸°ê°„ | ê³µì • | íˆ¬ì… | ì‚°ì¶œ | ë¶ˆëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <textarea class="paste-area" id="pasteProd" placeholder="Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('prod')">ğŸ“‹ ë°ì´í„° ì ìš©</button>
            <button class="btn-clr" onclick="clearTable('prod')">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryProd">
                <thead><tr><th>ì œí’ˆ</th><th>ê¸°ê°„</th><th>ê³µì •</th><th>íˆ¬ì…</th><th>ì‚°ì¶œ</th><th>ë¶ˆëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('prod')">+ í–‰ ì¶”ê°€</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('prod')">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('prod')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="modalShip" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitShip">ğŸ“¦ ì¶œí•˜ ë°ì´í„° ì…ë ¥</div>
        <div class="modal-desc">Excelì—ì„œ <strong>[ëª¨ë¸ | ëª¨ë¸ëª… | ë‚ ì§œ | ìˆ˜ëŸ‰ | ì‚¬ìœ ]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <textarea class="paste-area" id="pasteShip" placeholder="Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('ship')">ğŸ“‹ ë°ì´í„° ì ìš©</button>
            <button class="btn-clr" onclick="clearTable('ship')">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryShip">
                <thead><tr><th>ëª¨ë¸</th><th>ëª¨ë¸ëª…</th><th>ë‚ ì§œ</th><th>ìˆ˜ëŸ‰</th><th>ì‚¬ìœ </th><th>ê¸°ê°„(ìë™)</th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('ship')">+ í–‰ ì¶”ê°€</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('ship')">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('ship')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="modalDefect" class="modal">
    <div class="modal-box">
        <div class="modal-title" id="moTitDefect">ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ë°ì´í„° ì…ë ¥</div>
        <div class="modal-desc">Excelì—ì„œ <strong>[ë¶ˆëŸ‰ëª… | ê¸°ê°„(YY.MM) | ìˆ˜ëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <textarea class="paste-area" id="pasteDefect" placeholder="ì˜ˆì‹œ: Human Error&#9;26.02&#9;5"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn-parse" onclick="parsePaste('defect')">ğŸ“‹ ë°ì´í„° ì ìš©</button>
            <button class="btn-clr" onclick="clearTable('defect')">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblEntryDefect">
                <thead><tr><th>ë¶ˆëŸ‰ëª…</th><th>ê¸°ê°„ (YY.MM)</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addRow('defect')">+ í–‰ ì¶”ê°€</button>
        <div class="modal-footer">
            <button class="btn-save btn-full" onclick="saveData('defect')">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button>
            <button class="btn-cancel btn-full" onclick="closeModal('defect')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>


<!-- â•â•â• Daily Production Entry Modal â•â•â• -->
<div id="modalDailyProd" class="modal">
    <div class="modal-box">
        <div class="modal-title">ğŸ“… ì¼ë³„ ìƒì‚° ë°ì´í„° ì…ë ¥</div>
        <div class="modal-desc" id="dprodModalDesc">ëª¨ë¸Â·ë‚ ì§œÂ·ê³µì •ë³„ë¡œ <strong>íˆ¬ì…ìˆ˜ëŸ‰, ì–‘í’ˆìˆ˜ëŸ‰, ë¶ˆëŸ‰ìˆ˜ëŸ‰</strong>ì„ ì…ë ¥í•˜ì„¸ìš”.<br><strong style="color:#4f46e5;">ë¶™ì—¬ë„£ê¸° ìˆœì„œ: ëª¨ë¸ | ë‚ ì§œ(YYYY-MM-DD) | ê³µì • | íˆ¬ì…ìˆ˜ëŸ‰ | ì–‘í’ˆìˆ˜ëŸ‰ | ë¶ˆëŸ‰ìˆ˜ëŸ‰</strong></div>
        <textarea class="paste-area" id="pasteDailyProd" placeholder="Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)"></textarea>
        <div style="display:flex;gap:10px;margin-bottom:20px;"><button class="btn-parse" onclick="parseDailyPaste()">ğŸ“‹ ë°ì´í„° ì ìš©</button><span id="pasteSkipHint" style="font-size:11px;color:#f59e0b;margin-left:8px;font-family:'Noto Sans KR',sans-serif;"></span><button class="btn-clr" onclick="document.querySelector('#tblDailyProdEntry tbody').innerHTML='';document.getElementById('pasteDailyProd').value=''">ğŸ—‘ï¸ ì´ˆê¸°í™”</button></div>
        <div style="max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblDailyProdEntry">
                <thead><tr><th>ëª¨ë¸</th><th>ë‚ ì§œ</th><th>ê³µì •</th><th>íŒ€</th><th id="dThInQty">íˆ¬ì…ìˆ˜ëŸ‰</th><th id="dThGoodQty">ì–‘í’ˆìˆ˜ëŸ‰</th><th id="dThDefQty">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addDailyProdRow()">+ í–‰ ì¶”ê°€</button>
        <div style="padding:10px 20px 0;"><button onclick="clearAllDailyProdData()" style="width:100%;padding:10px;background:#fff0f0;border:1.5px solid #fca5a5;border-radius:10px;color:#e11d48;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;">ğŸ—‘ï¸ Firebase ì¼ë³„ ìƒì‚° ë°ì´í„° ì „ì²´ ì´ˆê¸°í™” (ì£¼ì˜: ë³µêµ¬ ë¶ˆê°€)</button></div>
        <div class="modal-footer"><button class="btn-save btn-full" onclick="saveDailyProd()">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button><button class="btn-cancel btn-full" onclick="document.getElementById('modalDailyProd').style.display='none'">ì·¨ì†Œ</button></div>
    </div>
</div>

<!-- â•â•â• Daily Defect Entry Modal â•â•â• -->
<div id="modalDailyDef" class="modal">
    <div class="modal-box" style="max-width:920px;">
        <div class="modal-title" id="ddefModalTitle">ğŸ”´ ì¼ë³„ ë¶ˆëŸ‰ ì½”ë“œ ì…ë ¥</div>
        <div class="modal-desc" id="ddefModalDesc">ê³µì •ë³„ <strong>ë¶ˆëŸ‰ ìˆ˜ëŸ‰ ë‚´ì—ì„œë§Œ</strong> ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê³µì • ì„ íƒ ì‹œ í•´ë‹¹ ë¶ˆëŸ‰ ìˆ˜ëŸ‰ì´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
        <span style="color:#6366f1;font-weight:700;">ğŸ”µ SMT (SMD/ROUTER): 1000ë²ˆëŒ€</span> &nbsp;|&nbsp; <span style="color:#0891b2;font-weight:700;">ğŸ”¬ TEST (ATE/PCT/AVI): 4000ë²ˆëŒ€</span></div>
        <div id="ddefAvailPanel" style="background:#f0f4fb;border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:12px;font-family:'Noto Sans KR',sans-serif;">
            <strong>ğŸ“‹ í˜„ì¬ ë‚ ì§œ ë²”ìœ„ ë¯¸ì…ë ¥ ë¶ˆëŸ‰:</strong> <span id="ddefAvailList" style="color:var(--text-sub);">ìƒì‚° ë°ì´í„°ì—ì„œ ë¶ˆëŸ‰ ìˆ˜ëŸ‰ì„ ê°€ì ¸ì˜µë‹ˆë‹¤</span>
        </div>
        <div style="max-height:420px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
            <table class="entry-tbl" id="tblDailyDefEntry">
                <thead><tr><th style="min-width:80px;">ëª¨ë¸</th><th style="min-width:130px;">ë‚ ì§œ</th><th style="min-width:80px;">ê³µì •</th><th style="min-width:50px;">íŒ€</th><th style="min-width:220px;">ë¶ˆëŸ‰ ì½”ë“œ ê²€ìƒ‰</th><th style="min-width:90px;">ìˆ˜ëŸ‰<br><span style="font-size:10px;color:#94a3b8;">(ê°€ìš©/ì”ì—¬)</span></th><th>ì‚­ì œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn-addrow" onclick="addDailyDefRow()">+ í–‰ ì¶”ê°€</button>
        <div class="modal-footer"><button class="btn-save btn-full" onclick="saveDailyDef()">ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)</button><button class="btn-cancel btn-full" onclick="document.getElementById('modalDailyDef').style.display='none'">ì·¨ì†Œ</button></div>
    </div>
</div>
<!-- Password Modal -->
<div id="pwModal">
    <div class="pw-box">
        <div class="pw-icon">ğŸ”’</div>
        <div class="pw-title" id="pwTitle">ë°ì´í„° ì…ë ¥ ë¹„ë°€ë²ˆí˜¸</div>
        <div class="pw-sub" id="pwSub">ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        <input type="password" class="pw-input" id="pwInput" placeholder="â€¢â€¢â€¢â€¢" maxlength="20" onkeydown="if(event.key==='Enter')pwConfirm()">
        <div class="pw-err" id="pwErr"></div>
        <div class="pw-btns">
            <button class="pw-cancel" onclick="pwCancel()" id="pwCancelBtn">ì·¨ì†Œ</button>
            <button class="pw-ok" onclick="pwConfirm()" id="pwOkBtn">í™•ì¸</button>
        </div>
    </div>
</div>

<!-- Backup Modal -->
<div id="backupModal">
    <div class="backup-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div>
                <div style="font-size:20px;font-weight:800;color:var(--navy);font-family:'Noto Sans KR',sans-serif;" id="backupTitle">ğŸ’¾ ë°ì´í„° ë°±ì—… ê´€ë¦¬</div>
                <div style="font-size:12px;color:var(--text-sub);margin-top:4px;font-family:'Noto Sans KR',sans-serif;" id="backupSubTitle">ìµœëŒ€ 10ê°œ ë°±ì—… ì €ì¥ Â· ì˜ëª» ì…ë ¥ ì‹œ ë³µì› ê°€ëŠ¥</div>
            </div>
            <button onclick="closeBackupModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);">âœ•</button>
        </div>
        <button onclick="createBackup()" style="width:100%;padding:13px;background:linear-gradient(135deg,var(--navy),var(--navy-light));color:white;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;margin-bottom:20px;transition:all .2s;" id="backupNowBtn" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">ğŸ“¸ ì§€ê¸ˆ ë°±ì—… ìƒì„±</button>
        <div id="backupList"><div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
    </div>
</div>



<script>
// ============================================================
// ğŸ”¥ FIREBASE ì„¤ì •
// ============================================================
const FIREBASE_CONFIG = {
    apiKey:            "AIzaSyAQAqYYenEzp0ps71LRxF9ikcYywq8WwQo",
    authDomain:        "ds-quality-41ad2.firebaseapp.com",
    databaseURL:       "https://ds-quality-41ad2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:         "ds-quality-41ad2",
    storageBucket:     "ds-quality-41ad2.firebasestorage.app",
    messagingSenderId: "910427066275",
    appId:             "1:910427066275:web:3aa0c8009e17619ad3d416"
};
// ============================================================

const isConfigured = !Object.values(FIREBASE_CONFIG).some(v=>v.includes('YOUR_'));
let db=null, prodData=[], shipData=[], defectTypeData=[];
let filters={product:'ì „ì²´',month:'ì „ì²´',process:'ì „ì²´',defectType:'ì „ì²´'};
let procChartFilter='ì „ì²´', prodChartFilter='ì „ì²´', prodVolFilter='ì „ì²´', shipChartFilter='ì „ì²´';
let charts={}, lang='ko';
let dataLoaded={prod:false,ship:false,defect:false,dprod:false,ddef:false};

// â˜… ìµœìš°ì„  ì‹¤í–‰: ë¡œê·¸ì¸ ëª¨ë‹¬ ì¦‰ì‹œ í‘œì‹œ (ë‹¤ë¥¸ ì½”ë“œ ì˜¤ë¥˜ì™€ ë¬´ê´€)
(function showLoginFirst(){
    try{
        var ov=document.getElementById('loadingOverlay');
        var lm=document.getElementById('loginModal');
        var li=document.getElementById('loginInput');
        if(ov) ov.style.display='none';
        if(lm) lm.style.display='flex';
        if(li) setTimeout(function(){try{li.focus();}catch(e){}},200);
    }catch(e){console.error('Login init error:',e);}
})();

// â˜… ìµœìš°ì„ : ë¡œê·¸ì¸ ëª¨ë‹¬ ì¦‰ì‹œ í‘œì‹œ (ë‹¤ë¥¸ ì½”ë“œ ì˜¤ë¥˜ì™€ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰)
(function showLoginFirst(){
    try{
        var ov=document.getElementById('loadingOverlay');
        var lm=document.getElementById('loginModal');
        var li=document.getElementById('loginInput');
        if(ov) ov.style.display='none';
        if(lm) lm.style.display='flex';
        if(li) setTimeout(function(){try{li.focus();}catch(e){}}, 200);
    }catch(e){console.error('Login modal init error:',e);}
})();

// â”€â”€â”€ PASSWORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DATA_PASSWORD = "ds!data"; // â† ë°ì´í„° ì…ë ¥ ë¹„ë°€ë²ˆí˜¸ (ì ‘ì† ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥´ê²Œ ì„¤ì •)
let pwCallback = null;

function requirePassword(cb){
    pwCallback = cb;
    document.getElementById('pwInput').value='';
    document.getElementById('pwErr').innerText='';
    document.getElementById('pwModal').classList.add('open');
    setTimeout(()=>document.getElementById('pwInput').focus(),100);
}
function pwConfirm(){
    const v=document.getElementById('pwInput').value;
    if(v===DATA_PASSWORD){ document.getElementById('pwModal').classList.remove('open'); if(pwCallback){pwCallback();pwCallback=null;} }
    else{ document.getElementById('pwErr').innerText=lang==='ko'?'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤':'âŒ Incorrect password'; document.getElementById('pwInput').value=''; document.getElementById('pwInput').focus(); }
}
function pwCancel(){ document.getElementById('pwModal').classList.remove('open'); pwCallback=null; }

// â”€â”€â”€ BACKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createBackup(){
    const now=new Date(), p=x=>String(x).padStart(2,'0');
    const ts=`${now.getFullYear()}-${p(now.getMonth()+1)}-${p(now.getDate())} ${p(now.getHours())}:${p(now.getMinutes())}:${p(now.getSeconds())}`;
    const key=`backup_${now.getTime()}`;
    const snapshot={ts,prodData:[...prodData],shipData:[...shipData],defectTypeData:[...defectTypeData]};
    if(db){
        db.ref('backups/'+key).set(snapshot).then(()=>{
            cleanOldBackups(); loadBackupList();
            alert(lang==='ko'?'âœ… ë°±ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!':'âœ… Backup created successfully!');
        }).catch(()=>alert(lang==='ko'?'âš ï¸ ë°±ì—… ì €ì¥ ì‹¤íŒ¨':'âš ï¸ Backup failed'));
    } else {
        try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');bs[key]=snapshot;const keys=Object.keys(bs).sort();if(keys.length>10){delete bs[keys[0]];}localStorage.setItem('ds_backups',JSON.stringify(bs));loadBackupList();alert(lang==='ko'?'âœ… ë°±ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¡œì»¬ ì €ì¥)':'âœ… Backup created (local)!');}catch(e){alert('ë°±ì—… ì˜¤ë¥˜');}
    }
}
function cleanOldBackups(){
    if(!db)return;
    db.ref('backups').once('value',s=>{
        const bks=s.val(); if(!bks)return;
        const keys=Object.keys(bks).sort();
        if(keys.length>10){ const toDelete=keys.slice(0,keys.length-10); toDelete.forEach(k=>db.ref('backups/'+k).remove()); }
    });
}
function loadBackupList(){
    const list=document.getElementById('backupList'); if(!list)return;
    if(db){
        db.ref('backups').orderByKey().limitToLast(10).once('value',s=>{
            const bks=s.val();
            if(!bks){list.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">${lang==='ko'?'ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤':'No backups'}</div>`;return;}
            const keys=Object.keys(bks).sort().reverse();
            list.innerHTML=keys.map((k,i)=>`<div class="backup-item"><div class="backup-item-info"><div class="backup-item-time">${bks[k].ts}</div><div class="backup-item-size">${lang==='ko'?`ìƒì‚° ${bks[k].prodData?.length||0}ê±´ Â· ì¶œí•˜ ${bks[k].shipData?.length||0}ê±´ Â· ë¶ˆëŸ‰ ${bks[k].defectTypeData?.length||0}ê±´`:`Prod ${bks[k].prodData?.length||0} Â· Ship ${bks[k].shipData?.length||0} Â· Defect ${bks[k].defectTypeData?.length||0}`}</div></div><div style="display:flex;align-items:center;gap:6px;"><button class="backup-restore-btn" onclick="restoreBackup('${k}')">${lang==='ko'?'ë³µì›':'Restore'}</button><button class="backup-del-btn" onclick="deleteBackup('${k}')">âœ•</button></div></div>`).join('');
        });
    } else {
        try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');const keys=Object.keys(bs).sort().reverse();if(!keys.length){list.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;">${lang==='ko'?'ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤':'No backups'}</div>`;return;}list.innerHTML=keys.map(k=>`<div class="backup-item"><div class="backup-item-info"><div class="backup-item-time">${bs[k].ts}</div><div class="backup-item-size">${lang==='ko'?`ìƒì‚° ${bs[k].prodData?.length||0}ê±´ Â· ì¶œí•˜ ${bs[k].shipData?.length||0}ê±´ Â· ë¶ˆëŸ‰ ${bs[k].defectTypeData?.length||0}ê±´`:`Prod ${bs[k].prodData?.length||0} Â· Ship ${bs[k].shipData?.length||0} Â· Defect ${bs[k].defectTypeData?.length||0}`}</div></div><div style="display:flex;align-items:center;gap:6px;"><button class="backup-restore-btn" onclick="restoreBackup('${k}')">${lang==='ko'?'ë³µì›':'Restore'}</button><button class="backup-del-btn" onclick="deleteBackup('${k}')">âœ•</button></div></div>`).join('');}catch(e){}
    }
}
function restoreBackup(key){
    if(!confirm(lang==='ko'?'âš ï¸ ì´ ë°±ì—…ìœ¼ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.':'âš ï¸ Restore from this backup?\nCurrent data will be overwritten.'))return;
    const doRestore=(snap)=>{
        if(!snap)return;
        prodData=snap.prodData||[]; shipData=snap.shipData||[]; defectTypeData=snap.defectTypeData||[];
        if(db){saveToFirebase('prod',prodData);saveToFirebase('ship',shipData);saveToFirebase('defect',defectTypeData);}
        updateSmartLists(); updateUI(); updateLastUpdate(); closeBackupModal();
        alert(lang==='ko'?'âœ… ë³µì› ì™„ë£Œ!':'âœ… Restore complete!');
    };
    if(db){db.ref('backups/'+key).once('value',s=>doRestore(s.val()));}
    else{try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');doRestore(bs[key]);}catch(e){}}
}
function deleteBackup(key){
    if(!confirm(lang==='ko'?'ì´ ë°±ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?':'Delete this backup?'))return;
    if(db){db.ref('backups/'+key).remove().then(()=>loadBackupList());}
    else{try{const bs=JSON.parse(localStorage.getItem('ds_backups')||'{}');delete bs[key];localStorage.setItem('ds_backups',JSON.stringify(bs));loadBackupList();}catch(e){}}
}
function openBackupModal(){ document.getElementById('backupModal').classList.add('open'); loadBackupList(); }
function closeBackupModal(){ document.getElementById('backupModal').classList.remove('open'); }

try{Chart.register(ChartDataLabels);}catch(e){console.warn("Chart init deferred:",e);}

function initFirebase(){
    if(!isConfigured){
        document.getElementById('configBanner').style.display='block';
        document.getElementById('loadingOverlay').style.display='none';
        setSyncStatus('offline','âš ï¸ Firebase ë¯¸ì„¤ì •');
        prodData=getDefaultProdData(); shipData=getDefaultShipData(); defectTypeData=getDefaultDefectData();
        dailyProdData=[]; dailyDefectData=[];
        Object.keys(dataLoaded).forEach(k=>dataLoaded[k]=true);
        initUI(); return;
    }
    try{
        firebase.initializeApp(FIREBASE_CONFIG); db=firebase.database();
        setupListeners();
    }catch(e){ setSyncStatus('offline','ì—°ê²° ì˜¤ë¥˜'); document.getElementById('loadingOverlay').style.display='none'; }
}

function setupListeners(){
    setSyncStatus('saving','ë°ì´í„° ë¡œë”© ì¤‘...');
    db.ref('prodData').on('value',s=>{ prodData=s.val()?Object.values(s.val()):getDefaultProdData(); dataLoaded.prod=true; checkLoaded(); });
    db.ref('shipData').on('value',s=>{ shipData=s.val()?Object.values(s.val()):getDefaultShipData(); dataLoaded.ship=true; checkLoaded(); });
    db.ref('defectTypeData').on('value',s=>{ defectTypeData=s.val()?Object.values(s.val()):getDefaultDefectData(); dataLoaded.defect=true; checkLoaded(); });
    db.ref('dailyProdData').on('value',s=>{
        const raw=s.val()?Object.values(s.val()):[];
        // ë°ì´í„° ë¡œë“œ: inspQty > 0ì¸ í–‰ë§Œ, defectQtyëŠ” ì €ì¥ê°’ ê·¸ëŒ€ë¡œ ì‹ ë¢°
        // (ì €ì¥ ì‹œ defectQty = inspQty - goodQty ë¡œ ì´ë¯¸ ì •í™•íˆ ê³„ì‚°ë¨)
        dailyProdData=raw.filter(d=>d.inspQty>0).map(d=>{
            const inspQty = Number(d.inspQty)||0;
            const goodQty = Number(d.goodQty)||0;
            // defectQty: ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ inspQty-goodQty
            const defectQty = (d.defectQty !== undefined && d.defectQty !== null)
                ? Math.min(Number(d.defectQty), inspQty)  // inspQty ì´ˆê³¼ ë°©ì§€ë§Œ
                : Math.max(0, inspQty - goodQty);
            return {...d, inspQty, goodQty, defectQty};
        });
        dataLoaded.dprod=true; checkLoaded(); if(currentView==='daily') updateDailyUI();
    });
    db.ref('dailyDefectData').on('value',s=>{ dailyDefectData=s.val()?Object.values(s.val()):[]; dataLoaded.ddef=true; checkLoaded(); if(currentView==='daily') updateDailyUI(); });
    firebase.database().ref('.info/connected').on('value',s=>setSyncStatus(s.val()?'online':'offline',s.val()?'ì‹¤ì‹œê°„ ì—°ê²°ë¨':'ì˜¤í”„ë¼ì¸'));
}

function checkLoaded(){ if(Object.values(dataLoaded).every(v=>v)){ document.getElementById('loadingOverlay').style.display='none'; initUI(); } }
function initUI(){ updateSmartLists(); renderFilterButtons(); updateUI(); updateLastUpdate(); }
function setSyncStatus(t,x){ const e=document.getElementById('syncStatus'); e.className='sync-'+t; document.getElementById('syncText').textContent=x; }

function saveToFirebase(type,data){
    if(!db) return Promise.resolve();
    setSyncStatus('saving','ì €ì¥ ì¤‘...');
    const k={prod:'prodData',ship:'shipData',defect:'defectTypeData',dprod:'dailyProdData',ddef:'dailyDefectData'}[type]||'prodData';
    return db.ref(k).set(data).then(()=>{setSyncStatus('online','ì‹¤ì‹œê°„ ì—°ê²°ë¨');const t=document.getElementById('saveSuccess');t.style.display='block';setTimeout(()=>t.style.display='none',2500);}).catch(()=>setSyncStatus('offline','ì €ì¥ ì‹¤íŒ¨'));
}

function getDefaultProdData(){return[{"prod":"RDIMM","month":"10ì›”","proc":"SMD","in":3450,"out":3450,"fail":0},{"prod":"RDIMM","month":"10ì›”","proc":"ROUTER","in":3450,"out":3450,"fail":0},{"prod":"RDIMM","month":"10ì›”","proc":"ATE","in":3450,"out":3448,"fail":2},{"prod":"RDIMM","month":"10ì›”","proc":"PCT","in":3448,"out":3418,"fail":30},{"prod":"RDIMM","month":"10ì›”","proc":"AVI","in":3418,"out":3413,"fail":5},{"prod":"RDIMM","month":"11ì›”","proc":"SMD","in":1410,"out":1410,"fail":0},{"prod":"RDIMM","month":"11ì›”","proc":"ROUTER","in":1410,"out":1409,"fail":1},{"prod":"RDIMM","month":"11ì›”","proc":"ATE","in":1409,"out":1407,"fail":2},{"prod":"RDIMM","month":"11ì›”","proc":"PCT","in":1407,"out":1386,"fail":21},{"prod":"RDIMM","month":"11ì›”","proc":"AVI","in":1386,"out":1384,"fail":2},{"prod":"RDIMM","month":"12ì›”","proc":"SMD","in":7632,"out":7630,"fail":2},{"prod":"RDIMM","month":"12ì›”","proc":"ROUTER","in":7630,"out":7628,"fail":2},{"prod":"RDIMM","month":"12ì›”","proc":"ATE","in":7628,"out":7622,"fail":6},{"prod":"RDIMM","month":"12ì›”","proc":"PCT","in":7622,"out":7581,"fail":41},{"prod":"RDIMM","month":"12ì›”","proc":"AVI","in":7581,"out":7576,"fail":5},{"prod":"RDIMM","month":"1ì›”","proc":"SMD","in":3204,"out":3204,"fail":0},{"prod":"RDIMM","month":"1ì›”","proc":"ROUTER","in":3204,"out":3204,"fail":0},{"prod":"RDIMM","month":"1ì›”","proc":"ATE","in":3204,"out":3201,"fail":3},{"prod":"RDIMM","month":"1ì›”","proc":"PCT","in":3201,"out":3179,"fail":22},{"prod":"RDIMM","month":"1ì›”","proc":"AVI","in":3179,"out":3179,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"SMD","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"ROUTER","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"ATE","in":2574,"out":2574,"fail":0},{"prod":"SODIMM","month":"11ì›”","proc":"PCT","in":2574,"out":2562,"fail":12},{"prod":"SODIMM","month":"11ì›”","proc":"AVI","in":2562,"out":2559,"fail":3},{"prod":"SODIMM","month":"12ì›”","proc":"SMD","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12ì›”","proc":"ROUTER","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12ì›”","proc":"ATE","in":1404,"out":1404,"fail":0},{"prod":"SODIMM","month":"12ì›”","proc":"PCT","in":1404,"out":1399,"fail":5},{"prod":"SODIMM","month":"12ì›”","proc":"AVI","in":1399,"out":1398,"fail":1},{"prod":"UDIMM","month":"12ì›”","proc":"SMD","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12ì›”","proc":"ROUTER","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12ì›”","proc":"ATE","in":4212,"out":4212,"fail":0},{"prod":"UDIMM","month":"12ì›”","proc":"PCT","in":4212,"out":4198,"fail":14},{"prod":"UDIMM","month":"12ì›”","proc":"AVI","in":4198,"out":4198,"fail":0},{"prod":"UDIMM","month":"1ì›”","proc":"SMD","in":2046,"out":2046,"fail":0},{"prod":"UDIMM","month":"1ì›”","proc":"ROUTER","in":2046,"out":2046,"fail":0},{"prod":"UDIMM","month":"1ì›”","proc":"ATE","in":2046,"out":2045,"fail":1},{"prod":"UDIMM","month":"1ì›”","proc":"PCT","in":2045,"out":2042,"fail":3},{"prod":"UDIMM","month":"1ì›”","proc":"AVI","in":2042,"out":2042,"fail":0}];}
function getDefaultShipData(){return[{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-10-28","qty":1026,"reason":"Mass Production","month":"25.10"},{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-11-06","qty":4304,"reason":"Mass Production","month":"25.11"},{"model":"UDIMM","name":"M323R2GA3EB0-CWMOL-IYB","date":"2025-11-25","qty":2000,"reason":"Mass Production","month":"25.11"},{"model":"RDIMM","name":"M321R8GA0EB2-CWMXJ-IRB","date":"2025-12-16","qty":2344,"reason":"Mass Production","month":"25.12"},{"model":"SODIMM","name":"M425R2GA3EB0-CWMOL-IYB","date":"2025-12-16","qty":1935,"reason":"Mass Production","month":"25.12"}];}
function getDefaultDefectData(){return[{"reason":"Human Error","month":"25.10","qty":0},{"reason":"Human Error","month":"25.11","qty":3},{"reason":"Human Error","month":"25.12","qty":1},{"reason":"Human Error","month":"26.01","qty":0},{"reason":"Handling Damage","month":"25.10","qty":5},{"reason":"Handling Damage","month":"25.11","qty":3},{"reason":"Handling Damage","month":"25.12","qty":8},{"reason":"Handling Damage","month":"26.01","qty":0},{"reason":"Component Lifting","month":"25.10","qty":0},{"reason":"Component Lifting","month":"25.11","qty":0},{"reason":"Component Lifting","month":"25.12","qty":1},{"reason":"Component Lifting","month":"26.01","qty":0}];}

const T={ko:{mainTitle:'ğŸ“Š DS Quality Performance',lblProd:'ì œí’ˆ',lblPeriod:'ê¸°ê°„',lblProcess:'ê³µì •',btnProd:'âœï¸ ìƒì‚° ì…ë ¥',btnShip:'ğŸ“¦ ì¶œí•˜ ì…ë ¥',btnDefect:'ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ì…ë ¥',lblKpiYield:'ì¢…í•© ìˆ˜ìœ¨',lblKpiPPM:'ë‹¹ì‚¬ ê·€ì±… PPM',lblKpiInput:'ì´ íˆ¬ì… ìˆ˜ëŸ‰',lblKpiOutput:'ì´ ì‚°ì¶œ ìˆ˜ëŸ‰',lblKpiDefect:'ì´ ë¶ˆëŸ‰ ìˆ˜ëŸ‰',lblKpiDefectPPM:'ì´ ë¶ˆëŸ‰ PPM',lblKpiCompDefect:'ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜',titProcYield:'ê³µì •ë³„ ìˆ˜ìœ¨ í˜„í™©',titMonthYield:'ê³µì •ë³„ ì›”ë³„ ìˆ˜ìœ¨ ì¶”ì´',titProdYield:'ì œí’ˆë³„ ìˆ˜ìœ¨ í˜„í™©',titTotalTrend:'ì¢…í•© ìˆ˜ìœ¨ ì›”ë³„ íŠ¸ë Œë“œ (%)',titPpmTrend:'ë‹¹ì‚¬ ê·€ì±… PPM ì›”ë³„ íŠ¸ë Œë“œ',titProdTrend:'ì œí’ˆë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)',titProcTrend:'ê³µì •ë³„ ìˆ˜ìœ¨ ì¶”ì´ (%)',titProdVol:'DS ìƒì‚° ì‹¤ì ',titTotalDefect:'ì›”ë³„ ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ',titCompDefect:'ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜ íŠ¸ë Œë“œ',titDefectType:'ë¶ˆëŸ‰ ìœ í˜• ì°¨íŠ¸',titDefectTable:'ë¶ˆëŸ‰ ìœ í˜• ìƒì„¸ í˜„í™©',titDefectSection:'ğŸ“‰ ë¶ˆëŸ‰ ë¶„ì„ ë° ìƒì„¸ í˜„í™©',titShipSection:'ğŸ“¦ ì¶œí•˜ ì‹¤ì ',titShipTable:'ì›”ë³„ ì¶œí•˜ ìˆ˜ëŸ‰',titShipChart:'ì›”ë³„ ì¶œí•˜ ì‹¤ì  ì¶”ì´',thProc:'ê³µì •',thIn:'íˆ¬ì…',thOut:'ì‚°ì¶œ',thFail:'ë¶ˆëŸ‰',thYld:'ìˆ˜ìœ¨',thStat:'íŒì •',thMonth:'ê¸°ê°„',thProd:'ì œí’ˆ',thIn2:'íˆ¬ì…',thOut2:'ì‚°ì¶œ',thFail2:'ë¶ˆëŸ‰',thYld2:'ìˆ˜ìœ¨',thStat2:'íŒì •',thShipMonth:'ê¸°ê°„',thTotal:'í•©ê³„',moTitProd:'âœï¸ ìƒì‚° ë°ì´í„° ì…ë ¥',moTitShip:'ğŸ“¦ ì¶œí•˜ ë°ì´í„° ì…ë ¥',moTitDefect:'ğŸ› ï¸ ë¶ˆëŸ‰ ìœ í˜• ë°ì´í„° ì…ë ¥',all:'ì „ì²´',good:'ì–‘í˜¸',warn:'ê²½ê³ ',
    btnViewMonthly:'ğŸ“… ì›”ë³„',btnViewDaily:'ğŸ“† ì¼ë³„',btnDailyProd:'ğŸ“… ì¼ë³„ ìƒì‚° ì…ë ¥',btnDailyDef:'ğŸ”´ ë¶ˆëŸ‰ ì½”ë“œ ì…ë ¥',
    dlblDate:'ë‚ ì§œ',dlblProd:'ì œí’ˆ',dlblTeam:'íŒ€',dlblProcess:'ê³µì •',
    dLblYield:'ì¢…í•© ìˆ˜ìœ¨',dLblInput:'ì´ íˆ¬ì… ìˆ˜ëŸ‰',dLblDefect:'ì´ ë¶ˆëŸ‰ ìˆ˜ëŸ‰',dLblDefectPPM:'ì´ ë¶ˆëŸ‰ PPM',dLblCompDefect:'ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ ìˆ˜',dLblPpm:'ë‹¹ì‚¬ ê·€ì±… PPM',
    dTitYieldTrend:'ì¼ë³„ ìˆ˜ìœ¨ íŠ¸ë Œë“œ (%)',dTitPpmTrend:'ì¼ë³„ ë‹¹ì‚¬ ê·€ì±… PPM íŠ¸ë Œë“œ',dTitVolTrend:'ì¼ë³„ íˆ¬ì…ëŸ‰ íŠ¸ë Œë“œ',
    dTitDefectSection:'ğŸ“‰ ë¶ˆëŸ‰ ì½”ë“œ ë¶„ì„',dTitDefectBar:'ë¶ˆëŸ‰ ì½”ë“œ TOP 10',dTitDefectPie:'ë¶ˆëŸ‰ ì½”ë“œ ë¹„ìœ¨',dTitDefectTable:'ë¶ˆëŸ‰ ì½”ë“œ ìƒì„¸',
    dTitProdSection:'ğŸ“‹ ì¼ë³„ ìƒì‚° ë°ì´í„°',dTitProcVolTrend:'ê³µì •ë³„ ì¼ë³„ ìƒì‚°ìˆ˜ëŸ‰',dTitProdBarProc:'ê³µì •ë³„ íˆ¬ì…ìˆ˜ëŸ‰',dTitProdBarModel:'ëª¨ë¸ë³„ íˆ¬ì…ìˆ˜ëŸ‰',dTitProdYieldDefect:'ë‚ ì§œë³„ ìˆ˜ìœ¨ & ë¶ˆëŸ‰ ì¶”ì´',
    dTblDefThCode:'ì½”ë“œ',dTblDefThName:'ë¶ˆëŸ‰ëª…',dTblDefThTeam:'íŒ€',dTblDefThQty:'ìˆ˜ëŸ‰',
    dThRate:'ìˆ˜ìœ¨',
    dProdTblThDate:'ë‚ ì§œ',dProdTblThModel:'ëª¨ë¸',dProdTblThProc:'ê³µì •',dProdTblThTeam:'íŒ€',dProdTblThYield:'ìˆ˜ìœ¨',
    dThDate:'ë‚ ì§œ',dThModel:'ëª¨ë¸',dThProc:'ê³µì •',dThTeamCol:'íŒ€',dThInQty:'íˆ¬ì…ìˆ˜ëŸ‰',dThGoodQty:'ì–‘í’ˆìˆ˜ëŸ‰',dThDefQty:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',dThYield:'ìˆ˜ìœ¨',
    btnToday:'ì˜¤ëŠ˜',btnYesterday:'ì–´ì œ',btnThisWeek:'ì´ë²ˆì£¼',btnThisMonth:'ì´ë²ˆë‹¬',btnAllDate:'ì „ì²´',lblWeekNum:'ì£¼ì°¨ ê²€ìƒ‰:',
    smtLblYield:'ìˆ˜ìœ¨',smtLblInput:'íˆ¬ì… ìˆ˜ëŸ‰',smtLblDefect:'ë¶ˆëŸ‰',testLblYield:'ìˆ˜ìœ¨',testLblInput:'íˆ¬ì… ìˆ˜ëŸ‰',testLblDefect:'ë¶ˆëŸ‰',
    modalDailyProdTitle:'ğŸ“… ì¼ë³„ ìƒì‚° ë°ì´í„° ì…ë ¥',modalDailyProdDesc:'ë¶™ì—¬ë„£ê¸° ìˆœì„œ: ëª¨ë¸ | ë‚ ì§œ(YYYY-MM-DD) | ê³µì • | íˆ¬ì…ìˆ˜ëŸ‰ | ì–‘í’ˆìˆ˜ëŸ‰ | ë¶ˆëŸ‰ìˆ˜ëŸ‰',
    modalDailyDefTitle:'ğŸ”´ ì¼ë³„ ë¶ˆëŸ‰ ì½”ë“œ ì…ë ¥',modalDailyDefDesc:'ê³µì •ë³„ ë¶ˆëŸ‰ ìˆ˜ëŸ‰ ë‚´ì—ì„œë§Œ ì½”ë“œë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤'},en:{mainTitle:'ğŸ“Š DS Quality Performance',lblProd:'Product',lblPeriod:'Period',lblProcess:'Process',btnProd:'âœï¸ Production',btnShip:'ğŸ“¦ Shipment',btnDefect:'ğŸ› ï¸ Defect Types',lblKpiYield:'Overall Yield',lblKpiPPM:'Company Defect PPM',lblKpiInput:'Total Input',lblKpiOutput:'Total Output',lblKpiDefect:'Total Defects',lblKpiDefectPPM:'Total Defect PPM',lblKpiCompDefect:'Company Defect Qty',titProcYield:'Process Yield',titMonthYield:'Monthly Process Yield',titProdYield:'Product Yield',titTotalTrend:'Overall Yield Trend (%)',titPpmTrend:'Company Defect PPM Trend',titProdTrend:'Product Yield Trend (%)',titProcTrend:'Process Yield Trend (%)',titProdVol:'Production Volume',titTotalDefect:'Total Defect Trend',titCompDefect:'Company Defect Trend',titDefectType:'Defect Type Chart',titDefectTable:'Defect Type Details',titDefectSection:'ğŸ“‰ Defect Analysis',titShipSection:'ğŸ“¦ Shipment Performance',titShipTable:'Monthly Shipment',titShipChart:'Shipment Trend',thProc:'Process',thIn:'Input',thOut:'Output',thFail:'Defect',thYld:'Yield',thStat:'Status',thMonth:'Period',thProd:'Product',thIn2:'Input',thOut2:'Output',thFail2:'Defect',thYld2:'Yield',thStat2:'Status',thShipMonth:'Period',thTotal:'Total',moTitProd:'âœï¸ Production Data Entry',moTitShip:'ğŸ“¦ Shipment Data Entry',moTitDefect:'ğŸ› ï¸ Defect Type Data Entry',all:'All',good:'Good',warn:'Warning',
    btnViewMonthly:'ğŸ“… Monthly',btnViewDaily:'ğŸ“† Daily',btnDailyProd:'ğŸ“… Daily Prod Entry',btnDailyDef:'ğŸ”´ Defect Code Entry',
    dlblDate:'Date',dlblProd:'Product',dlblTeam:'Team',dlblProcess:'Process',
    dLblYield:'Overall Yield',dLblInput:'Total Input Qty',dLblDefect:'Total Defects',dLblDefectPPM:'Total Defect PPM',dLblCompDefect:'Company Defect Qty',dLblPpm:'Company Defect PPM',
    dTitYieldTrend:'Daily Yield Trend (%)',dTitPpmTrend:'Daily Company Defect PPM Trend',dTitVolTrend:'Daily Input Volume Trend',
    dTitDefectSection:'ğŸ“‰ Defect Code Analysis',dTitDefectBar:'Top 10 Defect Codes',dTitDefectPie:'Defect Code Distribution',dTitDefectTable:'Defect Code Details',
    dTitProdSection:'ğŸ“‹ Daily Production Data',dTitProcVolTrend:'Daily Volume by Process',dTitProdBarProc:'Input Qty by Process',dTitProdBarModel:'Input Qty by Model',dTitProdYieldDefect:'Daily Yield & Defect Trend',
    dTblDefThCode:'Code',dTblDefThName:'Defect Name',dTblDefThTeam:'Team',dTblDefThQty:'Qty',
    dThRate:'Yield',
    dProdTblThDate:'Date',dProdTblThModel:'Model',dProdTblThProc:'Process',dProdTblThTeam:'Team',dProdTblThYield:'Yield',
    dThDate:'Date',dThModel:'Model',dThProc:'Process',dThTeamCol:'Team',dThInQty:'Input Qty',dThGoodQty:'Good Qty',dThDefQty:'Def. Qty',dThYield:'Yield',
    btnToday:'Today',btnYesterday:'Yesterday',btnThisWeek:'This Week',btnThisMonth:'This Month',btnAllDate:'All',lblWeekNum:'Week#:',
    smtLblYield:'Yield',smtLblInput:'Input Qty',smtLblDefect:'Defects',testLblYield:'Yield',testLblInput:'Input Qty',testLblDefect:'Defects',
    modalDailyProdTitle:'ğŸ“… Daily Production Entry',modalDailyProdDesc:'Paste order: Model | Date(YYYY-MM-DD) | Process | InputQty | GoodQty | DefectQty',
    modalDailyDefTitle:'ğŸ”´ Daily Defect Code Entry',modalDailyDefDesc:'Defect codes must be within the defect quantity already recorded for that date/model/process'}};

function getUV(a,k){return[...new Set(a.map(d=>d[k]))].filter(v=>v&&v.toString().trim()).sort();}
function updateSmartLists(){
    document.querySelectorAll('datalist').forEach(d=>d.remove());
    const months=[...new Set([...prodData.map(d=>d.month),...shipData.map(d=>d.month),...defectTypeData.map(d=>d.month)])];
    const dReasons=[...new Set([...getUV(defectTypeData,'reason'),'Human Error','Handling Damage','Component Lifting'])];
    const sReasons=[...new Set([...getUV(shipData,'reason'),'Mass Production','Sample','RMA'])];
    document.body.insertAdjacentHTML('beforeend',`<datalist id="list-products"><option value="RDIMM"><option value="SODIMM"><option value="UDIMM"></datalist><datalist id="list-months">${months.map(m=>`<option value="${m}">`).join('')}</datalist><datalist id="list-model-names">${getUV(shipData,'name').map(n=>`<option value="${n}">`).join('')}</datalist><datalist id="list-ship-reasons">${sReasons.map(r=>`<option value="${r}">`).join('')}</datalist><datalist id="list-defect-reasons">${dReasons.map(r=>`<option value="${r}">`).join('')}</datalist>`);
}
function updateLastUpdate(){
    const el=document.getElementById('lastUpdate'); if(!el)return;
    const n=new Date(), p=x=>String(x).padStart(2,'0');
    el.innerText=(lang==='ko'?'ìµœì¢… ì—…ë°ì´íŠ¸: ':'Last Update: ')+`${n.getFullYear()}-${p(n.getMonth()+1)}-${p(n.getDate())} ${p(n.getHours())}:${p(n.getMinutes())}:${p(n.getSeconds())}`;
}
// initFirebaseëŠ” ë¡œê·¸ì¸ í›„ doLogin()ì—ì„œ í˜¸ì¶œë¨
// window.onload=initFirebase; â† ìë™ì‹¤í–‰ ì œê±°

function extractYM(s){
    if(!s)return''; const c=s.toString().trim();
    if(/^\d{2}\.\d{2}$/.test(c))return c;
    const km=c.match(/(\d{2,4})\s*ë…„\s*(\d{1,2})\s*ì›”?/);
    if(km){let y=km[1];const m=km[2].padStart(2,'0');if(y.length===4)y=y.slice(2);return`${y}.${m}`;}
    const dm=c.match(/(\d{4})[-/](\d{1,2})/);
    if(dm)return`${dm[1].slice(2)}.${dm[2].padStart(2,'0')}`;
    return c;
}
function fmtPeriod(p){
    if(!/^\d{2}\.\d{2}$/.test(p))return p;
    const[y,m]=p.split('.'),mn=parseInt(m);
    if(lang==='en'){const ns=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${ns[mn]} ${y}`;}
    return`${y}ë…„ ${mn}ì›”`;
}
function getPM(){return[...new Set(prodData.map(d=>d.month))].sort();}
function getSM(){return[...new Set(shipData.map(d=>d.month))].sort();}
function getDM(){return[...new Set(defectTypeData.map(d=>d.month))].sort();}
function getAM(){return[...new Set([...prodData.map(d=>d.month),...shipData.map(d=>d.month),...defectTypeData.map(d=>d.month)])].sort();}
function getFD(){return prodData.filter(d=>(filters.product==='ì „ì²´'||d.prod===filters.product)&&(filters.month==='ì „ì²´'||d.month===filters.month)&&(filters.process==='ì „ì²´'||d.proc===filters.process));}
function cleanNum(v){return Number((v||'').toString().replace(/[,\s]/g,''))||0;}

function saveData(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const rows=document.querySelector(`#${tid} tbody`).querySelectorAll('tr');
    const nd=[];
    rows.forEach(tr=>{
        const i=tr.querySelectorAll('input,select');
        if(type==='prod'&&i[0].value)nd.push({prod:i[0].value,month:i[1].value.trim(),proc:i[2].value,in:cleanNum(i[3].value),out:cleanNum(i[4].value),fail:cleanNum(i[5].value)});
        else if(type==='ship'&&i[0].value.trim())nd.push({model:i[0].value.trim(),name:i[1].value.trim(),date:i[2].value.trim(),qty:cleanNum(i[3].value),reason:i[4].value.trim(),month:i[5].value.trim()});
        else if(type==='defect'&&i[0].value.trim())nd.push({reason:i[0].value.trim(),month:i[1].value.trim(),qty:cleanNum(i[2].value)});
    });
    if(!nd.length){alert('âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
    if(type==='prod')prodData=nd; else if(type==='ship')shipData=nd; else defectTypeData=nd;
    saveToFirebase(type,nd).then(()=>{
        closeModal(type); updateSmartLists(); updateUI(); updateLastUpdate();
        const s=document.getElementById('saveSuccess'); s.style.display='block'; setTimeout(()=>s.style.display='none',3000);
    });
}

function setLang(l){
    lang=l;
    document.getElementById('btnKo').className=l==='ko'?'lang-btn active':'lang-btn';
    document.getElementById('btnEn').className=l==='en'?'lang-btn active':'lang-btn';
    for(let k in T[lang]){const e=document.getElementById(k);if(e)e.innerText=T[lang][k];}
    updateUI(); updateLastUpdate(); updateModalLang();
}
function filter(t,v){filters[t]=v; updateUI();}

function renderProdChartBtns(){
    const c=document.getElementById('prodChartFilter'); if(!c)return; c.innerHTML='';
    ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(prodChartFilter===p?' active':'');
        b.innerText=p==='ì „ì²´'?T[lang].all:p; b.onclick=()=>setPCF(p); c.appendChild(b);
    });
}
function setPCF(v){
    prodChartFilter=v;
    if(charts.prodYield){
        const isSingle = v!=='ì „ì²´';
        charts.prodYield.data.datasets.forEach((ds,i)=>charts.prodYield.setDatasetVisibility(i,!isSingle||ds.label===v));
        // Show labels only when single filter
        charts.prodYield.options.plugins.datalabels.display = isSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false;
        charts.prodYield.update();
    }
    renderProdChartBtns();
}
function renderProcChartBtns(){
    const c=document.getElementById('procChartFilter'); if(!c)return; c.innerHTML='';
    ['ì „ì²´','SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(procChartFilter===p?' active':'');
        b.innerText=p==='ì „ì²´'?T[lang].all:p; b.onclick=()=>setRCF(p); c.appendChild(b);
    });
}
function setRCF(v){
    procChartFilter=v;
    if(charts.procYield){
        const isSingle = v!=='ì „ì²´';
        charts.procYield.data.datasets.forEach((ds,i)=>charts.procYield.setDatasetVisibility(i,!isSingle||ds.label===v));
        charts.procYield.options.plugins.datalabels.display = isSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false;
        charts.procYield.update();
    }
    renderProcChartBtns();
}
function renderProdVolBtns(){
    const c=document.getElementById('prodVolFilter'); if(!c)return; c.innerHTML='';
    ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(prodVolFilter===p?' active':'');
        b.innerText=p==='ì „ì²´'?T[lang].all:p; b.onclick=()=>setPVF(p); c.appendChild(b);
    });
}
function setPVF(v){
    prodVolFilter=v;
    if(charts.prodVol){
        charts.prodVol.data.datasets.forEach((ds,i)=>charts.prodVol.setDatasetVisibility(i,v==='ì „ì²´'||ds.label===v));
        charts.prodVol.update();
    }
    renderProdVolBtns();
}
function renderShipChartBtns(){
    const c=document.getElementById('shipChartFilter'); if(!c)return; c.innerHTML='';
    ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button'); b.className='mini-btn'+(shipChartFilter===p?' active':'');
        b.innerText=p==='ì „ì²´'?T[lang].all:p; b.onclick=()=>setSCF(p); c.appendChild(b);
    });
}
function setSCF(v){
    shipChartFilter=v;
    if(charts.shipment){
        charts.shipment.data.datasets.forEach((ds,i)=>{
            if(ds.label==='Total')charts.shipment.setDatasetVisibility(i,v==='ì „ì²´');
            else charts.shipment.setDatasetVisibility(i,v==='ì „ì²´'||ds.label===v);
        });
        charts.shipment.update();
    }
    renderShipChartBtns();
}
function renderDefectBtns(){
    const c=document.getElementById('defectTypeFilters'); if(!c)return; c.innerHTML='';
    const rs=[...new Set(defectTypeData.map(d=>d.reason))].sort();
    ['ì „ì²´',...rs].forEach(r=>{
        const b=document.createElement('button'); b.className='mini-btn'+(filters.defectType===r?' active':'');
        b.innerText=r==='ì „ì²´'?T[lang].all:r; b.onclick=()=>filter('defectType',r); c.appendChild(b);
    });
}

function updateDefectTable(){
    const tbl=document.getElementById('tblDefectType'); if(!tbl)return;
    const thead=tbl.querySelector('thead'), tbody=tbl.querySelector('tbody');
    const months=getDM(), reasons=[...new Set(defectTypeData.map(d=>d.reason))].sort();
    thead.innerHTML=`<tr><th>${lang==='ko'?'ê¸°ê°„':'Period'}</th>${reasons.map(r=>`<th>${r}</th>`).join('')}<th>${lang==='ko'?'í•©ê³„':'Total'}</th></tr>`;
    if(!months.length||!reasons.length){tbody.innerHTML=`<tr><td colspan="${reasons.length+2}" style="text-align:center;color:#94a3b8;padding:30px;">${lang==='ko'?'ë°ì´í„° ì—†ìŒ':'No data'}</td></tr>`;return;}
    const rt={};reasons.forEach(r=>rt[r]=defectTypeData.filter(d=>d.reason===r).reduce((a,b)=>a+b.qty,0));
    tbody.innerHTML=''; let grand=0;
    months.forEach(m=>{
        let rt2=0,row=`<tr><td><strong>${fmtPeriod(m)}</strong></td>`;
        reasons.forEach(r=>{
            const item=defectTypeData.find(d=>d.month===m&&d.reason===r), q=item?item.qty:0; rt2+=q;
            let cls='',dsp='';
            if(q===0){cls='d-zero';dsp='-';}else if(q<=2){cls='d-low';dsp=q.toLocaleString();}else if(q<=5){cls='d-med';dsp=q.toLocaleString();}else{cls='d-high';dsp=q.toLocaleString();}
            row+=`<td class="${cls}">${dsp}</td>`;
        });
        row+=`<td>${rt2.toLocaleString()}</td></tr>`;
        tbody.innerHTML+=row; grand+=rt2;
    });
    tbody.innerHTML+=`<tr class="grand-row"><td>${lang==='ko'?'ì „ì²´ í•©ê³„':'Grand Total'}</td>${reasons.map(r=>`<td>${rt[r].toLocaleString()}</td>`).join('')}<td>${grand.toLocaleString()}</td></tr>`;
}

function renderFilterButtons(){
    const pc=document.getElementById('filterProduct'); pc.innerHTML='';
    ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{const b=document.createElement('button');b.className='filter-btn'+(filters.product===p?' active':'');b.innerText=p==='ì „ì²´'?T[lang].all:p;b.onclick=()=>filter('product',p);pc.appendChild(b);});
    const mc=document.getElementById('filterMonth'); mc.innerHTML='';
    ['',...getAM()].forEach((m,i)=>{const b=document.createElement('button');const v=i===0?'ì „ì²´':m;b.className='filter-btn'+(filters.month===v?' active':'');b.innerText=i===0?T[lang].all:fmtPeriod(m);b.onclick=()=>filter('month',v);mc.appendChild(b);});
    const proc=document.getElementById('filterProcess'); proc.innerHTML='';
    ['ì „ì²´','SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{const b=document.createElement('button');b.className='filter-btn'+(filters.process===p?' active':'');b.innerText=p==='ì „ì²´'?T[lang].all:p;b.onclick=()=>filter('process',p);proc.appendChild(b);});
}

function updateUI(){
    renderFilterButtons(); renderProdChartBtns(); renderProcChartBtns(); renderDefectBtns(); renderProdVolBtns(); renderShipChartBtns();
    const data=getFD();
    let tI=0,tO=0,tF=0,cF=0;
    if(filters.process!=='ì „ì²´'){tI=data.reduce((a,b)=>a+b.in,0);tO=data.reduce((a,b)=>a+b.out,0);}
    else{tI=data.filter(d=>d.proc==='SMD').reduce((a,b)=>a+b.in,0);tO=data.filter(d=>d.proc==='AVI').reduce((a,b)=>a+b.out,0);}
    tF=data.reduce((a,b)=>a+b.fail,0);
    cF=data.filter(d=>['SMD','ROUTER','AVI'].includes(d.proc)).reduce((a,b)=>a+b.fail,0);
    const yv=tI>0?tO/tI*100:0, ppm=tI>0?cF/tI*1000000:0;
    document.getElementById('kpiYield').innerText=yv.toFixed(2)+'%';
    document.getElementById('kpiPPM').innerText=Math.round(ppm).toLocaleString()+' PPM';
    document.getElementById('kpiInput').innerText=tI.toLocaleString();
    document.getElementById('kpiOutput').innerText=tO.toLocaleString();
    document.getElementById('kpiDefect').innerText=tF.toLocaleString();
    const totalDefPpm=tI>0?tF/tI*1000000:0;
    document.getElementById('kpiDefectPPM').innerText=Math.round(totalDefPpm).toLocaleString()+' PPM';
    document.getElementById('kpiCompDefect').innerText=cF.toLocaleString();
    updateTables(data); updateDefectTable(); drawCharts(data);
}

function updateTables(data){
    const t=T[lang];
    const pb=document.querySelector('#tblProcYield tbody'); pb.innerHTML='';
    ['SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
        const d=data.filter(r=>r.proc===p);
        const ti=d.reduce((a,b)=>a+b.in,0),to=d.reduce((a,b)=>a+b.out,0),tf=d.reduce((a,b)=>a+b.fail,0);
        const y=ti>0?to/ti*100:0, ok=y>=99.5;
        pb.innerHTML+=`<tr><td><strong>${p}</strong></td><td>${ti.toLocaleString()}</td><td>${to.toLocaleString()}</td><td>${tf.toLocaleString()}</td><td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td><td><span class="badge ${ok?'badge-ok':'badge-ng'}">${ok?t.good:t.warn}</span></td></tr>`;
    });
    const mb=document.querySelector('#tblMonthYield tbody'); mb.innerHTML='';
    getPM().forEach(m=>{
        const d=data.filter(r=>r.month===m); if(!d.length)return;
        let row=`<tr><td><strong>${fmtPeriod(m)}</strong></td>`;
        ['SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
            const pd=d.filter(r=>r.proc===p);
            const ti=pd.reduce((a,b)=>a+b.in,0),to=pd.reduce((a,b)=>a+b.out,0);
            row+=`<td class="${ti>0&&to/ti*100>=99.5?'yield-good':'yield-bad'}">${ti>0?(to/ti*100).toFixed(2)+'%':'-'}</td>`;
        });
        mb.innerHTML+=row+'</tr>';
    });
    const prb=document.querySelector('#tblProdYield tbody'); prb.innerHTML='';
    ['RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const d=data.filter(r=>r.prod===p);
        const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0),to=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0),tf=d.reduce((a,b)=>a+b.fail,0);
        const y=ti>0?to/ti*100:0, ok=y>=99.5;
        prb.innerHTML+=`<tr><td><strong>${p}</strong></td><td>${ti.toLocaleString()}</td><td>${to.toLocaleString()}</td><td>${tf.toLocaleString()}</td><td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td><td><span class="badge ${ok?'badge-ok':'badge-ng'}">${ok?t.good:t.warn}</span></td></tr>`;
    });
    const sb=document.querySelector('#tblShipment tbody'); sb.innerHTML='';
    getSM().forEach(m=>{
        const d=shipData.filter(r=>r.month===m); if(!d.length)return;
        const r=d.filter(x=>x.model.toUpperCase()==='RDIMM').reduce((a,b)=>a+b.qty,0);
        const s=d.filter(x=>x.model.toUpperCase()==='SODIMM').reduce((a,b)=>a+b.qty,0);
        const u=d.filter(x=>x.model.toUpperCase()==='UDIMM').reduce((a,b)=>a+b.qty,0);
        sb.innerHTML+=`<tr><td><strong>${fmtPeriod(m)}</strong></td><td>${r.toLocaleString()}</td><td>${s.toLocaleString()}</td><td>${u.toLocaleString()}</td><td style="font-weight:800;color:#4f46e5;font-family:'DM Mono',monospace">${(r+s+u).toLocaleString()}</td></tr>`;
    });
}

function drawCharts(data){
    const pm=getPM(), pl=pm.map(m=>fmtPeriod(m));
    const sm=getSM(), sl=sm.map(m=>fmtPeriod(m));
    const dm=getDM(), dl=dm.map(m=>fmtPeriod(m));
    const reasons=[...new Set(defectTypeData.map(d=>d.reason))];
    Object.values(charts).forEach(c=>c&&c.destroy()); charts={};

    const baseOpts={
        responsive:true, maintainAspectRatio:false,
        layout:{padding:{top:40}},
        plugins:{
            legend:{position:'bottom',labels:{boxWidth:10,boxHeight:10,padding:14,font:{size:12,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:10}},
            datalabels:{color:'#0c1e3e',backgroundColor:'rgba(255,255,255,0.92)',borderRadius:5,padding:{top:3,right:7,bottom:3,left:7},font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},anchor:'end',align:'end',offset:8,clip:false,display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,formatter:v=>v?v.toLocaleString():''}
        },
        scales:{
            x:{grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},color:'#94a3b8'},border:{display:false}},
            y:{grid:{color:'#f1f5f9',drawBorder:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false},grace:'20%'}
        }
    };

    try{
        const totalY=pm.map(m=>{const d=data.filter(r=>r.month===m);const i=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);const o=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0);return i>0?o/i*100:null;});
        // Fix 1: Much more padding so labels never overlap Y axis
        charts.totalYield=new Chart(document.getElementById('chartTotalYield'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiYield,data:totalY,borderColor:'#004B87',backgroundColor:'rgba(0,75,135,0.06)',fill:true,tension:0.4,pointBackgroundColor:'white',pointBorderColor:'#004B87',pointBorderWidth:2.5,pointRadius:5,borderWidth:2.5}]},options:{...baseOpts,layout:{padding:{left:10,right:50,top:38,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{color:'#004B87',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:9,bottom:4,left:9},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},anchor:'end',align:'end',offset:12,clip:false,display:true,formatter:v=>v?v.toFixed(2)+'%':''}},scales:{...baseOpts.scales,x:{...baseOpts.scales.x,offset:true},y:{...baseOpts.scales.y,min:95,max:101}}}});

        // PPM Monthly Trend Chart
        const ppmTrendData=pm.map(m=>{
            const d=data.filter(r=>r.month===m);
            const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);
            const cf=d.filter(r=>['SMD','ROUTER','AVI'].includes(r.proc)).reduce((a,b)=>a+b.fail,0);
            return ti>0?Math.round(cf/ti*1000000):null;
        });
        charts.ppmTrend=new Chart(document.getElementById('chartPpmTrend'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].titPpmTrend||'ë‹¹ì‚¬ ê·€ì±… PPM',data:ppmTrendData,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.07)',fill:true,tension:0.4,pointBackgroundColor:'white',pointBorderColor:'#f59e0b',pointBorderWidth:2.5,pointRadius:5,borderWidth:2.5}]},options:{...baseOpts,layout:{padding:{left:10,right:50,top:38,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{color:'#d97706',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:9,bottom:4,left:9},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},anchor:'end',align:'end',offset:12,clip:false,display:true,formatter:v=>v!==null?v.toLocaleString()+' PPM':''}},scales:{...baseOpts.scales,x:{...baseOpts.scales.x,offset:true},y:{...baseOpts.scales.y,beginAtZero:true,grace:'20%'}}}});

        // Fix 2: legend ON, Fix 3: datalabels only when single filter
        const prodSingle = prodChartFilter!=='ì „ì²´';
        const prodYieldLabelOpts = {
            display: prodSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false,
            color: ctx=>['#f43f5e','#0891b2','#f59e0b'][ctx.datasetIndex]||'#0c1e3e',
            backgroundColor:'rgba(255,255,255,0.95)',borderRadius:5,
            padding:{top:3,right:7,bottom:3,left:7},
            font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},
            anchor:'end',align:'end',offset:8,clip:false,
            formatter:v=>v?v.toFixed(2)+'%':''
        };
        charts.prodYield=new Chart(document.getElementById('chartProdYield'),{type:'line',data:{labels:pl,datasets:['RDIMM','SODIMM','UDIMM'].map((p,i)=>({label:p,borderColor:['#f43f5e','#0891b2','#f59e0b'][i],backgroundColor:['rgba(244,63,94,0.05)','rgba(8,145,178,0.05)','rgba(245,158,11,0.05)'][i],fill:true,tension:0.4,borderWidth:2.5,pointRadius:4,pointBorderWidth:2,pointBackgroundColor:'white',hidden:prodSingle&&p!==prodChartFilter,data:pm.map(m=>{const d=data.filter(r=>r.month===m&&r.prod===p);const ti=d.filter(r=>r.proc==='SMD').reduce((a,b)=>a+b.in,0);const to=d.filter(r=>r.proc==='AVI').reduce((a,b)=>a+b.out,0);return ti>0?to/ti*100:null;})}))},options:{...baseOpts,layout:{padding:{top:prodSingle?38:16,right:prodSingle?50:14,bottom:8,left:8}},plugins:{...baseOpts.plugins,legend:{position:'bottom',display:true,labels:{boxWidth:10,boxHeight:10,padding:12,font:{size:11,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:8}},datalabels:prodYieldLabelOpts},scales:{...baseOpts.scales,y:{...baseOpts.scales.y,min:95,max:101}}}});

        const procSingle = procChartFilter!=='ì „ì²´';
        const procColors=['#8b5cf6','#ec4899','#6366f1','#f59e0b','#10b981'];
        const procYieldLabelOpts = {
            display: procSingle ? ctx=>ctx.dataset.data[ctx.dataIndex]!==null : false,
            color: ctx=>procColors[ctx.datasetIndex]||'#0c1e3e',
            backgroundColor:'rgba(255,255,255,0.95)',borderRadius:5,
            padding:{top:3,right:7,bottom:3,left:7},
            font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},
            anchor:'end',align:'end',offset:8,clip:false,
            formatter:v=>v?v.toFixed(2)+'%':''
        };
        charts.procYield=new Chart(document.getElementById('chartProcYield'),{type:'line',data:{labels:pl,datasets:['SMD','ROUTER','ATE','PCT','AVI'].map((p,i)=>({label:p,borderColor:procColors[i],tension:0.4,borderWidth:2.5,pointRadius:4,pointBorderWidth:2,pointBackgroundColor:'white',hidden:procSingle&&p!==procChartFilter,data:pm.map(m=>{const d=data.filter(r=>r.month===m&&r.proc===p);const ti=d.reduce((a,b)=>a+b.in,0);const to=d.reduce((a,b)=>a+b.out,0);return ti>0?to/ti*100:null;})}))},options:{...baseOpts,layout:{padding:{top:procSingle?38:16,right:procSingle?50:14,bottom:8,left:8}},plugins:{...baseOpts.plugins,legend:{position:'bottom',display:true,labels:{boxWidth:10,boxHeight:10,padding:12,font:{size:11,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:8}},datalabels:procYieldLabelOpts},scales:{...baseOpts.scales,y:{...baseOpts.scales.y,min:95,max:101}}}});

        // Fix 4: prodVol by model RDIMM/SODIMM/UDIMM stacked with filter
        const pvColors=['#6366f1','#0891b2','#f59e0b'];
        const pvDS=['RDIMM','SODIMM','UDIMM'].map((p,i)=>({
            label:p,
            data:pm.map(m=>data.filter(r=>r.month===m&&r.prod===p&&r.proc==='SMD').reduce((a,b)=>a+b.in,0)),
            backgroundColor:pvColors[i], borderRadius:4, borderSkipped:false, stack:'pv',
            hidden: prodVolFilter!=='ì „ì²´'&&p!==prodVolFilter,
            datalabels:{display:true,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',
                font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},
                formatter:v=>v>0?v.toLocaleString():''}
        }));
        const pvTotals=pm.map(m=>data.filter(r=>r.month===m&&r.proc==='SMD').reduce((a,b)=>a+b.in,0));
        charts.prodVol=new Chart(document.getElementById('chartProdVol'),{
            type:'bar',
            data:{labels:pl,datasets:[...pvDS,{type:'line',label:lang==='ko'?'í•©ê³„':'Total',data:pvTotals,borderColor:'transparent',backgroundColor:'transparent',pointRadius:0,hidden:prodVolFilter!=='ì „ì²´',
                datalabels:{display:true,anchor:'end',align:'end',color:'#4f46e5',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,
                    padding:{top:4,right:8,bottom:4,left:8},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},
                    formatter:v=>v.toLocaleString(),offset:12},order:-1}]},
            options:{...baseOpts,layout:{padding:{top:50,right:20,left:10,bottom:8}},
                plugins:{...baseOpts.plugins,
                    legend:{position:'bottom',display:true,labels:{boxWidth:10,boxHeight:10,padding:12,font:{size:11,weight:'600',family:'Noto Sans KR, Inter, sans-serif'},usePointStyle:true,pointStyleWidth:8,filter:item=>item.text!==lang?'í•©ê³„':'Total'}},
                    datalabels:{display:false}},
                scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},color:'#94a3b8'},border:{display:false}},
                    y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false}}}
            }
        });

        const defData=pm.map(m=>data.filter(r=>r.month===m).reduce((a,b)=>a+b.fail,0));
        charts.totalDefect=new Chart(document.getElementById('chartTotalDefect'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiDefect,data:defData,borderColor:'#f43f5e',backgroundColor:'rgba(244,63,94,0.07)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:'#f43f5e',pointBorderWidth:2.5}]},options:{...baseOpts,layout:{padding:{top:40,right:50,left:10,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{...baseOpts.plugins.datalabels,color:'#f43f5e',offset:10,formatter:v=>v.toLocaleString()}}}});

        const compDef=pm.map(m=>data.filter(r=>r.month===m&&['SMD','ROUTER','AVI'].includes(r.proc)).reduce((a,b)=>a+b.fail,0));
        charts.compDefect=new Chart(document.getElementById('chartCompDefect'),{type:'line',data:{labels:pl,datasets:[{label:T[lang].lblKpiCompDefect,data:compDef,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.07)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:'#f59e0b',pointBorderWidth:2.5}]},options:{...baseOpts,layout:{padding:{top:40,right:50,left:10,bottom:6}},plugins:{...baseOpts.plugins,legend:{display:false},datalabels:{...baseOpts.plugins.datalabels,color:'#d97706',offset:10,formatter:v=>v.toLocaleString()}}}});

        // Fix 5: Shipment chart with filter buttons support
        const sColors=['#3b82f6','#10b981','#f59e0b'];
        const sDS=['RDIMM','SODIMM','UDIMM'].map((m,i)=>({
            label:m,
            data:sm.map(mo=>shipData.filter(r=>r.month===mo&&r.model===m).reduce((a,b)=>a+b.qty,0)),
            backgroundColor:sColors[i], borderRadius:5, stack:'s0',
            hidden:shipChartFilter!=='ì „ì²´'&&m!==shipChartFilter,
            datalabels:{display:true,color:'white',font:{weight:'700',size:11,family:'JetBrains Mono, monospace'},anchor:'center',align:'center',formatter:v=>v>0?v.toLocaleString():''}
        }));
        const sTotals=sm.map(mo=>shipData.filter(r=>r.month===mo).reduce((a,b)=>a+b.qty,0));
        charts.shipment=new Chart(document.getElementById('chartShipment'),{type:'bar',data:{labels:sl,datasets:[...sDS,{type:'line',label:'Total',data:sTotals,borderColor:'transparent',backgroundColor:'transparent',pointRadius:0,hidden:shipChartFilter!=='ì „ì²´',
            datalabels:{display:true,anchor:'end',align:'end',color:'#0c1e3e',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:4,right:8,bottom:4,left:8},font:{weight:'700',size:12,family:'JetBrains Mono, monospace'},formatter:v=>v.toLocaleString(),offset:14},order:-1}]},
            options:{...baseOpts,layout:{padding:{top:50,right:20,left:10,bottom:8}},
                plugins:{...baseOpts.plugins,legend:{...baseOpts.plugins.legend,labels:{...baseOpts.plugins.legend.labels,filter:item=>item.text!=='Total'}},datalabels:{display:false}},
                scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},color:'#94a3b8'},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false}}}}});

        const palCols=['#6366f1','#06b6d4','#f59e0b','#f43f5e','#10b981'];
        let dDS=reasons.map((r,i)=>({label:r,data:dm.map(m=>{const d=defectTypeData.find(x=>x.month===m&&x.reason===r);return d?d.qty:0;}),backgroundColor:palCols[i%5],borderRadius:4,borderSkipped:false,stack:'s0'}));
        if(filters.defectType!=='ì „ì²´')dDS=dDS.filter(ds=>ds.label===filters.defectType);
        charts.defectType=new Chart(document.getElementById('chartDefectType'),{type:'bar',data:{labels:dl,datasets:dDS},options:{...baseOpts,plugins:{...baseOpts.plugins,datalabels:{...baseOpts.plugins.datalabels,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',font:{weight:'bold',size:11,family:'JetBrains Mono, monospace'}}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11,family:'Noto Sans KR, Inter, sans-serif'},color:'#94a3b8'},border:{display:false},grace:'20%'}}}});

        // Pie chart
        const pieVals=reasons.map(r=>defectTypeData.filter(d=>d.reason===r).reduce((a,b)=>a+b.qty,0));
        charts.defectTypePie=new Chart(document.getElementById('chartDefectTypePie'),{
            type:'doughnut',
            data:{labels:reasons,datasets:[{data:pieVals,backgroundColor:palCols,borderWidth:3,borderColor:'white',hoverBorderWidth:5,hoverOffset:6}]},
            options:{
                responsive:true, maintainAspectRatio:false, cutout:'52%',
                layout:{padding:{top:20,bottom:20,left:20,right:20}},
                plugins:{
                    legend:{
                        position:'right',
                        labels:{font:{size:12,family:'Noto Sans KR, Inter, sans-serif',weight:'600'},padding:14,usePointStyle:true,pointStyleWidth:10,color:'#334155'}
                    },
                    datalabels:{
                        display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,
                        color:'white',
                        backgroundColor:'rgba(0,0,0,0.0)',
                        font:{weight:'800',size:13,family:'JetBrains Mono, monospace'},
                        textStrokeColor:'rgba(0,0,0,0.4)',
                        textStrokeWidth:3,
                        formatter:(v,ctx)=>{
                            const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                            const pct=(v*100/total).toFixed(1);
                            return v>0?pct+'%':'';
                        },
                        anchor:'center', align:'center', offset:0
                    }
                }
            }
        });
    }catch(e){console.error('ì°¨íŠ¸ ì˜¤ë¥˜:',e);}
}

function openModal(t){
    requirePassword(()=>{
        document.getElementById(t==='prod'?'modalProd':t==='ship'?'modalShip':'modalDefect').style.display='block';
        renderEntryTable(t);
        updateModalLang();
    });
}
function closeModal(t){document.getElementById(t==='prod'?'modalProd':t==='ship'?'modalShip':'modalDefect').style.display='none';}
function clearTable(t){if(!confirm(lang==='ko'?'âš ï¸ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?':'âš ï¸ Reset all data?'))return;document.querySelector(`#${t==='prod'?'tblEntryProd':t==='ship'?'tblEntryShip':'tblEntryDefect'} tbody`).innerHTML='';document.getElementById(t==='prod'?'pasteProd':t==='ship'?'pasteShip':'pasteDefect').value='';}

function updateModalLang(){
    const t=T[lang];
    // Password modal
    document.getElementById('pwTitle').innerText=lang==='ko'?'ë°ì´í„° ì…ë ¥ ë¹„ë°€ë²ˆí˜¸':'Password Required';
    document.getElementById('pwSub').innerText=lang==='ko'?'ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”':'Enter password to edit data';
    document.getElementById('pwOkBtn').innerText=lang==='ko'?'í™•ì¸':'Confirm';
    document.getElementById('pwCancelBtn').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Prod modal
    document.getElementById('moTitProd').innerText=t.moTitProd;
    document.querySelector('#modalProd .modal-desc').innerHTML=lang==='ko'?'Excelì—ì„œ <strong>[ì œí’ˆ | ê¸°ê°„ | ê³µì • | íˆ¬ì… | ì‚°ì¶œ | ë¶ˆëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.':'Paste from Excel in order: <strong>[Product | Period | Process | Input | Output | Defect]</strong>';
    document.getElementById('pasteProd').placeholder=lang==='ko'?'Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)':'Paste Excel data here (Ctrl+V)';
    document.querySelector('#modalProd .btn-parse').innerText=lang==='ko'?'ğŸ“‹ ë°ì´í„° ì ìš©':'ğŸ“‹ Apply Data';
    document.querySelector('#modalProd .btn-clr').innerText=lang==='ko'?'ğŸ—‘ï¸ ì´ˆê¸°í™”':'ğŸ—‘ï¸ Reset';
    document.querySelector('#tblEntryProd thead tr').innerHTML=`<th>${lang==='ko'?'ì œí’ˆ':'Product'}</th><th>${lang==='ko'?'ê¸°ê°„':'Period'}</th><th>${lang==='ko'?'ê³µì •':'Process'}</th><th>${lang==='ko'?'íˆ¬ì…':'Input'}</th><th>${lang==='ko'?'ì‚°ì¶œ':'Output'}</th><th>${lang==='ko'?'ë¶ˆëŸ‰':'Defect'}</th><th>${lang==='ko'?'ì‚­ì œ':'Del'}</th>`;
    document.querySelector('#modalProd .btn-addrow').innerText=lang==='ko'?'+ í–‰ ì¶”ê°€':'+ Add Row';
    document.querySelector('#modalProd .btn-save').innerText=lang==='ko'?'ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)':'ğŸ’¾ Save (Sync Now)';
    document.querySelector('#modalProd .btn-cancel').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Ship modal
    document.getElementById('moTitShip').innerText=t.moTitShip;
    document.querySelector('#modalShip .modal-desc').innerHTML=lang==='ko'?'Excelì—ì„œ <strong>[ëª¨ë¸ | ëª¨ë¸ëª… | ë‚ ì§œ | ìˆ˜ëŸ‰ | ì‚¬ìœ ]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.':'Paste from Excel: <strong>[Model | Name | Date | Qty | Reason]</strong>';
    document.getElementById('pasteShip').placeholder=lang==='ko'?'Excel ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)':'Paste Excel data here (Ctrl+V)';
    document.querySelector('#modalShip .btn-parse').innerText=lang==='ko'?'ğŸ“‹ ë°ì´í„° ì ìš©':'ğŸ“‹ Apply Data';
    document.querySelector('#modalShip .btn-clr').innerText=lang==='ko'?'ğŸ—‘ï¸ ì´ˆê¸°í™”':'ğŸ—‘ï¸ Reset';
    document.querySelector('#tblEntryShip thead tr').innerHTML=`<th>${lang==='ko'?'ëª¨ë¸':'Model'}</th><th>${lang==='ko'?'ëª¨ë¸ëª…':'Name'}</th><th>${lang==='ko'?'ë‚ ì§œ':'Date'}</th><th>${lang==='ko'?'ìˆ˜ëŸ‰':'Qty'}</th><th>${lang==='ko'?'ì‚¬ìœ ':'Reason'}</th><th>${lang==='ko'?'ê¸°ê°„(ìë™)':'Period(auto)'}</th><th>${lang==='ko'?'ì‚­ì œ':'Del'}</th>`;
    document.querySelector('#modalShip .btn-addrow').innerText=lang==='ko'?'+ í–‰ ì¶”ê°€':'+ Add Row';
    document.querySelector('#modalShip .btn-save').innerText=lang==='ko'?'ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)':'ğŸ’¾ Save (Sync Now)';
    document.querySelector('#modalShip .btn-cancel').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Defect modal
    document.getElementById('moTitDefect').innerText=t.moTitDefect;
    document.querySelector('#modalDefect .modal-desc').innerHTML=lang==='ko'?'Excelì—ì„œ <strong>[ë¶ˆëŸ‰ëª… | ê¸°ê°„(YY.MM) | ìˆ˜ëŸ‰]</strong> ìˆœì„œë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.':'Paste from Excel: <strong>[Defect Name | Period(YY.MM) | Qty]</strong>';
    document.getElementById('pasteDefect').placeholder=lang==='ko'?'ì˜ˆì‹œ: Human Error\t26.02\t5':'Example: Human Error\t26.02\t5';
    document.querySelector('#modalDefect .btn-parse').innerText=lang==='ko'?'ğŸ“‹ ë°ì´í„° ì ìš©':'ğŸ“‹ Apply Data';
    document.querySelector('#modalDefect .btn-clr').innerText=lang==='ko'?'ğŸ—‘ï¸ ì´ˆê¸°í™”':'ğŸ—‘ï¸ Reset';
    document.querySelector('#tblEntryDefect thead tr').innerHTML=`<th>${lang==='ko'?'ë¶ˆëŸ‰ëª…':'Defect Name'}</th><th>${lang==='ko'?'ê¸°ê°„ (YY.MM)':'Period (YY.MM)'}</th><th>${lang==='ko'?'ìˆ˜ëŸ‰':'Qty'}</th><th>${lang==='ko'?'ì‚­ì œ':'Del'}</th>`;
    document.querySelector('#modalDefect .btn-addrow').innerText=lang==='ko'?'+ í–‰ ì¶”ê°€':'+ Add Row';
    document.querySelector('#modalDefect .btn-save').innerText=lang==='ko'?'ğŸ’¾ ì €ì¥ (ì¦‰ì‹œ ë°˜ì˜)':'ğŸ’¾ Save (Sync Now)';
    document.querySelector('#modalDefect .btn-cancel').innerText=lang==='ko'?'ì·¨ì†Œ':'Cancel';
    // Backup modal
    document.getElementById('backupTitle').innerText=lang==='ko'?'ğŸ’¾ ë°ì´í„° ë°±ì—… ê´€ë¦¬':'ğŸ’¾ Backup Manager';
    document.getElementById('backupSubTitle').innerText=lang==='ko'?'ìµœëŒ€ 10ê°œ ë°±ì—… ì €ì¥ Â· ì˜ëª» ì…ë ¥ ì‹œ ë³µì› ê°€ëŠ¥':'Up to 10 backups Â· Restore anytime';
    document.getElementById('backupNowBtn').innerText=lang==='ko'?'ğŸ“¸ ì§€ê¸ˆ ë°±ì—… ìƒì„±':'ğŸ“¸ Create Backup Now';
}

function renderEntryTable(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`); tbody.innerHTML='';
    const src=type==='prod'?prodData:type==='ship'?shipData:defectTypeData;
    src.forEach(d=>{
        const tr=document.createElement('tr');
        if(type==='prod'){tr.innerHTML=`<td><select><option value="">ì„ íƒ</option><option value="RDIMM"${d.prod==='RDIMM'?' selected':''}>RDIMM</option><option value="SODIMM"${d.prod==='SODIMM'?' selected':''}>SODIMM</option><option value="UDIMM"${d.prod==='UDIMM'?' selected':''}>UDIMM</option></select></td><td><input list="list-months" value="${d.month}"></td><td><select><option value="">ì„ íƒ</option><option value="SMD"${d.proc==='SMD'?' selected':''}>SMD</option><option value="ROUTER"${d.proc==='ROUTER'?' selected':''}>ROUTER</option><option value="ATE"${d.proc==='ATE'?' selected':''}>ATE</option><option value="PCT"${d.proc==='PCT'?' selected':''}>PCT</option><option value="AVI"${d.proc==='AVI'?' selected':''}>AVI</option></select></td><td><input type="number" value="${d.in}"></td><td><input type="number" value="${d.out}"></td><td><input type="number" value="${d.fail}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
        else if(type==='ship'){tr.innerHTML=`<td><input list="list-products" value="${d.model}"></td><td><input list="list-model-names" value="${d.name}"></td><td><input type="date" value="${d.date}"></td><td><input type="number" value="${d.qty}"></td><td><input list="list-ship-reasons" value="${d.reason}"></td><td><input list="list-months" value="${d.month}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
        else{tr.innerHTML=`<td><input list="list-defect-reasons" value="${d.reason||''}"></td><td><input list="list-months" value="${d.month||''}"></td><td><input type="number" value="${d.qty||0}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
        tbody.appendChild(tr);
    });
}

function addRow(type){
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`);
    const tr=document.createElement('tr');
    if(type==='prod'){tr.innerHTML=`<td><select><option value="">ì„ íƒ</option><option value="RDIMM">RDIMM</option><option value="SODIMM">SODIMM</option><option value="UDIMM">UDIMM</option></select></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><select><option value="">ì„ íƒ</option><option value="SMD">SMD</option><option value="ROUTER">ROUTER</option><option value="ATE">ATE</option><option value="PCT">PCT</option><option value="AVI">AVI</option></select></td><td><input type="number" placeholder="1000"></td><td><input type="number" placeholder="995"></td><td><input type="number" value="0"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
    else if(type==='ship'){tr.innerHTML=`<td><input list="list-products" placeholder="RDIMM"></td><td><input list="list-model-names" placeholder="ëª¨ë¸ëª…"></td><td><input type="date"></td><td><input type="number" placeholder="1000"></td><td><input list="list-ship-reasons" placeholder="Mass Production"></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
    else{tr.innerHTML=`<td><input list="list-defect-reasons" placeholder="Human Error"></td><td><input list="list-months" placeholder="26.02" value="26.02"></td><td><input type="number" value="0"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;}
    tbody.appendChild(tr); tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function parsePaste(type){
    const pid=type==='prod'?'pasteProd':type==='ship'?'pasteShip':'pasteDefect';
    const txt=document.getElementById(pid).value.trim();
    if(!txt){alert('ë¶™ì—¬ë„£ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
    const tid=type==='prod'?'tblEntryProd':type==='ship'?'tblEntryShip':'tblEntryDefect';
    const tbody=document.querySelector(`#${tid} tbody`); let cnt=0;
    txt.split('\n').forEach(row=>{
        const c=row.split(/\t/); const tr=document.createElement('tr');
        if(type==='prod'&&c.length>=6){const mv=extractYM(c[1].trim());tr.innerHTML=`<td><select><option value="">ì„ íƒ</option><option value="RDIMM"${c[0].trim()==='RDIMM'?' selected':''}>RDIMM</option><option value="SODIMM"${c[0].trim()==='SODIMM'?' selected':''}>SODIMM</option><option value="UDIMM"${c[0].trim()==='UDIMM'?' selected':''}>UDIMM</option></select></td><td><input list="list-months" value="${mv}"></td><td><select><option value="">ì„ íƒ</option><option value="SMD"${c[2].trim()==='SMD'?' selected':''}>SMD</option><option value="ROUTER"${c[2].trim()==='ROUTER'?' selected':''}>ROUTER</option><option value="ATE"${c[2].trim()==='ATE'?' selected':''}>ATE</option><option value="PCT"${c[2].trim()==='PCT'?' selected':''}>PCT</option><option value="AVI"${c[2].trim()==='AVI'?' selected':''}>AVI</option></select></td><td><input type="number" value="${cleanNum(c[3])}"></td><td><input type="number" value="${cleanNum(c[4])}"></td><td><input type="number" value="${cleanNum(c[5])}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;tbody.appendChild(tr);cnt++;}
        else if(type==='ship'&&c.length>=5){const mv=c.length>=6&&c[5].trim()?extractYM(c[5].trim()):extractYM(c[2].trim());tr.innerHTML=`<td><input list="list-products" value="${c[0].trim()}"></td><td><input list="list-model-names" value="${c[1].trim()}"></td><td><input type="date" value="${c[2].trim()}"></td><td><input type="number" value="${cleanNum(c[3])}"></td><td><input list="list-ship-reasons" value="${c[4].trim()}"></td><td><input list="list-months" value="${mv}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;tbody.appendChild(tr);cnt++;}
        else if(type==='defect'&&c.length>=3){const mv=extractYM(c[1].trim());tr.innerHTML=`<td><input list="list-defect-reasons" value="${c[0].trim()}"></td><td><input list="list-months" value="${mv}"></td><td><input type="number" value="${cleanNum(c[2])}"></td><td><button class="btn-del" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>`;tbody.appendChild(tr);cnt++;}
    });
    if(cnt>0){alert(`âœ… ${cnt}ê°œ ë°ì´í„° ì¶”ê°€ë¨. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);document.getElementById(pid).value='';}
    else alert('âš ï¸ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
}

function exportExcel(){
    try{
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(prodData.map(d=>({'ì œí’ˆ':d.prod,'ê¸°ê°„':fmtPeriod(d.month),'ê³µì •':d.proc,'íˆ¬ì…':d.in,'ì‚°ì¶œ':d.out,'ë¶ˆëŸ‰':d.fail}))),"ìƒì‚°ë°ì´í„°");
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(shipData.map(d=>({'ëª¨ë¸':d.model,'ëª¨ë¸ëª…':d.name,'ì¶œí•˜ì¼':d.date,'ìˆ˜ëŸ‰':d.qty,'ì‚¬ìœ ':d.reason,'ê¸°ê°„':fmtPeriod(d.month)}))),"ì¶œí•˜ë°ì´í„°");
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(defectTypeData.map(d=>({'ë¶ˆëŸ‰ëª…':d.reason,'ê¸°ê°„':fmtPeriod(d.month),'ìˆ˜ëŸ‰':d.qty}))),lang==='ko'?"ë¶ˆëŸ‰ìœ í˜•ë°ì´í„°":"Defect_Types");
        if(dailyProdData&&dailyProdData.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dailyProdData.map(d=>({[lang==='ko'?'ë‚ ì§œ':'Date']:d.date,[lang==='ko'?'ëª¨ë¸':'Model']:d.model,[lang==='ko'?'ê³µì •':'Process']:d.proc,[lang==='ko'?'íŒ€':'Team']:d.team,[lang==='ko'?'íˆ¬ì…ìˆ˜ëŸ‰':'Input Qty']:d.inspQty,[lang==='ko'?'ì–‘í’ˆìˆ˜ëŸ‰':'Good Qty']:d.goodQty,[lang==='ko'?'ë¶ˆëŸ‰ìˆ˜ëŸ‰':'Defect Qty']:d.defectQty}))),lang==='ko'?"ì¼ë³„ìƒì‚°":"Daily_Prod");
        if(dailyDefectData&&dailyDefectData.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dailyDefectData.map(d=>({[lang==='ko'?'ë‚ ì§œ':'Date']:d.date,[lang==='ko'?'ëª¨ë¸':'Model']:d.model,[lang==='ko'?'ê³µì •':'Process']:d.proc,[lang==='ko'?'íŒ€':'Team']:d.team,[lang==='ko'?'ë¶ˆëŸ‰ì½”ë“œ':'Code']:d.defectCode,[lang==='ko'?'ë¶ˆëŸ‰ëª…':'Name']:d.defectName,[lang==='ko'?'ìˆ˜ëŸ‰':'Qty']:d.qty}))),lang==='ko'?"ì¼ë³„ë¶ˆëŸ‰ì½”ë“œ":"Daily_Defects");
        XLSX.writeFile(wb,`DS_Quality_Performance_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.xlsx`);
        alert('âœ… Excel íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }catch(e){alert('Excel ì˜¤ë¥˜: '+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LOGIN_PASSWORD = "ds2025"; // â† ëŒ€ì‹œë³´ë“œ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ (ë°ì´í„° ì…ë ¥ê³¼ ë¶„ë¦¬)
let loggedIn = false;

function doLogin(){
    const v=document.getElementById('loginInput').value;
    if(v===LOGIN_PASSWORD){
        loggedIn=true;
        document.getElementById('loginModal').style.display='none';
        document.getElementById('loadingOverlay').style.display='flex';
        initFirebase();
    } else {
        const e=document.getElementById('loginErr');
        e.innerText='âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤';
        document.getElementById('loginInput').value='';
        document.getElementById('loginInput').focus();
        setTimeout(()=>e.innerText='',2000);
    }
}
// ë¡œê·¸ì¸ ì´ˆê¸°í™”ëŠ” ìŠ¤í¬ë¦½íŠ¸ ìµœìƒë‹¨ IIFEì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨ (ìœ„ ì°¸ê³ )

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEFECT CODE LISTS (SMT = 1000s, TEST = 4000s)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SMD_DEFECTS=[
    {code:'1000',name:'PCB;TAB BREAKAGE'},{code:'1001',name:'PCB;TAB EXPOSE'},{code:'1002',name:'PCB;TAB BUBBLE'},
    {code:'1003',name:'PCB;TAB BURR'},{code:'1004',name:'PCB;TAB LIFTING'},{code:'1005',name:'PCB;TAB DISCOLOR'},
    {code:'1006',name:'PCB;TAB SOLDER RESIDUE'},{code:'1008',name:'PCB;TAB FOREIGN MATERIALS'},{code:'1009',name:'PCB TAB DAMAGED'},
    {code:'1012',name:'PCB;TAB BURNT'},{code:'1013',name:'PCB;TAB DENT'},{code:'1014',name:'PCB;TAB SCRATCH'},
    {code:'1015',name:'PCB;TAB SHORT'},{code:'1016',name:'PCB;TAB VOID'},{code:'1018',name:'PCB;TAB SHAPE DEFECT'},
    {code:'1021',name:'PCB;TAB FINE DEFECT'},{code:'1100',name:'PCB;PCB FOLD'},{code:'1101',name:'PCB;PCB BURR'},
    {code:'1102',name:'PCB PCB LIFTING'},{code:'1103',name:'PCB PCB DELAMINATION'},{code:'1104',name:'PCB PCB DISCOLOR'},
    {code:'1105',name:'PCB PCB CONTAMINATION'},{code:'1106',name:'PCB PCB BREAKAGE'},{code:'1107',name:'PCB PCB FOREIGN MATERIALS'},
    {code:'1108',name:'PCB PCB BURNING'},{code:'1109',name:'PCB PCB CIRCUIT DEFECT'},{code:'1112',name:'PCB;PCB BOW'},
    {code:'1113',name:'PCB;PCB BUBBLE'},{code:'1115',name:'PCB PCB CU EXPOSE'},{code:'1116',name:'PCB PCB DIMENSION DEFECT'},
    {code:'1117',name:'PCB PCB MARKING DEFECT'},{code:'1118',name:'PCB PCB MIX'},{code:'1119',name:'PCB PCB PAD DEFECT'}
];
const TEST_DEFECTS=[
    {code:'4001',name:'COM;SPD_WP'},{code:'4041',name:'COM;SPD_WRITE_FUNC'},{code:'4044',name:'COM;SPD_READ_SERIAL_FUNC'},
    {code:'4045',name:'COM;SPD_WP (2)'},{code:'4046',name:'COM;EEPROM_TEMP_GRADE'},{code:'4048',name:'COM;SPD_BIN_READ_FUNC'},
    {code:'4050',name:'COM;BIN 50'},{code:'4051',name:'COM;BIN 51'},{code:'4052',name:'COM;BIN 52'},
    {code:'4053',name:'COM;BIN 53'},{code:'4054',name:'COM;BIN 54'},{code:'4057',name:'COM;BIN 57'},
    {code:'4061',name:'COM;VREFDQ-Vss_SHORT_SCREEN'},{code:'4070',name:'COM;INPUT_LEAKAGE'},{code:'4071',name:'COM;OUTPUT_LEAKAGE'},
    {code:'4080',name:'COM;INPUT_OPEN'},{code:'4081',name:'COM;OUTPUT_OPEN'},{code:'4095',name:'COM;FUSE FAIL'}
];
let CUSTOM_DEFECTS=[];

function getDefectsForProc(proc){
    const c=CUSTOM_DEFECTS;
    if(['SMD','ROUTER'].includes(proc)) return [...SMD_DEFECTS,...c.filter(d=>d.team==='SMT')];
    if(['ATE','PCT','AVI'].includes(proc)) return [...TEST_DEFECTS,...c.filter(d=>d.team==='TEST')];
    return [...SMD_DEFECTS,...TEST_DEFECTS,...c];
}
function getTeam(proc){
    if(['SMD','ROUTER'].includes(proc)) return 'SMT';
    if(['ATE','PCT','AVI'].includes(proc)) return 'TEST';
    return 'â€”';
}
function getTeamBadge(proc){
    const t=getTeam(proc);
    if(t==='SMT') return '<span class="team-badge team-smt">SMT</span>';
    if(t==='TEST') return '<span class="team-badge team-test">TEST</span>';
    return '<span style="color:var(--text-muted)">â€”</span>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dailyProdData=[], dailyDefectData=[];
let dFilters={product:'ì „ì²´',team:'ì „ì²´',process:'ì „ì²´',dateFrom:'',dateTo:''};
let dYieldFilter='ì „ì²´', dVolFilter='ì „ì²´', dDefectTeamFilter='ì „ì²´';
let dProcVolFilter='ì „ì²´', dModelVolFilter='ì „ì²´';
let dCharts={}, currentView='monthly';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setView(v){
    currentView=v;
    document.getElementById('viewMonthly').style.display=v==='monthly'?'block':'none';
    document.getElementById('viewDaily').style.display=v==='daily'?'block':'none';
    document.getElementById('monthlyBtns').style.display=v==='monthly'?'inline-flex':'none';
    document.getElementById('dailyBtns').style.display=v==='daily'?'inline-flex':'none';
    document.getElementById('btnViewMonthly').className='lang-btn'+(v==='monthly'?' active':'');
    document.getElementById('btnViewDaily').className='lang-btn'+(v==='daily'?' active':'');
    if(v==='daily'){initDailyFilters();updateDailyUI();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY DATE FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDailyFilters(){
    const now=new Date(),y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0');
    const last=new Date(y,now.getMonth()+1,0);
    if(!dFilters.dateFrom){
        dFilters.dateFrom=`${y}-${m}-01`;
        document.getElementById('dFilterFrom').value=dFilters.dateFrom;
    }
    if(!dFilters.dateTo){
        dFilters.dateTo=`${y}-${m}-${String(last.getDate()).padStart(2,'0')}`;
        document.getElementById('dFilterTo').value=dFilters.dateTo;
    }
}

function setDailyDatePreset(type){
    const now=new Date(),y=now.getFullYear(),m=now.getMonth();
    const p=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    let from,to;
    if(type==='today'){from=to=now;}
    else if(type==='yesterday'){const y2=new Date(now);y2.setDate(now.getDate()-1);from=to=y2;}
    else if(type==='week'){
        const day=now.getDay(),diff=now.getDate()-day+(day===0?-6:1);
        from=new Date(y,m,diff);to=new Date(y,m,diff+6);
    }
    else if(type==='month'){from=new Date(y,m,1);to=new Date(y,m+1,0);}
    else if(type==='all'){from=new Date('2000-01-01');to=new Date('2099-12-31');}
    else if(type==='weeknum'){
        const wn=parseInt(document.getElementById('weekNumInput').value);
        if(!wn||wn<1||wn>53){alert(lang==='ko'?'ì˜¬ë°”ë¥¸ ì£¼ì°¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1~53)':'Enter valid week number (1~53)');return;}
        const yr=now.getFullYear();
        const jan4=new Date(yr,0,4);
        const firstMon=new Date(jan4);
        firstMon.setDate(jan4.getDate()-(jan4.getDay()||7)+1);
        from=new Date(firstMon);from.setDate(firstMon.getDate()+(wn-1)*7);
        to=new Date(from);to.setDate(from.getDate()+6);
    }
    dFilters.dateFrom=p(from);dFilters.dateTo=p(to);
    document.getElementById('dFilterFrom').value=dFilters.dateFrom;
    document.getElementById('dFilterTo').value=dFilters.dateTo;
    updateDailyUI();
}

function applyDailyFilters(){
    dFilters.dateFrom=document.getElementById('dFilterFrom').value;
    dFilters.dateTo=document.getElementById('dFilterTo').value;
    updateDailyUI();
}
function dFilter(t,v){dFilters[t]=v;updateDailyUI();}

function renderDailyFilterBtns(){
    const all=lang==='ko'?'ì „ì²´':'All';
    const pp=document.getElementById('dFilterProduct');if(!pp)return;
    pp.innerHTML='';
    ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{
        const b=document.createElement('button');
        b.className='filter-btn'+(dFilters.product===p?' active':'');
        b.innerText=p==='ì „ì²´'?all:p;
        b.onclick=()=>dFilter('product',p);
        pp.appendChild(b);
    });
    const tp=document.getElementById('dFilterTeam');tp.innerHTML='';
    [['ì „ì²´',all],['SMT','SMT'],['TEST','TEST']].forEach(([v,label])=>{
        const b=document.createElement('button');
        b.className='filter-btn'+(dFilters.team===v?(v==='SMT'?' active-smt':v==='TEST'?' active-test':' active'):'');
        b.innerText=label;b.onclick=()=>dFilter('team',v);tp.appendChild(b);
    });
    const pr=document.getElementById('dFilterProcess');pr.innerHTML='';
    ['ì „ì²´','SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
        const b=document.createElement('button');
        b.className='filter-btn'+(dFilters.process===p?' active':'');
        b.innerText=p==='ì „ì²´'?all:p;b.onclick=()=>dFilter('process',p);pr.appendChild(b);
    });
    // Chart mini-filters
    const dyf=document.getElementById('dYieldFilter');if(dyf){dyf.innerHTML='';
        const yGroups=[
            {items:['ì „ì²´'],color:''},
            {items:['SMT','TEST'],color:'#6366f1',label:'Team'},
            {items:['RDIMM','SODIMM','UDIMM'],color:'#f43f5e',label:'Model'},
            {items:['SMD','ROUTER'],color:'#8b5cf6',label:'SMT-Proc'},
            {items:['ATE','PCT','AVI'],color:'#0891b2',label:'TEST-Proc'}
        ];
        const yGroupColors={'SMT':'#6366f1','TEST':'#6366f1','RDIMM':'#f43f5e','SODIMM':'#0891b2','UDIMM':'#f59e0b','SMD':'#8b5cf6','ROUTER':'#ec4899','ATE':'#6366f1','PCT':'#f59e0b','AVI':'#10b981'};
        yGroups.forEach(g=>{
            if(g.label){const sep=document.createElement('span');sep.style.cssText='display:inline-flex;align-items:center;margin:0 4px 0 6px;font-size:9px;font-weight:700;color:'+g.color+';letter-spacing:.5px;';sep.innerText=g.label.toUpperCase();dyf.appendChild(sep);}
            g.items.forEach(p=>{
                const b=document.createElement('button');
                const isActive=dYieldFilter===p;
                const gc=yGroupColors[p]||'';
                b.style.cssText=gc&&!isActive?`border-color:${gc}40;color:${gc};`:'';
                b.className='mini-btn'+(isActive?' active':'');
                if(isActive&&gc) b.style.cssText=`background:${gc};border-color:${gc};color:white;`;
                b.innerText=p==='ì „ì²´'?all:p;
                b.onclick=()=>{dYieldFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};
                dyf.appendChild(b);
            });
        });
    }
    // PPM í•„í„° (ìˆ˜ìœ¨ í•„í„°ì™€ ë™ì¼í•œ ê°’ ê³µìœ )
    const dpf=document.getElementById('dPpmFilter');if(dpf){dpf.innerHTML='';
        const ppmGroups=[
            {items:['ì „ì²´'],color:''},
            {items:['SMT','TEST'],color:'#6366f1',label:'Team'},
            {items:['RDIMM','SODIMM','UDIMM'],color:'#f43f5e',label:'Model'},
            {items:['SMD','ROUTER'],color:'#8b5cf6',label:'SMT-Proc'},
            {items:['ATE','PCT','AVI'],color:'#0891b2',label:'TEST-Proc'}
        ];
        const ppmGC={'SMT':'#6366f1','TEST':'#6366f1','RDIMM':'#f43f5e','SODIMM':'#0891b2','UDIMM':'#f59e0b','SMD':'#8b5cf6','ROUTER':'#ec4899','ATE':'#6366f1','PCT':'#f59e0b','AVI':'#10b981'};
        ppmGroups.forEach(g=>{
            if(g.label){const sep=document.createElement('span');sep.style.cssText='display:inline-flex;align-items:center;margin:0 4px 0 6px;font-size:9px;font-weight:700;color:'+g.color+';letter-spacing:.5px;';sep.innerText=g.label.toUpperCase();dpf.appendChild(sep);}
            g.items.forEach(p=>{
                const b=document.createElement('button');
                const isActive=dYieldFilter===p;
                const gc=ppmGC[p]||'';
                b.style.cssText=gc&&!isActive?`border-color:${gc}40;color:${gc};`:'';
                b.className='mini-btn'+(isActive?' active':'');
                if(isActive&&gc) b.style.cssText=`background:${gc};border-color:${gc};color:white;`;
                b.innerText=p==='ì „ì²´'?all:p;
                b.onclick=()=>{dYieldFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};
                dpf.appendChild(b);
            });
        });
    }
    const dvf=document.getElementById('dVolFilter');if(dvf){dvf.innerHTML='';
        ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(p=>{
            const b=document.createElement('button');b.className='mini-btn'+(dVolFilter===p?' active':'');
            b.innerText=p==='ì „ì²´'?all:p;b.onclick=()=>{dVolFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};dvf.appendChild(b);});}
    const ddf=document.getElementById('dDefectTeamFilter');if(ddf){ddf.innerHTML='';
        ['ì „ì²´','SMT','TEST'].forEach(t=>{
            const b=document.createElement('button');b.className='mini-btn'+(dDefectTeamFilter===t?' active':'');
            b.innerText=t==='ì „ì²´'?all:t;b.onclick=()=>{dDefectTeamFilter=t;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};ddf.appendChild(b);});}
    // ê³µì •ë³„ íˆ¬ì…ìˆ˜ëŸ‰ í•„í„°
    const dpvf=document.getElementById('dProcVolFilter');if(dpvf){dpvf.innerHTML='';
        ['ì „ì²´','SMD','ROUTER','ATE','PCT','AVI'].forEach(p=>{
            const b=document.createElement('button');b.className='mini-btn'+(dProcVolFilter===p?' active':'');
            b.innerText=p==='ì „ì²´'?all:p;b.onclick=()=>{dProcVolFilter=p;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};dpvf.appendChild(b);});}
    // ëª¨ë¸ë³„ íˆ¬ì…ìˆ˜ëŸ‰ í•„í„°
    const dmvf=document.getElementById('dModelVolFilter');if(dmvf){dmvf.innerHTML='';
        ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(m=>{
            const b=document.createElement('button');b.className='mini-btn'+(dModelVolFilter===m?' active':'');
            b.innerText=m==='ì „ì²´'?all:m;b.onclick=()=>{dModelVolFilter=m;renderDailyFilterBtns();drawDailyCharts(getDailyFiltered());};dmvf.appendChild(b);});}
}

function getDailyFiltered(){
    return dailyProdData.filter(d=>{
        if(!d.inspQty||d.inspQty<=0) return false; // 0ê±´ ì œì™¸
        if(dFilters.dateFrom&&d.date<dFilters.dateFrom)return false;
        if(dFilters.dateTo&&d.date>dFilters.dateTo)return false;
        if(dFilters.product!=='ì „ì²´'&&d.model!==dFilters.product)return false;
        if(dFilters.team!=='ì „ì²´'&&getTeam(d.proc)!==dFilters.team)return false;
        if(dFilters.process!=='ì „ì²´'&&d.proc!==dFilters.process)return false;
        return true;
    });
}
function getDailyDefFiltered(){
    return dailyDefectData.filter(d=>{
        if(dFilters.dateFrom&&d.date<dFilters.dateFrom)return false;
        if(dFilters.dateTo&&d.date>dFilters.dateTo)return false;
        if(dFilters.product!=='ì „ì²´'&&d.model!==dFilters.product)return false;
        if(dFilters.team!=='ì „ì²´'&&d.team!==dFilters.team)return false;
        if(dFilters.process!=='ì „ì²´'&&d.proc!==dFilters.process)return false;
        return true;
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY UI UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDailyUI(){
    renderDailyFilterBtns();
    const data=getDailyFiltered(), defData=getDailyDefFiltered();
    const smtData=data.filter(d=>['SMD','ROUTER'].includes(d.proc));
    const testData=data.filter(d=>['ATE','PCT','AVI'].includes(d.proc));
    // íˆ¬ì…ìˆ˜ëŸ‰: SMD ê¸°ì¤€ (ì²« ê³µì •)ìœ¼ë¡œë§Œ ì§‘ê³„
    const smdData=data.filter(d=>d.proc==='SMD');
    const totalIn=smdData.length>0 ? smdData.reduce((a,b)=>a+b.inspQty,0)
                  : data.filter(d=>d.proc==='ROUTER').reduce((a,b)=>a+b.inspQty,0)||data.reduce((a,b)=>a+b.inspQty,0);
    // â”€â”€ ë¶ˆëŸ‰: ê° ê³µì • defectQty í•©ì‚° â”€â”€
    const totalDef = data.reduce((a,b)=>a+(b.defectQty||0), 0);

    // â”€â”€ SMT íŒ€ì¹´ë“œ: SMD ê¸°ì¤€ íˆ¬ì… / SMT ì „ì²´ ë¶ˆëŸ‰ í•©ì‚° â”€â”€
    const smtSmdRows = data.filter(d=>d.proc==='SMD');
    const smtIn = smtSmdRows.reduce((a,b)=>a+b.inspQty,0);
    const smtDef = smtData.reduce((a,b)=>a+(b.defectQty||0), 0);
    // SMT ìˆ˜ìœ¨: SMD íˆ¬ì… ê¸°ì¤€ (SMT ì „ì²´ ë¶ˆëŸ‰ í¬í•¨)
    const smtYield = smtIn>0 ? Math.max(0,(smtIn-smtDef))/smtIn*100 : 0;

    // â”€â”€ TEST íŒ€ì¹´ë“œ: ATE ê¸°ì¤€ íˆ¬ì… / TEST ì „ì²´ ë¶ˆëŸ‰ í•©ì‚° â”€â”€
    const testAteRows = data.filter(d=>d.proc==='ATE');
    const testIn = testAteRows.reduce((a,b)=>a+b.inspQty,0);
    const testDef = testData.reduce((a,b)=>a+(b.defectQty||0), 0);
    // TEST ìˆ˜ìœ¨: ATE íˆ¬ì… ê¸°ì¤€ (TEST ì „ì²´ ë¶ˆëŸ‰ í¬í•¨)
    const testYield = testIn>0 ? Math.max(0,(testIn-testDef))/testIn*100 : 0;

    // â”€â”€ ì¢…í•© ìˆ˜ìœ¨/PPM: SMD ê¸°ì¤€ íˆ¬ì… â”€â”€
    const overallYield = totalIn>0 ? Math.max(0,(totalIn-totalDef))/totalIn*100 : 0;
    // â”€â”€ PPM: ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ë§Œ (SMD/ROUTER/AVI) â”€â”€
    const companyDefProcs = ['SMD','ROUTER','AVI'];
    let ppmDef, ppmIn;
    if(dFilters.process!=='ì „ì²´'){
        // íŠ¹ì • ê³µì • í•„í„° ì‹œ: í•´ë‹¹ ê³µì •ì˜ ë¶ˆëŸ‰/íˆ¬ì…ìœ¼ë¡œ PPM ê³„ì‚°
        const procData = data.filter(d=>d.proc===dFilters.process);
        ppmDef = procData.reduce((a,b)=>a+(b.defectQty||0), 0);
        ppmIn = procData.reduce((a,b)=>a+b.inspQty, 0);
    } else {
        // ì „ì²´: ë‹¹ì‚¬ ê·€ì±… ë¶ˆëŸ‰ë§Œ
        ppmDef = data.filter(d=>companyDefProcs.includes(d.proc)).reduce((a,b)=>a+(b.defectQty||0), 0);
        ppmIn = totalIn;
    }
    const ppm = ppmIn>0 ? ppmDef/ppmIn*1000000 : 0;

    // KPI ì¹´ë“œ
    document.getElementById('dKpiYield').innerText=overallYield.toFixed(2)+'%';
    document.getElementById('dKpiInput').innerText=totalIn.toLocaleString();
    document.getElementById('dKpiDefect').innerText=totalDef.toLocaleString();
    const dailyTotalDefPpm=totalIn>0?totalDef/totalIn*1000000:0;
    document.getElementById('dKpiDefectPPM').innerText=Math.round(dailyTotalDefPpm).toLocaleString()+' PPM';
    const companyDefQty=data.filter(d=>companyDefProcs.includes(d.proc)).reduce((a,b)=>a+(b.defectQty||0),0);
    document.getElementById('dKpiCompDefect').innerText=companyDefQty.toLocaleString();
    document.getElementById('dKpiPpm').innerText=Math.round(ppm).toLocaleString()+' PPM';
    // íŒ€ ì¹´ë“œ
    document.getElementById('smtYield').innerText=smtIn>0?smtYield.toFixed(2)+'%':'â€”';
    document.getElementById('smtInput').innerText=smtIn.toLocaleString();
    document.getElementById('smtDefect').innerText=smtDef.toLocaleString();
    document.getElementById('testYield').innerText=testIn>0?testYield.toFixed(2)+'%':'â€”';
    document.getElementById('testInput').innerText=testIn.toLocaleString();
    document.getElementById('testDefect').innerText=testDef.toLocaleString();
    // â”€â”€ íŒ€ ì¹´ë“œ ê³µì •ë³„ ìƒì„¸ ì •ë³´ â”€â”€
    const procDetailStyle='display:grid;grid-template-columns:repeat(3,1fr);gap:4px;font-size:11px;text-align:center;';
    const procHeaderStyle='font-size:10px;color:#94a3b8;font-weight:600;padding:2px 0;';
    const procValStyle='font-family:"JetBrains Mono",monospace;font-weight:700;font-size:12px;';
    // SMT ê³µì •ë³„ (SMD, ROUTER)
    const smtDetail=document.getElementById('smtProcDetail');
    if(smtDetail){
        let smtHtml='<div style="'+procDetailStyle+'"><div style="'+procHeaderStyle+'">ê³µì •</div><div style="'+procHeaderStyle+'">ìˆ˜ìœ¨</div><div style="'+procHeaderStyle+'">íˆ¬ì…/ë¶ˆëŸ‰</div>';
        ['SMD','ROUTER'].forEach(proc=>{
            const pd=data.filter(d=>d.proc===proc);
            const pi=pd.reduce((a,b)=>a+b.inspQty,0);
            const pdef=pd.reduce((a,b)=>a+(b.defectQty||0),0);
            const py=pi>0?((pi-pdef)/pi*100):0;
            const pyOk=py>=99.5;
            smtHtml+='<div style="font-weight:700;color:#8b5cf6;font-size:11px;">'+proc+'</div>';
            smtHtml+='<div style="'+procValStyle+'color:'+(pyOk?'#10b981':'#e11d48')+';">'+(pi>0?py.toFixed(2)+'%':'â€”')+'</div>';
            smtHtml+='<div style="'+procValStyle+'color:#334155;">'+pi.toLocaleString()+' / <span style="color:#e11d48;">'+pdef.toLocaleString()+'</span></div>';
        });
        smtHtml+='</div>';
        smtDetail.innerHTML=smtHtml;
    }
    // TEST ê³µì •ë³„ (ATE, PCT, AVI)
    const testDetail=document.getElementById('testProcDetail');
    if(testDetail){
        let testHtml='<div style="'+procDetailStyle+'"><div style="'+procHeaderStyle+'">ê³µì •</div><div style="'+procHeaderStyle+'">ìˆ˜ìœ¨</div><div style="'+procHeaderStyle+'">íˆ¬ì…/ë¶ˆëŸ‰</div>';
        ['ATE','PCT','AVI'].forEach(proc=>{
            const pd=data.filter(d=>d.proc===proc);
            const pi=pd.reduce((a,b)=>a+b.inspQty,0);
            const pdef=pd.reduce((a,b)=>a+(b.defectQty||0),0);
            const py=pi>0?((pi-pdef)/pi*100):0;
            const pyOk=py>=99.5;
            testHtml+='<div style="font-weight:700;color:#0891b2;font-size:11px;">'+proc+'</div>';
            testHtml+='<div style="'+procValStyle+'color:'+(pyOk?'#10b981':'#e11d48')+';">'+(pi>0?py.toFixed(2)+'%':'â€”')+'</div>';
            testHtml+='<div style="'+procValStyle+'color:#334155;">'+pi.toLocaleString()+' / <span style="color:#e11d48;">'+pdef.toLocaleString()+'</span></div>';
        });
        testHtml+='</div>';
        testDetail.innerHTML=testHtml;
    }
    updateDailyTables(data,defData);
    drawDailyCharts(data);
}

// Table-level filter state
let tblFilters={model:'ì „ì²´',proc:'ì „ì²´',team:'ì „ì²´'};
function renderTblFilterBtns(){
    const all=lang==='ko'?'ì „ì²´':'All';
    const mf=document.getElementById('dTblModelFilter');
    if(mf){mf.innerHTML='';['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(v=>{const b=document.createElement('button');b.className='filter-btn filter-btn-sm'+(tblFilters.model===v?' active':'');b.innerText=v==='ì „ì²´'?all:v;b.onclick=()=>{tblFilters.model=v;renderTblFilterBtns();updateDailyTables(getDailyFiltered(),getDailyDefFiltered());};mf.appendChild(b);});}
    const pf=document.getElementById('dTblProcFilter');
    if(pf){pf.innerHTML='';['ì „ì²´','SMD','ROUTER','ATE','PCT','AVI'].forEach(v=>{const b=document.createElement('button');b.className='filter-btn filter-btn-sm'+(tblFilters.proc===v?' active':'');b.innerText=v==='ì „ì²´'?all:v;b.onclick=()=>{tblFilters.proc=v;renderTblFilterBtns();updateDailyTables(getDailyFiltered(),getDailyDefFiltered());};pf.appendChild(b);});}
    const tf=document.getElementById('dTblTeamFilter');
    if(tf){tf.innerHTML='';[['ì „ì²´',all],['SMT','SMT'],['TEST','TEST']].forEach(([v,l])=>{const b=document.createElement('button');b.className='filter-btn filter-btn-sm'+(tblFilters.team===v?(v==='SMT'?' active-smt':v==='TEST'?' active-test':' active'):'');b.innerText=l;b.onclick=()=>{tblFilters.team=v;renderTblFilterBtns();updateDailyTables(getDailyFiltered(),getDailyDefFiltered());};tf.appendChild(b);});}
}
function applyTblFilter(data){
    return data.filter(d=>{
        if(tblFilters.model!=='ì „ì²´'&&d.model!==tblFilters.model) return false;
        if(tblFilters.proc!=='ì „ì²´'&&d.proc!==tblFilters.proc) return false;
        if(tblFilters.team!=='ì „ì²´'&&getTeam(d.proc)!==tblFilters.team) return false;
        return true;
    });
}
function updateDailyTables(data,defData){
    renderTblFilterBtns();
    // Production table with table-level filters + sort
    const tbody=document.querySelector('#dTblProd tbody');
    const tblData=applyTblFilter(data);
    if(!tblData.length){
        tbody.innerHTML=`<tr><td colspan="8" class="daily-no-data">ğŸ“­ ${lang==='ko'?'ë°ì´í„° ì—†ìŒ â€” ì¼ë³„ ìƒì‚° ì…ë ¥ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”':'No data â€” use Daily Prod Entry'}</td></tr>`;
    } else {
        const sortVal=(document.getElementById('dTblSort')||{}).value||'date-desc';
        const sorted=[...tblData].sort((a,b)=>{
            const ya=a.inspQty>0?a.goodQty/a.inspQty*100:0;
            const yb=b.inspQty>0?b.goodQty/b.inspQty*100:0;
            if(sortVal==='date-desc') return a.date>b.date?-1:1;
            if(sortVal==='date-asc') return a.date<b.date?-1:1;
            if(sortVal==='yield-asc') return ya-yb;
            if(sortVal==='yield-desc') return yb-ya;
            if(sortVal==='defect-desc') return b.defectQty-a.defectQty;
            return 0;
        });
        tbody.innerHTML=sorted.map(d=>{
            const y=d.inspQty>0?d.goodQty/d.inspQty*100:0,ok=y>=99.5;
            return`<tr>
                <td><strong>${d.date}</strong></td>
                <td>${d.model}</td><td>${d.proc}</td>
                <td>${getTeamBadge(d.proc)}</td>
                <td style="text-align:right;font-family:'JetBrains Mono',monospace">${d.inspQty.toLocaleString()}</td>
                <td style="text-align:right;font-family:'JetBrains Mono',monospace">${d.goodQty.toLocaleString()}</td>
                <td style="text-align:right;font-family:'JetBrains Mono',monospace;color:#e11d48">${d.defectQty.toLocaleString()}</td>
                <td class="${ok?'yield-good':'yield-bad'}">${y.toFixed(2)}%</td>
            </tr>`;
        }).join('');
        const cnt=document.getElementById('dTblProdCount');
        if(cnt) cnt.innerText=(lang==='ko'?`${sorted.length}ê±´ / ì „ì²´ ${tblData.length}ê±´`:`${sorted.length} / ${tblData.length} records`);
    }
    // Defect code table
    const dtbody=document.querySelector('#dTblDefect tbody');
    const fDef=dDefectTeamFilter==='ì „ì²´'?defData:defData.filter(d=>d.team===dDefectTeamFilter);
    if(!fDef.length){
        dtbody.innerHTML=`<tr><td colspan="4" class="daily-no-data">${lang==='ko'?'ë¶ˆëŸ‰ ì½”ë“œ ë°ì´í„° ì—†ìŒ':'No defect code data'}</td></tr>`;
        return;
    }
    const codeMap={};
    fDef.forEach(d=>{if(!codeMap[d.defectCode])codeMap[d.defectCode]={code:d.defectCode,name:d.defectName,team:d.team,qty:0};codeMap[d.defectCode].qty+=d.qty;});
    dtbody.innerHTML=Object.values(codeMap).sort((a,b)=>b.qty-a.qty).map(r=>
        `<tr><td style="font-family:'JetBrains Mono',monospace;font-weight:700;color:#4f46e5">${r.code}</td>
         <td style="font-size:12px;">${r.name}</td>
         <td>${getTeamBadge(r.team==='SMT'?'SMD':'ATE')}</td>
         <td style="font-family:'JetBrains Mono',monospace;font-weight:700;color:#e11d48">${r.qty.toLocaleString()}</td></tr>`
    ).join('');
}

function drawDailyCharts(data){
    Object.values(dCharts).forEach(c=>c&&c.destroy());dCharts={};
    const defData=getDailyDefFiltered();
    const bOpts={responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{boxWidth:10,boxHeight:10,padding:10,font:{size:11,weight:'600',family:'Noto Sans KR,Inter,sans-serif'},usePointStyle:true,pointStyleWidth:8}},
        datalabels:{display:false}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10,family:'Noto Sans KR,Inter,sans-serif',weight:'600'},color:'#94a3b8',maxRotation:45},border:{display:false}},
        y:{grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}};
    try{
        const dates=[...new Set(data.map(d=>d.date))].sort();
        if(!dates.length) return;
        // â”€â”€ Yield Trend with DATA LABELS â”€â”€
        const isTeam=['SMT','TEST'].includes(dYieldFilter);
        const isProc=['SMD','ROUTER','ATE','PCT','AVI'].includes(dYieldFilter);
        let yDS;
        if(isTeam){
            const procs=dYieldFilter==='SMT'?['SMD','ROUTER']:['ATE','PCT','AVI'];
            const c=dYieldFilter==='SMT'?'#6366f1':'#0891b2';
            yDS=[{label:dYieldFilter,data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&procs.includes(r.proc));const i=d.reduce((a,b)=>a+b.inspQty,0);const g=d.reduce((a,b)=>a+b.goodQty,0);return i>0?+(g/i*100).toFixed(2):null;}),borderColor:c,fill:false,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
        } else if(isProc){
            const c={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981'}[dYieldFilter]||'#6366f1';
            yDS=[{label:dYieldFilter,data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.proc===dYieldFilter);const i=d.reduce((a,b)=>a+b.inspQty,0);const g=d.reduce((a,b)=>a+b.goodQty,0);return i>0?+(g/i*100).toFixed(2):null;}),borderColor:c,fill:false,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
        } else {
            const models=dYieldFilter==='ì „ì²´'?['RDIMM','SODIMM','UDIMM']:[dYieldFilter];
            const pColors={RDIMM:'#f43f5e',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
            yDS=models.map(p=>({label:p,borderColor:pColors[p]||'#6366f1',fill:false,tension:.4,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'white',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.model===p);const i=d.reduce((a,b)=>a+b.inspQty,0);const g=d.reduce((a,b)=>a+b.goodQty,0);return i>0?+(g/i*100).toFixed(2):null;})}));
        }
        const yLabelOpts={display:ctx=>ctx.dataset.data[ctx.dataIndex]!==null,color:ctx=>{const c=['#f43f5e','#0891b2','#f59e0b','#6366f1','#10b981'];return c[ctx.datasetIndex]||'#334155';},backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:3,right:8,bottom:3,left:8},font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},anchor:'end',align:'top',offset:6,clip:false,formatter:v=>v?v.toFixed(2)+'%':''};
        dCharts.yield=new Chart(document.getElementById('dChartYield'),{type:'line',data:{labels:dates,datasets:yDS},options:{...bOpts,layout:{padding:{top:40,right:50,bottom:10,left:20}},plugins:{...bOpts.plugins,datalabels:yLabelOpts},scales:{...bOpts.scales,x:{...bOpts.scales.x,offset:true},y:{...bOpts.scales.y,max:101,min:99,afterDataLimits:(axis)=>{
                        axis.max=101;
                        // ìµœì†Ÿê°’ì´ 99 ë¯¸ë§Œì´ë©´ ë°ì´í„°ì— ë§ì¶° ì‚´ì§ ì¡°ì •
                        const allVals=[];
                        axis.chart.data.datasets.forEach(ds=>{ds.data.forEach(v=>{if(v!==null&&v!==undefined)allVals.push(v);});});
                        if(allVals.length){const minVal=Math.min(...allVals);axis.min=minVal<99?Math.floor(minVal-0.5):99;}
                        else{axis.min=99;}
                    }}}}});

        // â”€â”€ Volume Trend (SMD ê¸°ì¤€ íˆ¬ì…ìˆ˜ëŸ‰ per day+model) â”€â”€
        const models2=dVolFilter==='ì „ì²´'?['RDIMM','SODIMM','UDIMM']:[dVolFilter];
        const vColors={RDIMM:'#6366f1',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
        // SMD ê¸°ì¤€: ë‚ ì§œ+ëª¨ë¸ë³„ SMD íˆ¬ì…ìˆ˜ëŸ‰ë§Œ ì‚¬ìš© (ì—†ìœ¼ë©´ ì²«ë²ˆì§¸ ê³µì •)
        const getVolForDateModel=(dt,model)=>{
            const smdRow=data.find(r=>r.date===dt&&r.model===model&&r.proc==='SMD');
            if(smdRow) return smdRow.inspQty;
            const rows=data.filter(r=>r.date===dt&&r.model===model);
            if(!rows.length) return 0;
            rows.sort((a,b)=>['SMD','ROUTER','ATE','PCT','AVI'].indexOf(a.proc)-['SMD','ROUTER','ATE','PCT','AVI'].indexOf(b.proc));
            return rows[0].inspQty;
        };
        const vDS=models2.map(m=>({label:m,data:dates.map(dt=>getVolForDateModel(dt,m)),backgroundColor:vColors[m]||'#6366f1',borderRadius:4,borderSkipped:false,stack:'v0',
            datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',font:{weight:'700',size:10,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}}));
        const vTotals=dates.map(dt=>models2.reduce((s,m)=>s+getVolForDateModel(dt,m),0));
        dCharts.vol=new Chart(document.getElementById('dChartVol'),{type:'bar',data:{labels:dates,datasets:[...vDS,{type:'line',label:'Total',data:vTotals,borderColor:'transparent',backgroundColor:'transparent',pointRadius:0,order:-1,datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'end',align:'top',color:'#334155',backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:3,right:7,bottom:3,left:7},font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():'',offset:6}}]},options:{...bOpts,layout:{padding:{top:36,right:10}},plugins:{...bOpts.plugins,legend:{...bOpts.plugins.legend,labels:{...bOpts.plugins.legend.labels,filter:item=>item.text!=='Total'}},datalabels:{display:false}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}});
        // â”€â”€ Daily PPM Trend (shares dYieldFilter) â”€â”€
        if(document.getElementById('dChartPpm')){
            const isTeamPpm=['SMT','TEST'].includes(dYieldFilter);
            const isProcPpm=['SMD','ROUTER','ATE','PCT','AVI'].includes(dYieldFilter);
            let ppmDS;
            if(isTeamPpm){
                const procs=dYieldFilter==='SMT'?['SMD','ROUTER']:['ATE','PCT','AVI'];
                const c=dYieldFilter==='SMT'?'#6366f1':'#0891b2';
                ppmDS=[{label:dYieldFilter+' PPM',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&procs.includes(r.proc));const i=d.reduce((a,b)=>a+b.inspQty,0);const def=d.reduce((a,b)=>a+(b.defectQty||0),0);return i>0?Math.round(def/i*1000000):null;}),borderColor:c,backgroundColor:c+'12',fill:true,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
            } else if(isProcPpm){
                const c={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981'}[dYieldFilter]||'#6366f1';
                ppmDS=[{label:dYieldFilter+' PPM',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.proc===dYieldFilter);const i=d.reduce((a,b)=>a+b.inspQty,0);const def=d.reduce((a,b)=>a+(b.defectQty||0),0);return i>0?Math.round(def/i*1000000):null;}),borderColor:c,backgroundColor:c+'12',fill:true,tension:.4,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'white',pointBorderColor:c,pointBorderWidth:2.5}];
            } else {
                const models=dYieldFilter==='ì „ì²´'?['RDIMM','SODIMM','UDIMM']:[dYieldFilter];
                const pColors={RDIMM:'#f43f5e',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
                ppmDS=models.map(p=>({label:p+' PPM',borderColor:pColors[p]||'#6366f1',backgroundColor:(pColors[p]||'#6366f1')+'12',fill:true,tension:.4,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'white',data:dates.map(dt=>{const d=data.filter(r=>r.date===dt&&r.model===p);const i=d.reduce((a,b)=>a+b.inspQty,0);const def=d.reduce((a,b)=>a+(b.defectQty||0),0);return i>0?Math.round(def/i*1000000):null;})}));
            }
            const ppmLabelOpts={display:ctx=>ctx.dataset.data[ctx.dataIndex]!==null,color:ctx=>{const c=['#f43f5e','#0891b2','#f59e0b','#6366f1','#10b981'];return c[ctx.datasetIndex]||'#334155';},backgroundColor:'rgba(255,255,255,0.95)',borderRadius:6,padding:{top:3,right:8,bottom:3,left:8},font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},anchor:'end',align:'top',offset:6,clip:false,formatter:v=>v!==null?v.toLocaleString():''};
            dCharts.ppm=new Chart(document.getElementById('dChartPpm'),{type:'line',data:{labels:dates,datasets:ppmDS},options:{...bOpts,layout:{padding:{top:40,right:50,bottom:10,left:20}},plugins:{...bOpts.plugins,datalabels:ppmLabelOpts},scales:{...bOpts.scales,x:{...bOpts.scales.x,offset:true},y:{...bOpts.scales.y,beginAtZero:true,grace:'20%'}}}});
        }

        // â”€â”€ FIX 8: Daily Production by Process chart â”€â”€
        const procColors={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981'};
        const procs2=['SMD','ROUTER','ATE','PCT','AVI'];
        const pDS=procs2.map(p=>({label:p,data:dates.map(dt=>data.filter(r=>r.date===dt&&r.proc===p).reduce((a,b)=>a+b.inspQty,0)),backgroundColor:procColors[p],borderRadius:3,borderSkipped:false,stack:'p0',
            datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',backgroundColor:'transparent',font:{weight:'700',size:9,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}}));
        if(document.getElementById('dChartProcVol')){
            if(dCharts.procVol) dCharts.procVol.destroy();
            dCharts.procVol=new Chart(document.getElementById('dChartProcVol'),{type:'bar',data:{labels:dates,datasets:pDS},options:{...bOpts,layout:{padding:{top:10}},plugins:{...bOpts.plugins,datalabels:{display:false}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}});
        }

        // â”€â”€ Defect Bar & Pie â”€â”€
        const fDef=dDefectTeamFilter==='ì „ì²´'?defData:defData.filter(d=>d.team===dDefectTeamFilter);
        const codeMap={};fDef.forEach(d=>{if(!codeMap[d.defectCode])codeMap[d.defectCode]={name:d.defectName,team:d.team,qty:0};codeMap[d.defectCode].qty+=d.qty;});
        const top10=Object.entries(codeMap).sort((a,b)=>b[1].qty-a[1].qty).slice(0,10);
        if(top10.length){
            const dColors=top10.map(([,v])=>v.team==='SMT'?'rgba(99,102,241,0.85)':'rgba(8,145,178,0.85)');
            dCharts.defBar=new Chart(document.getElementById('dChartDefectBar'),{type:'bar',data:{labels:top10.map(([k,v])=>`${k} ${v.name.slice(0,18)}`),datasets:[{label:lang==='ko'?'ë¶ˆëŸ‰ ìˆ˜ëŸ‰':'Defect Qty',data:top10.map(([,v])=>v.qty),backgroundColor:dColors,borderRadius:4,borderSkipped:false}]},options:{...bOpts,indexAxis:'y',layout:{padding:{right:60}},plugins:{...bOpts.plugins,legend:{display:false},datalabels:{display:true,anchor:'end',align:'end',color:'#334155',font:{weight:'700',size:11,family:'JetBrains Mono,monospace'},formatter:v=>v.toLocaleString()}},scales:{x:{grid:{display:false},ticks:{font:{size:11,family:'JetBrains Mono,monospace'},color:'#94a3b8'},border:{display:false}},y:{grid:{display:false},ticks:{font:{size:11,family:'JetBrains Mono,monospace',weight:'600'},color:'#334155'},border:{display:false}}}}});
            const pieColors=['#6366f1','#0891b2','#f59e0b','#10b981','#ec4899','#8b5cf6','#ef4444','#06b6d4','#84cc16','#f97316'];
            const pieLabels=top10.map(([k,v])=>`${k} ${v.name.slice(0,20)}`);
            dCharts.defPie=new Chart(document.getElementById('dChartDefectPie'),{type:'doughnut',data:{labels:pieLabels,datasets:[{data:top10.map(([,v])=>v.qty),backgroundColor:top10.map(([,v],i)=>v.team==='SMT'?['#6366f1','#8b5cf6','#a78bfa','#c4b5fd','#e0e7ff'][i%5]:['#0891b2','#06b6d4','#22d3ee','#67e8f9','#cffafe'][i%5]),borderWidth:3,borderColor:'white',hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'45%',layout:{padding:{top:8,bottom:8,left:8,right:8}},plugins:{legend:{position:'bottom',align:'start',labels:{font:{size:10,family:'JetBrains Mono,monospace',weight:'600'},padding:6,usePointStyle:true,pointStyleWidth:8,boxWidth:10,boxHeight:10,generateLabels:(chart)=>{const data=chart.data;return data.labels.map((l,i)=>({text:l,fillStyle:data.datasets[0].backgroundColor[i],strokeStyle:'white',lineWidth:1,pointStyle:'circle',index:i}));}}},datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]/ctx.dataset.data.reduce((a,b)=>a+b,0)>0.03,color:'white',font:{weight:'800',size:11,family:'JetBrains Mono,monospace'},textStrokeColor:'rgba(0,0,0,0.5)',textStrokeWidth:3,formatter:(v,ctx)=>{const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);return v>0?(v*100/total).toFixed(1)+'%':'';},anchor:'center',align:'center'}}}});
        }
        // â”€â”€ FIX: ìƒì‚° ë°ì´í„° ì„¹ì…˜ ì°¨íŠ¸ â”€â”€
        const tblData2 = getDailyFiltered(); // í…Œì´ë¸” í•„í„°ì™€ ë¬´ê´€í•˜ê²Œ ì „ì²´ ì‚¬ìš©
        if(tblData2.length){
            // (1) ê³µì •ë³„ íˆ¬ì…ìˆ˜ëŸ‰ (ë‚ ì§œ xì¶•, ê³µì • ìŠ¤íƒ)
            const pColors2={SMD:'#8b5cf6',ROUTER:'#ec4899',ATE:'#6366f1',PCT:'#f59e0b',AVI:'#10b981'};
            const allDates=[...new Set(tblData2.map(d=>d.date))].sort();
            const procDS=['SMD','ROUTER','ATE','PCT','AVI'].map(p=>({
                label:p, backgroundColor:pColors2[p], borderRadius:3, borderSkipped:false, stack:'pp',
                hidden:dProcVolFilter!=='ì „ì²´'&&p!==dProcVolFilter,
                data:allDates.map(dt=>tblData2.filter(r=>r.date===dt&&r.proc===p).reduce((a,b)=>a+b.inspQty,0)),
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',font:{weight:'700',size:9,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}
            }));
            if(dCharts.prodByProc){dCharts.prodByProc.destroy();}
            if(document.getElementById('dChartProdByProc')){
                dCharts.prodByProc=new Chart(document.getElementById('dChartProdByProc'),{
                    type:'bar',data:{labels:allDates,datasets:procDS},
                    options:{...bOpts,layout:{padding:{top:10}},plugins:{...bOpts.plugins,datalabels:{display:false}},
                    scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},
                            y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}
                });
            }
            // (2) ëª¨ë¸ë³„ íˆ¬ì…ìˆ˜ëŸ‰ (SMD ê¸°ì¤€)
            const mColors2={RDIMM:'#6366f1',SODIMM:'#0891b2',UDIMM:'#f59e0b'};
            const modelDS2=['RDIMM','SODIMM','UDIMM'].map(m=>({
                label:m, backgroundColor:mColors2[m], borderRadius:3, borderSkipped:false, stack:'mm',
                hidden:dModelVolFilter!=='ì „ì²´'&&m!==dModelVolFilter,
                data:allDates.map(dt=>{
                    // SMD ê¸°ì¤€ ìš°ì„ , ì—†ìœ¼ë©´ ì²«ë²ˆì§¸ ê³µì •
                    const smdRow=tblData2.find(r=>r.date===dt&&r.model===m&&r.proc==='SMD');
                    if(smdRow) return smdRow.inspQty;
                    const rows=tblData2.filter(r=>r.date===dt&&r.model===m);
                    if(!rows.length) return 0;
                    rows.sort((a,b)=>['SMD','ROUTER','ATE','PCT','AVI'].indexOf(a.proc)-['SMD','ROUTER','ATE','PCT','AVI'].indexOf(b.proc));
                    return rows[0].inspQty;
                }),
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'center',align:'center',color:'white',font:{weight:'700',size:9,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}
            }));
            if(dCharts.prodByModel){dCharts.prodByModel.destroy();}
            if(document.getElementById('dChartProdByModel')){
                dCharts.prodByModel=new Chart(document.getElementById('dChartProdByModel'),{
                    type:'bar',data:{labels:allDates,datasets:modelDS2},
                    options:{...bOpts,layout:{padding:{top:10}},plugins:{...bOpts.plugins,datalabels:{display:false}},
                    scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},
                            y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{font:{size:11},color:'#94a3b8'},border:{display:false}}}}
                });
            }
            // (3) ë‚ ì§œë³„ ìˆ˜ìœ¨ & ë¶ˆëŸ‰ ë³µí•© ì°¨íŠ¸ (SMD ê¸°ì¤€ ì „ì²´ ìˆ˜ìœ¨ ë¼ì¸ + ë¶ˆëŸ‰ ë§‰ëŒ€)
            // ëª¨ë¸ í•„í„°
            const pdMF=document.getElementById('dProdChartModelFilter');
            if(pdMF&&!pdMF.dataset.init){
                pdMF.dataset.init='1';
                ['ì „ì²´','RDIMM','SODIMM','UDIMM'].forEach(m=>{
                    const b=document.createElement('button');
                    b.className='mini-btn'+(m==='ì „ì²´'?' active':'');
                    b.innerText=m==='ì „ì²´'?(lang==='ko'?'ì „ì²´':'All'):m;
                    b.dataset.model=m;
                    b.onclick=()=>{
                        pdMF.querySelectorAll('.mini-btn').forEach(x=>x.classList.remove('active'));
                        b.classList.add('active');
                        drawProdYieldDefChart(b.dataset.model);
                    };
                    pdMF.appendChild(b);
                });
            }
            drawProdYieldDefChart('ì „ì²´');
        }
    }catch(e){console.error('ì¼ë³„ ì°¨íŠ¸ ì˜¤ë¥˜:',e);}
}

function drawProdYieldDefChart(modelFilter){
    if(dCharts.prodYieldDef){dCharts.prodYieldDef.destroy();}
    const canvas=document.getElementById('dChartProdYieldDef');
    if(!canvas) return;
    const data=getDailyFiltered().filter(d=>modelFilter==='ì „ì²´'||d.model===modelFilter);
    const allDates=[...new Set(data.map(d=>d.date))].sort();
    if(!allDates.length) return;
    const procOrder=['SMD','ROUTER','ATE','PCT','AVI'];
    // ë‚ ì§œë³„ SMD ê¸°ì¤€ íˆ¬ì…, ì „ì²´ ë¶ˆëŸ‰
    const dateInsp=allDates.map(dt=>{
        const smdRows=data.filter(r=>r.date===dt&&r.proc==='SMD');
        if(smdRows.length) return smdRows.reduce((a,b)=>a+b.inspQty,0);
        const rows=data.filter(r=>r.date===dt);
        if(!rows.length) return 0;
        rows.sort((a,b)=>procOrder.indexOf(a.proc)-procOrder.indexOf(b.proc));
        return rows[0]?.inspQty||0;
    });
    const dateDef=allDates.map(dt=>data.filter(r=>r.date===dt).reduce((a,b)=>a+(b.defectQty||0),0));
    const dateYield=allDates.map((dt,i)=>dateInsp[i]>0?+((dateInsp[i]-dateDef[i])/dateInsp[i]*100).toFixed(2):null);
    dCharts.prodYieldDef=new Chart(canvas,{
        type:'bar',
        data:{labels:allDates,datasets:[
            {type:'line',label:lang==='ko'?'ìˆ˜ìœ¨(%)':'Yield(%)',data:dateYield,borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.05)',fill:true,tension:0.4,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'white',pointBorderColor:'#6366f1',pointBorderWidth:2,yAxisID:'y1',
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]!==null,anchor:'end',align:'top',color:'#6366f1',backgroundColor:'rgba(255,255,255,0.9)',borderRadius:5,padding:{top:2,right:6,bottom:2,left:6},font:{weight:'700',size:10,family:'JetBrains Mono,monospace'},formatter:v=>v?v.toFixed(2)+'%':'',offset:4,clip:false}},
            {type:'bar',label:lang==='ko'?'ë¶ˆëŸ‰ìˆ˜':'Defects',data:dateDef,backgroundColor:'rgba(244,63,94,0.75)',borderRadius:4,borderSkipped:false,yAxisID:'y2',
                datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'end',align:'top',color:'#e11d48',font:{weight:'700',size:10,family:'JetBrains Mono,monospace'},formatter:v=>v>0?v.toLocaleString():''}}
        ]},
        options:{responsive:true,maintainAspectRatio:false,
            layout:{padding:{top:36,right:20,bottom:0,left:10}},
            plugins:{legend:{position:'bottom',labels:{font:{size:11,family:'Noto Sans KR,sans-serif',weight:'600'},usePointStyle:true,padding:12}},
                     datalabels:{display:false}},
            scales:{
                x:{grid:{display:false},ticks:{font:{size:10},color:'#94a3b8',maxRotation:45},border:{display:false}},
                y1:{position:'left',min:90,max:101,grid:{color:'#f1f5f9'},ticks:{font:{size:10},color:'#6366f1'},border:{display:false},title:{display:true,text:'ìˆ˜ìœ¨(%)',color:'#6366f1',font:{size:10,weight:'700'}}},
                y2:{position:'right',min:0,grid:{display:false},ticks:{font:{size:10},color:'#e11d48'},border:{display:false},title:{display:true,text:lang==='ko'?'ë¶ˆëŸ‰ìˆ˜':'Defects',color:'#e11d48',font:{size:10,weight:'700'}}}
            }
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY PROD MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDailyProdModal(){
    requirePassword(()=>{
        document.getElementById('modalDailyProd').style.display='block';
        if(!document.querySelector('#tblDailyProdEntry tbody tr')) addDailyProdRow();
    });
}

function addDailyProdRow(model='',date='',proc='',insp='',good='',def=''){
    const today=new Date().toISOString().slice(0,10);
    const tbody=document.querySelector('#tblDailyProdEntry tbody');
    const tr=document.createElement('tr');
    tr.innerHTML=`
        <td><select style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;">
            <option value="">${lang==='ko'?'ì„ íƒ':'Select'}</option>
            <option value="RDIMM"${model==='RDIMM'?' selected':''}>RDIMM</option>
            <option value="SODIMM"${model==='SODIMM'?' selected':''}>SODIMM</option>
            <option value="UDIMM"${model==='UDIMM'?' selected':''}>UDIMM</option>
        </select></td>
        <td><input type="date" style="padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;width:138px;" value="${date||today}"></td>
        <td><select style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;" onchange="this.closest('tr').querySelector('.tc').innerHTML=getTeamBadge(this.value)">
            <option value="">${lang==='ko'?'ì„ íƒ':'Select'}</option>
            <option value="SMD"${proc==='SMD'?' selected':''}>SMD</option>
            <option value="ROUTER"${proc==='ROUTER'?' selected':''}>ROUTER</option>
            <option value="ATE"${proc==='ATE'?' selected':''}>ATE</option>
            <option value="PCT"${proc==='PCT'?' selected':''}>PCT</option>
            <option value="AVI"${proc==='AVI'?' selected':''}>AVI</option>
        </select></td>
        <td class="tc">${getTeamBadge(proc)}</td>
        <td><input type="number" style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" value="${insp}" placeholder="${lang==='ko'?'íˆ¬ì…':'Input'}" min="0"></td>
        <td><input type="number" style="width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" value="${good}" placeholder="${lang==='ko'?'ì–‘í’ˆ':'Good'}" min="0"></td>
        <td><input type="number" style="width:80px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" value="${def}" placeholder="0" min="0"></td>
        <td><button class="btn-del" onclick="this.closest('tr').remove()">${lang==='ko'?'ì‚­ì œ':'Del'}</button></td>`;
    tbody.appendChild(tr);
    tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function parseDailyPaste(){
    const raw=document.getElementById('pasteDailyProd').value.trim();if(!raw)return;
    const rows=raw.split('\n').filter(r=>r.trim());
    document.querySelector('#tblDailyProdEntry tbody').innerHTML='';
    let skipped=0;
    rows.forEach(r=>{
        const c=r.split('\t').map(x=>x.trim());
        const insp=Number(c[3])||0;
        // íˆ¬ì…ìˆ˜ëŸ‰ 0ì¸ í–‰ì€ ê±´ë„ˆëœ€
        if(insp<=0){skipped++;return;}
        addDailyProdRow(c[0]||'',c[1]||'',c[2]||'',c[3]||'',c[4]||'',c[5]||'');
    });
    document.getElementById('pasteDailyProd').value='';
    if(skipped>0){
        const hint=document.getElementById('pasteSkipHint');
        if(hint) hint.innerText=(lang==='ko'?`â„¹ï¸ íˆ¬ì…ìˆ˜ëŸ‰ 0ì¸ ${skipped}í–‰ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤`:`â„¹ï¸ ${skipped} zero-qty rows skipped`);
        setTimeout(()=>{const h=document.getElementById('pasteSkipHint');if(h)h.innerText='';},4000);
    }
}

function clearAllDailyProdData(){
    const msg=lang==='ko'?'âš ï¸ Firebase ì¼ë³„ ìƒì‚° ë°ì´í„°ë¥¼ ì „ë¶€ ì‚­ì œí•©ë‹ˆë‹¤. ë³µêµ¬ ë¶ˆê°€. ê³„ì†?':'âš ï¸ DELETE ALL daily production data? Cannot be undone.';
    if(!confirm(msg))return;
    saveToFirebase('dprod',[]).then(()=>{
        alert(lang==='ko'?'âœ… ì¼ë³„ ìƒì‚° ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.':'âœ… All daily production data deleted.');
        document.getElementById('modalDailyProd').style.display='none';
    });
}

function saveDailyProd(){
    const rows=document.querySelectorAll('#tblDailyProdEntry tbody tr');
    const newData=[];
    rows.forEach(r=>{
        const sels=r.querySelectorAll('select');
        const inps=r.querySelectorAll('input');
        const model=sels[0]?.value, proc=sels[1]?.value;
        const date=inps[0]?.value;
        const insp=cleanNum(inps[1]?.value);
        const goodRaw=inps[2]?.value.trim();
        const defRaw=inps[3]?.value.trim();
        const def=cleanNum(defRaw);
        // goodQty: ëª…ì‹œì ìœ¼ë¡œ ì…ë ¥ëœ ê²½ìš° ê·¸ ê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ insp-def ê³„ì‚°
        const good = goodRaw!=='' ? cleanNum(goodRaw) : Math.max(0, insp - def);
        if(!model||!proc||!date||insp<=0) return; // 0ê±´ í–‰ ì œì™¸
        // ê¸°ë³¸ ê²€ì¦
        if(good < 0 || def < 0 || good > insp){
            console.warn(`ê±´ë„ˆëœ€: ${date} ${model} ${proc} - ìˆ˜ëŸ‰ ì˜¤ë¥˜ (íˆ¬ì…:${insp} ì–‘í’ˆ:${good} ë¶ˆëŸ‰:${def})`);
            return;
        }
        newData.push({model,date,proc,team:getTeam(proc),inspQty:insp,goodQty:good,defectQty:Math.max(0,insp-good),month:extractYM(date)});
    });
    if(!newData.length){alert(lang==='ko'?'ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (íˆ¬ì…ìˆ˜ëŸ‰ > 0 ì´ì–´ì•¼ í•©ë‹ˆë‹¤)':'No valid data. (Input Qty must be > 0)');return;}
    
    // â˜… í•µì‹¬: ì…ë ¥í•œ ëª¨ë¸+ê³µì • ì¡°í•©ì„ í†µì§¸ë¡œ êµì²´
    // - ìƒˆë¡œ ì…ë ¥ëœ ëª¨ë¸+ê³µì • ì¡°í•©ì— í•´ë‹¹í•˜ëŠ” ê¸°ì¡´ ë°ì´í„° ì „ë¶€ ì‚­ì œ
    // - ì…ë ¥í•˜ì§€ ì•Šì€ ëª¨ë¸+ê³µì • ì¡°í•©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
    // â†’ Firebase ì˜¤ì—¼ ë°ì´í„°ê°€ ë‚¨ëŠ” ë¬¸ì œ ì™„ì „ í•´ê²°
    const newModelProcs = new Set(newData.map(d=>d.model+'|'+d.proc));
    const kept = dailyProdData.filter(d=>!newModelProcs.has(d.model+'|'+d.proc));
    const merged = [...kept, ...newData];
    
    const msg=lang==='ko'
        ? `âœ… ì €ì¥ ì™„ë£Œ! (${newData.length}ê±´)
êµì²´ëœ ëª¨ë¸+ê³µì •: ${[...newModelProcs].join(', ')}`
        : `âœ… Saved! (${newData.length} records)
Replaced: ${[...newModelProcs].join(', ')}`;
    
    saveToFirebase('dprod',merged).then(()=>{
        document.getElementById('modalDailyProd').style.display='none';
        document.querySelector('#tblDailyProdEntry tbody').innerHTML='';
        alert(msg);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY DEFECT MODAL (with qty limit validation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDailyDefModal(){
    requirePassword(()=>{
        document.getElementById('modalDailyDef').style.display='block';
        refreshAvailDefects();
        if(!document.querySelector('#tblDailyDefEntry tbody tr')) addDailyDefRow();
    });
}

// Build a lookup: date+model+proc â†’ available defect qty (from dailyProdData minus already-assigned)
function getAvailableDefects(){
    const available={};
    dailyProdData.forEach(d=>{
        const key=`${d.date}|${d.model}|${d.proc}`;
        if(!available[key]) available[key]={date:d.date,model:d.model,proc:d.proc,team:getTeam(d.proc),total:d.defectQty,assigned:0};
        else available[key].total+=d.defectQty;
    });
    dailyDefectData.forEach(d=>{
        const key=`${d.date}|${d.model}|${d.proc}`;
        if(available[key]) available[key].assigned+=d.qty;
    });
    return available;
}

function refreshAvailDefects(){
    const available=getAvailableDefects();
    const panel=document.getElementById('ddefAvailList');
    const items=Object.values(available).filter(a=>a.total>0).sort((a,b)=>a.date<b.date?1:-1);
    if(!items.length){
        panel.innerHTML=lang==='ko'?'<span style="color:#94a3b8">ìƒì‚° ë°ì´í„°ì— ë¶ˆëŸ‰ ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤</span>':'<span style="color:#94a3b8">No defect qty in production data</span>';
        return;
    }
    panel.innerHTML=items.map(a=>{
        const rem=a.total-a.assigned;
        const color=rem<=0?'#e11d48':rem<a.total?'#f59e0b':'#16a34a';
        return`<span style="display:inline-block;margin:2px 4px;padding:3px 10px;background:#f0f4fb;border-radius:20px;font-size:11px;font-family:'JetBrains Mono',monospace;border:1px solid ${color}20">
            <strong>${a.date} ${a.model} ${a.proc}</strong>: <span style="color:${color};font-weight:700;">${rem}/${a.total}</span>${lang==='ko'?' ì”ì—¬':' left'}</span>`;
    }).join('');
}

function addDailyDefRow(model='',date='',proc='',defCode='',defName='',qty=''){
    const today=new Date().toISOString().slice(0,10);
    const rowId='dr'+Date.now().toString(36)+Math.random().toString(36).slice(2,5);
    const tbody=document.querySelector('#tblDailyDefEntry tbody');
    const tr=document.createElement('tr');
    tr.innerHTML=`
        <td><select style="width:80px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;" onchange="refreshAvailDefects()">
            <option value="">${lang==='ko'?'ì„ íƒ':'Sel'}</option>
            <option value="RDIMM"${model==='RDIMM'?' selected':''}>RDIMM</option>
            <option value="SODIMM"${model==='SODIMM'?' selected':''}>SODIMM</option>
            <option value="UDIMM"${model==='UDIMM'?' selected':''}>UDIMM</option>
        </select></td>
        <td><input type="date" style="padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;width:128px;" value="${date||today}" onchange="refreshAvailDefects()"></td>
        <td><select style="width:80px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;background:white;" onchange="onDefProcChange(this,'${rowId}')">
            <option value="">${lang==='ko'?'ì„ íƒ':'Sel'}</option>
            <option value="SMD"${proc==='SMD'?' selected':''}>SMD</option>
            <option value="ROUTER"${proc==='ROUTER'?' selected':''}>ROUTER</option>
            <option value="ATE"${proc==='ATE'?' selected':''}>ATE</option>
            <option value="PCT"${proc==='PCT'?' selected':''}>PCT</option>
            <option value="AVI"${proc==='AVI'?' selected':''}>AVI</option>
        </select></td>
        <td class="tc-${rowId}">${getTeamBadge(proc)}</td>
        <td><div class="search-select-wrap" id="ssw_${rowId}">
            <input type="text" class="search-select-input" placeholder="${lang==='ko'?'ì½”ë“œ/ì´ë¦„ ê²€ìƒ‰...':'Search code/name...'}" 
                value="${defCode?(defCode+' '+defName).trim():''}" data-code="${defCode}" data-name="${defName}"
                oninput="filterDefDD(this,'${rowId}')" onfocus="openDefDD('${rowId}')" autocomplete="off">
            <div class="search-dropdown" id="dd_${rowId}"></div>
        </div></td>
        <td>
            <input type="number" class="def-qty-input" style="width:70px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;" 
                value="${qty}" placeholder="0" min="0" 
                oninput="validateDefQty(this,'${rowId}')" onchange="refreshAvailDefects()">
            <div class="def-avail-hint" id="hint_${rowId}" style="font-size:10px;color:#94a3b8;margin-top:2px;text-align:center;"></div>
        </td>
        <td><button class="btn-del" onclick="this.closest('tr').remove();refreshAvailDefects()">${lang==='ko'?'ì‚­ì œ':'Del'}</button></td>`;
    tbody.appendChild(tr);
    if(proc) buildDefDD(rowId,proc,'');
    tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function validateDefQty(input,rowId){
    const row=input.closest('tr');
    const sels=row.querySelectorAll('select');
    const dateInp=row.querySelector('input[type="date"]');
    const model=sels[0]?.value,proc=sels[1]?.value,date=dateInp?.value;
    if(!model||!proc||!date){return;}
    const key=`${date}|${model}|${proc}`;
    const available=getAvailableDefects();
    const avail=available[key];
    const hint=document.getElementById('hint_'+rowId);
    if(!avail||avail.total===0){
        if(hint) hint.innerHTML=`<span style="color:#e11d48">${lang==='ko'?'ìƒì‚° ë°ì´í„° ì—†ìŒ':'No prod data'}</span>`;
        return;
    }
    // Calculate already entered in this modal for same key (excluding current row)
    let thisRowQty=parseInt(input.value)||0;
    let otherRowsQty=0;
    document.querySelectorAll('#tblDailyDefEntry tbody tr').forEach(r=>{
        if(r===row) return;
        const rs=r.querySelectorAll('select');
        const rd=r.querySelector('input[type="date"]');
        const rq=r.querySelector('.def-qty-input');
        if(rs[0]?.value===model&&rs[1]?.value===proc&&rd?.value===date){
            otherRowsQty+=parseInt(rq?.value)||0;
        }
    });
    const alreadySaved=avail.assigned;
    const maxAllowed=avail.total-alreadySaved-otherRowsQty;
    if(thisRowQty>maxAllowed){
        input.value=Math.max(0,maxAllowed);
        input.style.borderColor='#e11d48';
        if(hint) hint.innerHTML=`<span style="color:#e11d48">Max: ${maxAllowed}</span>`;
    } else {
        input.style.borderColor=thisRowQty>0?'#10b981':'var(--border)';
        if(hint) hint.innerHTML=avail?`<span style="color:#94a3b8">${lang==='ko'?'ê°€ëŠ¥:':'Avail:'} ${Math.max(0,maxAllowed)}</span>`:'';
    }
}

function onDefProcChange(sel,rowId){
    const proc=sel.value;
    const tc=document.querySelector('.tc-'+rowId);
    if(tc) tc.innerHTML=getTeamBadge(proc);
    buildDefDD(rowId,proc,'');
    refreshAvailDefects();
}

function buildDefDD(rowId,proc,query){
    const dd=document.getElementById('dd_'+rowId);if(!dd)return;
    const codes=getDefectsForProc(proc);
    const q=(query||'').toLowerCase();
    const filtered=q?codes.filter(c=>c.code.includes(q)||c.name.toLowerCase().includes(q)):codes;
    dd.innerHTML=filtered.slice(0,25).map(c=>
        `<div class="search-option" onclick="selDefCode('${rowId}','${c.code}','${c.name.replace(/'/g,"\\'")}')">
            <span class="opt-code">${c.code}</span><span class="opt-name">${c.name}</span>
        </div>`
    ).join('');
    if(!filtered.length) dd.innerHTML=`<div class="search-option" style="color:var(--text-muted);cursor:default;">${lang==='ko'?'ê²°ê³¼ ì—†ìŒ â€” ì§ì ‘ ì…ë ¥ ê°€ëŠ¥':'Not found â€” manual entry OK'}</div>`;
}

function filterDefDD(input,rowId){
    const row=input.closest('tr');
    const proc=row.querySelectorAll('select')[1]?.value||'';
    buildDefDD(rowId,proc,input.value);
    document.getElementById('dd_'+rowId).classList.add('open');
}
function openDefDD(rowId){
    const row=document.getElementById('ssw_'+rowId).closest('tr');
    const proc=row.querySelectorAll('select')[1]?.value||'';
    const val=row.querySelector('.search-select-input')?.value||'';
    buildDefDD(rowId,proc,val);
    document.getElementById('dd_'+rowId).classList.add('open');
}
function selDefCode(rowId,code,name){
    const inp=document.querySelector('#ssw_'+rowId+' input');
    if(inp){inp.value=code+' '+name;inp.dataset.code=code;inp.dataset.name=name;}
    document.getElementById('dd_'+rowId).classList.remove('open');
}
document.addEventListener('click',e=>{
    if(!e.target.closest('.search-select-wrap'))
        document.querySelectorAll('.search-dropdown').forEach(d=>d.classList.remove('open'));
});

function saveDailyDef(){
    const rows=document.querySelectorAll('#tblDailyDefEntry tbody tr');
    const newData=[];
    let valid=true;
    rows.forEach(r=>{
        const sels=r.querySelectorAll('select');
        const dateInp=r.querySelector('input[type="date"]');
        const codeInp=r.querySelector('.search-select-input');
        const qtyInp=r.querySelector('.def-qty-input');
        const model=sels[0]?.value,proc=sels[1]?.value,date=dateInp?.value;
        const raw=codeInp?.value||'';
        const defCode=codeInp?.dataset.code||(raw.split(' ')[0]||'');
        const defName=codeInp?.dataset.name||(raw.split(' ').slice(1).join(' ')||'');
        const qty=cleanNum(qtyInp?.value);
        if(!model||!proc||!date||!defCode){return;}
        if(qty<=0) return;
        newData.push({model,date,proc,team:getTeam(proc),defectCode:defCode,defectName:defName,qty,month:extractYM(date)});
    });
    if(!newData.length){alert(lang==='ko'?'ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.':'No data to save.');return;}
    // Final validation: check totals don't exceed prod data
    const available=getAvailableDefects();
    const checkMap={};
    newData.forEach(d=>{
        const k=`${d.date}|${d.model}|${d.proc}`;
        checkMap[k]=(checkMap[k]||0)+d.qty;
    });
    for(const [k,total] of Object.entries(checkMap)){
        const a=available[k];
        if(a&&(a.assigned+total)>a.total){
            alert(lang==='ko'?`âš ï¸ [${k.replace(/\|/g,' ')}] ë¶ˆëŸ‰ ì½”ë“œ í•©ê³„(${a.assigned+total})ê°€ ë¶ˆëŸ‰ ìˆ˜ëŸ‰(${a.total})ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.`:`âš ï¸ [${k.replace(/\|/g,' ')}] Defect codes total(${a.assigned+total}) exceeds defect qty(${a.total}).`);
            return;
        }
    }
    const merged=[...dailyDefectData,...newData];
    saveToFirebase('ddef',merged).then(()=>{
        document.getElementById('modalDailyDef').style.display='none';
        document.querySelector('#tblDailyDefEntry tbody').innerHTML='';
        alert(lang==='ko'?`âœ… ${newData.length}ê±´ì˜ ë¶ˆëŸ‰ ì½”ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`:`âœ… ${newData.length} defect code records saved!`);
    });
}

window.onclick=e=>{
    if(e.target.classList.contains('modal')) e.target.style.display='none';
    if(e.target.id==='backupModal') closeBackupModal();
};
</script>
</body>
</html>
